<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIBR - Бобр-строитель привычек</title>
    <style>
:root {
            --bg-color: #faf7f0;
            --surface: #ffffff;
            --surface-alt: #f5ede0;
            --primary: #d97706;
            --secondary: #14b8a6;
            --success: #3cb371;
            --danger: #e53e3e;
            --text-color: #3b2f2f;
            --text-muted: rgba(59, 47, 47, 0.70);
            --border-color: rgba(0, 0, 0, 0.10);
            --font-family: "Segoe UI", "SF Pro Rounded", Roboto, sans-serif;
            --font-size-base: 16px;
            --radius: 12px;
            --gap-small: 8px;
            --gap: 16px;
            --gap-large: 24px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.10);
            --wood-light: #f5e1c7;
            --wood-dark: #e0c3a3;
            --animation-speed: 0.3s;
        }
* {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            background: var(--bg-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            overscroll-behavior: none;
        }
.app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 100%;
            overflow-x: hidden;
        }
.content {
            flex: 1;
            padding: var(--gap);
            padding-bottom: calc(var(--gap) + env(safe-area-inset-bottom));
            overflow-y: auto;
            overflow-x: hidden;
        }
.app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: var(--gap);
            background: var(--surface);
            box-shadow: var(--shadow-sm);
            z-index: 100;
            position: sticky;
            top: 0;
        }
.page-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
.profile-summary {
            display: flex;
            gap: var(--gap);
            font-size: 0.9rem;
            align-items: center;
        }
.profile-summary .resource {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
.bottom-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px var(--gap) calc(8px + env(safe-area-inset-bottom));
            background: var(--surface);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            bottom: 0;
            width: 100%;
            z-index: 100;
        }
.nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            font-size: 0.75rem;
            color: var(--text-muted);
            border: none;
            background: none;
            border-top: 3px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
            touch-action: manipulation;
        }
.nav-item .icon {
            width: 24px;
            height: 24px;
            stroke-width: 2;
            margin-bottom: 4px;
        }
.nav-item.active {
            color: var(--primary);
            border-top-color: var(--primary);
        }
.card {
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: var(--gap);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--gap);
            transition: transform 0.2s, box-shadow 0.2s;
        }
.card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
.habit-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: linear-gradient(135deg, var(--wood-light), var(--wood-dark));
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            animation: woodShimmer 3s infinite linear;
        }
@keyframes woodShimmer {
            0% { background-position: -100px 0; }
            100% { background-position: 100px 0; }
        }
.habit-card:not(.done):not(.missed) {
            opacity: 1;
            border-left: 4px solid transparent;
        }
.habit-card:not(.done):not(.missed):hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-left-color: var(--primary);
        }
.habit-card.done {
            background: linear-gradient(135deg, var(--success), #2ecc71);
            animation: habitDone 0.5s ease-out forwards;
            border-left: 4px solid var(--success);
        }
.habit-card.done .habit-title {
            color: white;
            text-decoration: line-through;
            opacity: 0.9;
        }
.habit-card.done .habit-meta {
            color: rgba(255, 255, 255, 0.8);
        }
.habit-card.done::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(255, 255, 255, 0.1) 50%, 
                transparent 70%);
            animation: shine 2s infinite;
        }
@keyframes habitDone {
            0% {
                transform: scale(1);
                box-shadow: var(--shadow-sm);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 8px 25px rgba(60, 179, 113, 0.3);
            }
            100% {
                transform: scale(1);
                box-shadow: var(--shadow-md);
            }
        }
@keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
.habit-card.missed {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            opacity: 0.7;
            border-left: 4px solid var(--danger);
        }
.habit-card.missed .habit-title {
            color: var(--text-muted);
        }
.habit-card.missed .habit-toggle {
            background: var(--danger);
            border-color: var(--danger);
        }
.habit-card.missed .habit-toggle::after {
            content: "!";
            color: white;
            font-weight: bold;
            opacity: 1;
            transform: none;
            border: none;
            width: auto;
            height: auto;
        }
.habit-title {
            flex: 1;
            font-weight: 600;
            margin-right: 16px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
.habit-title::before {
            content: attr(data-emoji);
            margin-right: 12px;
            font-size: 1.3rem;
        }
.habit-meta {
            display: flex;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
.habit-category-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--surface-alt);
            border-radius: 10px;
            font-size: 0.75rem;
            color: var(--text-color);
        }
.habit-toggle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 3px solid var(--border-color);
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            flex-shrink: 0;
            touch-action: manipulation;
        }
.habit-toggle::before {
            content: "";
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
.habit-toggle:hover::before {
            opacity: 0.3;
        }
.habit-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
.habit-toggle::after {
            content: "";
            width: 16px;
            height: 9px;
            border-left: 3px solid var(--text-color);
            border-bottom: 3px solid var(--text-color);
            transform: rotate(-45deg) scale(0);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
        }
.habit-card.done .habit-toggle {
            background: var(--success);
            border-color: var(--success);
            transform: scale(1);
        }
.habit-card.done .habit-toggle::after {
            transform: rotate(-45deg) scale(1);
            opacity: 1;
            border-color: white;
        }
.habit-card.done .habit-toggle:hover {
            transform: scale(1.1);
            background: #2ecc71;
        }
@keyframes checkmarkAnimation {
            0% {
                transform: rotate(-45deg) scale(0);
                opacity: 0;
            }
            50% {
                transform: rotate(-45deg) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: rotate(-45deg) scale(1);
                opacity: 1;
            }
        }
.habit-card.done .habit-toggle::after {
            animation: checkmarkAnimation 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }
@keyframes particleFloat {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }
.habit-reward-popup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
.reward-emoji {
            font-size: 2rem;
        }
.adventure-widget {
            background: linear-gradient(135deg, var(--surface), var(--surface-alt));
            border: 2px solid var(--secondary);
            border-radius: calc(var(--radius) + 4px);
            padding: var(--gap);
            margin-bottom: var(--gap);
            position: relative;
            overflow: hidden;
        }
.adventure-widget::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary), #0d9488);
        }
.energy-bar {
            height: 12px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin: 12px 0;
        }
.energy-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), #0d9488);
            border-radius: 6px;
            transition: width 0.5s ease;
            position: relative;
        }
.energy-fill::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent);
            animation: shimmer 2s infinite;
        }
@keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
.exercises-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--gap);
            margin: var(--gap) 0;
        }
.exercise-card {
            background: linear-gradient(135deg, var(--surface), var(--surface-alt));
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: var(--gap);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }
.exercise-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }
.exercise-emoji {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }
.shop-item.owned {
            border-color: var(--success);
        }
.shop-item.equipped {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary);
        }
.item-emoji {
            font-size: 2rem;
            margin-bottom: 8px;
        }
.profile-header {
            display: flex;
            align-items: center;
            gap: var(--gap);
            margin-bottom: var(--gap);
        }
.stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--gap);
            margin: var(--gap) 0;
        }
.stat-card {
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: var(--gap);
            text-align: center;
        }
.stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }
.stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
.reflection-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-color);
            font-family: var(--font-family);
            font-size: 1rem;
            resize: vertical;
            margin-bottom: var(--gap);
        }
.mood-selector {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: var(--gap) 0;
        }
.mood-option {
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.2s;
            padding: 8px;
            border-radius: 50%;
            touch-action: manipulation;
        }
.mood-option:hover {
            transform: scale(1.2);
            opacity: 0.8;
        }
.mood-option.active {
            opacity: 1;
            transform: scale(1.3);
            background: var(--surface);
            box-shadow: var(--shadow-md);
        }
.emoji-tab.active {
            background: var(--primary);
            color: white;
        }
.habit-modal {
            max-width: 600px;
        }
.modal-step.active {
            display: block;
        }
.habit-option.selected {
            border-color: var(--primary);
            background: rgba(217, 119, 6, 0.1);
        }
.step-dot.active {
            background: var(--primary);
        }
.exercise-modal {
            max-width: 500px;
        }
.completion-animation {
            position: relative;
            text-align: center;
            margin-bottom: 20px;
        }
.completion-emoji {
            font-size: 4rem;
            margin-bottom: 20px;
        }
.confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
.reward-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
.reward-emoji {
            font-size: 1.5rem;
        }
.reward-amount {
            font-weight: 600;
            font-size: 1.2rem;
        }
.reward-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
.category-details-modal {
            max-width: 500px;
        }
.category-stats {
            background: var(--surface-alt);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }
.stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
.stat-label {
            font-weight: 600;
        }
.habit-list-in-category {
            margin-bottom: 16px;
        }
.category-habit-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
.category-tips {
            background: var(--surface-alt);
            border-radius: var(--radius);
            padding: 16px;
            font-size: 0.9rem;
        }
.onboarding-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--gap);
        }
.onboarding-step {
            max-width: 400px;
            width: 100%;
            text-align: center;
            animation: slideIn 0.3s ease;
        }
@keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
.onboarding-avatar {
            width: 120px;
            height: 120px;
            margin: 0 auto var(--gap);
            background: var(--surface);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            border: 4px solid var(--primary);
            box-shadow: var(--shadow-md);
        }
.onboarding-choice.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
.btn {
            display: inline-block;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-family: var(--font-family);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            touch-action: manipulation;
        }
.btn-primary {
            background: var(--primary);
            color: white;
        }
.btn-primary:hover {
            background: #b45309;
            transform: translateY(-2px);
        }
.btn-secondary {
            background: var(--surface-alt);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
.btn-secondary:hover {
            background: var(--surface);
            transform: translateY(-2px);
        }
.btn-large {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
        }
.modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: var(--gap);
            backdrop-filter: blur(4px);
        }
.modal {
            background: var(--surface);
            border-radius: calc(var(--radius) + 4px);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-md);
            animation: modalAppear 0.3s ease;
        }
@keyframes modalAppear {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
.modal-header {
            padding: var(--gap);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
.modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            touch-action: manipulation;
        }
.modal-content {
            padding: var(--gap);
        }
.modal-footer {
            padding: var(--gap);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: var(--gap-small);
            justify-content: flex-end;
        }
.notification.show {
            transform: translateX(-50%) translateY(0);
        }
@keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
@keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
@keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
@media (max-width: 480px){.exercises-grid,
            .shop-grid,
            .stats-grid {
                grid-template-columns: 1fr;
            }.profile-header {
                flex-direction: column;
                text-align: center;
            }}
@media (max-width: 360px){.exercises-grid,
            .shop-grid,
            .bottom-nav .label {
                display: none;
            }.nav-item {
                padding: 8px 2px;
            }}
.text-center { text-align: center; }
.text-muted { color: var(--text-muted); }
.mb-2 { margin-bottom: var(--gap); }
.hidden { display: none !important; }
@keyframes spin {
            to { transform: rotate(360deg); }
        }
.progress-container {
            width: 100%;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: var(--gap) 0;
        }
.progress-bar {
            height: 10px;
            background: linear-gradient(90deg, var(--primary), #f59e0b);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
.accordion-item.active .accordion-content {
            display: block;
        }
.tab.active {
            background: var(--surface);
            box-shadow: var(--shadow-sm);
        }
.icon {
            width: 24px;
            height: 24px;
            stroke-width: 2;
            stroke: currentColor;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
.empty-state {
            text-align: center;
            padding: var(--gap-large) var(--gap);
            color: var(--text-muted);
        }
.empty-state-icon {
            font-size: 3rem;
            margin-bottom: var(--gap);
            opacity: 0.5;
        }
@keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
.form-group {
            margin-bottom: var(--gap);
        }
.form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }
.form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-color);
            font-family: var(--font-family);
            font-size: 1rem;
            transition: border-color 0.2s;
        }
.form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(217, 119, 6, 0.1);
        }
.switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
.switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
.slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--surface-alt);
            transition: .4s;
            border-radius: 34px;
        }
.slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
input:checked + .slider {
            background-color: var(--primary);
        }
input:checked + .slider:before {
            transform: translateX(24px);
        }
.player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--gap);
        }
.player-controls {
            display: flex;
            align-items: center;
            gap: var(--gap);
        }
.volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
.volume-control input[type="range"] {
            width: 100px;
        }
.volume-slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
.mix-control-modal .modal-content {
            max-height: 60vh;
            overflow-y: auto;
        }
.particle {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
        }
.confetti-piece {
            position: fixed;
            width: 10px;
            height: 20px;
            opacity: 0;
            z-index: 10000;
        }
@keyframes wobble {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }
@keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
@keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
@keyframes grow {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }
@keyframes shrink {
            from { transform: scale(1); }
            to { transform: scale(0); }
        }
@keyframes slideInLeft {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
@keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
@keyframes success {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
@keyframes error {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
@keyframes attention {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
.floating-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--success);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            z-index: 10001;
            transition: transform 0.3s ease;
            font-weight: 600;
            white-space: nowrap;
        }
.onboarding-step {
            flex: 1;
            display: none;
            animation: fadeIn 0.3s ease;
        }
.onboarding-step.active {
            display: flex;
            flex-direction: column;
        }
.category-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
.category-option.selected .category-emoji {
            transform: scale(1.2);
        }
.category-emoji {
            font-size: 2.5rem;
            transition: transform 0.2s;
        }
.category-name {
            font-weight: 600;
            font-size: 1rem;
        }
.habit-option.selected {
            border-color: var(--primary);
            background: rgba(217, 119, 6, 0.1);
        }
.summary-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
.summary-item:last-child {
            border-bottom: none;
        }
.summary-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-alt);
            border-radius: 50%;
        }
.summary-content {
            flex: 1;
        }
.summary-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
@keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
@keyframes slideInFromLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
.beaver-avatar-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
.beaver-background {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--wood-light), var(--wood-dark));
            opacity: 0.3;
        }
.beaver-body {
            position: relative;
            width: 100%;
            height: 100%;
        }
.beaver-head {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 70px;
            background: #8B4513;
            border-radius: 50% 50% 45% 45%;
        }
.beaver-eyes {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            display: flex;
            justify-content: space-between;
        }
.beaver-eye {
            width: 15px;
            height: 15px;
            background: #000;
            border-radius: 50%;
        }
.beaver-nose {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 10px;
            background: #000;
            border-radius: 50%;
        }
.beaver-mouth {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 5px;
            background: #FF6B6B;
            border-radius: 2px;
        }
.beaver-torso {
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 80px;
            background: #A0522D;
            border-radius: 40% 40% 30% 30%;
        }
.beaver-paws {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 40px;
            display: flex;
            justify-content: space-between;
        }
.beaver-paw {
            width: 25px;
            height: 30px;
            background: #8B4513;
            border-radius: 50%;
        }
.beaver-tail {
            position: absolute;
            top: 60%;
            right: 10%;
            width: 40px;
            height: 20px;
            background: #A0522D;
            border-radius: 50% 0 0 50%;
        }
.equipment-slot {
            position: absolute;
            pointer-events: none;
        }
.hat-slot {
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
        }
.tool-slot {
            bottom: 20%;
            right: 15%;
            font-size: 1.5rem;
        }
.accessory-slot {
            top: 40%;
            left: 10%;
            font-size: 1.2rem;
        }
.equipped-item {
            animation-duration: 2s;
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
        }
@keyframes idleBreath {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
@keyframes happyJump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
@keyframes celebrateDance {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
@keyframes hatWobble {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
@keyframes toolShine {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
@keyframes accessorySpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
@keyframes eyeSparkle {
            0%, 100% { box-shadow: 0 0 5px #fff; }
            50% { box-shadow: 0 0 15px #FFD700; }
        }
@keyframes toolWorking {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(5px) rotate(10deg); }
            75% { transform: translateX(-5px) rotate(-10deg); }
        }
.sleep-bubble {
            position: absolute;
            width: 10px;
            height: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: bubbleFloat 2s ease-in-out forwards;
        }
@keyframes bubbleFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(0.5);
                opacity: 0;
            }
        }
.equip-animation {
            animation: equipPulse 0.5s ease;
        }
@keyframes equipPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
.shop-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--gap);
            max-height: 80vh;
            overflow: hidden;
        }
.shop-header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--gap);
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }
.shop-balance {
            display: flex;
            align-items: center;
            gap: var(--gap);
        }
.balance-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: var(--radius);
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
        }
.shop-categories {
            grid-column: 1 / -1;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: var(--gap);
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }
.shop-category {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px;
            background: var(--surface-alt);
            border: 2px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
            white-space: nowrap;
            touch-action: manipulation;
        }
.shop-category:hover {
            background: var(--surface);
            transform: translateY(-2px);
        }
.shop-category.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
.category-emoji {
            font-size: 1.5rem;
        }
.category-name {
            font-size: 0.8rem;
            font-weight: 600;
        }
.shop-items {
            grid-column: 1;
            overflow-y: auto;
            padding: var(--gap);
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }
.items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--gap);
        }
.shop-item-card {
            background: var(--surface);
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            padding: var(--gap);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 12px;
            touch-action: manipulation;
        }
.shop-item-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }
.shop-item-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.2);
        }
.shop-item-card.owned {
            border-color: var(--success);
        }
.shop-item-card.equipped {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary);
        }
.item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
.item-emoji {
            font-size: 2rem;
        }
.item-badge {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
        }
.item-badge.owned {
            background: var(--success);
            color: white;
        }
.item-badge.equipped {
            background: var(--primary);
            color: white;
        }
.item-content {
            flex: 1;
        }
.item-content h4 {
            margin: 0 0 8px 0;
            font-size: 1rem;
        }
.item-price {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 8px;
            font-weight: 600;
        }
.price-emoji {
            font-size: 1rem;
        }
.price-value.insufficient {
            color: var(--danger);
        }
.item-type {
            font-size: 0.8rem;
            color: var(--text-muted);
            background: var(--surface-alt);
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
.item-actions {
            margin-top: auto;
        }
.shop-preview {
            grid-column: 2;
            padding: var(--gap);
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: var(--gap);
        }
.beaver-preview {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-alt);
            border-radius: var(--radius);
            min-height: 200px;
        }
.preview-controls {
            display: flex;
            gap: var(--gap);
        }
.purchase-success-modal .modal-content {
            text-align: center;
        }
.success-animation {
            position: relative;
            margin: 0 auto 20px;
            width: 100px;
            height: 100px;
        }
.success-emoji {
            font-size: 4rem;
            animation: bounce 1s infinite;
        }
.purchase-details {
            background: var(--surface-alt);
            border-radius: var(--radius);
            padding: var(--gap);
            margin: var(--gap) 0;
            text-align: left;
        }
.detail-item {
            display: flex;
            margin-bottom: 8px;
        }
.detail-item:last-child {
            margin-bottom: 0;
        }
.detail-label {
            min-width: 80px;
            font-weight: 600;
            color: var(--text-muted);
        }
.detail-value ul {
            margin: 0;
            padding-left: 20px;
        }
.detail-value li {
            margin-bottom: 4px;
        }
.purchase-tip {
            background: rgba(20, 184, 166, 0.1);
            border-radius: var(--radius);
            padding: var(--gap);
            margin-top: var(--gap);
        }
.earn-coins-modal .modal-content {
            max-height: 60vh;
            overflow-y: auto;
        }
.earn-methods {
            display: flex;
            flex-direction: column;
            gap: var(--gap);
            margin-bottom: var(--gap);
        }
.earn-method {
            display: flex;
            gap: var(--gap);
            padding: var(--gap);
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }
.earn-method:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }
.method-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-alt);
            border-radius: 50%;
            flex-shrink: 0;
        }
.method-content {
            flex: 1;
        }
.method-content h4 {
            margin: 0 0 4px 0;
            font-size: 1.1rem;
        }
.method-content p {
            margin: 0 0 8px 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
.method-reward {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
.earn-tips {
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--gap);
        }
.earn-tips h4 {
            margin: 0 0 12px 0;
        }
.earn-tips ul {
            margin: 0;
            padding-left: 20px;
        }
.earn-tips li {
            margin-bottom: 8px;
            color: var(--text-muted);
        }
@media (max-width: 768px){.shop-container {
                grid-template-columns: 1fr;
            }.shop-preview {
                grid-column: 1;
            }.items-grid {
                grid-template-columns: repeat(2, 1fr);
            }}
@media (max-width: 480px){.items-grid {
                grid-template-columns: 1fr;
            }.shop-header {
                flex-direction: column;
                gap: var(--gap);
                text-align: center;
            }.shop-categories {
                flex-wrap: wrap;
                justify-content: center;
            }}
:root {
            --bg-color: #faf7f0;
            --surface: #ffffff;
            --surface-alt: #f5ede0;
            --primary: #d97706;
            --secondary: #14b8a6;
            --success: #3cb371;
            --danger: #e53e3e;
            --text-color: #3b2f2f;
            --text-muted: rgba(59, 47, 47, 0.70);
            --border-color: rgba(0, 0, 0, 0.10);
            --font-family: "Segoe UI", "SF Pro Rounded", Roboto, sans-serif;
            --font-size-base: 16px;
            --radius: 12px;
            --gap-small: 8px;
            --gap: 16px;
            --gap-large: 24px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.10);
            --wood-light: #f5e1c7;
            --wood-dark: #e0c3a3;
            --animation-speed: 0.3s;
            --energy-color: #06b6d4;
            --expedition-color: #8b5cf6;
            --weekly-color: #10b981;
            --seasonal-color: #f59e0b;
        }
.adventure-progress-container {
            position: relative;
            height: 100px;
            margin: var(--gap) 0;
            background: var(--surface-alt);
            border-radius: var(--radius);
            overflow: hidden;
        }
.adventure-journey-path {
            position: absolute;
            top: 50%;
            left: 20px;
            right: 20px;
            height: 4px;
            background: var(--border-color);
            transform: translateY(-50%);
            z-index: 1;
        }
.adventure-jourway-points {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
.journey-point {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--surface);
            border: 3px solid var(--border-color);
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            transition: all 0.3s;
        }
.journey-point.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 0 0 4px rgba(217, 119, 6, 0.2);
        }
.journey-point.completed {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
.adventure-beaver-icon {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translate(-50%, -50%);
            font-size: 24px;
            z-index: 4;
            transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
@keyframes bubbleAppear {
            0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
            100% { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
.adventure-weather-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
            opacity: 0.7;
        }
.adventure-time-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 0.8rem;
            color: var(--text-muted);
            background: var(--surface);
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
.adventure-type-weekly .adventure-header {
            background: linear-gradient(135deg, var(--weekly-color), rgba(16, 185, 129, 0.1));
        }
.adventure-type-seasonal .adventure-header {
            background: linear-gradient(135deg, var(--seasonal-color), rgba(245, 158, 11, 0.1));
        }
@keyframes itemShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
.adventure-story-log {
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--gap);
            margin: var(--gap) 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
.story-entry {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
.story-entry:last-child {
            border-bottom: none;
        }
.story-time {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-right: 8px;
        }
.story-content {
            display: inline;
        }
.inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: var(--gap-small);
            margin: var(--gap) 0;
        }
.inventory-slot {
            aspect-ratio: 1;
            background: var(--surface-alt);
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
.inventory-slot:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }
.inventory-slot.equipped::after {
            content: "✓";
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: var(--success);
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
.item-quantity {
            position: absolute;
            bottom: 2px;
            left: 2px;
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            padding: 1px 4px;
            border-radius: 8px;
        }
.item-modal .modal-content {
            text-align: center;
        }
.item-preview-large {
            font-size: 4rem;
            margin: var(--gap) 0;
            animation: itemFloat 3s ease-in-out infinite;
        }
@keyframes itemFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
.item-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--gap-small);
            margin: var(--gap) 0;
        }
.item-stat {
            background: var(--surface-alt);
            padding: 8px;
            border-radius: var(--radius);
            font-size: 0.9rem;
        }
.stat-value {
            font-weight: 600;
            color: var(--primary);
        }
.requirements-card {
            background: var(--surface-alt);
            border-radius: var(--radius);
            padding: var(--gap);
            margin: var(--gap) 0;
            border-left: 4px solid var(--expedition-color);
        }
.requirement-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
.requirement-item.completed {
            color: var(--success);
        }
.requirement-progress {
            flex: 1;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }
.requirement-progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Onboarding helpers */
        .onboarding-choices {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .onboarding-choice {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 14px;
            background: var(--surface);
            cursor: pointer;
            user-select: none;
            transition: transform var(--animation-speed) ease, border-color var(--animation-speed) ease, background var(--animation-speed) ease;
        }
        .onboarding-choice:hover {
            transform: translateY(-1px);
            border-color: rgba(0,0,0,0.18);
        }
        .tame-meter {
            width: 100%;
            max-width: 360px;
            margin: 0 auto;
        }
        .tame-bar {
            width: 100%;
            height: 10px;
            background: rgba(0,0,0,0.10);
            border-radius: 999px;
            overflow: hidden;
        }
        .tame-fill {
            height: 100%;
            width: 0%;
            background: var(--primary);
            transition: width var(--animation-speed) ease;
        }
        .mt-1 { margin-top: 6px; }
        .mt-2 { margin-top: 12px; }
        .mt-3 { margin-top: 18px; }

    </style>
</head>
<body class="light">
    <!-- Основное приложение -->
    <div id="app" class="app-container hidden">
        <!-- Шапка -->
        <header class="app-header">
            <h1 id="pageTitle" class="page-title">Сегодня</h1>
            <button id="menuBtn" class="btn btn-secondary" style="padding: 8px 12px;">
                <svg class="icon" viewBox="0 0 24 24">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <div class="profile-summary">
                <div class="resource" title="Монеты">🪙 <span id="coins">0</span></div>
                <div class="resource" title="Опыт">⭐ <span id="xp">0</span></div>
                <div class="resource" title="Бобр">🦫 <span id="beaverNameHeader"></span></div>
            </div>
        </header>

        <!-- Контент -->
        <main id="content" class="content"></main>

        <!-- Навигация -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-page="today">
                <svg class="icon" viewBox="0 0 24 24">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span class="label">Сегодня</span>
            </button>
            <button class="nav-item" data-page="habits">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                </svg>
                <span class="label">Привычки</span>
            </button>
            <button class="nav-item" data-page="quests">
                <svg class="icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span class="label">Квесты</span>
            </button>            <button class="nav-item" data-page="shop">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M6 7l1-4h10l1 4"></path>
                    <path d="M4 7h16l-1 14H5L4 7z"></path>
                    <path d="M9 11v6"></path>
                    <path d="M15 11v6"></path>
                </svg>
                <span class="label">Магазин</span>
            </button>

            <button class="nav-item" data-page="profile">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <span class="label">Профиль</span>
            </button>
        </nav>
    </div>

    <script>


        // ========== КОНСТАНТЫ ==========
        const APP_STATE_KEY = 'bibr_state_v9';
        
        const HABIT_CATEGORIES = {
            health: { 
                name: 'Здоровье', 
                emoji: '💊', 
                color: '#10b981',
                subcategories: ['hydration', 'nutrition', 'hygiene', 'prevention', 'posture']
            },
            sleep: { 
                name: 'Сон', 
                emoji: '😴', 
                color: '#8b5cf6',
                subcategories: ['rituals', 'quality', 'timing', 'environment', 'recovery']
            },
            work: { 
                name: 'Работа', 
                emoji: '💼', 
                color: '#3b82f6',
                subcategories: ['planning', 'focus', 'communication', 'learning', 'rest']
            },
            mind: { 
                name: 'Мышление', 
                emoji: '🧠', 
                color: '#f59e0b',
                subcategories: ['meditation', 'reading', 'learning', 'creativity', 'reflection']
            },
            sport: { 
                name: 'Спорт', 
                emoji: '💪', 
                color: '#ef4444',
                subcategories: ['cardio', 'strength', 'stretching', 'balance', 'recovery']
            },
            social: { 
                name: 'Общение', 
                emoji: '👥', 
                color: '#ec4899',
                subcategories: ['family', 'friends', 'colleagues', 'new', 'support']
            },
            other: { 
                name: 'Другое', 
                emoji: '✨', 
                color: '#6b7280',
                subcategories: ['finance', 'organization', 'hobbies', 'charity', 'misc']
            }
        };

        const EXERCISES = [
            { id: 'breath', title: 'Дыхание', emoji: '🌬️', duration: 60, desc: '1 минута для успокоения', type: 'guided' },
            { id: 'stretch', title: 'Растяжка', emoji: '🧘', duration: 120, desc: '2 минуты для тела', type: 'timer' },
            { id: 'meditate', title: 'Медитация', emoji: '😌', duration: 300, desc: '5 минут для ума', type: 'meditation' },
            { id: 'gratitude', title: 'Благодарность', emoji: '🙏', duration: 0, desc: '3 вещи за день', type: 'reflection' }
        ];

        const SHOP_ITEMS = [
            { id: 'hat1', name: 'Каска', emoji: '⛑️', price: 50, type: 'hat' },
            { id: 'hat2', name: 'Шляпа', emoji: '🎩', price: 75, type: 'hat' },
            { id: 'tool1', name: 'Молоток', emoji: '🔨', price: 30, type: 'tool' },
            { id: 'tool2', name: 'Пила', emoji: '🪚', price: 45, type: 'tool' },
            { id: 'acc1', name: 'Очки', emoji: '🥽', price: 25, type: 'accessory' },
            { id: 'acc2', name: 'Часы', emoji: '⌚', price: 60, type: 'accessory' },
            { id: 'bg1', name: 'Лесной фон', emoji: '🌲', price: 100, type: 'background' },
            { id: 'bg2', name: 'Городской фон', emoji: '🏙️', price: 120, type: 'background' }
        ];

        const EMOJI_CATEGORIES = {
            people: ["😀", "😃", "😄", "😁", "😆", "😅", "😂", "🤣", "😊", "😇", "🙂", "🙃", "😉", "😌", "😍", "🥰", "😘", "😗", "😙", "😚", "😋", "😛", "😝", "😜", "🤪", "🤨", "🧐", "🤓", "😎", "🤩", "🥳", "😏", "😒", "😞", "😔", "😟", "😕", "🙁", "☹️", "😣", "😖", "😫", "😩", "🥺", "😢", "😭", "😤", "😠", "😡", "🤬", "🤯", "😳", "🥵", "🥶", "😱", "😨", "😰", "😥", "😓", "🤗", "🤔", "🤭", "🤫", "🤥", "😶", "😐", "😑", "😬", "🙄", "😯", "😦", "😧", "😮", "😲", "🥱", "😴", "🤤", "😪", "😵", "🤐", "🥴", "🤢", "🤮", "🤧", "😷", "🤒", "🤕", "🤑", "🤠"],
            nature: ["🐶", "🐱", "🐭", "🐹", "🐰", "🦊", "🐻", "🐼", "🐨", "🐯", "🦁", "🐮", "🐷", "🐸", "🐵", "🙈", "🙉", "🙊", "🐒", "🐔", "🐧", "🐦", "🐤", "🐣", "🐥", "🦆", "🦅", "🦉", "🦇", "🐺", "🐗", "🐴", "🦄", "🐝", "🐛", "🦋", "🐌", "🐞", "🐜", "🦟", "🦗", "🕷", "🕸", "🦂", "🐢", "🐍", "🦎", "🦖", "🦕", "🐙", "🦑", "🦐", "🦀", "🐡", "🐠", "🐟", "🐬", "🐳", "🐋", "🦈", "🐊", "🐅", "🐆", "🦓", "🦍", "🦧", "🐘", "🦛", "🦏", "🐪", "🐫", "🦒", "🦘", "🐃", "🐂", "🐄", "🐎", "🐖", "🐏", "🐑", "🦙", "🐐", "🦌", "🐕", "🐩", "🐈", "🦤", "🦢", "🦜", "🐓", "🦃", "🦚", "🦜", "🦩", "🦨", "🦦", "🦥", "🐁", "🐀", "🦔"],
            food: ["🍏", "🍎", "🍐", "🍊", "🍋", "🍌", "🍉", "🍇", "🍓", "🫐", "🍈", "🍒", "🍑", "🥭", "🍍", "🥥", "🥝", "🍅", "🍆", "🥑", "🥦", "🥬", "🥒", "🌶", "🫑", "🌽", "🥕", "🫒", "🧄", "🧅", "🥔", "🍠", "🥐", "🥯", "🍞", "🥖", "🥨", "🧀", "🥚", "🍳", "🧈", "🥞", "🧇", "🥓", "🥩", "🍗", "🍖", "🦴", "🌭", "🍔", "🍟", "🍕", "🫓", "🥪", "🥙", "🧆", "🌮", "🌯", "🫔", "🥗", "🥘", "🫕", "🥫", "🍝", "🍜", "🍲", "🍛", "🍣", "🍱", "🥟", "🦪", "🍤", "🍙", "🍚", "🍘", "🍥", "🥠", "🥮", "🍢", "🍡", "🍧", "🍨", "🍦", "🥧", "🧁", "🍰", "🎂", "🍮", "🍭", "🍬", "🍫", "🍿", "🍩", "🍪", "🌰", "🥜", "🫘", "🍯"],
            activity: ["⚽", "🏀", "🏈", "⚾", "🥎", "🏐", "🏉", "🥏", "🎱", "🪀", "🏓", "🏸", "🏒", "🏑", "🥍", "🏏", "🪃", "🥅", "⛳", "🪁", "🏹", "🎣", "🤿", "🥊", "🥋", "🎽", "🛹", "🛼", "🛷", "⛸", "🥌", "🎿", "⛷", "🏂", "🪂", "🏋️", "🤼", "🤸", "⛹️", "🤺", "🤾", "🏌️", "🏇", "🧘", "🏄", "🏊", "🤽", "🚣", "🧗", "🚵", "🚴", "🏆", "🥇", "🥈", "🥉", "🏅", "🎖", "🏵", "🎗", "🎫", "🎟", "🎪", "🤹", "🎭", "🩰", "🎨", "🎬", "🎤", "🎧", "🎼", "🎹", "🥁", "🪘", "🎷", "🎺", "🪗", "🎸", "🪕", "🎻", "🎲", "🧩", "♟", "🪄", "🎮", "🎯", "🎳", "🎰", "🎲"],
            objects: ["⌚", "📱", "📲", "💻", "⌨️", "🖥", "🖨", "🖱", "🖲", "🕹", "🗜", "💽", "💾", "💿", "📀", "📼", "📷", "📸", "📹", "🎥", "📽", "🎞", "📞", "☎️", "📟", "📠", "📺", "📻", "🎙", "🎚", "🎛", "🧭", "⏱", "⏲", "⏰", "🕰", "⌛", "⏳", "📡", "🔋", "🔌", "💡", "🔦", "🕯", "🪔", "🧯", "🛢", "💸", "💵", "💴", "💶", "💷", "💰", "💳", "💎", "⚖️", "🪜", "🧰", "🪛", "🔧", "🔨", "⚒", "🛠", "⛏", "🔩", "⚙️", "🧱", "⛓", "🧲", "🔫", "💣", "🧨", "🪓", "🔪", "🗡", "⚔️", "🛡", "🚬", "⚰️", "🪦", "⚱️", "🏺", "🔮", "📿", "💈", "⚗️", "🔭", "🔬", "🕳", "🩹", "🩺", "💊", "💉", "🩸", "🧬", "🦠", "🧫", "🧪", "🌡", "🧹", "🪠", "🧺", "🧻", "🚽", "🚰", "🚿", "🛁", "🪥", "🪒", "🧽", "🧴", "🛎", "🔑", "🗝", "🚪", "🪑", "🛋", "🛏", "🧸", "🪆", "🖼", "🛍", "🛒", "🎁", "🎈", "🎏", "🎀", "🪄", "🪅", "🎊", "🎉", "🎎", "🏮", "🎐", "🧧", "✉️", "📩", "📨", "📧", "💌", "📥", "📤", "📦", "🏷", "📪", "📫", "📬", "📭", "📮", "📯", "📜", "📃", "📄", "📑", "🧾", "📊", "📈", "📉", "🗒", "🗓", "📆", "📅", "🗑", "📇", "🗃", "🗳", "🗄", "📋", "📁", "📂", "🗂", "🗞", "📰", "📓", "📔", "📒", "📕", "📗", "📘", "📙", "📚", "📖", "🔖", "🧷", "🔗", "📎", "🖇", "📐", "📏", "🧮", "📌", "📍", "✂️", "🖊", "🖋", "✒️", "🖌", "🖍", "📝", "✏️", "🔍", "🔎", "🔏", "🔐", "🔒", "🔓"],
            symbols: ["❤️", "🧡", "💛", "💚", "💙", "💜", "🖤", "🤍", "🤎", "💔", "❣️", "💕", "💞", "💓", "💗", "💖", "💘", "💝", "💟", "☮️", "✝️", "☪️", "🕉", "☸️", "✡️", "🔯", "🕎", "☯️", "☦️", "🛐", "⛎", "♈", "♉", "♊", "♋", "♌", "♍", "♎", "♏", "♐", "♑", "♒", "♓", "🆔", "⚛️", "🉑", "☢️", "☣️", "📴", "📳", "🈶", "🈚", "🈸", "🈺", "🈷️", "✴️", "🆚", "💮", "🉐", "㊙️", "㊗️", "🈴", "🈵", "🈹", "🈲", "🅰️", "🅱️", "🆎", "🆑", "🅾️", "🆘", "❌", "⭕", "🛑", "⛔", "📛", "🚫", "💯", "💢", "♨️", "🚷", "🚯", "🚳", "🚱", "🔞", "📵", "🚭", "❗", "❕", "❓", "❔", "‼️", "⁉️", "🔅", "🔆", "〽️", "⚠️", "🚸", "🔱", "⚜️", "🔰", "♻️", "✅", "🈯", "💹", "❇️", "✳️", "❎", "🌐", "💠", "Ⓜ️", "🌀", "💤", "🏧", "🚾", "♿", "🅿️", "🈳", "🈂️", "🛂", "🛃", "🛄", "🛅", "🚹", "🚺", "🚼", "🚻", "🚮", "🎦", "📶", "🈁", "🔣", "ℹ️", "🔤", "🔡", "🔠", "🆖", "🆗", "🆙", "🆒", "🆕", "🆓", "0️⃣", "1️⃣", "2️⃣", "3️⃣", "4️⃣", "5️⃣", "6️⃣", "7️⃣", "8️⃣", "9️⃣", "🔟", "🔢", "#️⃣", "*️⃣", "⏏️", "▶️", "⏸", "⏯", "⏹", "⏺", "⏭", "⏮", "⏩", "⏪", "⏫", "⏬", "◀️", "🔼", "🔽", "➡️", "⬅️", "⬆️", "⬇️", "↗️", "↘️", "↙️", "↖️", "↕️", "↔️", "↪️", "↩️", "⤴️", "⤵️", "🔀", "🔁", "🔂", "🔄", "🔃", "🎵", "🎶", "➕", "➖", "➗", "✖️", "♾", "💲", "💱", "™️", "©️", "®️", "〰️", "➰", "➿", "🔚", "🔙", "🔛", "🔝", "🔜", "✔️", "☑️", "🔘", "⚪", "⚫", "🔴", "🔵", "🔸", "🔹", "🔶", "🔷", "🔺", "▪️", "▫️", "⬛", "⬜", "◼️", "◻️", "◾", "◽", "🔲", "🔳", "🟥", "🟧", "🟨", "🟩", "🟦", "🟪", "🟫", "🟧", "🟨", "🟩", "🟦", "🟪", "🟫", "⚫", "⚪"]
        };

        // ========== ПРЕДОПРЕДЕЛЕННЫЕ ПРИВЫЧКИ ==========
        const PREDEFINED_HABITS = [
            {
                id: "habit_001",
                title: "Выпить 2 литра воды",
                category: "health",
                subcategory: "hydration",
                emoji: "💧",
                description: "Поддержание водного баланса в течение дня",
                difficulty: 2,
                timeOfDay: ["morning", "afternoon", "evening"],
                duration: 0,
                frequency: "daily",
                triggers: ["проснулся", "сел за работу", "после еды"],
                benefits: ["улучшение кожи", "повышение энергии", "детокс"],
                tags: ["здоровье", "базовое", "важное"],
                popularity: 85
            },
            {
                id: "habit_002",
                title: "Утренняя зарядка",
                category: "sport",
                subcategory: "stretching",
                emoji: "💪",
                description: "15 минут упражнений для пробуждения тела",
                difficulty: 1,
                timeOfDay: ["morning"],
                duration: 15,
                frequency: "daily",
                triggers: ["проснулся", "после душа"],
                benefits: ["энергия", "гибкость", "хорошее настроение"],
                tags: ["спорт", "утро", "энергия"],
                popularity: 75
            },
            {
                id: "habit_003",
                title: "Запись мыслей",
                category: "mind",
                subcategory: "reflection",
                emoji: "📝",
                description: "5 минут для записи мыслей и идей",
                difficulty: 1,
                timeOfDay: ["evening"],
                duration: 5,
                frequency: "daily",
                triggers: ["перед сном", "после работы"],
                benefits: ["ясность ума", "самоанализ", "идеи"],
                tags: ["мышление", "вечер", "рефлексия"],
                popularity: 65
            },
            {
                id: "habit_004",
                title: "Медитация",
                category: "mind",
                subcategory: "meditation",
                emoji: "🧘",
                description: "10 минут медитации для успокоения ума",
                difficulty: 2,
                timeOfDay: ["morning", "evening"],
                duration: 10,
                frequency: "daily",
                triggers: ["проснулся", "перед сном"],
                benefits: ["спокойствие", "концентрация", "снижение стресса"],
                tags: ["медитация", "осознанность", "покой"],
                popularity: 80
            },
            {
                id: "habit_005",
                title: "Чтение книги",
                category: "mind",
                subcategory: "reading",
                emoji: "📚",
                description: "30 минут чтения для развития",
                difficulty: 1,
                timeOfDay: ["evening"],
                duration: 30,
                frequency: "daily",
                triggers: ["после ужина", "перед сном"],
                benefits: ["знания", "словарный запас", "расслабление"],
                tags: ["чтение", "развитие", "вечер"],
                popularity: 70
            },
            {
                id: "habit_006",
                title: "Прогулка на свежем воздухе",
                category: "health",
                subcategory: "prevention",
                emoji: "🚶",
                description: "30 минут пешей прогулки",
                difficulty: 1,
                timeOfDay: ["afternoon", "evening"],
                duration: 30,
                frequency: "daily",
                triggers: ["после обеда", "после работы"],
                benefits: ["здоровье сердца", "витамин D", "снижение стресса"],
                tags: ["прогулка", "здоровье", "отдых"],
                popularity: 60
            },
            {
                id: "habit_007",
                title: "Планирование дня",
                category: "work",
                subcategory: "planning",
                emoji: "📅",
                description: "10 минут для составления плана на день",
                difficulty: 1,
                timeOfDay: ["morning"],
                duration: 10,
                frequency: "daily",
                triggers: ["за чашкой кофе", "перед работой"],
                benefits: ["продуктивность", "организованность", "фокус"],
                tags: ["работа", "планирование", "утро"],
                popularity: 85
            }
        ];

        // ========== STATE MANAGER ==========
        class StateManager {
            static getState() {
                const saved = localStorage.getItem(APP_STATE_KEY);
                if (saved) {
                    const state = JSON.parse(saved);
                    // Миграция для новых полей
                    if (!state.user.energy) state.user.energy = 100;
                    if (!state.user.maxEnergy) state.user.maxEnergy = 100;
                    if (!state.adventures) state.adventures = [];
                    if (!state.activeAdventure) state.activeAdventure = null;
                    if (!state.adventureProgress) state.adventureProgress = [];
                    if (!state.inventory) state.inventory = [];
                    return state;
                }
                return this.getDefaultState();
            }

            static getDefaultState() {
                return {
                    version: 8,
                    user: {
                        name: 'Бобрик',
                        level: 1,
                        xp: 0,
                        coins: 100,
                        streak: 0,
                        energy: 100,
                        maxEnergy: 100,
                        lastActive: null,
                        categories: [],
                        equipped: {
                            hat: null,
                            tool: 'starter_hammer',
                            accessory: null,
                            background: null
                        }
                    },
                    habits: [],
                    completedToday: {},
                    stats: {
                        totalCompleted: 0,
                        perfectDays: 0,
                        currentStreak: 0,
                        longestStreak: 0
                    },
                    quests: {
                        daily: [],
                        special: [],
                        completed: []
                    },
                    inventory: [],
                    adventures: [],
                    activeAdventure: null,
                    adventureProgress: [],
                    reflections: [],
                    settings: {
sound: true,
                        haptic: true,
                        notifications: true
                    },
                    onboarding: {
                        completed: false,
                        step: 1
                    }
                };
            }

            static saveState(state) {
                localStorage.setItem(APP_STATE_KEY, JSON.stringify(state));
                this.updateUI();
            }

            static updateUI() {
                const state = this.getState();
                const coinsEl = document.getElementById('coins');
                if (coinsEl) coinsEl.textContent = state.user.coins;
                const xpEl = document.getElementById('xp');
                if (xpEl) xpEl.textContent = state.user.xp;
                const beaverEl = document.getElementById('beaverNameHeader');
                if (beaverEl) beaverEl.textContent = state.user.name || 'Бобр';
            }

            static addHabit(habit) {
                const state = this.getState();
                const newHabit = {
                    id: 'habit_' + Date.now(),
                    title: habit.title,
                    category: habit.category,
                    subcategory: habit.subcategory || 'misc',
                    emoji: habit.emoji || '✨',
                    description: habit.description || '',
                    difficulty: habit.difficulty || 1,
                    timeOfDay: habit.timeOfDay || ['any'],
                    duration: habit.duration || 0,
                    frequency: habit.frequency || 'daily',
                    goal: habit.goal || 1,
                    completedToday: 0,
                    createdAt: new Date().toISOString(),
                    completed: 0,
                    streak: 0
                };
                
                state.habits.push(newHabit);
                this.saveState(state);
                return newHabit;
            }

            static toggleHabit(habitId) {
                const state = this.getState();
                const today = new Date().toDateString();
                
                if (!state.completedToday[today]) {
                    state.completedToday[today] = [];
                }
                
                const habit = state.habits.find(h => h.id === habitId);
                if (!habit) return [];
                
                const index = state.completedToday[today].indexOf(habitId);
                
                if (index > -1) {
                    // Отмена выполнения
                    state.completedToday[today].splice(index, 1);
                    state.stats.totalCompleted--;
                    
                    if (habit.goal > 1) {
                        habit.completedToday = Math.max(0, (habit.completedToday || 0) - 1);
                    }
                } else {
                    // Выполнение
                    state.completedToday[today].push(habitId);
                    state.stats.totalCompleted++;
                    
                    // Награда
                    state.user.coins += 5;
                    state.user.xp += 2;
                    
                    // Увеличиваем счетчики
                    habit.completed++;
                    if (habit.goal > 1) {
                        habit.completedToday = (habit.completedToday || 0) + 1;
                    }
                    
                    // Увеличиваем стрик
                    habit.streak++;
                    
                    // Проверяем уровень
                    this.checkLevelUp(state);
                }
                
                this.saveState(state);
                return state.completedToday[today];
            }

            static checkLevelUp(state) {
                const xpNeeded = state.user.level * 100;
                if (state.user.xp >= xpNeeded) {
                    state.user.level++;
                    state.user.xp -= xpNeeded;
                    return true;
                }
                return false;
            }

            static getTodayCompletion() {
                const state = this.getState();
                const today = new Date().toDateString();
                const completed = state.completedToday[today] || [];
                
                // Получаем ID привычек, выполненных сегодня
                const completedHabits = completed.filter(id => {
                    const habit = state.habits.find(h => h.id === id);
                    return habit && (!habit.goal || habit.goal <= 1 || habit.completedToday >= habit.goal);
                });
                
                return {
                    completed: completedHabits.length,
                    total: state.habits.filter(h => h.frequency === 'daily').length,
                    percentage: state.habits.filter(h => h.frequency === 'daily').length > 0 ? 
                        (completedHabits.length / state.habits.filter(h => h.frequency === 'daily').length) * 100 : 0,
                    completedHabits: completedHabits
                };
            }

            static getHabitStats() {
                const state = this.getState();
                const stats = {};
                
                Object.entries(HABIT_CATEGORIES).forEach(([categoryId, category]) => {
                    const categoryHabits = state.habits.filter(h => h.category === categoryId);
                    const completedToday = state.completedToday[new Date().toDateString()] || [];
                    
                    stats[categoryId] = {
                        ...category,
                        total: categoryHabits.length,
                        completed: categoryHabits.filter(h => completedToday.includes(h.id)).length,
                        percentage: categoryHabits.length > 0 ? 
                            (categoryHabits.filter(h => completedToday.includes(h.id)).length / categoryHabits.length) * 100 : 0
                    };
                });
                
                return stats;
            }

            static getHabitsByCategory(categoryId) {
                const state = this.getState();
                return state.habits.filter(h => h.category === categoryId);
            }

            static addCoins(amount) {
                const state = this.getState();
                state.user.coins += amount;
                this.saveState(state);
                return state.user.coins;
            }

            static addXP(amount) {
                const state = this.getState();
                state.user.xp += amount;
                this.saveState(state);
                return state.user.xp;
            }

            static completeOnboarding() {
                const state = this.getState();
                state.onboarding.completed = true;
                state.onboarding.step = 0;
                this.saveState(state);
            }

            static setOnboardingStep(step) {
                const state = this.getState();
                state.onboarding.step = step;
                this.saveState(state);
            }

            static setUserCategories(categories) {
                const state = this.getState();
                state.user.categories = categories;
                this.saveState(state);
            }

            static setBeaverName(name) {
                const state = this.getState();
                state.user.name = name;
                this.saveState(state);
            }

            static addEnergy(amount) {
                const state = this.getState();
                state.user.energy = Math.min(state.user.maxEnergy, state.user.energy + amount);
                this.saveState(state);
                return state.user.energy;
            }

            static useEnergy(amount) {
                const state = this.getState();
                if (state.user.energy >= amount) {
                    state.user.energy -= amount;
                    this.saveState(state);
                    return true;
                }
                return false;
            }

            static getEnergy() {
                const state = this.getState();
                return {
                    current: state.user.energy,
                    max: state.user.maxEnergy
                };
            }
        }

        // ========== ANIMATION MANAGER ==========
        class AnimationManager {
            constructor() {
                this.animations = new Map();
                this.particles = new Map();
                this.confettiSystems = new Map();
                this.hapticEnabled = true;
                this.animationQuality = 'high';
                
                this.init();
            }

            init() {
                this.hapticEnabled = 'vibrate' in navigator;
                console.log('AnimationManager инициализирован');
            }

            vibrate(pattern) {
                if (!this.hapticEnabled) return false;
                
                try {
                    navigator.vibrate(pattern);
                    return true;
                } catch (error) {
                    console.warn('Ошибка вибрации:', error);
                    return false;
                }
            }

            vibrateSuccess() {
                return this.vibrate([50, 30, 50]);
            }

            vibrateError() {
                return this.vibrate([100, 50, 100, 50, 100]);
            }

            vibrateTap() {
                return this.vibrate(50);
            }

            createParticles(options = {}) {
                const {
                    count = 20,
                    element = document.body,
                    x = window.innerWidth / 2,
                    y = window.innerHeight / 2,
                    colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#06D6A0', '#118AB2'],
                    size = { min: 4, max: 10 },
                    speed = { min: 1, max: 3 },
                    life = { min: 500, max: 1500 }
                } = options;
                
                const particleId = `particles_${Date.now()}`;
                const particles = [];
                
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    
                    const angle = Math.random() * Math.PI * 2;
                    const velocity = Math.random() * (speed.max - speed.min) + speed.min;
                    const particleSize = Math.random() * (size.max - size.min) + size.min;
                    const particleLife = Math.random() * (life.max - life.min) + life.min;
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    
                    particle.style.cssText = `
                        position: fixed;
                        left: ${x}px;
                        top: ${y}px;
                        width: ${particleSize}px;
                        height: ${particleSize}px;
                        background: ${color};
                        border-radius: 50%;
                        opacity: 1;
                        pointer-events: none;
                        z-index: 10000;
                    `;
                    
                    document.body.appendChild(particle);
                    
                    particles.push({
                        element: particle,
                        vx: Math.cos(angle) * velocity,
                        vy: Math.sin(angle) * velocity,
                        life: particleLife,
                        born: Date.now()
                    });
                }
                
                this.particles.set(particleId, { particles, startTime: Date.now() });
                this.animateParticles(particleId);
                return particleId;
            }

            animateParticles(particleId) {
                const particleSystem = this.particles.get(particleId);
                if (!particleSystem) return;
                
                const { particles } = particleSystem;
                const now = Date.now();
                
                particles.forEach((particle, index) => {
                    const { element, vx, vy, life, born } = particle;
                    const age = now - born;
                    
                    if (age > life) {
                        element.remove();
                        particles.splice(index, 1);
                    } else {
                        const currentLeft = parseFloat(element.style.left) || 0;
                        const currentTop = parseFloat(element.style.top) || 0;
                        
                        element.style.left = `${currentLeft + vx}px`;
                        element.style.top = `${currentTop + vy}px`;
                        
                        const opacity = 1 - (age / life);
                        element.style.opacity = opacity;
                    }
                });
                
                if (particles.length > 0) {
                    requestAnimationFrame(() => this.animateParticles(particleId));
                } else {
                    this.particles.delete(particleId);
                }
            }

            createConfetti(options = {}) {
                const {
                    count = 100,
                    colors = ['#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', '#EF476F', '#FF9A00', '#00B4D8'],
                    origin = { x: window.innerWidth / 2, y: window.innerHeight / 2 }
                } = options;
                
                const confettiId = `confetti_${Date.now()}`;
                const confettiPieces = [];
                
                for (let i = 0; i < count; i++) {
                    const piece = document.createElement('div');
                    piece.className = 'confetti-piece';
                    
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    const size = Math.random() * 10 + 5;
                    const angle = Math.random() * Math.PI * 2;
                    const velocity = Math.random() * 5 + 2;
                    const rotationSpeed = (Math.random() - 0.5) * 20;
                    const life = Math.random() * 2000 + 3000;
                    
                    piece.style.cssText = `
                        position: fixed;
                        left: ${origin.x}px;
                        top: ${origin.y}px;
                        width: ${size}px;
                        height: ${size}px;
                        background: ${color};
                        opacity: 1;
                        border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
                        transform: rotate(${Math.random() * 360}deg);
                        z-index: 10000;
                        pointer-events: none;
                    `;
                    
                    document.body.appendChild(piece);
                    
                    confettiPieces.push({
                        element: piece,
                        vx: Math.cos(angle) * velocity,
                        vy: Math.sin(angle) * velocity - 5,
                        rotation: Math.random() * 360,
                        rotationSpeed,
                        life,
                        born: Date.now()
                    });
                }
                
                this.confettiSystems.set(confettiId, { pieces: confettiPieces, startTime: Date.now() });
                this.animateConfetti(confettiId);
                return confettiId;
            }

            animateConfetti(confettiId) {
                const confettiSystem = this.confettiSystems.get(confettiId);
                if (!confettiSystem) return;
                
                const { pieces } = confettiSystem;
                const now = Date.now();
                
                pieces.forEach((piece, index) => {
                    const { element, vx, vy, rotation, rotationSpeed, life, born } = piece;
                    const age = now - born;
                    
                    if (age > life) {
                        element.remove();
                        pieces.splice(index, 1);
                    } else {
                        const currentLeft = parseFloat(element.style.left) || 0;
                        const currentTop = parseFloat(element.style.top) || 0;
                        
                        element.style.left = `${currentLeft + vx}px`;
                        element.style.top = `${currentTop + vy}px`;
                        
                        const newRotation = rotation + rotationSpeed;
                        element.style.transform = `rotate(${newRotation}deg)`;
                        
                        const opacity = age > life - 1000 ? 1 - ((age - (life - 1000)) / 1000) : 1;
                        element.style.opacity = opacity;
                        
                        piece.rotation = newRotation;
                    }
                });
                
                if (pieces.length > 0) {
                    requestAnimationFrame(() => this.animateConfetti(confettiId));
                } else {
                    this.confettiSystems.delete(confettiId);
                }
            }

            celebrateSuccess(message = 'Успех!') {
                this.vibrate([50, 30, 50, 30, 50, 100, 50, 30, 50]);
                this.createConfetti({ count: 150 });
                this.createParticles({ count: 50 });
                this.showFloatingMessage(message, 'success');
                return true;
            }

            showFloatingMessage(text, type = 'info') {
                const message = document.createElement('div');
                message.className = `floating-message floating-${type}`;
                message.textContent = text;
                
                message.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%) translateY(-100px);
                    background: ${type === 'success' ? 'var(--success)' : 
                               type === 'error' ? 'var(--danger)' : 
                               type === 'warning' ? '#f59e0b' : 'var(--secondary)'};
                    color: white;
                    padding: 12px 24px;
                    border-radius: var(--radius);
                    box-shadow: var(--shadow-md);
                    z-index: 10001;
                    transition: transform 0.3s ease;
                    font-weight: 600;
                    white-space: nowrap;
                `;
                
                document.body.appendChild(message);
                
                setTimeout(() => {
                    message.style.transform = 'translateX(-50%) translateY(0)';
                }, 10);
                
                setTimeout(() => {
                    message.style.transform = 'translateX(-50%) translateY(-100px)';
                    setTimeout(() => {
                        message.remove();
                    }, 300);
                }, 3000);
            }
        }

        // ========== BEAVER AVATAR CLASS ==========
        class BeaverAvatar {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                if (!this.container) {
                    this.container = document.createElement('div');
                    this.container.id = 'beaverAvatar';
                    document.body.appendChild(this.container);
                }
                
                this.state = StateManager.getState();
                this.currentAnimation = 'idle';
                this.animations = {
                    idle: this.createIdleAnimation(),
                    happy: this.createHappyAnimation(),
                    working: this.createWorkingAnimation(),
                    sleeping: this.createSleepingAnimation(),
                    celebrating: this.createCelebratingAnimation()
                };
                
                this.equippedItems = {
                    hat: null,
                    tool: null,
                    accessory: null,
                    background: null
                };
                
                this.init();
            }

            init() {
                this.render();
                this.loadEquippedItems();
                this.startIdleAnimation();
            }

            render() {
                this.container.innerHTML = `
                    <div class="beaver-avatar-container">
                        <div class="beaver-background" id="beaverBackground"></div>
                        <div class="beaver-body">
                            <!-- Голова -->
                            <div class="beaver-head">
                                <div class="beaver-eyes">
                                    <div class="beaver-eye left"></div>
                                    <div class="beaver-eye right"></div>
                                </div>
                                <div class="beaver-nose"></div>
                                <div class="beaver-mouth"></div>
                            </div>
                            
                            <!-- Тело -->
                            <div class="beaver-torso"></div>
                            
                            <!-- Лапы -->
                            <div class="beaver-paws">
                                <div class="beaver-paw front left"></div>
                                <div class="beaver-paw front right"></div>
                                <div class="beaver-paw back left"></div>
                                <div class="beaver-paw back right"></div>
                            </div>
                            
                            <!-- Хвост -->
                            <div class="beaver-tail"></div>
                            
                            <!-- Слоты для экипировки -->
                            <div class="equipment-slot hat-slot" data-type="hat"></div>
                            <div class="equipment-slot tool-slot" data-type="tool"></div>
                            <div class="equipment-slot accessory-slot" data-type="accessory"></div>
                        </div>
                    </div>
                `;
                
                // Получаем DOM элементы
                this.elements = {
                    container: this.container.querySelector('.beaver-avatar-container'),
                    background: this.container.querySelector('#beaverBackground'),
                    head: this.container.querySelector('.beaver-head'),
                    eyes: this.container.querySelectorAll('.beaver-eye'),
                    nose: this.container.querySelector('.beaver-nose'),
                    mouth: this.container.querySelector('.beaver-mouth'),
                    torso: this.container.querySelector('.beaver-torso'),
                    paws: this.container.querySelectorAll('.beaver-paw'),
                    tail: this.container.querySelector('.beaver-tail'),
                    hatSlot: this.container.querySelector('.hat-slot'),
                    toolSlot: this.container.querySelector('.tool-slot'),
                    accessorySlot: this.container.querySelector('.accessory-slot')
                };
            }

            loadEquippedItems() {
                const { equipped } = this.state.user;
                
                // Загружаем надетые предметы
                Object.entries(equipped).forEach(([type, itemId]) => {
                    if (itemId) {
                        this.equipItem(type, itemId);
                    }
                });
            }

            equipItem(type, itemId) {
                let item = SHOP_ITEMS.find(i => i.id === itemId);
                if (!item && typeof UNIQUE_ITEMS !== 'undefined') {
                    item = UNIQUE_ITEMS.find(i => i.id === itemId);
                }
                if (!item) return;
                
                // Сохраняем в состоянии
                this.equippedItems[type] = item;
                
                // Визуализируем предмет
                this.renderItem(type, item);
                
                // Запускаем анимацию экипировки
                this.playEquipAnimation();
            }

            unequipItem(type) {
                this.equippedItems[type] = null;
                this.clearItemSlot(type);
            }

            renderItem(type, item) {
                const slot = this.elements[`${type}Slot`];
                if (!slot) return;
                
                slot.innerHTML = `
                    <div class="equipped-item" data-item-id="${item.id}">
                        <div class="item-emoji">${item.emoji}</div>
                    </div>
                `;
                
                // Добавляем анимацию в зависимости от типа предмета
                switch (type) {
                    case 'hat':
                        this.animateHat(item);
                        break;
                    case 'tool':
                        this.animateTool(item);
                        break;
                    case 'accessory':
                        this.animateAccessory(item);
                        break;
                }
            }

            clearItemSlot(type) {
                const slot = this.elements[`${type}Slot`];
                if (slot) {
                    slot.innerHTML = '';
                }
            }

            animateHat(item) {
                // Анимация шляпы (покачивание)
                const hat = this.elements.hatSlot.querySelector('.equipped-item');
                if (hat) {
                    hat.style.animation = 'hatWobble 3s infinite';
                }
            }

            animateTool(item) {
                // Анимация инструмента (мерцание)
                const tool = this.elements.toolSlot.querySelector('.equipped-item');
                if (tool) {
                    tool.style.animation = 'toolShine 2s infinite';
                }
            }

            animateAccessory(item) {
                // Анимация аксессуара (вращение)
                const accessory = this.elements.accessorySlot.querySelector('.equipped-item');
                if (accessory) {
                    accessory.style.animation = 'accessorySpin 5s infinite linear';
                }
            }

            playEquipAnimation() {
                // Анимация при экипировке предмета
                this.elements.container.classList.add('equip-animation');
                setTimeout(() => {
                    this.elements.container.classList.remove('equip-animation');
                }, 500);
            }

            setAnimation(animationName) {
                if (this.currentAnimation === animationName) return;
                
                // Останавливаем текущую анимацию
                this.stopCurrentAnimation();
                
                // Устанавливаем новую анимацию
                this.currentAnimation = animationName;
                const animation = this.animations[animationName];
                
                if (animation) {
                    animation.start();
                }
            }

            startIdleAnimation() {
                this.setAnimation('idle');
            }

            createIdleAnimation() {
                return {
                    start: () => {
                        // Медленное покачивание
                        this.elements.container.style.animation = 'idleBreath 3s infinite ease-in-out';
                        
                        // Моргание глаз
                        this.startBlinking();
                    },
                    stop: () => {
                        this.stopBlinking();
                        this.elements.container.style.animation = '';
                    }
                };
            }

            createHappyAnimation() {
                return {
                    start: () => {
                        // Подпрыгивание от радости
                        this.elements.container.style.animation = 'happyJump 1s infinite';
                        
                        // Сияющие глаза
                        this.elements.eyes.forEach(eye => {
                            eye.style.animation = 'eyeSparkle 2s infinite';
                        });
                    },
                    stop: () => {
                        this.elements.container.style.animation = '';
                        this.elements.eyes.forEach(eye => {
                            eye.style.animation = '';
                        });
                    }
                };
            }

            createWorkingAnimation() {
                return {
                    start: () => {
                        // Анимация работы с инструментом
                        if (this.equippedItems.tool) {
                            this.elements.toolSlot.style.animation = 'toolWorking 0.5s infinite';
                        }
                        
                        // Концентрированный взгляд
                        this.elements.eyes.forEach(eye => {
                            eye.style.transform = 'scale(0.8)';
                        });
                    },
                    stop: () => {
                        this.elements.toolSlot.style.animation = '';
                        this.elements.eyes.forEach(eye => {
                            eye.style.transform = '';
                        });
                    }
                };
            }

            createSleepingAnimation() {
                return {
                    start: () => {
                        // Наклон головы
                        this.elements.head.style.transform = 'rotate(10deg)';
                        
                        // Закрытые глаза
                        this.elements.eyes.forEach(eye => {
                            eye.style.height = '2px';
                        });
                        
                        // Пузырики сна
                        this.startSleepBubbles();
                    },
                    stop: () => {
                        this.elements.head.style.transform = '';
                        this.elements.eyes.forEach(eye => {
                            eye.style.height = '';
                        });
                        this.stopSleepBubbles();
                    }
                };
            }

            createCelebratingAnimation() {
                return {
                    start: () => {
                        // Танцующая анимация
                        this.elements.container.style.animation = 'celebrateDance 1s infinite';
                        
                        // Конфетти вокруг
                        this.startCelebrationConfetti();
                    },
                    stop: () => {
                        this.elements.container.style.animation = '';
                        this.stopCelebrationConfetti();
                    }
                };
            }

            startBlinking() {
                this.blinkInterval = setInterval(() => {
                    this.elements.eyes.forEach(eye => {
                        eye.style.height = '2px';
                        setTimeout(() => {
                            eye.style.height = '';
                        }, 200);
                    });
                }, 3000);
            }

            stopBlinking() {
                if (this.blinkInterval) {
                    clearInterval(this.blinkInterval);
                }
            }

            startSleepBubbles() {
                this.sleepBubbleInterval = setInterval(() => {
                    const bubble = document.createElement('div');
                    bubble.className = 'sleep-bubble';
                    bubble.style.left = `${Math.random() * 100}%`;
                    this.elements.container.appendChild(bubble);
                    
                    setTimeout(() => {
                        bubble.remove();
                    }, 2000);
                }, 1000);
            }

            stopSleepBubbles() {
                if (this.sleepBubbleInterval) {
                    clearInterval(this.sleepBubbleInterval);
                }
            }

            startCelebrationConfetti() {
                this.confettiInterval = setInterval(() => {
                    if (Math.random() > 0.7) {
                        window.animationManager.createParticles({
                            count: 5,
                            element: this.elements.container,
                            x: this.elements.container.offsetWidth / 2,
                            y: this.elements.container.offsetHeight / 2,
                            colors: ['#FFD700', '#FF6B6B', '#4ECDC4'],
                            size: { min: 3, max: 6 },
                            speed: { min: 1, max: 3 },
                            life: { min: 500, max: 1000 }
                        });
                    }
                }, 300);
            }

            stopCelebrationConfetti() {
                if (this.confettiInterval) {
                    clearInterval(this.confettiInterval);
                }
            }

            stopCurrentAnimation() {
                const currentAnim = this.animations[this.currentAnimation];
                if (currentAnim) {
                    currentAnim.stop();
                }
            }

            // Реакции на события
            onHabitCompleted() {
                this.setAnimation('celebrating');
                setTimeout(() => {
                    this.setAnimation('idle');
                }, 2000);
            }

            onDayCompleted() {
                this.setAnimation('happy');
                setTimeout(() => {
                    this.setAnimation('sleeping');
                }, 3000);
            }

            onQuestCompleted() {
                this.setAnimation('celebrating');
                setTimeout(() => {
                    this.setAnimation('happy');
                }, 3000);
            }

            onLowEnergy() {
                this.setAnimation('sleeping');
            }
        }

        // ========== ENHANCED SHOP CLASS ==========
        class EnhancedShop {
            constructor() {
                this.items = SHOP_ITEMS;
                this.categories = ['hat', 'tool', 'accessory', 'background', 'special'];
                this.currentCategory = 'all';
                this.selectedItem = null;
                this.beaverAvatar = null;
                
                this.init();
            }

            init() {
                // Инициализируем аватар бобра, если контейнер существует
                const avatarContainer = document.getElementById('beaverAvatar');
                if (avatarContainer) {
                    this.beaverAvatar = new BeaverAvatar('beaverAvatar');
                }
            }

            renderShop() {
                return `
                    <div class="shop-container">
                        <div class="shop-header">
                            <h3>🛒 Магазин бобра</h3>
                            <div class="shop-balance">
                                <div class="balance-display">
                                    <span class="balance-emoji">🪙</span>
                                    <span id="shopCoins">${StateManager.getState().user.coins}</span>
                                </div>
                                <button class="btn btn-small btn-secondary" onclick="window.enhancedShop.showEarnCoinsModal()">
                                    + Получить монеты
                                </button>
                            </div>
                        </div>
                        
                        <div class="shop-categories">
                            ${this.renderCategoryTabs()}
                        </div>
                        
                        <div class="shop-items">
                            ${this.renderItemsGrid()}
                        </div>
                        
                        <div class="shop-preview">
                            <h4>Примерка</h4>
                            <div id="beaverAvatar" class="beaver-preview"></div>
                            <div class="preview-controls">
                                <button class="btn btn-secondary" onclick="window.enhancedShop.resetPreview()">
                                    Сбросить
                                </button>
                                <button class="btn btn-primary" onclick="window.enhancedShop.buySelectedItem()" id="buyBtn" disabled>
                                    Купить
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderCategoryTabs() {
                const categories = [
                    { id: 'all', name: 'Все', emoji: '📦' },
                    { id: 'hat', name: 'Головные уборы', emoji: '🎩' },
                    { id: 'tool', name: 'Инструменты', emoji: '🔨' },
                    { id: 'accessory', name: 'Аксессуары', emoji: '👓' },
                    { id: 'background', name: 'Фоны', emoji: '🎨' },
                    { id: 'special', name: 'Особые', emoji: '⭐' }
                ];
                
                return categories.map(cat => `
                    <button class="shop-category ${this.currentCategory === cat.id ? 'active' : ''}"
                            onclick="window.enhancedShop.setCategory('${cat.id}')">
                        <span class="category-emoji">${cat.emoji}</span>
                        <span class="category-name">${cat.name}</span>
                    </button>
                `).join('');
            }

            renderItemsGrid() {
                const filteredItems = this.currentCategory === 'all' 
                    ? this.items 
                    : this.items.filter(item => item.type === this.currentCategory);
                
                const state = StateManager.getState();
                
                return `
                    <div class="items-grid">
                        ${filteredItems.map(item => {
                            const owned = state.inventory.some(i => i.id === item.id);
                            const equipped = state.user.equipped[item.type] === item.id;
                            const canAfford = state.user.coins >= item.price;
                            
                            return `
                                <div class="shop-item-card ${owned ? 'owned' : ''} ${equipped ? 'equipped' : ''} 
                                            ${this.selectedItem?.id === item.id ? 'selected' : ''}"
                                     onclick="window.enhancedShop.selectItem('${item.id}')">
                                    <div class="item-header">
                                        <div class="item-emoji">${item.emoji}</div>
                                        ${owned ? '<div class="item-badge owned">✓</div>' : ''}
                                        ${equipped ? '<div class="item-badge equipped">★</div>' : ''}
                                    </div>
                                    
                                    <div class="item-content">
                                        <h4>${item.name}</h4>
                                        <div class="item-price">
                                            <span class="price-emoji">🪙</span>
                                            <span class="price-value ${!canAfford && !owned ? 'insufficient' : ''}">
                                                ${item.price}
                                            </span>
                                        </div>
                                        <div class="item-type">${this.getItemTypeLabel(item.type)}</div>
                                    </div>
                                    
                                    <div class="item-actions">
                                        ${this.renderItemActions(item, owned, equipped, canAfford)}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            renderItemActions(item, owned, equipped, canAfford) {
                if (owned) {
                    if (equipped) {
                        return `
                            <button class="btn btn-small btn-secondary" onclick="window.enhancedShop.unequipItem('${item.type}')">
                                Снять
                            </button>
                        `;
                    } else {
                        return `
                            <button class="btn btn-small btn-primary" onclick="window.enhancedShop.equipItem('${item.id}', '${item.type}')">
                                Надеть
                            </button>
                        `;
                    }
                } else {
                    return `
                        <button class="btn btn-small btn-primary" 
                                onclick="window.enhancedShop.buyItem('${item.id}')"
                                ${canAfford ? '' : 'disabled'}>
                            Купить
                        </button>
                    `;
                }
            }

            getItemTypeLabel(type) {
                const labels = {
                    hat: 'Головной убор',
                    tool: 'Инструмент',
                    accessory: 'Аксессуар',
                    background: 'Фон',
                    special: 'Особый'
                };
                return labels[type] || type;
            }

            setCategory(category) {
                this.currentCategory = category;
                this.updateShopView();
            }

            selectItem(itemId) {
                const item = this.items.find(i => i.id === itemId);
                if (!item) return;
                
                this.selectedItem = item;
                
                // Обновляем выделение
                document.querySelectorAll('.shop-item-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                const selectedCard = document.querySelector(`[onclick*="${itemId}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }
                
                // Включаем кнопку покупки, если предмет не куплен
                const state = StateManager.getState();
                const owned = state.inventory.some(i => i.id === itemId);
                const canAfford = state.user.coins >= item.price;
                
                const buyBtn = document.getElementById('buyBtn');
                if (buyBtn) {
                    buyBtn.disabled = owned || !canAfford;
                    buyBtn.textContent = owned ? 'Уже куплено' : 'Купить';
                }
                
                // Примеряем предмет
                this.previewItem(item);
            }

            previewItem(item) {
                if (!this.beaverAvatar) {
                    this.beaverAvatar = new BeaverAvatar('beaverAvatar');
                }
                
                // Временно экипируем предмет для примерки
                this.beaverAvatar.equipItem(item.type, item.id);
                
                // Показываем информацию о предмете
                this.showItemPreviewInfo(item);
            }

            showItemPreviewInfo(item) {
                const previewInfo = document.querySelector('.item-preview-info');
                if (!previewInfo) return;
                
                const state = StateManager.getState();
                const owned = state.inventory.some(i => i.id === item.id);
                
                previewInfo.innerHTML = `
                    <h4>${item.emoji} ${item.name}</h4>
                    <p>Тип: ${this.getItemTypeLabel(item.type)}</p>
                    <p>Цена: 🪙 ${item.price}</p>
                    <p>${owned ? '✅ Уже в инвентаре' : '❌ Не куплено'}</p>
                    <div class="item-effects">
                        <h5>Эффекты:</h5>
                        <ul>
                            ${this.getItemEffects(item).map(effect => `<li>${effect}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            getItemEffects(item) {
                const effects = {
                    hat1: ['+5% к опыту', 'Особый вид в профиле'],
                    hat2: ['+10% к монетам', 'Уникальная анимация'],
                    tool1: ['Ускорение выполнения привычек', 'Особые звуки'],
                    tool2: ['Дополнительные монеты за квесты', 'Анимация при работе'],
                    acc1: ['+1 к максимальной энергии', 'Специальные реакции бобра'],
                    acc2: ['Удвоение стрика', 'Эксклюзивные фразы']
                };
                
                return effects[item.id] || ['Уникальный внешний вид', 'Особые анимации'];
            }

            resetPreview() {
                // Сбрасываем примерку и показываем текущую экипировку
                if (this.beaverAvatar) {
                    this.beaverAvatar.loadEquippedItems();
                }
                
                this.selectedItem = null;
                document.querySelectorAll('.shop-item-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                const buyBtn = document.getElementById('buyBtn');
                if (buyBtn) {
                    buyBtn.disabled = true;
                }
            }

            async buyItem(itemId) {
                const item = this.items.find(i => i.id === itemId);
                if (!item) return;
                
                const state = StateManager.getState();
                
                // Проверяем, куплен ли уже предмет
                if (state.inventory.some(i => i.id === itemId)) {
                    window.animationManager.showFloatingMessage('Уже куплено!', 'info');
                    return;
                }
                
                // Проверяем достаточно ли монет
                if (state.user.coins < item.price) {
                    window.animationManager.showFloatingMessage('Недостаточно монет!', 'error');
                    window.animationManager.vibrateError();
                    return;
                }
                
                // Покупка
                state.user.coins -= item.price;
                state.inventory.push(item);
                
                // Автоматически экипируем, если слот пустой
                if (!state.user.equipped[item.type]) {
                    state.user.equipped[item.type] = itemId;
                    if (this.beaverAvatar) {
                        this.beaverAvatar.equipItem(item.type, itemId);
                    }
                }
                
                StateManager.saveState(state);
                
                // Анимация и уведомление
                window.animationManager.celebrateSuccess(`Куплено: ${item.name}!`);
                window.animationManager.vibrateSuccess();
                
                // Обновляем UI
                this.updateShopView();
                
                // Показываем модальное окно с поздравлением
                this.showPurchaseSuccessModal(item);
            }

            async equipItem(itemId, type) {
                const state = StateManager.getState();
                
                // Проверяем, есть ли предмет в инвентаре
                if (!state.inventory.some(i => i.id === itemId)) {
                    window.animationManager.showFloatingMessage('Сначала купите предмет!', 'error');
                    return;
                }
                
                // Экипируем
                state.user.equipped[type] = itemId;
                StateManager.saveState(state);
                
                // Обновляем аватар
                if (this.beaverAvatar) {
                    this.beaverAvatar.equipItem(type, itemId);
                }
                
                // Анимация
                window.animationManager.showFloatingMessage('Предмет надет!', 'success');
                window.animationManager.vibrateSuccess();
                
                // Обновляем UI
                this.updateShopView();
            }

            async unequipItem(type) {
                const state = StateManager.getState();
                state.user.equipped[type] = null;
                StateManager.saveState(state);
                
                // Обновляем аватар
                if (this.beaverAvatar) {
                    this.beaverAvatar.unequipItem(type);
                }
                
                window.animationManager.showFloatingMessage('Предмет снят', 'info');
                this.updateShopView();
            }

            buySelectedItem() {
                if (this.selectedItem) {
                    this.buyItem(this.selectedItem.id);
                }
            }

            updateShopView() {
                // Обновляем баланс
                const coinsElement = document.getElementById('shopCoins');
                if (coinsElement) {
                    coinsElement.textContent = StateManager.getState().user.coins;
                }
                
                // Перерисовываем сетку предметов
                const itemsGrid = document.querySelector('.items-grid');
                if (itemsGrid) {
                    itemsGrid.innerHTML = this.renderItemsGrid();
                }
            }

            showPurchaseSuccessModal(item) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal purchase-success-modal">
                        <div class="modal-content">
                            <div class="success-animation">
                                <div class="success-emoji">🎉</div>
                                <div class="confetti-container"></div>
                            </div>
                            
                            <h3 class="text-center">Поздравляем с покупкой!</h3>
                            <p class="text-center">Вы приобрели: <strong>${item.emoji} ${item.name}</strong></p>
                            
                            <div class="purchase-details">
                                <div class="detail-item">
                                    <div class="detail-label">Тип:</div>
                                    <div class="detail-value">${this.getItemTypeLabel(item.type)}</div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-label">Эффекты:</div>
                                    <div class="detail-value">
                                        <ul>
                                            ${this.getItemEffects(item).map(effect => `<li>${effect}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="purchase-tip">
                                <p>💡 <em>Предмет автоматически экипирован. Вы можете сменить его в любой момент.</em></p>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">
                                Отлично!
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Добавляем конфетти
                window.animationManager.createConfetti({
                    count: 100,
                    origin: { x: window.innerWidth / 2, y: 100 }
                });
                
                // Автозакрытие через 5 секунд
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 5000);
            }

            showEarnCoinsModal() {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal earn-coins-modal">
                        <div class="modal-header">
                            <h3>Получить монеты</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        
                        <div class="modal-content">
                            <div class="earn-methods">
                                <div class="earn-method">
                                    <div class="method-icon">🎯</div>
                                    <div class="method-content">
                                        <h4>Выполнять привычки</h4>
                                        <p>+5 монет за каждую привычку</p>
                                        <div class="method-reward">🪙 +5/привычка</div>
                                    </div>
                                </div>
                                
                                <div class="earn-method">
                                    <div class="method-icon">📅</div>
                                    <div class="method-content">
                                        <h4>Закрывать дни</h4>
                                        <p>Бонус за ежедневное выполнение</p>
                                        <div class="method-reward">🪙 +20-100/день</div>
                                    </div>
                                </div>
                                
                                <div class="earn-method">
                                    <div class="method-icon">🏆</div>
                                    <div class="method-content">
                                        <h4>Выполнять квесты</h4>
                                        <p>Особые награды за задания</p>
                                        <div class="method-reward">🪙 +50-200/квест</div>
                                    </div>
                                </div>
                                
                                <div class="earn-method">
                                    <div class="method-icon">👥</div>
                                    <div class="method-content">
                                        <h4>Приглашать друзей</h4>
                                        <p>Получай монеты за каждого друга</p>
                                        <div class="method-reward">🪙 +100/друг</div>
                                    </div>
                                </div>
                                
                                <div class="earn-method">
                                    <div class="method-icon">⭐</div>
                                    <div class="method-content">
                                        <h4>Повышать уровень</h4>
                                        <p>Награды за новый уровень</p>
                                        <div class="method-reward">🪙 +500/уровень</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="earn-tips">
                                <h4>Советы по заработку:</h4>
                                <ul>
                                    <li>Выполняйте все ежедневные привычки</li>
                                    <li>Не прерывайте серии дней (стрики)</li>
                                    <li>Участвуйте в специальных событиях</li>
                                    <li>Приглашайте друзей в приложение</li>
                                    <li>Выполняйте дополнительные квесты</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">
                                Понятно
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
        }

        // ========== ADVENTURE SYSTEM CLASS ==========
        class AdventureSystem {
            constructor() {
                this.adventures = [];
                this.activeAdventure = null;
                this.adventureProgress = new Map();
                this.energy = 100;
                this.maxEnergy = 100;
                this.energyRegenRate = 10; // Энергия в час
                this.lastEnergyUpdate = Date.now();
                
                // Типы вылазок
                this.adventureTypes = {
                    short: {
                        name: 'Короткая вылазка',
                        duration: 300, // 5 минут
                        energy: 10,
                        reward: { coins: 20, xp: 10, items: [] }
                    },
                    medium: {
                        name: 'Средняя вылазка',
                        duration: 1800, // 30 минут
                        energy: 30,
                        reward: { coins: 50, xp: 25, items: ['wood_chip'] }
                    },
                    long: {
                        name: 'Длинная вылазка',
                        duration: 7200, // 2 часа
                        energy: 60,
                        reward: { coins: 100, xp: 50, items: ['rare_wood', 'tool_part'] }
                    },
                    expedition: {
                        name: 'Экспедиция',
                        duration: 21600, // 6 часов
                        energy: 90,
                        reward: { coins: 200, xp: 100, items: ['special_item', 'blueprint'] }
                    }
                };
                
                // Локации для вылазок
                this.locations = [
                    {
                        id: 'forest',
                        name: 'Тайный лес',
                        emoji: '🌲',
                        description: 'Густой лес с древними деревьями',
                        difficulty: 1,
                        events: ['find_berries', 'meet_squirrel', 'discover_stream'],
                        color: '#10b981'
                    },
                    {
                        id: 'river',
                        name: 'Быстрая река',
                        emoji: '🌊',
                        description: 'Бурная река с кристально чистой водой',
                        difficulty: 2,
                        events: ['catch_fish', 'build_bridge', 'find_waterfall'],
                        color: '#3b82f6'
                    },
                    {
                        id: 'mountain',
                        name: 'Высокие горы',
                        emoji: '⛰️',
                        description: 'Скалистые вершины с прекрасным видом',
                        difficulty: 3,
                        events: ['climb_cliff', 'find_cave', 'meet_eagle'],
                        color: '#8b5cf6'
                    },
                    {
                        id: 'meadow',
                        name: 'Цветущий луг',
                        emoji: '🌼',
                        description: 'Просторный луг с полевыми цветами',
                        difficulty: 1,
                        events: ['collect_flowers', 'help_deer', 'find_herbs'],
                        color: '#f59e0b'
                    },
                    {
                        id: 'swamp',
                        name: 'Таинственное болото',
                        emoji: '🐊',
                        description: 'Загадочное болото с редкими растениями',
                        difficulty: 2,
                        events: ['find_mushrooms', 'avoid_alligator', 'discover_ruins'],
                        color: '#6366f1'
                    }
                ];
                
                // События во время вылазок
                this.events = {
                    find_berries: {
                        name: 'Нашел ягоды!',
                        emoji: '🍓',
                        effect: { energy: 5, coins: 5 },
                        message: 'Ты нашел вкусные лесные ягоды!'
                    },
                    meet_squirrel: {
                        name: 'Встретил белку',
                        emoji: '🐿️',
                        effect: { xp: 10 },
                        message: 'Белка показала тебе короткий путь!'
                    },
                    discover_stream: {
                        name: 'Нашел ручей',
                        emoji: '💧',
                        effect: { energy: 10 },
                        message: 'Прохладная вода восстановила твои силы!'
                    },
                    catch_fish: {
                        name: 'Поймал рыбу',
                        emoji: '🐟',
                        effect: { coins: 15, items: ['fish'] },
                        message: 'Отличный улов! Этой рыбой можно торговать.'
                    },
                    build_bridge: {
                        name: 'Построил мост',
                        emoji: '🌉',
                        effect: { xp: 20 },
                        message: 'Ты помог другим животным перебраться через реку!'
                    },
                    find_waterfall: {
                        name: 'Нашел водопад',
                        emoji: '🌈',
                        effect: { coins: 25, xp: 15 },
                        message: 'Водопад скрывал небольшую пещеру с сокровищами!'
                    }
                };
                
                this.init();
            }

            init() {
                // Загружаем сохраненные вылазки
                this.loadAdventures();
                
                // Восстанавливаем энергию
                this.updateEnergy();
                
                // Запускаем таймер обновления
                this.startUpdateTimer();
                
                console.log('AdventureSystem инициализирован');
            }

            loadAdventures() {
                const state = StateManager.getState();
                this.adventures = state.adventures || [];
                this.activeAdventure = state.activeAdventure || null;
                this.adventureProgress = new Map(state.adventureProgress || []);
                this.energy = state.user.energy || 100;
                this.maxEnergy = state.user.maxEnergy || 100;
            }

            saveAdventures() {
                const state = StateManager.getState();
                state.adventures = this.adventures;
                state.activeAdventure = this.activeAdventure;
                state.adventureProgress = Array.from(this.adventureProgress.entries());
                state.user.energy = this.energy;
                state.user.maxEnergy = this.maxEnergy;
                StateManager.saveState(state);
            }

            updateEnergy() {
                const now = Date.now();
                const hoursPassed = (now - this.lastEnergyUpdate) / (1000 * 60 * 60);
                
                // Восстанавливаем энергию
                const energyGain = Math.floor(hoursPassed * this.energyRegenRate);
                this.energy = Math.min(this.maxEnergy, this.energy + energyGain);
                
                this.lastEnergyUpdate = now;
                this.saveAdventures();
            }

            startUpdateTimer() {
                // Обновляем каждую минуту
                setInterval(() => {
                    this.updateEnergy();
                    this.updateActiveAdventures();
                }, 60000);
            }

            renderAdventureMenu() {
                return `
                    <div class="adventure-menu">
                        <div class="adventure-header">
                            <h3>🌲 Вылазки</h3>
                            <div class="energy-display">
                                <div class="energy-bar">
                                    <div class="energy-fill" style="width: ${(this.energy / this.maxEnergy) * 100}%"></div>
                                </div>
                                <div class="energy-text">
                                    <span class="energy-emoji">⚡</span>
                                    <span>${this.energy}/${this.maxEnergy}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${this.renderActiveAdventure()}
                        
                        <div class="adventure-types">
                            <h4>Выбери вылазку:</h4>
                            ${this.renderAdventureOptions()}
                        </div>
                        
                        <div class="adventure-locations">
                            <h4>Локации:</h4>
                            <div class="locations-grid">
                                ${this.renderLocations()}
                            </div>
                        </div>
                        
                        <div class="adventure-history">
                            <h4>История вылазок:</h4>
                            ${this.renderAdventureHistory()}
                        </div>
                    </div>
                `;
            }

            renderActiveAdventure() {
                if (!this.activeAdventure) {
                    return `
                        <div class="active-adventure empty">
                            <div class="empty-state">
                                <div class="empty-state-icon">🌲</div>
                                <p>Нет активных вылазок</p>
                                <p class="text-muted">Выбери вылазку ниже, чтобы начать приключение!</p>
                            </div>
                        </div>
                    `;
                }
                
                const adventure = this.activeAdventure;
                const progress = this.adventureProgress.get(adventure.id) || 0;
                const percentage = (progress / adventure.duration) * 100;
                const timeLeft = adventure.duration - progress;
                
                // Форматируем оставшееся время
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;
                
                let timeDisplay = '';
                if (hours > 0) timeDisplay += `${hours}ч `;
                if (minutes > 0) timeDisplay += `${minutes}м `;
                timeDisplay += `${seconds}с`;
                
                return `
                    <div class="active-adventure">
                        <div class="adventure-info">
                            <div class="adventure-emoji">${adventure.emoji}</div>
                            <div class="adventure-details">
                                <h4>${adventure.name}</h4>
                                <p class="adventure-location">${adventure.locationName}</p>
                                <div class="adventure-time">
                                    <span class="time-emoji">⏱️</span>
                                    <span>${timeDisplay} осталось</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="adventure-progress">
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${percentage}%"></div>
                            </div>
                            <div class="progress-text">${Math.round(percentage)}%</div>
                        </div>
                        
                        <div class="adventure-events">
                            ${this.renderAdventureEvents()}
                        </div>
                        
                        <div class="adventure-controls">
                            <button class="btn btn-secondary" onclick="window.adventureSystem.cancelAdventure()">
                                Отменить
                            </button>
                            <button class="btn btn-primary" onclick="window.adventureSystem.speedUpAdventure()">
                                ⚡ Ускорить (10 монет)
                            </button>
                        </div>
                    </div>
                `;
            }

            renderAdventureEvents() {
                if (!this.activeAdventure || !this.activeAdventure.events) {
                    return '<p class="text-muted">События появятся во время вылазки...</p>';
                }
                
                return this.activeAdventure.events.map(event => `
                    <div class="adventure-event">
                        <div class="event-emoji">${event.emoji}</div>
                        <div class="event-details">
                            <div class="event-name">${event.name}</div>
                            <div class="event-message">${event.message}</div>
                        </div>
                    </div>
                `).join('');
            }

            renderAdventureOptions() {
                return Object.entries(this.adventureTypes).map(([type, data]) => `
                    <div class="adventure-option" data-type="${type}">
                        <div class="option-header">
                            <div class="option-emoji">${this.getAdventureEmoji(type)}</div>
                            <div class="option-title">${data.name}</div>
                        </div>
                        
                        <div class="option-details">
                            <div class="option-detail">
                                <span class="detail-emoji">⏱️</span>
                                <span>${this.formatDuration(data.duration)}</span>
                            </div>
                            
                            <div class="option-detail">
                                <span class="detail-emoji">⚡</span>
                                <span>${data.energy} энергии</span>
                            </div>
                            
                            <div class="option-detail">
                                <span class="detail-emoji">🪙</span>
                                <span>${data.reward.coins} монет</span>
                            </div>
                            
                            <div class="option-detail">
                                <span class="detail-emoji">⭐</span>
                                <span>${data.reward.xp} опыта</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary start-adventure-btn"
                                onclick="window.adventureSystem.startAdventure('${type}')"
                                ${this.energy < data.energy ? 'disabled' : ''}>
                            Начать вылазку
                        </button>
                    </div>
                `).join('');
            }

            renderLocations() {
                return this.locations.map(location => {
                    const progress = this.adventureProgress.get(`location_${location.id}`) || 0;
                    const unlocked = progress >= 10; // 10 вылазок для разблокировки
                    
                    return `
                        <div class="location-card ${unlocked ? 'unlocked' : 'locked'}" 
                             data-location="${location.id}">
                            <div class="location-header">
                                <div class="location-emoji">${location.emoji}</div>
                                <div class="location-status">
                                    ${unlocked ? '✅' : '🔒'}
                                </div>
                            </div>
                            
                            <div class="location-content">
                                <h5>${location.name}</h5>
                                <p class="location-desc">${location.description}</p>
                                
                                <div class="location-progress">
                                    <div class="progress-text">Прогресс: ${progress}/10</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${(progress / 10) * 100}%"></div>
                                    </div>
                                </div>
                                
                                <div class="location-difficulty">
                                    Сложность: ${'⭐'.repeat(location.difficulty)}
                                </div>
                                
                                ${unlocked ? `
                                    <div class="location-events">
                                        <small>События: ${location.events.map(e => this.events[e]?.emoji || '❓').join(' ')}</small>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${unlocked ? `
                                <button class="btn btn-small" onclick="window.adventureSystem.selectLocation('${location.id}')">
                                    Выбрать
                                </button>
                            ` : `
                                <button class="btn btn-small btn-secondary" disabled>
                                    Заблокировано
                                </button>
                            `}
                        </div>
                    `;
                }).join('');
            }

            renderAdventureHistory() {
                const completedAdventures = this.adventures.filter(a => a.completed);
                
                if (completedAdventures.length === 0) {
                    return '<p class="text-muted">Еще не завершено ни одной вылазки</p>';
                }
                
                // Показываем только последние 5 вылазок
                const recentAdventures = completedAdventures.slice(-5);
                
                return `
                    <div class="history-list">
                        ${recentAdventures.map(adventure => `
                            <div class="history-item">
                                <div class="history-emoji">${adventure.emoji}</div>
                                <div class="history-details">
                                    <div class="history-name">${adventure.name}</div>
                                    <div class="history-date">${this.formatDate(adventure.completedAt)}</div>
                                    <div class="history-rewards">
                                        <span class="reward-item">🪙 +${adventure.reward?.coins || 0}</span>
                                        <span class="reward-item">⭐ +${adventure.reward?.xp || 0}</span>
                                        ${adventure.reward?.items?.map(item => 
                                            `<span class="reward-item">${this.getItemEmoji(item)}</span>`
                                        ).join('') || ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            startAdventure(type) {
                const adventureType = this.adventureTypes[type];
                if (!adventureType) return;
                
                // Проверяем энергию
                if (this.energy < adventureType.energy) {
                    window.animationManager.showFloatingMessage('Недостаточно энергии!', 'error');
                    window.animationManager.vibrateError();
                    return;
                }
                
                // Выбираем случайную локацию
                const location = this.selectRandomLocation();
                if (!location) return;
                
                // Создаем вылазку
                const adventure = {
                    id: `adventure_${Date.now()}`,
                    type: type,
                    name: adventureType.name,
                    emoji: this.getAdventureEmoji(type),
                    location: location.id,
                    locationName: location.name,
                    duration: adventureType.duration,
                    energy: adventureType.energy,
                    reward: { ...adventureType.reward },
                    startedAt: Date.now(),
                    completed: false,
                    events: []
                };
                
                // Расходуем энергию
                this.energy -= adventureType.energy;
                
                // Сохраняем как активную вылазку
                this.activeAdventure = adventure;
                this.adventureProgress.set(adventure.id, 0);
                
                // Генерируем события
                this.generateAdventureEvents(adventure, location);
                
                // Сохраняем
                this.saveAdventures();
                
                // Анимация
                window.animationManager.showFloatingMessage('Вылазка началась!', 'success');
                window.animationManager.vibrateSuccess();
                
                // Обновляем UI
                this.updateAdventureUI();
                
                // Запускаем таймер прогресса
                this.startAdventureTimer(adventure.id);
                
                return adventure;
            }

            selectRandomLocation() {
                const availableLocations = this.locations.filter(location => {
                    const progress = this.adventureProgress.get(`location_${location.id}`) || 0;
                    return progress >= 10; // Разблокированные локации
                });
                
                if (availableLocations.length === 0) {
                    // Если нет разблокированных локаций, выбираем первую
                    return this.locations[0];
                }
                
                return availableLocations[Math.floor(Math.random() * availableLocations.length)];
            }

            generateAdventureEvents(adventure, location) {
                // Определяем количество событий в зависимости от длительности
                let eventCount;
                if (adventure.type === 'short') eventCount = 1;
                else if (adventure.type === 'medium') eventCount = 2;
                else if (adventure.type === 'long') eventCount = 3;
                else eventCount = 4;
                
                // Выбираем случайные события для локации
                const availableEvents = location.events;
                const selectedEvents = [];
                
                for (let i = 0; i < Math.min(eventCount, availableEvents.length); i++) {
                    const eventId = availableEvents[Math.floor(Math.random() * availableEvents.length)];
                    const event = this.events[eventId];
                    
                    if (event && !selectedEvents.some(e => e.id === eventId)) {
                        selectedEvents.push({
                            id: eventId,
                            name: event.name,
                            emoji: event.emoji,
                            message: event.message,
                            effect: event.effect,
                            triggered: false,
                            triggerTime: Math.floor(adventure.duration * (i + 1) / (eventCount + 1))
                        });
                    }
                }
                
                adventure.events = selectedEvents;
            }

            startAdventureTimer(adventureId) {
                const interval = setInterval(() => {
                    const progress = this.adventureProgress.get(adventureId) || 0;
                    const adventure = this.activeAdventure;
                    
                    if (!adventure || adventure.id !== adventureId) {
                        clearInterval(interval);
                        return;
                    }
                    
                    // Увеличиваем прогресс
                    const newProgress = progress + 1;
                    this.adventureProgress.set(adventureId, newProgress);
                    
                    // Проверяем события
                    this.checkAdventureEvents(adventure, newProgress);
                    
                    // Проверяем завершение
                    if (newProgress >= adventure.duration) {
                        clearInterval(interval);
                        this.completeAdventure(adventureId);
                    }
                    
                    // Обновляем UI каждые 10 секунд прогресса
                    if (newProgress % 10 === 0) {
                        this.updateAdventureUI();
                    }
                    
                }, 1000); // 1 секунда реального времени = 1 секунда в вылазке
            }

            checkAdventureEvents(adventure, progress) {
                if (!adventure.events) return;
                
                adventure.events.forEach(event => {
                    if (!event.triggered && progress >= event.triggerTime) {
                        // Триггерим событие
                        event.triggered = true;
                        event.triggeredAt = Date.now();
                        
                        // Применяем эффект
                        this.applyEventEffect(event.effect);
                        
                        // Показываем уведомление
                        this.showEventNotification(event);
                        
                        // Анимация
                        window.animationManager.createParticles({
                            count: 20,
                            x: window.innerWidth / 2,
                            y: window.innerHeight / 2,
                            colors: ['#FFD700', '#FF6B6B', '#4ECDC4'],
                            size: { min: 4, max: 8 }
                        });
                        
                        window.animationManager.vibrateSuccess();
                    }
                });
            }

            applyEventEffect(effect) {
                const state = StateManager.getState();
                
                if (effect.coins) {
                    state.user.coins += effect.coins;
                }
                
                if (effect.xp) {
                    state.user.xp += effect.xp;
                }
                
                if (effect.energy) {
                    this.energy = Math.min(this.maxEnergy, this.energy + effect.energy);
                }
                
                if (effect.items) {
                    effect.items.forEach(item => {
                        state.inventory.push({
                            id: item,
                            name: this.getItemName(item),
                            emoji: this.getItemEmoji(item),
                            type: 'adventure_item',
                            obtainedAt: new Date().toISOString()
                        });
                    });
                }
                
                StateManager.saveState(state);
            }

            showEventNotification(event) {
                const notification = document.createElement('div');
                notification.className = 'event-notification';
                notification.innerHTML = `
                    <div class="event-notification-content">
                        <div class="event-emoji">${event.emoji}</div>
                        <div class="event-text">
                            <div class="event-title">${event.name}</div>
                            <div class="event-message">${event.message}</div>
                        </div>
                    </div>
                `;
                
                // Позиционируем
                notification.style.position = 'fixed';
                notification.style.top = '80px';
                notification.style.right = '20px';
                notification.style.zIndex = '10001';
                
                document.body.appendChild(notification);
                
                // Анимация появления
                setTimeout(() => {
                    notification.classList.add('show');
                    
                    // Автоматическое скрытие
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 300);
                    }, 3000);
                }, 10);
            }

            completeAdventure(adventureId) {
                const adventure = this.activeAdventure;
                if (!adventure || adventure.id !== adventureId) return;
                
                // Отмечаем как завершенную
                adventure.completed = true;
                adventure.completedAt = new Date().toISOString();
                
                // Добавляем в историю
                this.adventures.push(adventure);
                
                // Награждаем пользователя
                this.giveAdventureReward(adventure);
                
                // Обновляем прогресс локации
                this.updateLocationProgress(adventure.location);
                
                // Очищаем активную вылазку
                this.activeAdventure = null;
                this.adventureProgress.delete(adventureId);
                
                // Сохраняем
                this.saveAdventures();
                
                // Анимация завершения
                this.showAdventureCompleteModal(adventure);
                
                // Обновляем UI
                this.updateAdventureUI();
                
                return adventure;
            }

            giveAdventureReward(adventure) {
                const state = StateManager.getState();
                
                // Основная награда
                state.user.coins += adventure.reward.coins;
                state.user.xp += adventure.reward.xp;
                
                // Дополнительные предметы
                if (adventure.reward.items && adventure.reward.items.length > 0) {
                    adventure.reward.items.forEach(item => {
                        state.inventory.push({
                            id: item,
                            name: this.getItemName(item),
                            emoji: this.getItemEmoji(item),
                            type: 'adventure_item',
                            obtainedAt: new Date().toISOString()
                        });
                    });
                }
                
                // Награды за события
                if (adventure.events) {
                    adventure.events.forEach(event => {
                        if (event.triggered && event.effect) {
                            if (event.effect.coins) {
                                state.user.coins += event.effect.coins;
                            }
                            if (event.effect.xp) {
                                state.user.xp += event.effect.xp;
                            }
                        }
                    });
                }
                
                StateManager.saveState(state);
            }

            updateLocationProgress(locationId) {
                const progressKey = `location_${locationId}`;
                const currentProgress = this.adventureProgress.get(progressKey) || 0;
                this.adventureProgress.set(progressKey, currentProgress + 1);
            }

            showAdventureCompleteModal(adventure) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal adventure-complete-modal">
                        <div class="modal-content">
                            <div class="completion-animation">
                                <div class="completion-emoji">🎉</div>
                                <div class="confetti-container"></div>
                            </div>
                            
                            <h3 class="text-center">Вылазка завершена!</h3>
                            <p class="text-center">${adventure.name} в ${adventure.locationName}</p>
                            
                            <div class="adventure-rewards">
                                <h4>Награды:</h4>
                                
                                <div class="rewards-grid">
                                    <div class="reward-item main">
                                        <div class="reward-emoji">🪙</div>
                                        <div class="reward-info">
                                            <div class="reward-amount">+${adventure.reward.coins}</div>
                                            <div class="reward-label">монет</div>
                                        </div>
                                    </div>
                                    
                                    <div class="reward-item main">
                                        <div class="reward-emoji">⭐</div>
                                        <div class="reward-info">
                                            <div class="reward-amount">+${adventure.reward.xp}</div>
                                            <div class="reward-label">опыта</div>
                                        </div>
                                    </div>
                                    
                                    ${adventure.reward.items?.map(item => `
                                        <div class="reward-item">
                                            <div class="reward-emoji">${this.getItemEmoji(item)}</div>
                                            <div class="reward-info">
                                                <div class="reward-amount">1</div>
                                                <div class="reward-label">${this.getItemName(item)}</div>
                                            </div>
                                        </div>
                                    `).join('') || ''}
                                    
                                    ${adventure.events?.filter(e => e.triggered).map(event => `
                                        <div class="reward-item event">
                                            <div class="reward-emoji">${event.emoji}</div>
                                            <div class="reward-info">
                                                <div class="reward-amount">+${event.effect?.coins || 0}🪙 +${event.effect?.xp || 0}⭐</div>
                                                <div class="reward-label">${event.name}</div>
                                            </div>
                                        </div>
                                    `).join('') || ''}
                                </div>
                            </div>
                            
                            <div class="location-progress-update">
                                <h4>Прогресс локации:</h4>
                                <div class="progress-update">
                                    <span class="location-emoji">${this.getLocationEmoji(adventure.location)}</span>
                                    <span>${adventure.locationName}</span>
                                    <span class="progress-text">+1 к прогрессу</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">
                                Отлично!
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Конфетти
                window.animationManager.createConfetti({
                    count: 150,
                    origin: { x: window.innerWidth / 2, y: 100 }
                });
                
                // Вибрация
                window.animationManager.vibrate([50, 30, 50, 30, 50, 100, 50, 30, 50]);
                
                // Автозакрытие через 5 секунд
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 5000);
            }

            cancelAdventure() {
                if (!this.activeAdventure) return;
                
                const confirm = window.confirm('Отменить вылазку? Вы потеряете потраченную энергию.');
                if (!confirm) return;
                
                // Возвращаем часть энергии (50%)
                const energyReturn = Math.floor(this.activeAdventure.energy * 0.5);
                this.energy = Math.min(this.maxEnergy, this.energy + energyReturn);
                
                // Очищаем активную вылазку
                const adventureId = this.activeAdventure.id;
                this.activeAdventure = null;
                this.adventureProgress.delete(adventureId);
                
                // Сохраняем
                this.saveAdventures();
                
                // Уведомление
                window.animationManager.showFloatingMessage(`Вылазка отменена. Возвращено ${energyReturn} энергии`, 'info');
                
                // Обновляем UI
                this.updateAdventureUI();
            }

            speedUpAdventure() {
                if (!this.activeAdventure) return;
                
                const state = StateManager.getState();
                const cost = 10; // 10 монет за ускорение
                
                if (state.user.coins < cost) {
                    window.animationManager.showFloatingMessage('Недостаточно монет!', 'error');
                    return;
                }
                
                // Списание монет
                state.user.coins -= cost;
                StateManager.saveState(state);
                
                // Ускоряем вылазку на 30 минут
                const currentProgress = this.adventureProgress.get(this.activeAdventure.id) || 0;
                const speedUpAmount = 1800; // 30 минут в секундах
                const newProgress = Math.min(this.activeAdventure.duration, currentProgress + speedUpAmount);
                
                this.adventureProgress.set(this.activeAdventure.id, newProgress);
                
                // Проверяем завершение
                if (newProgress >= this.activeAdventure.duration) {
                    this.completeAdventure(this.activeAdventure.id);
                }
                
                // Уведомление
                window.animationManager.showFloatingMessage('Вылазка ускорена на 30 минут!', 'success');
                window.animationManager.vibrateSuccess();
                
                // Обновляем UI
                this.updateAdventureUI();
            }

            updateActiveAdventures() {
                // Проверяем завершение активных вылазок
                if (this.activeAdventure) {
                    const progress = this.adventureProgress.get(this.activeAdventure.id) || 0;
                    
                    if (progress >= this.activeAdventure.duration) {
                        this.completeAdventure(this.activeAdventure.id);
                    }
                }
            }

            updateAdventureUI() {
                // Обновляем UI вылазок если открыта соответствующая страница
                const adventureContainer = document.querySelector('.adventure-menu');
                if (adventureContainer) {
                    // Можно добавить оптимизированное обновление только прогресса
                    const progressBar = adventureContainer.querySelector('.energy-fill');
                    if (progressBar) {
                        progressBar.style.width = `${(this.energy / this.maxEnergy) * 100}%`;
                    }
                    
                    const energyText = adventureContainer.querySelector('.energy-text span:last-child');
                    if (energyText) {
                        energyText.textContent = `${this.energy}/${this.maxEnergy}`;
                    }
                }
            }

            // Вспомогательные методы
            formatDuration(seconds) {
                if (seconds < 60) return `${seconds}с`;
                if (seconds < 3600) return `${Math.floor(seconds / 60)}м`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)}ч`;
                return `${Math.floor(seconds / 86400)}д`;
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            getAdventureEmoji(type) {
                const emojis = {
                    short: '🚶',
                    medium: '🚴',
                    long: '🏕️',
                    expedition: '🗺️'
                };
                return emojis[type] || '🌲';
            }

            getLocationEmoji(locationId) {
                const location = this.locations.find(l => l.id === locationId);
                return location?.emoji || '📍';
            }

            getItemEmoji(itemId) {
                const items = {
                    wood_chip: '🪵',
                    rare_wood: '🪴',
                    tool_part: '⚙️',
                    special_item: '💎',
                    blueprint: '📜',
                    fish: '🐟'
                };
                return items[itemId] || '🎁';
            }

            getItemName(itemId) {
                const names = {
                    wood_chip: 'Щепка',
                    rare_wood: 'Редкая древесина',
                    tool_part: 'Часть инструмента',
                    special_item: 'Особый предмет',
                    blueprint: 'Чертеж',
                    fish: 'Рыба'
                };
                return names[itemId] || 'Предмет';
            }

            selectLocation(locationId) {
                const location = this.locations.find(l => l.id === locationId);
                if (!location) return;
                
                // Показываем информацию о локации
                this.showLocationInfoModal(location);
            }

            showLocationInfoModal(location) {
                const progress = this.adventureProgress.get(`location_${location.id}`) || 0;
                const unlocked = progress >= 10;
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal location-info-modal">
                        <div class="modal-header">
                            <h3>
                                <span class="location-emoji">${location.emoji}</span>
                                ${location.name}
                            </h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        
                        <div class="modal-content">
                            <div class="location-description">
                                <p>${location.description}</p>
                            </div>
                            
                            <div class="location-stats">
                                <div class="stat-item">
                                    <div class="stat-label">Сложность:</div>
                                    <div class="stat-value">${'⭐'.repeat(location.difficulty)}</div>
                                </div>
                                
                                <div class="stat-item">
                                    <div class="stat-label">Прогресс:</div>
                                    <div class="stat-value">${progress}/10 вылазок</div>
                                </div>
                                
                                <div class="stat-item">
                                    <div class="stat-label">Статус:</div>
                                    <div class="stat-value">${unlocked ? '✅ Разблокировано' : '🔒 Заблокировано'}</div>
                                </div>
                            </div>
                            
                            <div class="location-events">
                                <h4>Возможные события:</h4>
                                <div class="events-grid">
                                    ${location.events.map(eventId => {
                                        const event = this.events[eventId];
                                        if (!event) return '';
                                        
                                        return `
                                            <div class="event-card">
                                                <div class="event-emoji">${event.emoji}</div>
                                                <div class="event-name">${event.name}</div>
                                                <div class="event-desc">${event.message}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            ${unlocked ? `
                                <div class="location-tips">
                                    <h4>💡 Советы для этой локации:</h4>
                                    <ul>
                                        <li>Выбирай средние или длинные вылазки для большего количества событий</li>
                                        <li>Ускорение вылазки может принести дополнительные награды</li>
                                        <li>Следи за энергией - некоторые события восстанавливают ее</li>
                                    </ul>
                                </div>
                            ` : `
                                <div class="location-locked">
                                    <h4>🔒 Чтобы разблокировать эту локацию:</h4>
                                    <p>Выполни 10 вылазок в других локациях. Осталось: ${10 - progress}</p>
                                    <div class="progress-container">
                                        <div class="progress-bar" style="width: ${(progress / 10) * 100}%"></div>
                                    </div>
                                </div>
                            `}
                        </div>
                        
                        <div class="modal-footer">
                            ${unlocked ? `
                                <button class="btn btn-primary" onclick="window.adventureSystem.startAdventureFromLocation('${location.id}')">
                                    Начать вылазку здесь
                                </button>
                            ` : ''}
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                                Закрыть
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            startAdventureFromLocation(locationId) {
                // Закрываем модальное окно
                document.querySelector('.modal-overlay')?.remove();
                
                // Показываем выбор типа вылазки для этой локации
                this.showAdventureTypeSelector(locationId);
            }

            showAdventureTypeSelector(locationId) {
                const location = this.locations.find(l => l.id === locationId);
                if (!location) return;
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal adventure-type-modal">
                        <div class="modal-header">
                            <h3>
                                <span class="location-emoji">${location.emoji}</span>
                                Выбери тип вылазки
                            </h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        
                        <div class="modal-content">
                            <div class="adventure-options">
                                ${Object.entries(this.adventureTypes).map(([type, data]) => {
                                    const canStart = this.energy >= data.energy;
                                    
                                    return `
                                        <div class="adventure-type-option ${canStart ? '' : 'disabled'}">
                                            <div class="type-header">
                                                <div class="type-emoji">${this.getAdventureEmoji(type)}</div>
                                                <div class="type-name">${data.name}</div>
                                            </div>
                                            
                                            <div class="type-details">
                                                <div class="type-detail">
                                                    <span>⏱️ ${this.formatDuration(data.duration)}</span>
                                                </div>
                                                <div class="type-detail">
                                                    <span>⚡ ${data.energy} энергии</span>
                                                </div>
                                                <div class="type-detail">
                                                    <span>🪙 ${data.reward.coins} монет</span>
                                                </div>
                                                <div class="type-detail">
                                                    <span>⭐ ${data.reward.xp} опыта</span>
                                                </div>
                                            </div>
                                            
                                            <button class="btn ${canStart ? 'btn-primary' : 'btn-secondary'}"
                                                    onclick="${canStart ? `window.adventureSystem.startLocationAdventure('${type}', '${locationId}')` : ''}"
                                                    ${!canStart ? 'disabled' : ''}>
                                                ${canStart ? 'Начать' : 'Недостаточно энергии'}
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            startLocationAdventure(type, locationId) {
                const adventureType = this.adventureTypes[type];
                const location = this.locations.find(l => l.id === locationId);
                
                if (!adventureType || !location) return;
                
                // Закрываем модальное окно
                document.querySelector('.modal-overlay')?.remove();
                
                // Создаем вылазку
                const adventure = {
                    id: `adventure_${Date.now()}`,
                    type: type,
                    name: adventureType.name,
                    emoji: this.getAdventureEmoji(type),
                    location: location.id,
                    locationName: location.name,
                    duration: adventureType.duration,
                    energy: adventureType.energy,
                    reward: { ...adventureType.reward },
                    startedAt: Date.now(),
                    completed: false,
                    events: []
                };
                
                // Расходуем энергию
                this.energy -= adventureType.energy;
                
                // Сохраняем как активную вылазку
                this.activeAdventure = adventure;
                this.adventureProgress.set(adventure.id, 0);
                
                // Генерируем события для этой локации
                this.generateAdventureEvents(adventure, location);
                
                // Сохраняем
                this.saveAdventures();
                
                // Анимация
                window.animationManager.showFloatingMessage(`Вылазка началась в ${location.name}!`, 'success');
                window.animationManager.vibrateSuccess();
                
                // Обновляем UI
                this.updateAdventureUI();
                
                // Запускаем таймер
                this.startAdventureTimer(adventure.id);
                
                return adventure;
            }
        }

        // ========== UI AND NAVIGATION ==========
        // Навигация и отображение страниц
        class UIManager {
            constructor() {
                this.currentPage = 'today';
                this.state = StateManager.getState();
                this.beaverAvatar = null;
                
                this.init();
            }

            init() {
                // Проверяем онбординг
                if (!this.state.onboarding.completed) {
                    this.showOnboarding();
                } else {
                    this.showApp();
                }
                
                // Настраиваем навигацию
                this.setupNavigation();
                
                // Загружаем начальную страницу
                this.loadPage(this.currentPage);
                
                // Обновляем UI состояния
                StateManager.updateUI();
            }

            showOnboarding() {
                document.getElementById('app').classList.add('hidden');

                // Создаём/переиспользуем оверлей онбординга
                let overlay = document.getElementById('onboardingOverlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'onboardingOverlay';
                    overlay.className = 'onboarding-screen';
                    overlay.innerHTML = `
                        <div class="onboarding-step" id="obStep1">
                            <div class="onboarding-avatar" id="obAvatar1">🦫</div>
                            <h2 id="obTitle1">Вы обнаружили дикого бобра</h2>
                            <p class="text-muted mb-2" id="obText1">Он растерян и напуган.</p>

                            <div class="tame-meter mb-2">
                                <div class="tame-bar">
                                    <div class="tame-fill" id="tameFill" style="width:0%"></div>
                                </div>
                                <div class="text-muted" id="tameLabel">Приручение: 0/5</div>
                            </div>

                            <button class="btn btn-primary btn-large" onclick="window.uiManager.onboardingTryTame()">
                                Попытаться приручить?
                            </button>
                        </div>

                        <div class="onboarding-step hidden" id="obStep2">
                            <div class="onboarding-avatar">🦫</div>
                            <h2>Как назовём твоего бобра?</h2>
                            <input type="text" id="obBeaverNameInput" class="form-input mt-2" placeholder="Бобрик">
                            <div class="onboarding-choices mt-2" id="obNameChoices">
                                <div class="onboarding-choice" onclick="window.uiManager.onboardingSetBeaverName('Бобрик')">Бобрик</div>
                                <div class="onboarding-choice" onclick="window.uiManager.onboardingSetBeaverName('Прораб')">Прораб</div>
                                <div class="onboarding-choice" onclick="window.uiManager.onboardingSetBeaverName('Плотник')">Плотник</div>
                                <div class="onboarding-choice" onclick="window.uiManager.onboardingSetBeaverName('Строитель')">Строитель</div>
                            </div>
                            <button class="btn btn-primary btn-large mt-2" onclick="window.uiManager.onboardingNextStep()">
                                Продолжить
                            </button>
                        </div>

                        <div class="onboarding-step hidden" id="obStep3">
                            <div class="onboarding-avatar">🪵</div>
                            <h2>Что будем строить?</h2>
                            <p class="text-muted">Выбери направление — и забери пару привычек для старта.</p>

                            <div class="onboarding-choices mt-2" id="obCategoryChoices"></div>

                            <div class="card mt-2" id="obSuggestedBox" style="display:none;">
                                <h3 style="margin-bottom: 8px;" id="obSuggestedTitle">Подсказки</h3>
                                <div class="habit-list" id="obSuggestedHabits"></div>
                                <button class="btn btn-secondary btn-large mt-2" onclick="window.uiManager.onboardingAddSuggestedHabits()">
                                    Добавить выбранные привычки
                                </button>
                                <p class="text-muted mt-1" id="obPickedCount"></p>
                            </div>

                            <button class="btn btn-primary btn-large mt-2" onclick="window.uiManager.onboardingNextStep()">
                                Дальше
                            </button>
                        </div>

                        <div class="onboarding-step hidden" id="obStep4">
                            <div class="onboarding-avatar">🎯</div>
                            <h2>Твоя первая победа!</h2>
                            <p>Отметь первую привычку — и бобр станет спокойнее 🙂</p>

                            <div class="habit-card mt-2" id="obFirstHabitCard">
                                <span class="habit-title" id="obFirstHabitTitle">Выпить стакан воды</span>
                                <button class="habit-toggle" id="obFirstHabitToggle" onclick="window.uiManager.onboardingCompleteFirstHabit()"></button>
                            </div>

                            <p class="text-muted mt-2" id="obFirstHint">Нажми на галочку, чтобы отметить выполнение</p>

                            <button class="btn btn-primary btn-large mt-2" onclick="window.uiManager.onboardingNextStep()">
                                Продолжить
                            </button>
                        </div>

                        <div class="onboarding-step hidden" id="obStep5">
                            <div class="onboarding-avatar">🎉</div>
                            <h2>Отлично, бригадир!</h2>
                            <p>Бобр уже доверяет тебе. Пора строить плотину каждый день.</p>
                            <div class="mt-2" style="font-size: 3rem;">🪙</div>
                            <p class="text-muted mt-2">Заглядывай ежедневно — бобр (${StateManager.getState().user.name || 'Бобрик'}) будет ждать.</p>
                            <button class="btn btn-primary btn-large mt-2" onclick="window.uiManager.completeOnboarding()">
                                Начать строить
                            </button>
                        </div>

                        <div class="mt-2">
                            <button class="btn btn-secondary" onclick="window.uiManager.onboardingPrevStep()" id="obPrevBtn" style="display:none;">← Назад</button>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                }

                // Инициализируем состояние онбординга
                this.onboardingTameTarget = 5;
                this.onboardingTameClicks = (this.state.onboarding && this.state.onboarding.tameClicks) ? this.state.onboarding.tameClicks : 0;
                this.onboardingCurrentCategory = null;
                this.onboardingSuggestedSelected = new Set();
                this.onboardingPickedHabitIds = new Set();

                // Заполняем категории и поле имени
                this.onboardingBuildCategoryChoices();
                const nameInput = document.getElementById('obBeaverNameInput');
                if (nameInput) {
                    nameInput.value = this.state.user.name || 'Бобрик';
                    nameInput.addEventListener('input', () => this.onboardingSetBeaverName(nameInput.value, true));
                }

                // Показать актуальный шаг
                const step = (this.state.onboarding && this.state.onboarding.step) ? this.state.onboarding.step : 1;
                this.onboardingShowStep(step);
            }

            onboardingShowStep(step) {
                const overlay = document.getElementById('onboardingOverlay');
                if (!overlay) return;

                // Скрываем все шаги
                overlay.querySelectorAll('.onboarding-step').forEach(el => el.classList.add('hidden'));
                const current = overlay.querySelector('#obStep' + step);
                if (current) current.classList.remove('hidden');

                // Назад
                const prevBtn = document.getElementById('obPrevBtn');
                if (prevBtn) prevBtn.style.display = step > 1 ? 'inline-block' : 'none';

                // Сохраняем шаг
                const state = StateManager.getState();
                state.onboarding.step = step;
                state.onboarding.tameClicks = this.onboardingTameClicks || 0;
                StateManager.saveState(state);

                // Обновляем прогресс приручения
                if (step === 1) this.onboardingUpdateTameUI();

                // При входе в шаг 4 — назначаем первую привычку
                if (step === 4) this.onboardingPrepareFirstHabit();

                // Подпись в шаге 5
                const step5Text = document.querySelector('#obStep5 .text-muted.mt-2');
                if (step5Text) step5Text.textContent = `Заглядывай ежедневно — бобр (${StateManager.getState().user.name || 'Бобрик'}) будет ждать.`;
            }

            onboardingNextStep() {
                const state = StateManager.getState();
                const step = state.onboarding.step || 1;

                // Валидации шагов
                if (step === 2) {
                    const name = (state.user.name || '').trim();
                    if (!name) {
                        window.animationManager?.showNotification('Дай бобру имя 🙂', 'error');
                        return;
                    }
                }

                this.onboardingShowStep(Math.min(5, step + 1));
            }

            onboardingPrevStep() {
                const state = StateManager.getState();
                const step = state.onboarding.step || 1;
                this.onboardingShowStep(Math.max(1, step - 1));
            }

            onboardingTryTame() {
                this.onboardingTameClicks = Math.min(this.onboardingTameTarget, (this.onboardingTameClicks || 0) + 1);

                const state = StateManager.getState();
                state.onboarding.tameClicks = this.onboardingTameClicks;
                StateManager.saveState(state);

                this.onboardingUpdateTameUI();

                if (this.onboardingTameClicks >= this.onboardingTameTarget) {
                    // Приручили
                    window.animationManager?.celebrateSuccess('Бобр успокоился!');
                    this.onboardingShowStep(2);
                }
            }

            onboardingUpdateTameUI() {
                const fill = document.getElementById('tameFill');
                const label = document.getElementById('tameLabel');
                const pct = Math.round((this.onboardingTameClicks / this.onboardingTameTarget) * 100);
                if (fill) fill.style.width = pct + '%';
                if (label) label.textContent = `Приручение: ${this.onboardingTameClicks}/${this.onboardingTameTarget}`;

                const txt = document.getElementById('obText1');
                if (txt) {
                    const phrases = [
                        'Он растерян и напуган.',
                        'Он косится на тебя и нюхает воздух…',
                        'Похоже, он перестал дрожать.',
                        'Он уже почти доверяет.',
                        'Он приручился и готов к стройке!'
                    ];
                    txt.textContent = phrases[Math.min(phrases.length - 1, Math.max(0, this.onboardingTameClicks - 0))];
                }
            }

            onboardingSetBeaverName(name, silent = false) {
                const clean = (name || '').toString().trim().slice(0, 24);
                const state = StateManager.getState();
                state.user.name = clean || state.user.name || 'Бобрик';
                StateManager.saveState(state);

                const input = document.getElementById('obBeaverNameInput');
                if (input && input.value !== state.user.name) input.value = state.user.name;

                // Подсветка быстрых вариантов
                const choices = document.querySelectorAll('#obNameChoices .onboarding-choice');
                choices.forEach(el => {
                    el.classList.toggle('active', el.textContent.trim() === state.user.name);
                });

                if (!silent) {
                    window.animationManager?.showNotification(`Бобр теперь: ${state.user.name}`, 'success');
                }
            }

            onboardingBuildCategoryChoices() {
                const container = document.getElementById('obCategoryChoices');
                if (!container) return;

                const picks = ['health', 'sleep', 'work', 'mind', 'sport', 'social'];
                container.innerHTML = picks.map(id => {
                    const c = HABIT_CATEGORIES[id];
                    if (!c) return '';
                    return `<div class="onboarding-choice" onclick="window.uiManager.onboardingSelectCategory('${id}')">${c.emoji} ${c.name}</div>`;
                }).join('');
            }

            onboardingSelectCategory(categoryId) {
                this.onboardingCurrentCategory = categoryId;
                this.onboardingSuggestedSelected = new Set();

                // Подсветка категории
                document.querySelectorAll('#obCategoryChoices .onboarding-choice').forEach(el => {
                    el.classList.toggle('active', el.textContent.includes(HABIT_CATEGORIES[categoryId]?.name || ''));
                });

                // Рендер привычек
                const box = document.getElementById('obSuggestedBox');
                const list = document.getElementById('obSuggestedHabits');
                const title = document.getElementById('obSuggestedTitle');
                const picked = document.getElementById('obPickedCount');

                if (box) box.style.display = 'block';
                if (title) title.textContent = `Подсказки для: ${HABIT_CATEGORIES[categoryId]?.emoji || '✨'} ${HABIT_CATEGORIES[categoryId]?.name || categoryId}`;

                const suggestions = this.getOnboardingSuggestions(categoryId);
                if (list) {
                    list.innerHTML = suggestions.map((h, idx) => {
                        const key = `${categoryId}__${idx}`;
                        return `
                            <div class="habit-card" data-skey="${key}" onclick="window.uiManager.onboardingToggleSuggested('${key}')">
                                <div class="habit-title" style="display:flex;align-items:center;gap:10px;">
                                    <span style="font-size:1.25rem;">${h.emoji || '✨'}</span>
                                    <span>${h.title}</span>
                                </div>
                                <div class="habit-toggle" style="pointer-events:none;"></div>
                            </div>
                        `;
                    }).join('');
                }

                if (picked) picked.textContent = 'Выбери несколько привычек и нажми “Добавить выбранные”.';
            }

            onboardingToggleSuggested(key) {
                if (this.onboardingSuggestedSelected.has(key)) this.onboardingSuggestedSelected.delete(key);
                else this.onboardingSuggestedSelected.add(key);

                // Визуал
                document.querySelectorAll(`[data-skey]`).forEach(el => {
                    const k = el.getAttribute('data-skey');
                    el.classList.toggle('done', this.onboardingSuggestedSelected.has(k));
                });

                const picked = document.getElementById('obPickedCount');
                if (picked) picked.textContent = `Выбрано: ${this.onboardingSuggestedSelected.size}`;
            }

            onboardingAddSuggestedHabits() {
                if (!this.onboardingCurrentCategory) return;

                const suggestions = this.getOnboardingSuggestions(this.onboardingCurrentCategory);
                const keys = Array.from(this.onboardingSuggestedSelected);
                if (keys.length === 0) {
                    window.animationManager?.showNotification('Выбери хотя бы одну привычку 🙂', 'error');
                    return;
                }

                const state = StateManager.getState();
                keys.forEach(k => {
                    const idx = parseInt(k.split('__')[1], 10);
                    const s = suggestions[idx];
                    if (!s) return;

                    // Не добавляем дубликаты по title
                    const exists = state.habits.some(h => (h.title || '').trim().toLowerCase() === (s.title || '').trim().toLowerCase());
                    if (exists) return;

                    const newHabit = StateManager.addHabit({
                        title: s.title,
                        emoji: s.emoji,
                        category: this.onboardingCurrentCategory,
                        duration: s.duration || 0,
                        frequency: 'daily',
                        difficulty: 1
                    });

                    this.onboardingPickedHabitIds.add(newHabit.id);
                });

                window.animationManager?.celebrateSuccess('Привычки добавлены!');
                this.onboardingSuggestedSelected.clear();
                this.onboardingSelectCategory(this.onboardingCurrentCategory);
            }

            getOnboardingSuggestions(categoryId) {
                const map = {
                    health: [
                        { title: 'Выпить стакан воды', emoji: '💧', duration: 0 },
                        { title: 'Пройти 6000 шагов', emoji: '🚶', duration: 0 },
                        { title: 'Съесть фрукт/овощ', emoji: '🍎', duration: 0 },
                        { title: 'Разминка 3 минуты', emoji: '🤸', duration: 3 },
                        { title: 'Почистить зубы + нить', emoji: '🦷', duration: 3 }
                    ],
                    sleep: [
                        { title: 'Лечь спать до 23:30', emoji: '🌙', duration: 0 },
                        { title: 'Без экрана за 30 минут', emoji: '📵', duration: 0 },
                        { title: 'Проветрить комнату', emoji: '🌬️', duration: 2 },
                        { title: 'Тёплый душ/ванна', emoji: '🚿', duration: 10 },
                        { title: 'Записать завтра 3 задачи', emoji: '📝', duration: 3 }
                    ],
                    work: [
                        { title: 'План дня (3 приоритета)', emoji: '🗒️', duration: 5 },
                        { title: 'Фокус 25 минут', emoji: '⏱️', duration: 25 },
                        { title: 'Разобрать 10 минут входящие', emoji: '📥', duration: 10 },
                        { title: 'Мини-обучение 10 минут', emoji: '📚', duration: 10 },
                        { title: 'Перерыв на растяжку', emoji: '🧘', duration: 3 }
                    ],
                    mind: [
                        { title: 'Медитация 5 минут', emoji: '😌', duration: 5 },
                        { title: 'Благодарность: 3 пункта', emoji: '🙏', duration: 3 },
                        { title: 'Прочитать 10 страниц', emoji: '📖', duration: 10 },
                        { title: 'Вести дневник 5 минут', emoji: '📓', duration: 5 },
                        { title: '1 вдох-выдох: пауза', emoji: '🌬️', duration: 1 }
                    ],
                    sport: [
                        { title: '10 отжиманий', emoji: '💪', duration: 2 },
                        { title: 'Планка 30 секунд', emoji: '🧱', duration: 1 },
                        { title: 'Растяжка 5 минут', emoji: '🧘‍♂️', duration: 5 },
                        { title: 'Кардио 10 минут', emoji: '🏃', duration: 10 },
                        { title: 'Прогулка 20 минут', emoji: '🚶‍♂️', duration: 20 }
                    ],
                    social: [
                        { title: 'Написать близкому человеку', emoji: '💬', duration: 2 },
                        { title: 'Созвон 5 минут', emoji: '📞', duration: 5 },
                        { title: 'Комплимент/спасибо', emoji: '😊', duration: 1 },
                        { title: 'Поддержать друга', emoji: '🫶', duration: 2 },
                        { title: 'Отключить уведомления на час', emoji: '🔕', duration: 0 }
                    ]
                };
                return map[categoryId] || [
                    { title: 'Убрать рабочее место', emoji: '🧹', duration: 5 },
                    { title: 'Сделать одно полезное действие', emoji: '✨', duration: 1 }
                ];
            }

            onboardingPrepareFirstHabit() {
                const state = StateManager.getState();

                // Гарантируем хотя бы одну привычку
                if (state.habits.length === 0) {
                    StateManager.addHabit({
                        title: 'Выпить стакан воды',
                        emoji: '💧',
                        category: 'health',
                        duration: 0,
                        frequency: 'daily'
                    });
                }

                // Берём первую привычку
                const first = StateManager.getState().habits[0];
                this.onboardingFirstHabitId = first?.id;

                const title = document.getElementById('obFirstHabitTitle');
                if (title) title.textContent = `${first.emoji || '✨'} ${first.title || 'Первая привычка'}`;

                // Сброс вида
                const card = document.getElementById('obFirstHabitCard');
                const hint = document.getElementById('obFirstHint');
                if (card) card.classList.remove('done');
                if (hint) hint.textContent = 'Нажми на галочку, чтобы отметить выполнение';
            }

            onboardingCompleteFirstHabit() {
                if (!this.onboardingFirstHabitId) return;

                const state = StateManager.getState();
                const today = new Date().toDateString();
                const completed = state.completedToday[today] || [];
                if (completed.includes(this.onboardingFirstHabitId)) {
                    return;
                }

                // Выполняем привычку
                StateManager.toggleHabit(this.onboardingFirstHabitId);

                // Бонус онбординга (один раз)
                const st = StateManager.getState();
                st.onboarding.firstBonus = st.onboarding.firstBonus || false;
                if (!st.onboarding.firstBonus) {
                    st.user.coins += 15; // итого будет ~20 (5 базовых + 15 бонус)
                    st.user.xp += 10;
                    st.onboarding.firstBonus = true;
                    StateManager.saveState(st);
                }

                // UI
                const card = document.getElementById('obFirstHabitCard');
                if (card) card.classList.add('done');
                const hint = document.getElementById('obFirstHint');
                if (hint) hint.textContent = 'Готово! Так и строится плотина — по одной доске 🙂';

                window.animationManager?.celebrateSuccess('Первая привычка отмечена!');
            }

            completeOnboarding() {
                StateManager.completeOnboarding();
                const overlay = document.getElementById('onboardingOverlay') || document.querySelector('.onboarding-screen');
                if (overlay) overlay.remove();
                this.state = StateManager.getState();
                this.showApp();
                this.setActivePage('today');
                this.loadPage('today');
                StateManager.updateUI();
            }

            showApp() {
                document.getElementById('app').classList.remove('hidden');
            }

            setupNavigation() {
                // Навигация по страницам
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const page = e.currentTarget.dataset.page;
                        this.setActivePage(page);
                        this.loadPage(page);
                    });
                });
                
                // Кнопка меню
                document.getElementById('menuBtn').addEventListener('click', () => {
                    this.showMenuModal();
                });
            }

            setActivePage(page) {
                this.currentPage = page;
                
                // Обновляем активную кнопку навигации
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.page === page) {
                        item.classList.add('active');
                    }
                });
                
                // Обновляем заголовок страницы
                const titles = {
                    'today': 'Сегодня',
                    'habits': 'Привычки',
                    'quests': 'Квесты',
                    'shop': 'Магазин',
                    'profile': 'Профиль'
                };
                document.getElementById('pageTitle').textContent = titles[page] || 'BIBR';
            }

            loadPage(page) {
                const content = document.getElementById('content');
                
                switch (page) {
                    case 'today':
                        content.innerHTML = this.renderTodayPage();
                        break;
                    case 'habits':
                        content.innerHTML = this.renderHabitsPage();
                        break;
                    case 'quests':
                        content.innerHTML = this.renderQuestsPage();
                        break;
                    case 'shop':
                        content.innerHTML = this.renderShopPage();
                        break;
                    case 'profile':
                        content.innerHTML = this.renderProfilePage();
                        break;
                }
                
                // Инициализируем аватар бобра на странице профиля
                if (page === 'profile') {
                    this.beaverAvatar = new BeaverAvatar('beaverAvatar');
                }
            }

            renderTodayPage() {
                const todayCompletion = StateManager.getTodayCompletion();
                const habits = StateManager.getState().habits.filter(h => h.frequency === 'daily');
                const now = new Date();
                
                return `
                    <div class="today-container">
                        <div class="card">
                            <h3>📊 Прогресс дня</h3>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${todayCompletion.percentage}%"></div>
                            </div>
                            <div class="text-center">
                                <p>${todayCompletion.completed} из ${todayCompletion.total} привычек выполнено</p>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3>🚀 Привычки на сегодня</h3>
                            ${habits.length > 0 ? habits.map(habit => this.renderHabitCard(habit)).join('') : 
                                '<p class="text-muted">Нет привычек на сегодня. Добавьте их на странице "Привычки".</p>'}
                        </div>
                        
                        <div class="card">
                            <h3>⚡ Энергия</h3>
                            <div class="energy-bar">
                                <div class="energy-fill" style="width: ${(window.adventureSystem.energy / window.adventureSystem.maxEnergy) * 100}%"></div>
                            </div>
                            <p>${window.adventureSystem.energy}/${window.adventureSystem.maxEnergy} ⚡</p>
                            <button class="btn btn-secondary" onclick="window.adventureSystem.updateEnergy()">
                                Обновить энергию
                            </button>
                        </div>
                        
                        <div class="adventure-widget">
                            <h3>🌲 Вылазки</h3>
                            ${window.adventureSystem.renderActiveAdventure()}
                            <button class="btn btn-primary" onclick="window.uiManager.loadPage('quests')">
                                Посмотреть все вылазки
                            </button>
                        </div>
                    </div>
                `;
            }

            renderHabitsPage() {
                const habits = StateManager.getState().habits;
                const categories = HABIT_CATEGORIES;
                
                return `
                    <div class="habits-container">
                        <div class="card">
                            <h3>📋 Все привычки</h3>
                            <button class="btn btn-primary mb-2" onclick="window.uiManager.showAddHabitModal()">
                                + Добавить привычку
                            </button>
                            
                            ${habits.length > 0 ? 
                                habits.map(habit => this.renderHabitCard(habit)).join('') : 
                                '<p class="text-muted">У вас пока нет привычек. Добавьте первую!</p>'}
                        </div>
                        
                        <div class="card">
                            <h3>🏷️ Категории</h3>
                            <div class="categories-grid">
                                ${Object.entries(categories).map(([id, category]) => {
                                    const habitsInCategory = habits.filter(h => h.category === id);
                                    return `
                                        <div class="category-card" onclick="window.uiManager.showCategoryHabits('${id}')">
                                            <div class="category-emoji">${category.emoji}</div>
                                            <div class="category-name">${category.name}</div>
                                            <div class="habits-count">${habitsInCategory.length} привычек</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderQuestsPage() {
                return `
                    <div class="quests-container">
                        <div class="card">
                            <h3>🎯 Квесты</h3>
                            <p>Система квестов в разработке...</p>
                        </div>
                        
                        <div class="adventure-widget">
                            <h3>🌲 Система вылазок</h3>
                            ${window.adventureSystem.renderAdventureMenu()}
                        </div>
                    </div>
                `;
            }


            renderShopPage() {
                const beaverName = StateManager.getState().user.name || 'Бобр';
                return `
                    <div class="shop-container">
                        <div class="card">
                            <h3>🛒 Магазин</h3>
                            <p class="text-muted">Подбери снаряжение для ${beaverName} и укрась свою плотину.</p>
                        </div>
                        <div class="card">
                            ${window.enhancedShop.renderShop()}
                        </div>
                    </div>
                `;
            }

            renderProfilePage() {
                const state = StateManager.getState();
                const stats = state.stats;
                
                return `
                    <div class="profile-container">
                        <div class="profile-header">
                            <div id="beaverAvatar"></div>
                            <div>
                                <h2>${state.user.name}</h2>
                                <p>Уровень ${state.user.level} ⭐ ${state.user.xp} опыта</p>
                                <div class="profile-summary">
                                    <div class="resource">🪙 ${state.user.coins} монет</div>
                                    <div class="resource">🔥 ${stats.currentStreak || 0} дней стрик</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${stats.totalCompleted || 0}</div>
                                <div class="stat-label">Всего выполнено</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.perfectDays || 0}</div>
                                <div class="stat-label">Идеальных дней</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.longestStreak || 0}</div>
                                <div class="stat-label">Лучший стрик</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${state.habits.length}</div>
                                <div class="stat-label">Активных привычек</div>
                            </div>
                        </div>
                        <div class="card">
                            <h3>⚙️ Настройки</h3>
                            <div class="settings"><div class="setting">
                                    <span>Звуки</span>
                                    <label class="switch">
                                        <input type="checkbox" ${state.settings.sound ? 'checked' : ''} 
                                               onchange="window.uiManager.toggleSound(this.checked)">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="setting">
                                    <span>Вибрация</span>
                                    <label class="switch">
                                        <input type="checkbox" ${state.settings.haptic ? 'checked' : ''} 
                                               onchange="window.uiManager.toggleHaptic(this.checked)">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderHabitCard(habit) {
                const today = new Date().toDateString();
                const completedToday = StateManager.getState().completedToday[today] || [];
                const isCompleted = completedToday.includes(habit.id);
                
                return `
                    <div class="habit-card ${isCompleted ? 'done' : ''}" data-habit-id="${habit.id}">
                        <div class="habit-title" data-emoji="${habit.emoji}">${habit.title}</div>
                        <div class="habit-meta">
                            <span class="habit-category-badge">${HABIT_CATEGORIES[habit.category]?.name || 'Другое'}</span>
                            ${habit.duration > 0 ? `<span>⏱️ ${habit.duration} мин</span>` : ''}
                        </div>
                        <div class="habit-toggle" onclick="window.uiManager.toggleHabit('${habit.id}')"></div>
                    </div>
                `;
            }

            toggleHabit(habitId) {
                const completed = StateManager.toggleHabit(habitId);
                const habitCard = document.querySelector(`[data-habit-id="${habitId}"]`);
                
                if (habitCard) {
                    const isCompleted = completed.includes(habitId);
                    habitCard.classList.toggle('done', isCompleted);
                    
                    // Анимация
                    if (isCompleted) {
                        window.animationManager.celebrateSuccess('Привычка выполнена!');
                        
                        // Анимация маскота
                        if (this.beaverAvatar) {
                            this.beaverAvatar.onHabitCompleted();
                        }
                    }
                }
                
                // Обновляем прогресс дня
                this.updateTodayProgress();
            }

            updateTodayProgress() {
                const todayCompletion = StateManager.getTodayCompletion();
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${todayCompletion.percentage}%`;
                }
                
                // Обновляем счетчик
                const counter = document.querySelector('.progress-container + .text-center p');
                if (counter) {
                    counter.textContent = `${todayCompletion.completed} из ${todayCompletion.total} привычек выполнено`;
                }
            }

            showAddHabitModal() {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal habit-modal">
                        <div class="modal-header">
                            <h3>➕ Добавить привычку</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        
                        <div class="modal-content">
                            <div class="form-group">
                                <label class="form-label">Название привычки</label>
                                <input type="text" class="form-input" id="habitTitle" placeholder="Например, Утренняя зарядка">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Категория</label>
                                <select class="form-input" id="habitCategory">
                                    ${Object.entries(HABIT_CATEGORIES).map(([id, category]) => 
                                        `<option value="${id}">${category.emoji} ${category.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Эмодзи</label>
                                <input type="text" class="form-input" id="habitEmoji" value="✨" maxlength="2">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Описание (необязательно)</label>
                                <textarea class="form-input" id="habitDescription" rows="2"></textarea>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                                Отмена
                            </button>
                            <button class="btn btn-primary" onclick="window.uiManager.saveNewHabit()">
                                Сохранить
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            saveNewHabit() {
                const title = document.getElementById('habitTitle').value;
                const category = document.getElementById('habitCategory').value;
                const emoji = document.getElementById('habitEmoji').value;
                const description = document.getElementById('habitDescription').value;
                
                if (!title.trim()) {
                    window.animationManager.showFloatingMessage('Введите название привычки', 'error');
                    return;
                }
                
                const habit = {
                    title: title.trim(),
                    category: category,
                    emoji: emoji || '✨',
                    description: description.trim()
                };
                
                StateManager.addHabit(habit);
                window.animationManager.showFloatingMessage('Привычка добавлена!', 'success');
                
                // Закрываем модальное окно
                document.querySelector('.modal-overlay').remove();
                
                // Обновляем страницу привычек
                if (this.currentPage === 'habits') {
                    this.loadPage('habits');
                }
            }

            showCategoryHabits(categoryId) {
                const habits = StateManager.getHabitsByCategory(categoryId);
                const category = HABIT_CATEGORIES[categoryId];
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal category-details-modal">
                        <div class="modal-header">
                            <h3>${category.emoji} ${category.name}</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        
                        <div class="modal-content">
                            <div class="category-stats">
                                <div class="stat-row">
                                    <div class="stat-label">Привычек в категории:</div>
                                    <div class="stat-value">${habits.length}</div>
                                </div>
                                <div class="stat-row">
                                    <div class="stat-label">Выполнено сегодня:</div>
                                    <div class="stat-value">
                                        ${habits.filter(h => {
                                            const today = new Date().toDateString();
                                            const completedToday = StateManager.getState().completedToday[today] || [];
                                            return completedToday.includes(h.id);
                                        }).length} из ${habits.length}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="habit-list-in-category">
                                <h4>Привычки:</h4>
                                ${habits.length > 0 ? 
                                    habits.map(habit => `
                                        <div class="category-habit-item">
                                            <div class="habit-emoji">${habit.emoji}</div>
                                            <div class="habit-details">
                                                <div class="habit-name">${habit.title}</div>
                                                <div class="habit-frequency">Ежедневно</div>
                                            </div>
                                        </div>
                                    `).join('') :
                                    '<p class="text-muted">В этой категории пока нет привычек.</p>'}
                            </div>
                            
                            <div class="category-tips">
                                <h4>💡 Советы по категории "${category.name}":</h4>
                                <ul>
                                    <li>Начинайте с маленьких, легко выполнимых привычек</li>
                                    <li>Связывайте новые привычки с существующими ритуалами</li>
                                    <li>Отслеживайте прогресс и награждайте себя</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="window.uiManager.showAddHabitModal()">
                                Добавить привычку
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            showMenuModal() {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal menu-modal">
                        <div class="modal-header">
                            <h3>Меню</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        
                        <div class="modal-content">
                            <div class="menu-options">
                                <button class="menu-option" onclick="window.uiManager.loadPage('today')">
                                    <div class="menu-emoji">📊</div>
                                    <div class="menu-text">Сегодня</div>
                                </button>
                                <button class="menu-option" onclick="window.uiManager.loadPage('habits')">
                                    <div class="menu-emoji">📋</div>
                                    <div class="menu-text">Привычки</div>
                                </button>
                                <button class="menu-option" onclick="window.uiManager.loadPage('quests')">
                                    <div class="menu-emoji">🎯</div>
                                    <div class="menu-text">Квесты и вылазки</div>
                                </button>
                                <button class="menu-option" onclick="window.uiManager.loadPage('profile')">
                                    <div class="menu-emoji">👤</div>
                                    <div class="menu-text">Профиль</div>
                                </button>
                                <button class="menu-option" onclick="window.uiManager.showExercisesModal()">
                                    <div class="menu-emoji">💪</div>
                                    <div class="menu-text">Упражнения</div>
                                </button>
                                <button class="menu-option" onclick="window.uiManager.showReflectionModal()">
                                    <div class="menu-emoji">📝</div>
                                    <div class="menu-text">Рефлексия</div>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            showExercisesModal() {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal exercise-modal">
                        <div class="modal-header">
                            <h3>💪 Упражнения</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        
                        <div class="modal-content">
                            <div class="exercises-grid">
                                ${EXERCISES.map(exercise => `
                                    <div class="exercise-card" onclick="window.uiManager.startExercise('${exercise.id}')">
                                        <div class="exercise-emoji">${exercise.emoji}</div>
                                        <h4>${exercise.title}</h4>
                                        <p>${exercise.desc}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            showReflectionModal() {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal reflection-modal">
                        <div class="modal-header">
                            <h3>📝 Рефлексия дня</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        
                        <div class="modal-content">
                            <div class="form-group">
                                <label class="form-label">Как прошел твой день?</label>
                                <textarea class="reflection-input" id="reflectionText" 
                                          placeholder="Что получилось хорошо? Что можно улучшить?"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Настроение дня</label>
                                <div class="mood-selector">
                                    <div class="mood-option" data-mood="happy">😊</div>
                                    <div class="mood-option" data-mood="good">😌</div>
                                    <div class="mood-option" data-mood="neutral">😐</div>
                                    <div class="mood-option" data-mood="sad">😔</div>
                                    <div class="mood-option" data-mood="tired">😴</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                                Пропустить
                            </button>
                            <button class="btn btn-primary" onclick="window.uiManager.saveReflection()">
                                Сохранить
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Настройка выбора настроения
                modal.querySelectorAll('.mood-option').forEach(option => {
                    option.addEventListener('click', function() {
                        modal.querySelectorAll('.mood-option').forEach(o => o.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
                
                // Выбираем первое настроение по умолчанию
                modal.querySelector('.mood-option').classList.add('active');
            }

            saveReflection() {
                const text = document.getElementById('reflectionText').value;
                const mood = document.querySelector('.mood-option.active')?.dataset.mood || 'neutral';
                
                const state = StateManager.getState();
                state.reflections.push({
                    date: new Date().toISOString(),
                    text: text,
                    mood: mood
                });
                
                StateManager.saveState(state);
                window.animationManager.showFloatingMessage('Рефлексия сохранена!', 'success');
                
                document.querySelector('.modal-overlay').remove();
            }
            toggleSound(enabled) {
                const state = StateManager.getState();
                state.settings.sound = enabled;
                StateManager.saveState(state);
            }

            toggleHaptic(enabled) {
                const state = StateManager.getState();
                state.settings.haptic = enabled;
                StateManager.saveState(state);
                
                window.animationManager.hapticEnabled = enabled;
            }
        }

/* ===== Patch: UIManager inventory + energy helpers for EnhancedAdventureSystem ===== */
if (typeof UIManager !== 'undefined') {
  if (!UIManager.prototype.updateEnergyDisplay) {
    UIManager.prototype.updateEnergyDisplay = function() {
      const energyElement = document.getElementById('energy');
      if (energyElement && window.enhancedAdventureSystem) {
        energyElement.textContent = window.enhancedAdventureSystem.energy;
      }
    };
  }

  if (!UIManager.prototype.renderInventory) {
    UIManager.prototype.renderInventory = function() {
      const state = StateManager.getState();
      const uniqueItems = (state.inventory || []).filter(item =>
        window.enhancedAdventureSystem && window.enhancedAdventureSystem.uniqueItems &&
        window.enhancedAdventureSystem.uniqueItems.some(ui => ui.id === item.id)
      );

      if (!uniqueItems || uniqueItems.length === 0) {
        return '<p class="text-muted">У вас пока нет уникальных предметов. Отправляйтесь в вылазки, чтобы получить их!</p>';
      }

      const groupedItems = {};
      uniqueItems.forEach(item => {
        const itemData = window.enhancedAdventureSystem.uniqueItems.find(ui => ui.id === item.id);
        if (itemData) {
          if (!groupedItems[itemData.rarity]) groupedItems[itemData.rarity] = [];
          groupedItems[itemData.rarity].push({ ...itemData, quantity: item.quantity });
        }
      });

      const rarityOrder = ['legendary', 'epic', 'rare', 'uncommon', 'common'];
      return rarityOrder.map(rarity => {
        const items = groupedItems[rarity];
        if (!items || items.length === 0) return '';
        return `
          <div class="rarity-section">
            <h4 class="rarity-${rarity}">${window.enhancedAdventureSystem.getRarityName(rarity)}</h4>
            <div class="inventory-grid">
              ${items.map(item => {
                const isEquipped = state.user && state.user.equipped && state.user.equipped[item.type] === item.id;
                return `
                  <div class="inventory-slot ${isEquipped ? 'equipped' : ''}"
                       onclick="window.enhancedAdventureSystem.showItemModal('${item.id}')">
                    ${item.emoji}
                    ${item.quantity > 1 ? `<span class="item-quantity">${item.quantity}</span>` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    };
  }

  if (!UIManager.prototype.showInventoryModal) {
    UIManager.prototype.showInventoryModal = function() {
      const state = StateManager.getState();
      const uniqueItems = (state.inventory || []).filter(item =>
        window.enhancedAdventureSystem && window.enhancedAdventureSystem.uniqueItems &&
        window.enhancedAdventureSystem.uniqueItems.some(ui => ui.id === item.id)
      );

      if (!uniqueItems || uniqueItems.length === 0) {
        if (window.animationManager && window.animationManager.showFloatingMessage) {
          window.animationManager.showFloatingMessage('Инвентарь пуст', 'info');
        }
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal inventory-modal">
          <div class="modal-header">
            <h3>🎒 Полный инвентарь</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
          </div>

          <div class="modal-content">
            ${this.renderInventory()}
          </div>

          <div class="modal-footer">
            <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Закрыть</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };
  }
}

        // ========== INITIALIZE MANAGERS ==========
        // Инициализация менеджеров
        

/* ===== Imported: Enhanced Adventure System (data + classes) ===== */

        // ========== КОНСТАНТЫ ==========
        
        // Уникальные предметы (50 штук)
        const UNIQUE_ITEMS = [
            // Обычные (Common) - 15 предметов
            { id: 'wooden_helmet', name: 'Деревянный шлем', emoji: '🪖', type: 'hat', rarity: 'common', stats: { defense: 5 }, price: 50 },
            { id: 'stone_hammer', name: 'Каменный молот', emoji: '🔨', type: 'tool', rarity: 'common', stats: { strength: 3 }, price: 40 },
            { id: 'leaf_cloak', name: 'Плащ из листьев', emoji: '🍃', type: 'accessory', rarity: 'common', stats: { agility: 2 }, price: 30 },
            { id: 'moss_boots', name: 'Ботинки из мха', emoji: '👢', type: 'boots', rarity: 'common', stats: { speed: 2 }, price: 35 },
            { id: 'twig_bow', name: 'Лук из веток', emoji: '🏹', type: 'weapon', rarity: 'common', stats: { dexterity: 4 }, price: 45 },
            { id: 'berry_pouch', name: 'Сумка для ягод', emoji: '🎒', type: 'bag', rarity: 'common', stats: { capacity: 3 }, price: 25 },
            { id: 'river_stone', name: 'Речной камень', emoji: '🪨', type: 'accessory', rarity: 'common', stats: { luck: 1 }, price: 20 },
            { id: 'pinecone_grenade', name: 'Шишко-граната', emoji: '🪔', type: 'weapon', rarity: 'common', stats: { damage: 5 }, price: 40 },
            { id: 'bark_shield', name: 'Щит из коры', emoji: '🛡️', type: 'shield', rarity: 'common', stats: { defense: 6 }, price: 55 },
            { id: 'acorn_necklace', name: 'Ожерелье из желудей', emoji: '📿', type: 'accessory', rarity: 'common', stats: { charm: 3 }, price: 30 },
            { id: 'mud_sandals', name: 'Сандалии из грязи', emoji: '👡', type: 'boots', rarity: 'common', stats: { endurance: 3 }, price: 25 },
            { id: 'reed_flute', name: 'Тростниковая флейта', emoji: '🎵', type: 'accessory', rarity: 'common', stats: { charisma: 4 }, price: 35 },
            { id: 'web_cloak', name: 'Плащ из паутины', emoji: '🕸️', type: 'accessory', rarity: 'common', stats: { stealth: 5 }, price: 40 },
            { id: 'feather_cap', name: 'Шапка с перьями', emoji: '🎩', type: 'hat', rarity: 'common', stats: { perception: 3 }, price: 30 },
            { id: 'root_staff', name: 'Посох из корней', emoji: '🪄', type: 'weapon', rarity: 'common', stats: { wisdom: 4 }, price: 50 },
            
            // Необычные (Uncommon) - 15 предметов
            { id: 'amber_amulet', name: 'Янтарный амулет', emoji: '🧿', type: 'accessory', rarity: 'uncommon', stats: { luck: 3, wisdom: 2 }, price: 100 },
            { id: 'ironwood_axe', name: 'Топор из железного дерева', emoji: '🪓', type: 'tool', rarity: 'uncommon', stats: { strength: 6, damage: 4 }, price: 120 },
            { id: 'crystal_lens', name: 'Кристальная линза', emoji: '🔍', type: 'accessory', rarity: 'uncommon', stats: { perception: 5, wisdom: 3 }, price: 90 },
            { id: 'glow_mushroom_lamp', name: 'Лампа из светящихся грибов', emoji: '💡', type: 'accessory', rarity: 'uncommon', stats: { light: 8, charm: 2 }, price: 110 },
            { id: 'thunder_drum', name: 'Громовой барабан', emoji: '🥁', type: 'weapon', rarity: 'uncommon', stats: { charisma: 5, damage: 3 }, price: 130 },
            { id: 'frost_cape', name: 'Морозный плащ', emoji: '🧥', type: 'accessory', rarity: 'uncommon', stats: { defense: 4, agility: 4 }, price: 115 },
            { id: 'sunstone_pendant', name: 'Подвеска из солнечного камня', emoji: '☀️', type: 'accessory', rarity: 'uncommon', stats: { energy: 5, luck: 2 }, price: 95 },
            { id: 'moonlit_sword', name: 'Меч лунного света', emoji: '⚔️', type: 'weapon', rarity: 'uncommon', stats: { damage: 7, speed: 3 }, price: 140 },
            { id: 'spider_silk_armor', name: 'Доспех из паучьего шелка', emoji: '🦺', type: 'armor', rarity: 'uncommon', stats: { defense: 8, stealth: 3 }, price: 160 },
            { id: 'echo_boots', name: 'Ботинки-эхо', emoji: '👞', type: 'boots', rarity: 'uncommon', stats: { speed: 5, agility: 4 }, price: 125 },
            { id: 'whisper_ring', name: 'Кольцо шёпота', emoji: '💍', type: 'accessory', rarity: 'uncommon', stats: { stealth: 6, perception: 4 }, price: 105 },
            { id: 'vine_whip', name: 'Кнут из лиан', emoji: '🪢', type: 'weapon', rarity: 'uncommon', stats: { dexterity: 6, damage: 5 }, price: 135 },
            { id: 'crystal_shard_dagger', name: 'Кинжал из осколков кристалла', emoji: '🗡️', type: 'weapon', rarity: 'uncommon', stats: { damage: 8, speed: 4 }, price: 145 },
            { id: 'petrified_wood_shield', name: 'Щит из окаменевшего дерева', emoji: '🪵', type: 'shield', rarity: 'uncommon', stats: { defense: 10, endurance: 3 }, price: 155 },
            { id: 'glowing_moss_cape', name: 'Плащ из светящегося мха', emoji: '✨', type: 'accessory', rarity: 'uncommon', stats: { light: 10, charm: 3 }, price: 120 },
            
            // Редкие (Rare) - 10 предметов
            { id: 'dragon_scale_armor', name: 'Доспех из драконьей чешуи', emoji: '🐉', type: 'armor', rarity: 'rare', stats: { defense: 15, fire_resistance: 8 }, price: 300 },
            { id: 'phoenix_feather_quill', name: 'Перо феникса', emoji: '🪶', type: 'accessory', rarity: 'rare', stats: { wisdom: 10, luck: 5 }, price: 280 },
            { id: 'starfall_scythe', name: 'Коса звездопада', emoji: '🔱', type: 'weapon', rarity: 'rare', stats: { damage: 15, magic: 8 }, price: 320 },
            { id: 'titanium_gauntlets', name: 'Титановые рукавицы', emoji: '🥊', type: 'gloves', rarity: 'rare', stats: { strength: 12, defense: 8 }, price: 310 },
            { id: 'void_cloak', name: 'Плащ пустоты', emoji: '🌌', type: 'accessory', rarity: 'rare', stats: { stealth: 12, speed: 6 }, price: 290 },
            { id: 'elemental_staff', name: 'Стихийный посох', emoji: '🌀', type: 'weapon', rarity: 'rare', stats: { magic: 12, wisdom: 10 }, price: 330 },
            { id: 'celestial_compass', name: 'Небесный компас', emoji: '🧭', type: 'accessory', rarity: 'rare', stats: { navigation: 15, luck: 8 }, price: 270 },
            { id: 'adamantine_helmet', name: 'Адамантиновый шлем', emoji: '⛑️', type: 'hat', rarity: 'rare', stats: { defense: 14, perception: 8 }, price: 295 },
            { id: 'thunderbird_boots', name: 'Ботинки громовой птицы', emoji: '⚡', type: 'boots', rarity: 'rare', stats: { speed: 10, agility: 8 }, price: 285 },
            { id: 'ancient_tome', name: 'Древний фолиант', emoji: '📖', type: 'accessory', rarity: 'rare', stats: { wisdom: 15, knowledge: 12 }, price: 275 },
            
            // Эпические (Epic) - 7 предметов
            { id: 'excalibur_replica', name: 'Реплика Экскалибура', emoji: '⚔️', type: 'weapon', rarity: 'epic', stats: { damage: 25, charisma: 15, leadership: 10 }, price: 600 },
            { id: 'aegis_shield', name: 'Щит Эгида', emoji: '🛡️', type: 'shield', rarity: 'epic', stats: { defense: 25, protection: 20, luck: 10 }, price: 580 },
            { id: 'hermes_wings', name: 'Крылья Гермеса', emoji: '👼', type: 'accessory', rarity: 'epic', stats: { speed: 20, agility: 15, flight: 10 }, price: 650 },
            { id: 'midas_touch_gloves', name: 'Перчатки Мидаса', emoji: '🧤', type: 'gloves', rarity: 'epic', stats: { wealth: 25, charm: 15, luck: 12 }, price: 700 },
            { id: 'odin_eye_patch', name: 'Глаз Одина', emoji: '👁️', type: 'accessory', rarity: 'epic', stats: { wisdom: 20, perception: 18, foresight: 15 }, price: 620 },
            { id: 'thor_hammer', name: 'Молот Тора', emoji: '🔨', type: 'weapon', rarity: 'epic', stats: { damage: 30, strength: 20, thunder: 25 }, price: 750 },
            { id: 'zeus_lightning', name: 'Молния Зевса', emoji: '⚡', type: 'weapon', rarity: 'epic', stats: { damage: 28, magic: 22, lightning: 30 }, price: 780 },
            
            // Легендарные (Legendary) - 3 предмета
            { id: 'holy_grail', name: 'Святой Грааль', emoji: '🏺', type: 'accessory', rarity: 'legendary', stats: { healing: 50, wisdom: 30, divinity: 40 }, price: 1500 },
            { id: 'philosopher_stone', name: 'Философский камень', emoji: '💎', type: 'accessory', rarity: 'legendary', stats: { alchemy: 50, wisdom: 35, immortality: 30 }, price: 2000 },
            { id: 'infinity_gauntlet', name: 'Перчатка Бесконечности', emoji: '🪬', type: 'gloves', rarity: 'legendary', stats: { power: 100, control: 50, reality: 60 }, price: 5000 }
        ];

        // Истории для вылазок (30 вариаций для обычных вылазок)
        const ADVENTURE_STORIES = {
            short: [
                "Бобрик начал короткую прогулку по лесу. В воздухе пахнет свежей хвоей.",
                "По пути Бобрик нашёл блестящий камушек и положил его в карман на удачу.",
                "На поляне Бобрик встретил старого друга-ёжика, они обменялись новостями.",
                "Бобрик заметил следы зайца и решил последовать за ними, чтобы попрактиковаться в следопытстве.",
                "Внезапно пошёл лёгкий дождь, но Бобрик был готов - у него всегда есть с собой лист-зонтик.",
                "Бобрик нашёл гнездо с яйцами и аккуратно обошёл его, чтобы не потревожить птиц.",
                "На обратном пути Бобрик собрал немного ягод для вечернего чая.",
                "Бобрик услышал шорох в кустах - оказалось, это просто белка собирала орехи.",
                "Солнце начало садиться, окрашивая небо в оранжевые тона. Пора возвращаться домой.",
                "Бобрик благополучно вернулся в свою хатку, полный приятных впечатлений."
            ],
            medium: [
                "Бобрик отправился в среднюю вылазку. Впереди ждут новые открытия!",
                "На пути встретился ручей с чистой водой. Бобрик попил и набрал воды в бутылку из коры.",
                "Бобрик обнаружил старую карту, нацарапанную на бересте. Интересно, что на ней обозначено?",
                "Внезапно налетел ветер, и с дерева упало гнездо. Бобрик помог вернуть птенцов на место.",
                "Бобрик нашёл заброшенную нору. Решил исследовать её и обнаружил там старые запасы орехов.",
                "На поляне рос необычный цветок, который светился в тени. Бобрик сделал зарисовку в блокноте.",
                "Бобрик встретил семью оленей. Они позволили ему пройти рядом, не убегая.",
                "Начался сильный дождь. Бобрик укрылся под скалой и решил переждать непогоду.",
                "После дождя появилась радуга. Бобрик заметил, что один её конец упирается как раз туда, куда он шёл.",
                "Бобрик достиг цели своей вылазки - старого дуба-великана. Дерево было просто огромным!"
            ],
            long: [
                "Начало длинной экспедиции! Бобрик проверил снаряжение и отправился в путь.",
                "Первая ночь в походе. Бобрик развёл небольшой костёр и приготовил ужин из грибов и ягод.",
                "Утром Бобрик обнаружил, что к его лагерю приходил любопытный лис. Остались следы.",
                "На третий день Бобрик нашёл древние петроглифы на скале. Кто их нарисовал?",
                "Бобрик пересёк быструю реку по упавшему дереву. Было страшновато, но он справился.",
                "В лесу Бобрик нашёл заброшенный домик лесника. Там ещё сохранились некоторые вещи.",
                "Шестой день экспедиции. Бобрик начал замечать, что стал лучше ориентироваться в лесу.",
                "Бобрик столкнулся с медведем! К счастью, медведь был сыт и просто ушёл своей дорогой.",
                "Бобрик нашёл пещеру с кристаллами. Внутри было красиво, как в сказке.",
                "Экспедиция подошла к концу. Бобрик вернулся домой с массой впечатлений и находок."
            ],
            weekly: [
                "Недельное приключение началось! Бобрик настроен на серьёзные испытания.",
                "День 2: Бобрик обнаружил следы неизвестного животного. Решил проследить за ними.",
                "День 3: Нашёл древний каменный круг. Возможно, это было место ритуалов.",
                "День 4: Случилась буря. Бобрик укрылся в пещере и переждал непогоду.",
                "День 5: В пещере Бобрик нашёл наскальные рисунки, изображающие древних бобров.",
                "День 6: Бобрик построил плот, чтобы пересечь озеро. Это было непросто!",
                "День 7: На другом берегу озера Бобрик обнаружил затерянную долину.",
                "День 8: В долине росли невиданные растения. Бобрик собрал образцы.",
                "День 9: Бобрик встретил отшельника-бобра, который жил здесь много лет.",
                "День 10: Отшельник рассказал Бобрику древние легенды этих мест.",
                "День 11: Бобрик помог отшельнику починить плотину. Взамен получил ценный совет.",
                "День 12: Используя совет отшельника, Бобрик нашёл скрытый источник.",
                "День 13: Источник оказался целебным! Бобрик почувствовал прилив сил.",
                "День 14: Возвращение домой. Бобрик стал мудрее и сильнее после этого приключения."
            ],
            seasonal: [
                "Сезонная экспедиция началась! Бобрик готов к месяцу открытий.",
                "Первая неделя: Исследование северных лесов. Холодно, но красиво.",
                "Вторая неделя: Бобрик научился строить иглу из снега. Теперь ночёвки стали теплее.",
                "Третья неделя: Обнаружен древний замёрзший водопад. Внутри - кристаллы льда.",
                "Четвёртая неделя: Встреча с полярной совой. Она стала проводником Бобрика.",
                "Пятая неделя: Бобрик нашёл горячий источник посреди снегов. Настоящее чудо!",
                "Шестая неделя: Исследование ледяных пещер. Стены переливаются всеми цветами радуги.",
                "Седьмая неделя: Бобрик обнаружил затерянный город древней цивилизации бобров.",
                "Восьмая неделя: Изучение артефактов города. Каждый рассказывает свою историю.",
                "Девятая неделя: Бобрик разгадал главную тайну города - источник их мудрости.",
                "Десятая неделя: Применение древних знаний. Бобрик улучшил свои навыки строительства.",
                "Одиннадцатая неделя: Возвращение цивилизации. Бобрик начал восстанавливать город.",
                "Двенадцатая неделя: К Бобрику присоединились другие бобры. Вместе они работают быстрее.",
                "Тринадцатая неделя: Город ожил! Теперь здесь снова кипит жизнь.",
                "Четырнадцатая неделя: Церемония в честь Бобрика. Его объявляют хранителем города.",
                "Пятнадцатая неделя: Возвращение домой. Бобрик принёс с собой не только артефакты, но и мудрость веков."
            ]
        };

        // События в пути (30 вариантов)
        const JOURNEY_EVENTS = [
            { type: 'encounter', emoji: '🐿️', title: 'Встреча с белкой', description: 'Белка показала короткую дорогу', effect: { time: -60 } },
            { type: 'discovery', emoji: '🍄', title: 'Нашёл грибную поляну', description: 'Собрал немного грибов для ужина', effect: { energy: 5 } },
            { type: 'obstacle', emoji: '🪨', title: 'Завал на пути', description: 'Пришлось обходить большую груду камней', effect: { time: 120 } },
            { type: 'weather', emoji: '🌧️', title: 'Внезапный дождь', description: 'Промок, но нашёл укрытие', effect: { energy: -3 } },
            { type: 'treasure', emoji: '💰', title: 'Нашёл клад!', description: 'Старая шкатулка с монетами', effect: { coins: 25 } },
            { type: 'animal', emoji: '🦊', title: 'Следы лисы', description: 'Проследил за ними и нашёл нору', effect: { xp: 10 } },
            { type: 'plant', emoji: '🌿', title: 'Лекарственные травы', description: 'Собрал целебные растения', effect: { health: 10 } },
            { type: 'artifact', emoji: '🔮', title: 'Древний артефакт', description: 'Нашёл странный предмет неизвестного назначения', effect: { item: 'mysterious_artifact' } },
            { type: 'help', emoji: '🐦', title: 'Помог птице', description: 'Вернул выпавшего птенца в гнездо', effect: { karma: 5 } },
            { type: 'danger', emoji: '🐍', title: 'Встреча со змеёй', description: 'Осторожно обошёл опасное существо', effect: { energy: -5 } },
            { type: 'food', emoji: '🍎', title: 'Фруктовое дерево', description: 'Насобирал спелых фруктов', effect: { energy: 8 } },
            { type: 'water', emoji: '💧', title: 'Чистый источник', description: 'Напился кристально чистой воды', effect: { energy: 6, health: 5 } },
            { type: 'rest', emoji: '😴', title: 'Удачное место для отдыха', description: 'Отдохнул в уютном месте', effect: { energy: 12 } },
            { type: 'map', emoji: '🗺️', title: 'Нашёл карту', description: 'Старая карта с отметками', effect: { navigation: 10 } },
            { type: 'tool', emoji: '🔧', title: 'Потерянный инструмент', description: 'Нашёл полезный инструмент', effect: { efficiency: 5 } },
            { type: 'riddle', emoji: '🤔', title: 'Загадка на камне', description: 'Разгадал древнюю загадку', effect: { wisdom: 8 } },
            { type: 'bridge', emoji: '🌉', title: 'Мост через реку', description: 'Нашёл безопасную переправу', effect: { time: -180 } },
            { type: 'cave', emoji: '🕳️', title: 'Обнаружил пещеру', description: 'Исследовал и нашёл интересные образования', effect: { courage: 7 } },
            { type: 'fire', emoji: '🔥', title: 'Развёл костёр', description: 'Согрелся и приготовил еду', effect: { energy: 10, warmth: 15 } },
            { type: 'storm', emoji: '⛈️', title: 'Гроза', description: 'Переждал бурю в укрытии', effect: { time: 300, energy: -8 } },
            { type: 'friends', emoji: '👥', title: 'Встреча с другими путешественниками', description: 'Обменялись опытом и историями', effect: { knowledge: 12 } },
            { type: 'lost', emoji: '🧭', title: 'Немного заблудился', description: 'Потратил время на поиск пути', effect: { time: 240, orientation: 5 } },
            { type: 'view', emoji: '🏞️', title: 'Захватывающий вид', description: 'Поднялся на холм с панорамным видом', effect: { inspiration: 10 } },
            { type: 'fishing', emoji: '🎣', title: 'Удачная рыбалка', description: 'Поймал несколько рыбин', effect: { food: 15 } },
            { type: 'berry', emoji: '🫐', title: 'Ягодная поляна', description: 'Собрал корзину ягод', effect: { energy: 7, health: 4 } },
            { type: 'photo', emoji: '📸', title: 'Фотография природы', description: 'Сделал красивые снимки', effect: { memory: 8 } },
            { type: 'meditation', emoji: '🧘', title: 'Медитация на природе', description: 'Помедитировал в тихом месте', effect: { peace: 12 } },
            { type: 'bird', emoji: '🦜', title: 'Разговор с попугаем', description: 'Попугай повторял интересные фразы', effect: { amusement: 9 } },
            { type: 'waterfall', emoji: '🌈', title: 'Водопад с радугой', description: 'Увидел красивое природное явление', effect: { joy: 15 } },
            { type: 'star', emoji: '⭐', title: 'Звёздная ночь', description: 'Наблюдал за звёздами в чистом небе', effect: { wonder: 10 } }
        ];

        // Погодные условия
        const WEATHER_TYPES = [
            { id: 'sunny', emoji: '☀️', name: 'Солнечно', color: '#fbbf24', effects: { energy: 2, speed: 1 } },
            { id: 'cloudy', emoji: '☁️', name: 'Облачно', color: '#9ca3af', effects: { energy: 0, speed: 0 } },
            { id: 'rainy', emoji: '🌧️', name: 'Дождь', color: '#3b82f6', effects: { energy: -1, speed: -1 } },
            { id: 'stormy', emoji: '⛈️', name: 'Гроза', color: '#4f46e5', effects: { energy: -3, speed: -2, danger: 2 } },
            { id: 'snowy', emoji: '❄️', name: 'Снег', color: '#dbeafe', effects: { energy: -2, speed: -3, cold: 2 } },
            { id: 'foggy', emoji: '🌫️', name: 'Туман', color: '#e5e7eb', effects: { energy: 0, speed: -2, visibility: -3 } },
            { id: 'windy', emoji: '💨', name: 'Ветер', color: '#a5f3fc', effects: { energy: -1, speed: 2 } },
            { id: 'perfect', emoji: '🌈', name: 'Идеально', color: '#8b5cf6', effects: { energy: 3, speed: 2, luck: 2 } }
        ];

        // Времена суток
        const TIME_OF_DAY = [
            { id: 'dawn', emoji: '🌅', name: 'Рассвет', color: '#f59e0b', effects: { energy: 2, beauty: 3 } },
            { id: 'morning', emoji: '🌄', name: 'Утро', color: '#fbbf24', effects: { energy: 3, speed: 1 } },
            { id: 'noon', emoji: '☀️', name: 'Полдень', color: '#fde047', effects: { energy: 1, heat: 2 } },
            { id: 'afternoon', emoji: '🌤️', name: 'День', color: '#a3e635', effects: { energy: 2, comfort: 2 } },
            { id: 'dusk', emoji: '🌇', name: 'Закат', color: '#fb923c', effects: { energy: 0, beauty: 4 } },
            { id: 'evening', emoji: '🌆', name: 'Вечер', color: '#c084fc', effects: { energy: -1, peace: 3 } },
            { id: 'night', emoji: '🌃', name: 'Ночь', color: '#1e3a8a', effects: { energy: -2, stealth: 3 } },
            { id: 'midnight', emoji: '🌌', name: 'Полночь', color: '#312e81', effects: { energy: -3, mystery: 4 } }
        ];

        // ========== ENHANCED ADVENTURE SYSTEM ==========
        class EnhancedAdventureSystem extends AdventureSystem {
            constructor() {
                super();
                this.journeyEvents = JOURNEY_EVENTS;
                this.weatherTypes = WEATHER_TYPES;
                this.timeOfDay = TIME_OF_DAY;
                this.currentWeather = this.getRandomWeather();
                this.currentTime = this.getCurrentTime();
                this.storyLog = [];
                this.uniqueItems = UNIQUE_ITEMS;
                this.weeklyStories = ADVENTURE_STORIES.weekly;
                this.seasonalStories = ADVENTURE_STORIES.seasonal;
                this.seasonalExpeditionsUnlocked = false;
                
                // Расширяем типы приключений
                this.adventureTypes.weekly = {
                    name: 'Недельное приключение',
                    emoji: '🗓️',
                    duration: 604800, // 7 дней
                    energy: 200,
                    reward: { 
                        coins: 500, 
                        xp: 300, 
                        items: this.getRandomUniqueItems(2, ['uncommon', 'rare']),
                        unlock: 'seasonal_expedition'
                    },
                    requirement: { perfectDays: 7, level: 5 }
                };

                this.adventureTypes.seasonal = {
                    name: 'Сезонная экспедиция',
                    emoji: '🗺️',
                    duration: 2592000, // 30 дней
                    energy: 500,
                    reward: { 
                        coins: 2000, 
                        xp: 1000, 
                        items: this.getRandomUniqueItems(3, ['rare', 'epic', 'legendary']),
                        title: 'Мастер экспедиций'
                    },
                    requirement: { perfectDays: 30, level: 10, completedWeekly: 3 }
                };
            }

            getRandomWeather() {
                return this.weatherTypes[Math.floor(Math.random() * this.weatherTypes.length)];
            }

            getCurrentTime() {
                const hour = new Date().getHours();
                if (hour >= 5 && hour < 9) return this.timeOfDay[0]; // dawn
                if (hour >= 9 && hour < 12) return this.timeOfDay[1]; // morning
                if (hour >= 12 && hour < 14) return this.timeOfDay[2]; // noon
                if (hour >= 14 && hour < 17) return this.timeOfDay[3]; // afternoon
                if (hour >= 17 && hour < 19) return this.timeOfDay[4]; // dusk
                if (hour >= 19 && hour < 22) return this.timeOfDay[5]; // evening
                if (hour >= 22 && hour < 24) return this.timeOfDay[6]; // night
                return this.timeOfDay[7]; // midnight
            }

            getRandomUniqueItems(count, rarities) {
                const filteredItems = this.uniqueItems.filter(item => 
                    rarities.includes(item.rarity)
                );
                
                const shuffled = [...filteredItems].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, count).map(item => item.id);
            }

            addStoryEntry(message, type = 'info') {
                const entry = {
                    timestamp: new Date().toISOString(),
                    message: message,
                    type: type
                };
                
                this.storyLog.unshift(entry);
                
                // Ограничиваем лог 50 записями
                if (this.storyLog.length > 50) {
                    this.storyLog.pop();
                }
                
                return entry;
            }

            generateJourneyEvents(adventure) {
                const events = [];
                const pointCount = 5; // Количество точек на пути
                
                for (let i = 1; i <= pointCount; i++) {
                    const progress = (i / pointCount) * 100;
                    const randomEvent = this.journeyEvents[Math.floor(Math.random() * this.journeyEvents.length)];
                    
                    events.push({
                        ...randomEvent,
                        progressPoint: progress,
                        timestamp: Date.now() + (adventure.duration * (i / pointCount) * 1000),
                        triggered: false
                    });
                }
                
                return events;
            }

            startAdventure(type, locationId) {
                const adventureType = this.adventureTypes[type];
                if (!adventureType) return;
                
                // Проверка требований для специальных приключений
                if (type === 'weekly' || type === 'seasonal') {
                    const canStart = this.checkAdventureRequirements(type);
                    if (!canStart) return;
                }
                
                // Проверка энергии
                if (this.energy < adventureType.energy) {
                    window.animationManager.showFloatingMessage('Недостаточно энергии!', 'error');
                    window.animationManager.vibrateError();
                    return;
                }
                
                const location = locationId ? 
                    this.locations.find(l => l.id === locationId) : 
                    this.selectRandomLocation();
                    
                if (!location) return;
                
                // Создание вылазки с улучшенной структурой
                const adventure = {
                    id: `adventure_${Date.now()}`,
                    type: type,
                    name: adventureType.name,
                    emoji: adventureType.emoji || this.getAdventureEmoji(type),
                    location: location.id,
                    locationName: location.name,
                    duration: adventureType.duration,
                    energy: adventureType.energy,
                    reward: { ...adventureType.reward },
                    startedAt: Date.now(),
                    completed: false,
                    currentProgress: 0,
                    journeyEvents: this.generateJourneyEvents(adventureType),
                    story: type === 'weekly' ? this.weeklyStories : 
                           type === 'seasonal' ? this.seasonalStories : 
                           ADVENTURE_STORIES[type] || [],
                    weather: this.getRandomWeather(),
                    timeOfDay: this.getCurrentTime(),
                    from: 'Хатка Бобрика',
                    to: location.name,
                    distance: Math.floor(Math.random() * 100) + 50 // км
                };
                
                // Расход энергии
                this.energy -= adventureType.energy;
                
                // Установка как активной
                this.activeAdventure = adventure;
                this.adventureProgress.set(adventure.id, 0);
                
                // Начальная запись в лог
                this.addStoryEntry(`🎒 Начало ${adventure.name} в ${adventure.locationName}!`, 'start');
                this.addStoryEntry(`🌤️ Погода: ${adventure.weather.name} ${adventure.weather.emoji}`, 'weather');
                this.addStoryEntry(`⏰ Время: ${adventure.timeOfDay.name} ${adventure.timeOfDay.emoji}`, 'time');
                
                // Сохранение
                this.saveAdventures();
                
                // Анимация
                window.animationManager.showFloatingMessage(`${adventure.name} началась!`, 'success');
                window.animationManager.vibrateSuccess();
                
                // Обновление UI
                this.updateAdventureUI();
                
                // Запуск таймера с улучшенной логикой
                this.startEnhancedAdventureTimer(adventure.id);
                
                return adventure;
            }

            checkAdventureRequirements(type) {
                const state = StateManager.getState();
                const requirements = this.adventureTypes[type].requirement;
                
                if (!requirements) return true;
                
                // Проверка идеальных дней
                if (requirements.perfectDays && state.stats.perfectDays < requirements.perfectDays) {
                    window.animationManager.showFloatingMessage(
                        `Требуется ${requirements.perfectDays} идеальных дней! У вас: ${state.stats.perfectDays}`,
                        'error'
                    );
                    return false;
                }
                
                // Проверка уровня
                if (requirements.level && state.user.level < requirements.level) {
                    window.animationManager.showFloatingMessage(
                        `Требуется уровень ${requirements.level}! Ваш уровень: ${state.user.level}`,
                        'error'
                    );
                    return false;
                }
                
                // Проверка выполненных недельных вылазок
                if (requirements.completedWeekly) {
                    const completedWeekly = this.adventures.filter(a => 
                        a.type === 'weekly' && a.completed
                    ).length;
                    
                    if (completedWeekly < requirements.completedWeekly) {
                        window.animationManager.showFloatingMessage(
                            `Требуется ${requirements.completedWeekly} недельных вылазок! Выполнено: ${completedWeekly}`,
                            'error'
                        );
                        return false;
                    }
                }
                
                return true;
            }

            startEnhancedAdventureTimer(adventureId) {
                const updateInterval = setInterval(() => {
                    const adventure = this.activeAdventure;
                    if (!adventure || adventure.id !== adventureId) {
                        clearInterval(updateInterval);
                        return;
                    }
                    
                    const currentProgress = this.adventureProgress.get(adventureId) || 0;
                    const newProgress = currentProgress + 1;
                    
                    // Обновление прогресса
                    this.adventureProgress.set(adventureId, newProgress);
                    adventure.currentProgress = (newProgress / adventure.duration) * 100;
                    
                    // Проверка событий в пути
                    this.checkJourneyEvents(adventure, newProgress);
                    
                    // Обновление погоды и времени (каждые 10% прогресса)
                    if (newProgress % Math.floor(adventure.duration / 10) === 0) {
                        this.updateAdventureEnvironment(adventure);
                    }
                    
                    // Проверка завершения
                    if (newProgress >= adventure.duration) {
                        clearInterval(updateInterval);
                        this.completeAdventure(adventureId);
                    }
                    
                    // Обновление UI каждые 5 секунд
                    if (newProgress % 5 === 0) {
                        this.updateAdventureUI();
                    }
                    
                }, 1000); // Обновление каждую секунду
            }

            checkJourneyEvents(adventure, progress) {
                if (!adventure.journeyEvents) return;
                
                const progressPercentage = (progress / adventure.duration) * 100;
                
                adventure.journeyEvents.forEach(event => {
                    if (!event.triggered && progressPercentage >= event.progressPoint) {
                        event.triggered = true;
                        event.triggeredAt = Date.now();
                        
                        // Добавление в лог
                        this.addStoryEntry(
                            `${event.emoji} ${event.title}: ${event.description}`,
                            event.type
                        );
                        
                        // Применение эффектов
                        this.applyEventEffect(event.effect);
                        
                        // Анимация
                        window.animationManager.createParticles({
                            count: 15,
                            x: window.innerWidth / 2,
                            y: window.innerHeight / 2,
                            colors: ['#FFD700', '#FF6B6B', '#4ECDC4']
                        });
                    }
                });
            }

            updateAdventureEnvironment(adventure) {
                // Случайное изменение погоды
                if (Math.random() > 0.7) {
                    adventure.weather = this.getRandomWeather();
                    this.addStoryEntry(
                        `🌤️ Погода изменилась: ${adventure.weather.name} ${adventure.weather.emoji}`,
                        'weather'
                    );
                }
                
                // Изменение времени суток (на основе реального времени)
                adventure.timeOfDay = this.getCurrentTime();
            }

            completeAdventure(adventureId) {
                const adventure = this.activeAdventure;
                if (!adventure || adventure.id !== adventureId) return;
                
                // Отмечаем как завершенную
                adventure.completed = true;
                adventure.completedAt = new Date().toISOString();
                adventure.actualDuration = Date.now() - adventure.startedAt;
                
                // Добавляем финальную запись
                this.addStoryEntry(
                    `🏁 ${adventure.name} успешно завершена! Длительность: ${this.formatDuration(adventure.actualDuration / 1000)}`,
                    'success'
                );
                
                // Добавляем в историю
                this.adventures.push(adventure);
                
                // Выдаем награды
                this.giveEnhancedReward(adventure);
                
                // Обновляем прогресс локации
                this.updateLocationProgress(adventure.location);
                
                // Разблокировка сезонных экспедиций
                if (adventure.type === 'weekly') {
                    const weeklyCount = this.adventures.filter(a => 
                        a.type === 'weekly' && a.completed
                    ).length;
                    
                    if (weeklyCount >= 3) {
                        this.seasonalExpeditionsUnlocked = true;
                        this.addStoryEntry(
                            '🎉 Открыт доступ к сезонным экспедициям!',
                            'unlock'
                        );
                    }
                }
                
                // Очищаем активную вылазку
                this.activeAdventure = null;
                this.adventureProgress.delete(adventureId);
                
                // Сохраняем
                this.saveAdventures();
                
                // Показываем экран завершения
                this.showEnhancedCompletionModal(adventure);
                
                // Обновляем UI
                this.updateAdventureUI();
                
                return adventure;
            }

            giveEnhancedReward(adventure) {
                const state = StateManager.getState();
                
                // Основная награда
                state.user.coins += adventure.reward.coins;
                state.user.xp += adventure.reward.xp;
                
                // Уникальные предметы
                if (adventure.reward.items && adventure.reward.items.length > 0) {
                    adventure.reward.items.forEach(itemId => {
                        const item = this.uniqueItems.find(i => i.id === itemId);
                        if (item) {
                            // Проверяем, есть ли уже такой предмет
                            const existingItem = state.inventory.find(i => i.id === itemId);
                            
                            if (existingItem) {
                                // Увеличиваем количество
                                existingItem.quantity = (existingItem.quantity || 1) + 1;
                            } else {
                                // Добавляем новый предмет
                                state.inventory.push({
                                    ...item,
                                    quantity: 1,
                                    obtainedAt: new Date().toISOString(),
                                    obtainedFrom: adventure.name
                                });
                            }
                            
                            // Запись в лог
                            this.addStoryEntry(
                                `🎁 Получен предмет: ${item.emoji} ${item.name} (${this.getRarityName(item.rarity)})`,
                                'reward'
                            );
                        }
                    });
                }
                
                // Награды за события в пути
                if (adventure.journeyEvents) {
                    adventure.journeyEvents.forEach(event => {
                        if (event.triggered && event.effect) {
                            if (event.effect.coins) {
                                state.user.coins += event.effect.coins;
                            }
                            if (event.effect.xp) {
                                state.user.xp += event.effect.xp;
                            }
                            if (event.effect.energy) {
                                this.energy = Math.min(this.maxEnergy, this.energy + event.effect.energy);
                            }
                        }
                    });
                }
                
                // Награда за идеальные дни
                if (adventure.type === 'seasonal') {
                    state.stats.perfectDays += 7; // Бонус за сезонную экспедицию
                }
                
                StateManager.saveState(state);
            }

            getRarityName(rarity) {
                const names = {
                    'common': 'Обычный',
                    'uncommon': 'Необычный',
                    'rare': 'Редкий',
                    'epic': 'Эпический',
                    'legendary': 'Легендарный'
                };
                return names[rarity] || rarity;
            }

            renderEnhancedAdventureMenu() {
                return `
                    <div class="adventure-menu">
                        <div class="adventure-header">
                            <h3>🌲 Улучшенные вылазки</h3>
                            <div class="energy-display">
                                <div class="energy-bar">
                                    <div class="energy-fill" style="width: ${(this.energy / this.maxEnergy) * 100}%"></div>
                                </div>
                                <div class="energy-text">
                                    <span class="energy-emoji">⚡</span>
                                    <span>${this.energy}/${this.maxEnergy}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${this.renderActiveAdventureWithProgress()}
                        
                        <div class="adventure-types">
                            <h4>Типы вылазок:</h4>
                            <div class="adventure-type-grid">
                                ${this.renderEnhancedAdventureOptions()}
                            </div>
                        </div>
                        
                        <div class="story-log-container">
                            <h4>📖 Журнал событий:</h4>
                            ${this.renderStoryLog()}
                        </div>
                        
                        <div class="unique-items-preview">
                            <h4>🎁 Уникальные предметы:</h4>
                            ${this.renderUniqueItemsPreview()}
                        </div>
                    </div>
                `;
            }

            renderActiveAdventureWithProgress() {
                if (!this.activeAdventure) {
                    return `
                        <div class="active-adventure empty">
                            <div class="empty-state">
                                <div class="empty-state-icon">🌲</div>
                                <p>Нет активных вылазок</p>
                                <p class="text-muted">Выберите вылазку ниже, чтобы начать приключение!</p>
                            </div>
                        </div>
                    `;
                }
                
                const adventure = this.activeAdventure;
                const progress = this.adventureProgress.get(adventure.id) || 0;
                const progressPercentage = (progress / adventure.duration) * 100;
                
                return `
                    <div class="active-adventure ${adventure.type === 'weekly' ? 'adventure-type-weekly' : ''} ${adventure.type === 'seasonal' ? 'adventure-type-seasonal' : ''}">
                        <div class="adventure-header">
                            <div class="adventure-emoji">${adventure.emoji}</div>
                            <div class="adventure-title">
                                <h4>${adventure.name}</h4>
                                <div class="adventure-subtitle">
                                    <span>${adventure.from} → ${adventure.to}</span>
                                    <span class="adventure-distance">${adventure.distance} км</span>
                                </div>
                            </div>
                            <div class="adventure-time">
                                <span class="time-emoji">${adventure.timeOfDay.emoji}</span>
                                <span>${adventure.timeOfDay.name}</span>
                            </div>
                        </div>
                        
                        <div class="adventure-progress-container">
                            <div class="adventure-journey-path"></div>
                            <div class="adventure-jourway-points">
                                ${[0, 25, 50, 75, 100].map(point => `
                                    <div class="journey-point ${progressPercentage >= point ? 'completed' : ''} ${progressPercentage >= point && progressPercentage < point + 25 ? 'active' : ''}"
                                         style="left: ${point}%">
                                        ${point === 0 ? 'A' : point === 100 ? 'B' : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="adventure-beaver-icon" style="left: ${progressPercentage}%">
                                🦫
                            </div>
                            
                            <div class="adventure-weather-icon">
                                ${adventure.weather.emoji}
                            </div>
                            
                            <div class="adventure-time-indicator">
                                ${this.formatDuration(progress)} / ${this.formatDuration(adventure.duration)}
                            </div>
                        </div>
                        
                        <div class="adventure-progress-info">
                            <div class="progress-text">
                                Прогресс: ${Math.round(progressPercentage)}%
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${progressPercentage}%"></div>
                            </div>
                        </div>
                        
                        ${this.renderActiveJourneyEvents(adventure)}
                        
                        <div class="adventure-controls">
                            <button class="btn btn-secondary" onclick="window.enhancedAdventureSystem.cancelAdventure()">
                                Отменить
                            </button>
                            <button class="btn btn-primary" onclick="window.enhancedAdventureSystem.speedUpAdventure()">
                                ⚡ Ускорить (10 энергии)
                            </button>
                        </div>
                    </div>
                `;
            }

            renderActiveJourneyEvents(adventure) {
                const activeEvents = adventure.journeyEvents?.filter(e => e.triggered) || [];
                
                if (activeEvents.length === 0) {
                    return '<p class="text-muted">События появятся по мере продвижения...</p>';
                }
                
                return `
                    <div class="active-journey-events">
                        <h5>События в пути:</h5>
                        <div class="events-grid">
                            ${activeEvents.slice(-3).map(event => `
                                <div class="event-bubble">
                                    <div class="event-emoji">${event.emoji}</div>
                                    <div class="event-info">
                                        <div class="event-title">${event.title}</div>
                                        <div class="event-desc">${event.description}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            renderEnhancedAdventureOptions() {
                const state = StateManager.getState();
                
                return Object.entries(this.adventureTypes).map(([type, data]) => {
                    const canStart = this.energy >= data.energy && this.checkAdventureRequirements(type);
                    const requirements = data.requirement || {};
                    
                    return `
                        <div class="adventure-option ${type}" data-type="${type}">
                            <div class="option-header">
                                <div class="option-emoji">${data.emoji || this.getAdventureEmoji(type)}</div>
                                <div class="option-title">${data.name}</div>
                            </div>
                            
                            <div class="option-details">
                                <div class="option-detail">
                                    <span class="detail-emoji">⏱️</span>
                                    <span>${this.formatDuration(data.duration)}</span>
                                </div>
                                
                                <div class="option-detail">
                                    <span class="detail-emoji">⚡</span>
                                    <span>${data.energy} энергии</span>
                                </div>
                                
                                <div class="option-detail">
                                    <span class="detail-emoji">🪙</span>
                                    <span>${data.reward.coins} монет</span>
                                </div>
                                
                                <div class="option-detail">
                                    <span class="detail-emoji">⭐</span>
                                    <span>${data.reward.xp} опыта</span>
                                </div>
                            </div>
                            
                            ${requirements.perfectDays ? `
                                <div class="requirements-card">
                                    <h6>Требования:</h6>
                                    <div class="requirement-item ${state.stats.perfectDays >= requirements.perfectDays ? 'completed' : ''}">
                                        <span>${state.stats.perfectDays >= requirements.perfectDays ? '✅' : '⭕'}</span>
                                        <span>${requirements.perfectDays} идеальных дней</span>
                                        <div class="requirement-progress">
                                            <div class="requirement-progress-fill" style="width: ${Math.min(100, (state.stats.perfectDays / requirements.perfectDays) * 100)}%"></div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <button class="btn ${canStart ? 'btn-primary' : 'btn-secondary'} start-adventure-btn"
                                    onclick="${canStart ? `window.enhancedAdventureSystem.startAdventure('${type}')` : ''}"
                                    ${!canStart ? 'disabled' : ''}>
                                ${canStart ? 'Начать вылазку' : 'Недоступно'}
                            </button>
                        </div>
                    `;
                }).join('');
            }

            renderStoryLog() {
                if (this.storyLog.length === 0) {
                    return '<p class="text-muted">Здесь будут отображаться события ваших вылазок</p>';
                }
                
                return `
                    <div class="adventure-story-log">
                        ${this.storyLog.slice(0, 10).map(entry => `
                            <div class="story-entry">
                                <span class="story-time">${new Date(entry.timestamp).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</span>
                                <span class="story-content ${entry.type}">${entry.message}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            renderUniqueItemsPreview() {
                const state = StateManager.getState();
                const uniqueItemsInInventory = state.inventory.filter(item => 
                    this.uniqueItems.some(ui => ui.id === item.id)
                ).slice(0, 5);
                
                if (uniqueItemsInInventory.length === 0) {
                    return '<p class="text-muted">У вас пока нет уникальных предметов</p>';
                }
                
                return `
                    <div class="inventory-grid">
                        ${uniqueItemsInInventory.map(item => {
                            const itemData = this.uniqueItems.find(ui => ui.id === item.id);
                            return `
                                <div class="inventory-slot ${state.user.equipped[itemData.type] === item.id ? 'equipped' : ''}"
                                     onclick="window.enhancedAdventureSystem.showItemModal('${item.id}')">
                                    ${itemData.emoji}
                                    ${item.quantity > 1 ? `<span class="item-quantity">${item.quantity}</span>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <button class="btn btn-secondary" onclick="window.uiManager.showInventoryModal()">
                        Посмотреть все предметы
                    </button>
                `;
            }

            showItemModal(itemId) {
                const item = this.uniqueItems.find(i => i.id === itemId);
                if (!item) return;
                
                const state = StateManager.getState();
                const inventoryItem = state.inventory.find(i => i.id === itemId);
                const isEquipped = state.user.equipped[item.type] === itemId;
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal item-modal">
                        <div class="modal-header">
                            <h3>${item.emoji} ${item.name}</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        
                        <div class="modal-content">
                            <div class="item-preview-large">${item.emoji}</div>
                            
                            <div class="item-rarity ${item.rarity}">
                                ${this.getRarityName(item.rarity)}
                            </div>
                            
                            <div class="item-stats">
                                ${Object.entries(item.stats || {}).map(([stat, value]) => `
                                    <div class="item-stat">
                                        <div class="stat-label">${this.getStatName(stat)}</div>
                                        <div class="stat-value">+${value}</div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${inventoryItem?.obtainedFrom ? `
                                <div class="item-origin">
                                    <p><small>Получено из: ${inventoryItem.obtainedFrom}</small></p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="modal-footer">
                            ${isEquipped ? `
                                <button class="btn btn-secondary" onclick="window.enhancedAdventureSystem.unequipItem('${item.type}')">
                                    Снять
                                </button>
                            ` : `
                                <button class="btn btn-primary" onclick="window.enhancedAdventureSystem.equipItem('${itemId}', '${item.type}')">
                                    Надеть
                                </button>
                            `}
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                                Закрыть
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            getStatName(stat) {
                const names = {
                    'defense': 'Защита',
                    'strength': 'Сила',
                    'agility': 'Ловкость',
                    'speed': 'Скорость',
                    'dexterity': 'Меткость',
                    'luck': 'Удача',
                    'damage': 'Урон',
                    'charm': 'Обаяние',
                    'endurance': 'Выносливость',
                    'stealth': 'Скрытность',
                    'perception': 'Внимание',
                    'wisdom': 'Мудрость',
                    'charisma': 'Харизма',
                    'energy': 'Энергия',
                    'light': 'Свет',
                    'navigation': 'Навигация',
                    'knowledge': 'Знания',
                    'healing': 'Лечение'
                };
                return names[stat] || stat;
            }

            equipItem(itemId, type) {
                const state = StateManager.getState();
                const item = this.uniqueItems.find(i => i.id === itemId);
                
                if (!item) {
                    window.animationManager.showFloatingMessage('Предмет не найден', 'error');
                    return;
                }
                
                // Проверяем, есть ли предмет в инвентаре
                const inventoryItem = state.inventory.find(i => i.id === itemId);
                if (!inventoryItem) {
                    window.animationManager.showFloatingMessage('Предмет не в инвентаре', 'error');
                    return;
                }
                
                // Экипируем
                state.user.equipped[type] = itemId;
                StateManager.saveState(state);
                
                // Обновляем аватар
                if (window.beaverAvatar) {
                    window.beaverAvatar.equipItem(type, itemId);
                }
                
                // Уведомление
                window.animationManager.showFloatingMessage(`${item.emoji} ${item.name} надет!`, 'success');
                window.animationManager.vibrateSuccess();
                
                // Закрываем модальное окно
                document.querySelector('.modal-overlay')?.remove();
                
                // Обновляем UI
                if (window.uiManager.currentPage === 'adventures') {
                    window.uiManager.loadPage('adventures');
                }
            }

            unequipItem(type) {
                const state = StateManager.getState();
                state.user.equipped[type] = null;
                StateManager.saveState(state);
                
                // Обновляем аватар
                if (window.beaverAvatar) {
                    window.beaverAvatar.unequipItem(type);
                }
                
                window.animationManager.showFloatingMessage('Предмет снят', 'info');
                
                // Закрываем модальное окно
                document.querySelector('.modal-overlay')?.remove();
                
                // Обновляем UI
                if (window.uiManager.currentPage === 'adventures') {
                    window.uiManager.loadPage('adventures');
                }
            }

            showEnhancedCompletionModal(adventure) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal adventure-complete-modal">
                        <div class="modal-content">
                            <div class="completion-animation">
                                <div class="completion-emoji">🎉</div>
                                <div class="confetti-container"></div>
                            </div>
                            
                            <h3 class="text-center">${adventure.name} завершена!</h3>
                            <p class="text-center">${adventure.from} → ${adventure.to}</p>
                            
                            <div class="journey-summary">
                                <div class="summary-item">
                                    <div class="summary-icon">⏱️</div>
                                    <div class="summary-content">
                                        <div class="summary-title">Время в пути</div>
                                        <div class="summary-value">${this.formatDuration(adventure.actualDuration / 1000)}</div>
                                    </div>
                                </div>
                                
                                <div class="summary-item">
                                    <div class="summary-icon">🌤️</div>
                                    <div class="summary-content">
                                        <div class="summary-title">Погода</div>
                                        <div class="summary-value">${adventure.weather.name} ${adventure.weather.emoji}</div>
                                    </div>
                                </div>
                                
                                <div class="summary-item">
                                    <div class="summary-icon">📊</div>
                                    <div class="summary-content">
                                        <div class="summary-title">Событий в пути</div>
                                        <div class="summary-value">${adventure.journeyEvents?.filter(e => e.triggered).length || 0}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="adventure-rewards">
                                <h4>Награды:</h4>
                                
                                <div class="rewards-grid">
                                    <div class="reward-item main">
                                        <div class="reward-emoji">🪙</div>
                                        <div class="reward-info">
                                            <div class="reward-amount">+${adventure.reward.coins}</div>
                                            <div class="reward-label">монет</div>
                                        </div>
                                    </div>
                                    
                                    <div class="reward-item main">
                                        <div class="reward-emoji">⭐</div>
                                        <div class="reward-info">
                                            <div class="reward-amount">+${adventure.reward.xp}</div>
                                            <div class="reward-label">опыта</div>
                                        </div>
                                    </div>
                                    
                                    ${adventure.reward.items?.map(itemId => {
                                        const item = this.uniqueItems.find(i => i.id === itemId);
                                        if (!item) return '';
                                        return `
                                            <div class="reward-item unique">
                                                <div class="reward-emoji">${item.emoji}</div>
                                                <div class="reward-info">
                                                    <div class="reward-amount">${item.name}</div>
                                                    <div class="reward-label">${this.getRarityName(item.rarity)}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <div class="completion-story">
                                <h4>История приключения:</h4>
                                <div class="story-excerpt">
                                    ${adventure.story[Math.min(adventure.story.length - 1, Math.floor(adventure.story.length * 0.7))]}
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">
                                Отлично!
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Конфетти
                window.animationManager.createConfetti({
                    count: 200,
                    colors: ['#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', '#EF476F']
                });
                
                // Вибрация
                window.animationManager.vibrate([50, 30, 50, 30, 50, 100, 50, 30, 50]);
                
                // Автозакрытие через 7 секунд
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 7000);
            }

            speedUpAdventure() {
                if (!this.activeAdventure) return;
                
                const cost = 10; // 10 энергии за ускорение
                
                if (this.energy < cost) {
                    window.animationManager.showFloatingMessage('Недостаточно энергии!', 'error');
                    return;
                }
                
                // Расход энергии
                this.energy -= cost;
                
                // Ускоряем вылазку на 1 час
                const currentProgress = this.adventureProgress.get(this.activeAdventure.id) || 0;
                const speedUpAmount = 3600; // 1 час в секундах
                const newProgress = Math.min(this.activeAdventure.duration, currentProgress + speedUpAmount);
                
                this.adventureProgress.set(this.activeAdventure.id, newProgress);
                
                // Добавляем запись в лог
                this.addStoryEntry('⚡ Вылазка ускорена на 1 час!', 'speed');
                
                // Проверяем завершение
                if (newProgress >= this.activeAdventure.duration) {
                    this.completeAdventure(this.activeAdventure.id);
                }
                
                // Уведомление
                window.animationManager.showFloatingMessage('Вылазка ускорена на 1 час!', 'success');
                window.animationManager.vibrateSuccess();
                
                // Обновляем UI
                this.updateAdventureUI();
                this.saveAdventures();
            }

            formatDuration(seconds) {
                if (seconds < 60) return `${seconds}с`;
                if (seconds < 3600) return `${Math.floor(seconds / 60)}м`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)}ч`;
                if (seconds < 604800) return `${Math.floor(seconds / 86400)}д`;
                if (seconds < 2592000) return `${Math.floor(seconds / 604800)}н`;
                return `${Math.floor(seconds / 2592000)}мес`;
            }
        }

        // ========== UPDATED UI MANAGER ==========
        // ========== UPDATED STATE MANAGER ==========
        // ========== ENHANCED BEAVER AVATAR ==========
        // ========== INITIALIZE ENHANCED MANAGERS ==========
        // Инициализация улучшенных менеджеров

        // ========== START APPLICATION ==========
        // Запускаем приложение

        // Глобальные функции для вызова из HTML

        window.closeModal = function() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        };

        // Инициализация при загрузке
        // Запускаем обновление энергии каждую минуту
            setInterval(() => {
                window.enhancedAdventureSystem.updateEnergy();
                window.uiManager.updateEnergyDisplay();
            }, 60000);
            
            // Обновляем прогресс активной вылазки каждую секунду
            setInterval(() => {
                if (window.enhancedAdventureSystem.activeAdventure) {
                    window.enhancedAdventureSystem.updateAdventureUI();
                }
            }, 1000);
        window.animationManager = new AnimationManager();
        window.enhancedShop = new EnhancedShop();
        window.adventureSystem = new EnhancedAdventureSystem();
        window.enhancedAdventureSystem = window.adventureSystem;
        window.uiManager = new UIManager();
</script>
</body>
</html>