<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ü¶´ Beaver Builder ‚Äî –ú–æ–±–∏–ª—å–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫ (v4)</title>
<style>
:root{
  --bg1:#eaf4ff; --bg2:#fff7e8;
  --card:#ffffff; --text:#0b1220; --muted:#6b7280;
  --brand:#34d399; --brand2:#60a5fa; --warn:#f59e0b; --danger:#ef4444;
  --shadow:0 14px 40px rgba(0,0,0,.10);
  --r:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  color:var(--text);
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
}
button{font:inherit; touch-action:manipulation}
a{color:inherit}
#app{min-height:100%; padding-bottom:92px;}
.wrap{max-width:980px;margin:0 auto;padding:12px 12px 0}
.topbar{
  display:flex;gap:10px;align-items:center;justify-content:space-between;
  padding:12px;
  background:rgba(255,255,255,.90);
  border:1px solid rgba(17,24,39,.08);
  border-radius:24px;
  box-shadow: var(--shadow);
}
.title{font-weight:1000;letter-spacing:.2px}
.sub{font-size:12px;color:var(--muted);font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width: 52vw}
.stats{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pill{
  display:flex;gap:8px;align-items:center;
  padding:7px 10px;border-radius:999px;
  background:#fff;border:1px solid rgba(17,24,39,.10);
  font-weight:900;font-size:13px;
}
.pill small{font-size:12px;color:var(--muted);font-weight:800}
.xpbar{height:10px;border-radius:999px;background:rgba(17,24,39,.10);overflow:hidden;margin-top:6px}
.xpbar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2));border-radius:999px;transition:width .45s ease}

.grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
@media (min-width:860px){.grid{grid-template-columns:1.05fr .95fr}}
.card{
  background:var(--card);
  border-radius:calc(var(--r) + 6px);
  box-shadow: var(--shadow);
  border:1px solid rgba(17,24,39,.06);
  padding:14px;
}
.h{display:flex;align-items:center;justify-content:space-between;gap:10px}
.h h3{margin:0;font-size:16px}
.muted{color:var(--muted);font-size:12px;font-weight:800}
.sep{height:1px;background:rgba(17,24,39,.08);margin:12px 0}

.btn{
  border:1px solid rgba(17,24,39,.14);
  background:#fff;
  padding:10px 12px;border-radius:14px;
  font-weight:1000;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
  transition: transform .06s ease, filter .15s ease;
}
.btn:active{transform: translateY(1px) scale(.99)}
.btn.primary{background:linear-gradient(135deg,var(--brand),#a7f3d0); border-color:rgba(16,185,129,.35); color:#064e3b}
.btn.blue{background:linear-gradient(135deg,var(--brand2),#bfdbfe); border-color:rgba(59,130,246,.35); color:#0b2a55}
.btn.warn{background:linear-gradient(135deg,#fbbf24,#fde68a); border-color:rgba(245,158,11,.35); color:#3a2a00}
.btn.danger{background:linear-gradient(135deg,#fb7185,#fecdd3); border-color:rgba(239,68,68,.35); color:#7f1d1d}
.btn.ghost{background:transparent}
.btn.sm{padding:8px 10px;border-radius:12px;font-size:13px}
.btn.full{width:100%}
.btnRow{display:flex;gap:10px;flex-wrap:wrap}
.tag{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 9px;border-radius:999px;
  background:rgba(52,211,153,.14);
  border:1px solid rgba(52,211,153,.28);
  color:#065f46;
  font-weight:1000;font-size:12px;
}
.lock{background:rgba(17,24,39,.06);border:1px solid rgba(17,24,39,.10);padding:4px 9px;border-radius:999px;font-weight:1000;font-size:12px;color:#334155}
.own{background:rgba(52,211,153,.18);border:1px solid rgba(52,211,153,.30);padding:4px 9px;border-radius:999px;font-weight:1000;font-size:12px;color:#065f46}

.habits{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.habit{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(17,24,39,.08);
  background:linear-gradient(180deg,#ffffff,#f8fafc);
}
.habit .left{display:flex;gap:10px;align-items:center;min-width:0}
.habit .emoji{font-size:22px}
.habit .name{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.habit .meta{font-size:12px;color:var(--muted);font-weight:800}
.toggle{
  width:56px;height:34px;border-radius:999px;
  border:1px solid rgba(17,24,39,.12);
  background:rgba(17,24,39,.12);
  position:relative;
  cursor:pointer;
  padding:0;
}
.toggle::after{
  content:"";
  position:absolute;top:50%;left:3px;
  width:28px;height:28px;border-radius:999px;
  background:#fff;
  transform: translateY(-50%);
  box-shadow:0 8px 20px rgba(0,0,0,.12);
  transition:left .18s ease, background .18s ease;
}
.toggle.on{background:rgba(52,211,153,.32);border-color:rgba(52,211,153,.35)}
.toggle.on::after{left:25px;background:#ecfdf5}

.kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi .box{
  flex:1; min-width: 110px;
  border-radius:16px;
  padding:10px 12px;
  border:1px solid rgba(17,24,39,.08);
  background:linear-gradient(180deg,#fff,#f8fafc);
}
.kpi .box b{display:block;font-size:14px}
.kpi .box span{display:block;font-size:12px;color:var(--muted);font-weight:900;margin-top:3px}
.note{font-size:12px;color:var(--muted);font-weight:800;line-height:1.35}

.nav{
  position:fixed;left:0;right:0;bottom:0;
  padding:10px 12px calc(10px + env(safe-area-inset-bottom));
  background:rgba(255,255,255,.92);
  border-top:1px solid rgba(17,24,39,.10);
  display:flex;justify-content:space-between;gap:8px;
  z-index:50;
}
.nav button{
  flex:1;
  border:1px solid rgba(17,24,39,.10);
  background:linear-gradient(180deg,#fff,#f8fafc);
  padding:10px 8px;border-radius:16px;
  font-weight:1000;font-size:12px;
  cursor:pointer;
  display:flex;flex-direction:column;align-items:center;gap:4px;
  -webkit-tap-highlight-color: transparent;
}
.nav button.active{border-color:rgba(52,211,153,.50);box-shadow:0 10px 30px rgba(16,185,129,.18)}
.nav .ico{font-size:18px;line-height:1}

.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.42);
  display:none;
  align-items:flex-end;
  justify-content:center;
  z-index:100;
}
.modal.show{display:flex}
.sheet{
  width:min(920px,100%);
  border-radius:24px 24px 0 0;
  background:#fff;
  box-shadow:0 -20px 60px rgba(0,0,0,.25);
  padding:14px;
  max-height: 90vh;
  overflow:auto;
}
.sheet h2{margin:0 0 8px;font-size:18px}
.field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
.field label{font-size:12px;color:var(--muted);font-weight:1000}
input{
  border:1px solid rgba(17,24,39,.14);
  border-radius:14px;
  padding:12px;
  font-weight:900;
  outline:none;
}
.picker{
  display:grid;grid-template-columns:repeat(10,1fr);
  gap:6px;
  background:linear-gradient(180deg,#fff,#f8fafc);
  border:1px solid rgba(17,24,39,.08);
  padding:10px;border-radius:16px;
}
@media (max-width:420px){.picker{grid-template-columns:repeat(8,1fr)}}
.emoBtn{
  border:1px solid rgba(17,24,39,.10);
  background:#fff;
  border-radius:12px;
  padding:8px;
  font-size:18px;
  cursor:pointer;
}
.emoBtn.sel{outline:3px solid rgba(52,211,153,.35)}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{
  border:1px solid rgba(17,24,39,.12);
  background:#fff;
  padding:8px 10px;border-radius:999px;
  font-weight:1000;font-size:12px;
  cursor:pointer;
}
.chip.on{background:rgba(96,165,250,.16);border-color:rgba(96,165,250,.35)}

.list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.item{
  border:1px solid rgba(17,24,39,.10);
  border-radius:18px;
  background:linear-gradient(180deg,#fff,#f8fafc);
  padding:12px;
  display:flex;gap:12px;justify-content:space-between;align-items:flex-start;
}
.item .l{min-width:0}
.item .name{font-weight:1100}
.item .desc{font-size:12px;color:var(--muted);font-weight:800;margin-top:4px;line-height:1.25}
.item .cost{margin-top:8px;font-size:12px;color:#0f172a;font-weight:1000}
.item .r{display:flex;flex-direction:column;gap:8px;align-items:flex-end}

.resGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
@media (min-width:520px){.resGrid{grid-template-columns:repeat(4,1fr)}}
.resBox{
  padding:10px 12px;border-radius:16px;
  background:linear-gradient(180deg,#fff,#f8fafc);
  border:1px solid rgba(17,24,39,.08);
  font-weight:1100;
}
.resBox .k{font-size:12px;color:var(--muted);font-weight:1000}
.resBox .v{font-size:18px;margin-top:2px}

.toast{
  position:fixed;left:50%;bottom:96px;
  transform:translateX(-50%);
  padding:10px 12px;border-radius:999px;
  background:rgba(17,24,39,.92);
  color:#fff;font-weight:1000;font-size:13px;
  opacity:0;pointer-events:none;
  transition: opacity .2s ease, transform .2s ease;
  z-index:200;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-2px)}

/* Mascot */
.mascotWrap{display:flex;flex-direction:column;gap:10px}
.mascotTop{display:flex;gap:12px;align-items:center;justify-content:space-between}
.bubble{
  flex:1;
  border-radius:20px;
  background:linear-gradient(180deg,#ffffff,#f8fafc);
  border:1px solid rgba(17,24,39,.08);
  padding:10px 12px;
  font-weight:1100;
  line-height:1.25;
  min-height:74px;
  position:relative;
}
.bubble::after{
  content:"";
  position:absolute;
  left:-8px;top:18px;
  width:16px;height:16px;
  background:linear-gradient(180deg,#fff,#f8fafc);
  border-left:1px solid rgba(17,24,39,.08);
  border-bottom:1px solid rgba(17,24,39,.08);
  transform: rotate(45deg);
}
#beaverStage{
  width:196px; height:196px;
  border-radius:34px;
  background: radial-gradient(circle at 30% 25%, #ffffff, #dbeafe);
  border:1px solid rgba(17,24,39,.08);
  box-shadow:0 16px 40px rgba(59,130,246,.15);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
  position:relative;
}
#beaverSVG{width:186px;height:186px}
#beaverStage.float #beaverSVG{animation: floaty 2.6s ease-in-out infinite}
@keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
#beaverStage.hype #beaverSVG{animation: hype .55s ease-in-out 1}
@keyframes hype{0%{transform:scale(1)}35%{transform:scale(1.05) rotate(-1deg)}70%{transform:scale(1.02) rotate(1deg)}100%{transform:scale(1)}}
#beaverStage.angry #beaverSVG{animation: angry .45s ease-in-out 1}
@keyframes angry{0%{transform:translateX(0)}20%{transform:translateX(-3px)}40%{transform:translateX(3px)}60%{transform:translateX(-2px)}80%{transform:translateX(2px)}100%{transform:translateX(0)}}
.blink{animation: blink 6s infinite}
@keyframes blink{0%,96%,100%{transform:scaleY(1)}97%{transform:scaleY(.15)}98%{transform:scaleY(1)}}
</style>
</head>
<body>
<div id="app">
  <div class="wrap">
    <div class="topbar">
      <div style="min-width:0">
        <div class="title">ü¶´ Beaver Builder</div>
        <div class="sub" id="subline">–º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Ä¢ –≤—Å—ë –∫–ª–∏–∫–∞–µ—Ç—Å—è</div>
        <div class="sub" id="tapline" style="opacity:.75">—Ç–∞–ø—ã: 0</div>
        <div class="xpbar"><div id="xpFill"></div></div>
      </div>
      <div class="stats">
        <div class="pill"><span id="lvlTxt">Lv 1</span> <small id="rankTxt">–°–∞–∂–µ–Ω–µ—Ü</small></div>
        <div class="pill">ü™ô <span id="coinsTxt">0</span></div>
        <div class="pill">üî• <span id="streakTxt">0</span></div>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="panelMain"></div>

      <div class="card">
        <div class="mascotWrap">
          <div class="mascotTop">
            <div id="beaverStage" class="float" aria-label="–ë–æ–±—Ä-–º–∞—Å–∫–æ—Ç">
              <svg id="beaverSVG" viewBox="0 0 240 240" role="img" aria-label="–ë–æ–±—Ä —Å—Ç—Ä–æ–∏—Ç–µ–ª—å (–ø–æ–ª–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂)">
                <defs>
                  <radialGradient id="fur" cx="35%" cy="25%" r="85%">
                    <stop offset="0%" stop-color="#e0b089"/>
                    <stop offset="55%" stop-color="#b97a4a"/>
                    <stop offset="100%" stop-color="#7a4e28"/>
                  </radialGradient>
                  <radialGradient id="fur2" cx="35%" cy="25%" r="85%">
                    <stop offset="0%" stop-color="#c9976a"/>
                    <stop offset="100%" stop-color="#6a3f1f"/>
                  </radialGradient>
                  <linearGradient id="shine" x1="0" x2="1">
                    <stop offset="0" stop-color="rgba(255,255,255,.75)"/>
                    <stop offset="1" stop-color="rgba(255,255,255,0)"/>
                  </linearGradient>
                  <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="0" dy="6" stdDeviation="6" flood-opacity="0.25"/>
                  </filter>
                </defs>

                <!-- BG layer -->
                <g id="layer_bg"></g>

                <!-- Tail -->
                <g filter="url(#shadow)">
                  <path d="M170 160 C210 170 215 205 185 220 C165 230 145 220 150 200 C155 185 155 170 170 160Z" fill="rgba(135,80,40,.55)"/>
                  <path d="M168 170 C200 178 202 202 182 210" stroke="rgba(255,255,255,.25)" stroke-width="5" stroke-linecap="round"/>
                </g>

                <!-- Body + Head -->
                <g filter="url(#shadow)">
                  <!-- Legs base -->
                  <ellipse cx="98" cy="196" rx="22" ry="16" fill="url(#fur2)"/>
                  <ellipse cx="142" cy="196" rx="22" ry="16" fill="url(#fur2)"/>
                  <!-- Torso -->
                  <ellipse cx="120" cy="156" rx="70" ry="64" fill="url(#fur)"/>
                  <ellipse cx="120" cy="172" rx="54" ry="44" fill="rgba(255,255,255,.10)"/>
                  <!-- Arms -->
                  <ellipse cx="62" cy="160" rx="20" ry="18" fill="url(#fur2)"/>
                  <ellipse cx="178" cy="160" rx="20" ry="18" fill="url(#fur2)"/>
                  <!-- Head -->
                  <ellipse cx="120" cy="92" rx="74" ry="64" fill="url(#fur)"/>
                  <!-- Ears -->
                  <ellipse cx="72" cy="44" rx="18" ry="20" fill="url(#fur2)"/>
                  <ellipse cx="168" cy="44" rx="18" ry="20" fill="url(#fur2)"/>
                  <ellipse cx="72" cy="48" rx="10" ry="11" fill="rgba(255,255,255,.18)"/>
                  <ellipse cx="168" cy="48" rx="10" ry="11" fill="rgba(255,255,255,.18)"/>
                  <!-- Face patch -->
                  <ellipse cx="120" cy="110" rx="58" ry="42" fill="rgba(255,255,255,.10)"/>
                  <!-- Eyes -->
                  <g class="blink" style="transform-origin:120px 86px">
                    <circle cx="94" cy="86" r="9" fill="#0b0f19"/>
                    <circle cx="146" cy="86" r="9" fill="#0b0f19"/>
                    <circle cx="91" cy="83" r="3" fill="#fff"/>
                    <circle cx="143" cy="83" r="3" fill="#fff"/>
                  </g>
                  <!-- Nose -->
                  <path d="M116 98 Q120 90 124 98 Q120 104 116 98Z" fill="#0b0f19"/>
                  <!-- Teeth -->
                  <rect x="108" y="120" width="12" height="24" rx="4" fill="#fff"/>
                  <rect x="122" y="120" width="12" height="24" rx="4" fill="#fff"/>
                  <rect x="120" y="120" width="1" height="24" fill="rgba(17,24,39,.22)"/>
                  <!-- Blush -->
                  <circle cx="86" cy="112" r="8" fill="rgba(244,63,94,.12)"/>
                  <circle cx="154" cy="112" r="8" fill="rgba(244,63,94,.12)"/>
                </g>

                <!-- Gear overlays -->
                <g id="layer_body"></g>
                <g id="layer_paws"></g>
                <g id="layer_legs"></g>
                <g id="layer_head"></g>

                <!-- Gloss -->
                <path d="M52 82 C70 40 104 28 138 28 C110 46 92 70 84 98 C78 90 64 88 52 82Z" fill="url(#shine)" opacity=".45"/>
              </svg>
            </div>
            <div class="bubble" id="speech">–ó–∞–≥—Ä—É–∂–∞—é —Å—Ç—Ä–æ–π–∫—É‚Ä¶</div>
          </div>

          <div class="btnRow">
            <button type="button" class="btn sm blue" data-act="suggestHabit">üß† –ü–æ–¥–∫–∏–Ω—å –ø—Ä–∏–≤—ã—á–∫—É</button>
            <button type="button" class="btn sm warn" data-act="collect">üì¶ –°–æ–±—Ä–∞—Ç—å –¥–æ–±—ã—á—É</button>
            <button type="button" class="btn sm" data-act="openChest">üéÅ –°—É–Ω–¥—É–∫ –¥–Ω—è</button>
            <button type="button" class="btn sm ghost" data-act="say">üé≠ –ï—â—ë</button>
          </div>
          <div class="note" id="toneHint"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="nav" role="navigation" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
    <button type="button" data-tab="today" class="active"><div class="ico">‚úÖ</div><div>–°–µ–≥–æ–¥–Ω—è</div></button>
    <button type="button" data-tab="habits"><div class="ico">üßæ</div><div>–ü—Ä–∏–≤—ã—á–∫–∏</div></button>
    <button type="button" data-tab="base"><div class="ico">üèóÔ∏è</div><div>–ë–∞–∑–∞</div></button>
    <button type="button" data-tab="shop"><div class="ico">üõ†Ô∏è</div><div>–®–º–æ—Ç–∫–∏</div></button>
    <button type="button" data-tab="me"><div class="ico">üì¶</div><div>–ü—Ä–æ—Ñ–∏–ª—å</div></button>
  </div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="sheet" role="dialog" aria-modal="true" aria-label="–û–∫–Ω–æ">
    <div class="h">
      <h2 id="mTitle">–û–∫–Ω–æ</h2>
      <button type="button" class="btn sm ghost" data-act="closeModal">‚úï</button>
    </div>
    <div id="mBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  var KEY = "beaver_habit_builder_mobile_v4";
  function $(s,r){ return (r||document).querySelector(s); }
  function $all(s,r){ return Array.prototype.slice.call((r||document).querySelectorAll(s)); }
  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
  function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  // If JS fails (old browsers), show visible hint
  window.onerror = function(msg, src, line, col){
    try{
      var t = $("#toast");
      t.textContent = "–û—à–∏–±–∫–∞: " + msg + " (–æ–±–Ω–æ–≤–∏ –±—Ä–∞—É–∑–µ—Ä)";
      t.classList.add("show");
    }catch(e){}
  };

  var RES = [
    ["wood","ü™µ","–©–µ–ø–∫–∏"],
    ["stone","ü™®","–ö–∞–º–µ–Ω—å"],
    ["nails","üß∑","–ì–≤–æ–∑–¥–∏"],
    ["paint","üé®","–ö—Ä–∞—Å–∫–∞"],
    ["gears","‚öôÔ∏è","–®–µ—Å—Ç–µ—Ä—ë–Ω–∫–∏"],
    ["cookies","üç™","–ü–µ—á–µ–Ω—å–∫–∏"],
    ["crystals","üíé","–ö—Ä–∏—Å—Ç–∞–ª–ª—ã"]
  ];

  var EMO = ["üíß","üèÉ","üìö","üß†","ü•¶","üßò","üò¥","ü¶∑","üßº","üßπ","üìù","üéØ","üö∂","üí™","üçé","ü•õ","üéß","üìµ","üïØÔ∏è","üß©","üéπ","üó£Ô∏è","üåø","üß±","üõ†Ô∏è","üì¶","üßØ","‚òÄÔ∏è","‚è≥","üß¥","üßΩ","üõèÔ∏è","üßä","ü´ó","üßò‚Äç‚ôÇÔ∏è"];

  var RANKS = [
    {min:1, name:"–°–∞–∂–µ–Ω–µ—Ü"},
    {min:5, name:"–ü–æ–¥–º–∞—Å—Ç–µ—Ä—å–µ"},
    {min:10, name:"–ü–ª–æ—Ç–Ω–∏–∫ –¥–Ω—è"},
    {min:18, name:"–ü—Ä–æ—Ä–∞–±"},
    {min:28, name:"–ò–Ω–∂–µ–Ω–µ—Ä —Å—Ç—Ä–æ–π–∫–∏"},
    {min:40, name:"–ì–ª–∞–≤–±–æ–±—Ä"},
    {min:55, name:"–õ–µ–≥–µ–Ω–¥–∞ –ø–ª–æ—Ç–∏–Ω—ã"}
  ];

  var BUILDINGS = [
    {id:"sawmill", name:"–õ–µ—Å–æ–ø–∏–ª–∫–∞", icon:"ü™µ", produces:{wood:36}, baseCost:{coins:40, wood:0, stone:10, nails:0}},
    {id:"quarry", name:"–ö–∞–º–µ–Ω–æ–ª–æ–º–Ω—è", icon:"ü™®", produces:{stone:22}, baseCost:{coins:40, wood:10, stone:0, nails:0}},
    {id:"workshop", name:"–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è", icon:"‚öôÔ∏è", produces:{nails:10, gears:6}, baseCost:{coins:70, wood:30, stone:20, nails:0}},
    {id:"paintbooth", name:"–ü–æ–∫—Ä–∞—Å–æ—á–Ω–∞—è", icon:"üé®", produces:{paint:9}, baseCost:{coins:70, wood:20, stone:20, nails:10}},
    {id:"bakery", name:"–ë–æ–±—Ä-–ø–µ–∫–∞—Ä–Ω—è", icon:"üç™", produces:{cookies:14}, baseCost:{coins:90, wood:30, stone:10, nails:14}},
    {id:"lab", name:"–°—Ç—Ä–æ–π-–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è", icon:"üíé", produces:{crystals:3}, baseCost:{coins:140, wood:60, stone:40, nails:35}}
  ];

  var GEAR = [
    // HEAD 5
    {slot:"head", id:"h1", name:"–ö–µ–ø–∫–∞ —Å—Ç–∞–∂—ë—Ä–∞", rarity:"–æ–±—ã—á–Ω–∞—è", cost:{coins:35, wood:15}, perks:{xp:0.04}, desc:"+4% –æ–ø—ã—Ç–∞. –í—Å—ë –µ—â—ë –ø–∞—Ö–Ω–µ—Ç –º–∞–≥–∞–∑–∏–Ω–æ–º."},
    {slot:"head", id:"h2", name:"–ö–∞—Å–∫–∞ –Ω–æ–≤–∏—á–∫–∞", rarity:"—Ä–µ–¥–∫–∞—è", cost:{coins:85, wood:30, nails:10}, perks:{xp:0.08, coins:0.04}, desc:"+8% XP, +4% –º–æ–Ω–µ—Ç. –ó–≤—É–∫ –º—ã—Å–ª–µ–π —Å—Ç–∞–ª –≥–ª—É—à–µ."},
    {slot:"head", id:"h3", name:"–ö–∞—Å–∫–∞ —Å —Ñ–æ–Ω–∞—Ä—ë–º", rarity:"—ç–ø–∏–∫", cost:{coins:160, wood:55, nails:22, gears:10}, perks:{xp:0.12, res:0.06}, desc:"+12% XP, +6% –¥–æ–±—ã—á–∏. –°–≤–µ—Ç–∏—Ç –¥–∞–∂–µ –≤ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏—è—Ö."},
    {slot:"head", id:"h4", name:"–®–ª–µ–º –ø—Ä–æ—Ä–∞–±–∞", rarity:"—ç–ø–∏–∫", cost:{coins:260, stone:80, nails:38, gears:18}, perks:{xp:0.16, coins:0.08, insurance:1}, desc:"+16% XP, +8% –º–æ–Ω–µ—Ç. 1 —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞/–Ω–µ–¥."},
    {slot:"head", id:"h5", name:"–≠–∫–∑–æ—à–ª–µ–º –ì–ª–∞–≤–±–æ–±—Ä–∞", rarity:"–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è", cost:{coins:420, wood:120, stone:120, nails:80, gears:50, crystals:10}, perks:{xp:0.22, coins:0.12, res:0.12, insurance:2}, desc:"+22% XP, +12% –º–æ–Ω–µ—Ç, +12% –¥–æ–±—ã—á–∏. 2 —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏/–Ω–µ–¥."},
    // PAWS 5
    {slot:"paws", id:"p1", name:"–ü–µ—Ä—á–∞—Ç–∫–∏ —Ä–∞–±–æ—Ç—è–≥–∏", rarity:"–æ–±—ã—á–Ω–∞—è", cost:{coins:30, nails:8}, perks:{coins:0.04}, desc:"+4% –º–æ–Ω–µ—Ç. –õ–∞–π–∫, –µ—Å–ª–∏ –Ω–µ –º–µ—Ä–∑–Ω—É—Ç –ª–∞–ø—ã."},
    {slot:"paws", id:"p2", name:"–ö—Ä–∞–≥–∏ –ø—Ä–æ—Ä–∞–±–∞", rarity:"—Ä–µ–¥–∫–∞—è", cost:{coins:90, nails:18, stone:20}, perks:{coins:0.08}, desc:"+8% –º–æ–Ω–µ—Ç. –î–∞, —è —Ç—Ä–æ–≥–∞—é –∂–∏–∑–Ω—å —Ä—É–∫–∞–º–∏."},
    {slot:"paws", id:"p3", name:"–ú–∞–≥–Ω–∏—Ç–Ω—ã–µ –ø–µ—Ä—á–∞—Ç–∫–∏", rarity:"—ç–ø–∏–∫", cost:{coins:170, nails:30, gears:18}, perks:{res:0.08}, desc:"+8% –¥–æ–±—ã—á–∏. –ì–≤–æ–∑–¥–∏ —Å–∞–º–∏ –∏–¥—É—Ç –∫ —Ç–µ–±–µ."},
    {slot:"paws", id:"p4", name:"–ì–∏–¥—Ä–æ–ø–µ—Ä—á–∞—Ç–∫–∏ ¬´–ë–µ–∑ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–π¬ª", rarity:"—ç–ø–∏–∫", cost:{coins:260, paint:40, gears:28}, perks:{xp:0.14}, desc:"+14% XP. –û—Ç–º—ã–≤–∞—é—Ç –¥–∞–∂–µ –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—é."},
    {slot:"paws", id:"p5", name:"–ú–µ—Ö–∞-–ª–∞–ø—ã –ö—Ä–∞–Ω–æ–≤—â–∏–∫–∞", rarity:"–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è", cost:{coins:420, nails:70, gears:70, crystals:12}, perks:{xp:0.18, coins:0.10, res:0.10}, desc:"+18% XP, +10% –º–æ–Ω–µ—Ç, +10% –¥–æ–±—ã—á–∏."},
    // BODY 5
    {slot:"body", id:"b1", name:"–ñ–∏–ª–µ—Ç —Å—Ç—Ä–æ–∏—Ç–µ–ª—è", rarity:"–æ–±—ã—á–Ω–∞—è", cost:{coins:45, wood:20}, perks:{res:0.05}, desc:"+5% –¥–æ–±—ã—á–∏. –ö–∞—Ä–º–∞–Ω—ã –¥–ª—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏."},
    {slot:"body", id:"b2", name:"–ö—É—Ä—Ç–∫–∞ ¬´–°–º–µ–Ω–∫–∞¬ª", rarity:"—Ä–µ–¥–∫–∞—è", cost:{coins:110, wood:35, paint:10}, perks:{xp:0.07, res:0.06}, desc:"+7% XP, +6% –¥–æ–±—ã—á–∏. –í–µ—Ç–µ—Ä –≤–∏–Ω—ã –Ω–µ –ø—Ä–æ–¥—É–≤–∞–µ—Ç."},
    {slot:"body", id:"b3", name:"–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç –ø—Ä–æ—Ä–∞–±–∞", rarity:"—ç–ø–∏–∫", cost:{coins:190, stone:60, nails:25}, perks:{insurance:1, res:0.08}, desc:"1 —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞/–Ω–µ–¥. +8% –¥–æ–±—ã—á–∏. –ü—Ä–æ–ø—É—Å–∫–∏ –æ—Ç—Å–∫–∞–∫–∏–≤–∞—é—Ç."},
    {slot:"body", id:"b4", name:"–ö–æ—Å—Ç—é–º –∏–Ω–∂–µ–Ω–µ—Ä–∞", rarity:"—ç–ø–∏–∫", cost:{coins:290, gears:45, paint:30, nails:35}, perks:{xp:0.14, coins:0.06}, desc:"+14% XP, +6% –º–æ–Ω–µ—Ç. –ú–æ–∑–≥ –≤ —Ä–µ–∂–∏–º–µ ¬´—Å–¥–∞—á–∞ –æ–±—ä–µ–∫—Ç–∞¬ª."},
    {slot:"body", id:"b5", name:"–≠–∫–∑–æ—Å–∫–µ–ª–µ—Ç ¬´–°–¥–∞—ë–º –≤ —Å—Ä–æ–∫¬ª", rarity:"–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è", cost:{coins:520, wood:140, stone:140, gears:90, paint:60, crystals:14}, perks:{xp:0.20, coins:0.12, res:0.12, insurance:2}, desc:"+20% XP, +12% –º–æ–Ω–µ—Ç, +12% –¥–æ–±—ã—á–∏. 2 —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏/–Ω–µ–¥."},
    // LEGS 5
    {slot:"legs", id:"l1", name:"–†–∞–±–æ—á–∏–µ –±–æ—Ç–∏–Ω–∫–∏", rarity:"–æ–±—ã—á–Ω–∞—è", cost:{coins:35, wood:15}, perks:{xp:0.04}, desc:"+4% XP. –ù–µ —Å–∫–æ–ª—å–∑—è—Ç –ø–æ –æ—Ç–º–∞–∑–∫–∞–º."},
    {slot:"legs", id:"l2", name:"–°–∞–ø–æ–≥–∏ —Å —É—Å–∏–ª–µ–Ω–∏–µ–º", rarity:"—Ä–µ–¥–∫–∞—è", cost:{coins:120, stone:35, nails:18}, perks:{res:0.07}, desc:"+7% –¥–æ–±—ã—á–∏. –°–ª—ã—à–Ω–æ, –∫–∞–∫ —Ü–µ–ª–∏ –¥—Ä–æ–∂–∞—Ç."},
    {slot:"legs", id:"l3", name:"–ü—Ä—É–∂–∏–Ω–Ω—ã–µ –±–æ—Ç–∏–Ω–∫–∏", rarity:"—ç–ø–∏–∫", cost:{coins:220, gears:28, nails:35}, perks:{xp:0.12}, desc:"+12% XP. –ü—Ä—ã–≥–∞–µ—à—å –≤—ã—à–µ –ø—Ä–∏–≤—ã—á–µ–∫."},
    {slot:"legs", id:"l4", name:"–ë–æ—Ç–∏–Ω–∫–∏ ¬´–°–º–µ–Ω–∞ –Ω–∞ —Å–º–µ–Ω—É¬ª", rarity:"—ç–ø–∏–∫", cost:{coins:320, gears:40, paint:26, nails:40}, perks:{xp:0.15, coins:0.06}, desc:"+15% XP, +6% –º–æ–Ω–µ—Ç. –ù–µ —É—Å—Ç–∞—ë—à—å –¥–∞–∂–µ –º–æ—Ä–∞–ª—å–Ω–æ."},
    {slot:"legs", id:"l5", name:"–†–∞–∫–µ—Ç–Ω—ã–µ —Å–∞–ø–æ–≥–∏ –ü—Ä–æ–µ–∫—Ç–∞", rarity:"–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è", cost:{coins:520, gears:110, nails:80, crystals:16}, perks:{xp:0.22, res:0.10}, desc:"+22% XP, +10% –¥–æ–±—ã—á–∏. –î–∞, —ç—Ç–æ –ø–µ—Ä–µ–±–æ—Ä. –ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É –∫–∞–π—Ñ."},
    // BG 5
    {slot:"bg", id:"g1", name:"–°–∫–ª–∞–¥ –¥–æ—Å–æ–∫", rarity:"–æ–±—ã—á–Ω–∞—è", cost:{coins:25, wood:25}, perks:{coins:0.03}, desc:"+3% –º–æ–Ω–µ—Ç. –ü–∞—Ö–Ω–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º."},
    {slot:"bg", id:"g2", name:"–°—Ç—Ä–æ–π–ø–ª–æ—â–∞–¥–∫–∞", rarity:"—Ä–µ–¥–∫–∞—è", cost:{coins:90, wood:40, stone:20}, perks:{res:0.06}, desc:"+6% –¥–æ–±—ã—á–∏. –ó–¥–µ—Å—å –¥–∞–∂–µ –ª–µ–Ω—å —Ä–∞–±–æ—Ç–∞–µ—Ç."},
    {slot:"bg", id:"g3", name:"–ö—Ä–∞–Ω –Ω–∞ –∑–∞–∫–∞—Ç–µ", rarity:"—ç–ø–∏–∫", cost:{coins:180, paint:25, gears:18}, perks:{xp:0.10, coins:0.06}, desc:"+10% XP, +6% –º–æ–Ω–µ—Ç. –†–æ–º–∞–Ω—Ç–∏–∫–∞ —Å–¥–∞—á–∏ –æ–±—ä–µ–∫—Ç–∞."},
    {slot:"bg", id:"g4", name:"–ù–æ—á–Ω–æ–π –º–µ–≥–∞–ø—Ä–æ–µ–∫—Ç", rarity:"—ç–ø–∏–∫", cost:{coins:300, gears:55, paint:40, cookies:40}, perks:{xp:0.12, res:0.10}, desc:"+12% XP, +10% –¥–æ–±—ã—á–∏. –ù–æ—á—å, –∫—Ä–∞–Ω, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞."},
    {slot:"bg", id:"g5", name:"–ö–æ—Å–º–æ—Å—Ç—Ä–æ–π ¬´–ü–ª–æ—Ç–∏–Ω–∞-9¬ª", rarity:"–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è", cost:{coins:520, crystals:20, gears:90, paint:70}, perks:{xp:0.18, coins:0.10, res:0.12, insurance:1}, desc:"+18% XP, +10% –º–æ–Ω–µ—Ç, +12% –¥–æ–±—ã—á–∏. 1 —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞/–Ω–µ–¥."}
  ];

  var HABIT_SUGGEST = [
    {emoji:"üíß", name:"–í–æ–¥–∞ 1.5–ª"},
    {emoji:"üèÉ", name:"10 –º–∏–Ω—É—Ç —Ö–æ–¥—å–±—ã"},
    {emoji:"üìö", name:"15 –º–∏–Ω—É—Ç —á—Ç–µ–Ω–∏—è"},
    {emoji:"ü¶∑", name:"–ù–∏—Ç—å –¥–ª—è –∑—É–±–æ–≤"},
    {emoji:"üßò", name:"3 –º–∏–Ω—É—Ç—ã –¥—ã—Ö–∞–Ω–∏—è"},
    {emoji:"üìµ", name:"–ë–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∑–∞ —á–∞—Å –¥–æ —Å–Ω–∞"},
    {emoji:"üìù", name:"3 —Å—Ç—Ä–æ–∫–∏ –¥–Ω–µ–≤–Ω–∏–∫–∞"},
    {emoji:"ü•¶", name:"–û–≤–æ—â–∏ —Å–µ–≥–æ–¥–Ω—è"},
    {emoji:"üí™", name:"15 –æ—Ç–∂–∏–º–∞–Ω–∏–π"},
    {emoji:"üõèÔ∏è", name:"–õ–æ–∂—É—Å—å –¥–æ 00:30"}
  ];

  var TASKS = [
    "–°–¥–µ–ª–∞–π 10 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π. –î–∞, –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å. –Ø —Å–º–æ—Ç—Ä—é.",
    "–ü–æ—Å—Ç–∞–≤—å —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã —Ä—è–¥–æ–º. –í—ã–ø—å–µ—à—å ‚Äî –≤–µ—Ä–Ω—ë—à—å—Å—è –∫–∞–∫ –≥–µ—Ä–æ–π.",
    "–û—Ç–∫—Ä–æ–π –æ–∫–Ω–æ –Ω–∞ 30 —Å–µ–∫—É–Ω–¥. –í–¥–æ—Ö–Ω–∏. –ñ–∏–∑–Ω—å –Ω–µ –±–∞–≥, —Ç—ã –ø—Ä–æ—Å—Ç–æ –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏.",
    "–ù–∞–ø–∏—à–∏ –æ–¥–Ω—É —Ü–µ–ª—å –Ω–∞ –∑–∞–≤—Ç—Ä–∞. –û–¥–Ω—É. –ù–µ —Å–ø–∏—Å–æ–∫ –Ω–∞ 47 –ø—É–Ω–∫—Ç–æ–≤.",
    "–£–±–µ—Ä–∏ 3 –≤–µ—â–∏ –Ω–∞ –º–µ—Å—Ç–æ. –Ø —Å—á–∏—Ç–∞—é.",
    "–ü–æ—Ç—è–Ω–∏—Å—å 20 —Å–µ–∫—É–Ω–¥. –¢—ã –Ω–µ –±—Ä–µ–≤–Ω–æ. –•–æ—Ç—è‚Ä¶ –±—Ä–µ–≤–Ω–æ ‚Äî —ç—Ç–æ —Ä–µ—Å—É—Ä—Å.",
    "–ü—Ä–æ–π–¥–∏ 200 —à–∞–≥–æ–≤ –ø–æ –∫–æ–º–Ω–∞—Ç–µ. –î–∞, –∑–≤—É—á–∏—Ç –≥–ª—É–ø–æ. –ü–æ—ç—Ç–æ–º—É —Ä–∞–±–æ—Ç–∞–µ—Ç."
  ];

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, function(m){
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }

  function localISODate(d){
    d = d || new Date();
    var y = d.getFullYear();
    var m = String(d.getMonth()+1).padStart(2,"0");
    var day = String(d.getDate()).padStart(2,"0");
    return y + "-" + m + "-" + day;
  }
  function addDays(iso,n){
    var p = iso.split("-"); var y=+p[0], m=+p[1], d=+p[2];
    var dt = new Date(y,m-1,d); dt.setDate(dt.getDate()+n);
    return localISODate(dt);
  }
  function daysBetween(a,b){
    var pa=a.split("-"), pb=b.split("-");
    var ta = new Date(+pa[0],+pa[1]-1,+pa[2]).getTime();
    var tb = new Date(+pb[0],+pb[1]-1,+pb[2]).getTime();
    return Math.round((tb-ta)/86400000);
  }
  function weekKey(d){
    d = d || new Date();
    var dt = new Date(d.getTime()); dt.setHours(0,0,0,0);
    dt.setDate(dt.getDate() + 3 - (dt.getDay()+6)%7);
    var week1 = new Date(dt.getFullYear(),0,4);
    var w = 1 + Math.round(((dt - week1)/86400000 - 3 + (week1.getDay()+6)%7)/7);
    return dt.getFullYear() + "-W" + String(w).padStart(2,"0");
  }

  function xpNeed(level){
    return Math.round(80 * Math.pow(level, 1.35));
  }
  function getRank(level){
    var r = RANKS[0].name;
    for(var i=0;i<RANKS.length;i++){
      if(level>=RANKS[i].min) r = RANKS[i].name;
    }
    return r;
  }

  function diffRewards(d){
    if(d==="hard") return {xp:22, coins:12};
    if(d==="normal") return {xp:14, coins:8};
    return {xp:10, coins:6};
  }
  function diffName(d){
    return d==="easy" ? "–ª—ë–≥–∫–∞—è" : (d==="hard" ? "–∂—ë—Å—Ç–∫–∞—è" : "–Ω–æ—Ä–º");
  }

  function defaultState(){
    var now = localISODate();
    var habits = [
      {id:uid(), emoji:"üíß", name:"–í–æ–¥–∞", diff:"easy", xp:10, coins:6, active:true, createdAt:Date.now()},
      {id:uid(), emoji:"üèÉ", name:"10 –º–∏–Ω—É—Ç —Ö–æ–¥—å–±—ã", diff:"easy", xp:10, coins:6, active:true, createdAt:Date.now()},
      {id:uid(), emoji:"üìö", name:"–ß—Ç–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç", diff:"normal", xp:14, coins:8, active:true, createdAt:Date.now()},
      {id:uid(), emoji:"ü¶∑", name:"–ù–∏—Ç—å –¥–ª—è –∑—É–±–æ–≤", diff:"easy", xp:10, coins:6, active:true, createdAt:Date.now()}
    ];
    var b = {};
    for(var i=0;i<BUILDINGS.length;i++){
      var x = BUILDINGS[i];
      b[x.id] = {level: (x.id==="sawmill"?1:0), lastTick: Date.now(), banked:{}};
    }
    var owned = {head:[],paws:[],body:[],legs:[],bg:[]};
    return {
      v:3,
      user:{
        xp:0, level:1, coins:120, streak:0,
        insuranceLeft:0, insuranceWeek:weekKey(new Date()),
        lastDay: now,
        behavior:{wins:0, misses:0, last14:[]},
        chest:{lastOpen:""}
      },
      day:{date: now, done:{}, closed:false, rest:false},
      habits: habits,
      resources:{wood:40, stone:25, nails:0, paint:0, gears:0, cookies:0, crystals:0},
      base:{buildings:b},
      gear:{owned:owned, equipped:{head:null,paws:null,body:null,legs:null,bg:null}},
      quests:{active:null}
    };
  }

  function load(){
    try{
      var raw = localStorage.getItem(KEY);
      if(!raw) return defaultState();
      var st = JSON.parse(raw);
      if(!st || st.v!==3) return defaultState();
      // backfill missing keys safely
      if(!st.user) st.user = defaultState().user;
      if(!st.user.behavior) st.user.behavior = {wins:0, misses:0, last14:[]};
      if(!st.user.chest) st.user.chest = {lastOpen:""};
      if(!st.base || !st.base.buildings) st.base = defaultState().base;
      if(!st.gear || !st.gear.owned || !st.gear.equipped) st.gear = defaultState().gear;
      if(!st.resources) st.resources = defaultState().resources;
      if(!st.day) st.day = defaultState().day;
      if(!st.habits) st.habits = defaultState().habits;
      return st;
    }catch(e){
      return defaultState();
    }
  }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  function toast(msg){
    var t = $("#toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(function(){ t.classList.remove("show"); }, 1600);
  }

  function iconOf(key){
    if(key==="coins") return "ü™ô";
    for(var i=0;i<RES.length;i++) if(RES[i][0]===key) return RES[i][1];
    return "‚Ä¢";
  }
  function costLine(cost){
    var parts = [];
    for(var k in cost){
      var v = cost[k] || 0;
      if(v<=0) continue;
      parts.push(iconOf(k) + " " + v);
    }
    return parts.join(" ‚Ä¢ ") || "‚Äî";
  }

  function sumPerks(){
    var eq = state.gear.equipped;
    var out = {xp:0, coins:0, res:0, insurance:0};
    for(var slot in eq){
      var id = eq[slot];
      if(!id) continue;
      for(var i=0;i<GEAR.length;i++){
        if(GEAR[i].id===id){
          var p = GEAR[i].perks || {};
          if(p.xp) out.xp += p.xp;
          if(p.coins) out.coins += p.coins;
          if(p.res) out.res += p.res;
          if(p.insurance) out.insurance += p.insurance;
          break;
        }
      }
    }
    return out;
  }

  function tone(){
    var b = state.user.behavior;
    var miss = b.misses || 0;
    var win = b.wins || 0;
    var ratio = win / Math.max(1, win + miss);
    if(state.user.streak >= 7 && ratio >= 0.75) return "hype";
    if(state.user.streak >= 3 && ratio >= 0.55) return "banter";
    if(miss >= 2 && ratio < 0.5) return "angry";
    return "neutral";
  }

  // Meme generator: produces thousands (>>400)
  var MEME = (function(){
    var a = ["–Ω—É —á—Ç–æ","–∏—Ç–∞–∫","—Å–ª—É—à–∞–π —Å—é–¥–∞","–¥–∞–≤–∞–π-–∫–∞","–∫–æ—Ä–æ—á–µ","—Å–∏—Ç—É–∞—Ü–∏—è —Ç–∞–∫–∞—è","–º–æ–º–µ–Ω—Ç –∏—Å—Ç–∏–Ω—ã","–Ω–∞ —Å–≤—è–∑–∏","–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —ç—Ç–æ","–ø—Ä–∏—à—ë–ª –≤–∞—à"];
    var b = ["–≥–ª–∞–≤–±–æ–±—Ä","–ø—Ä–æ—Ä–∞–±","–∏–Ω–∂–µ–Ω–µ—Ä –ø–ª–æ—Ç–∏–Ω—ã","–∫–∏—Ä–ø–∏—á –¥—É—à–∏","–∫—Ä–∞–Ω–æ–≤—â–∏–∫ —ç–º–æ—Ü–∏–π","—à–ø–∞—Ç–µ–ª—å –º–æ—Ç–∏–≤–∞—Ü–∏–∏","–¥–æ—Å–∫–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã","–±–µ—Ç–æ–Ω–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥","–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∑–∞–∫–∞–∑—á–∏–∫"];
    var c = ["–æ–≥—É—Ä–µ—Ü","–∫–æ—Ç","—á–∞–π–Ω–∏–∫","–ø–µ–ª—å–º–µ–Ω—å","—Å—Ç—É–ª","—Ç—É–º–±–æ—á–∫–∞","–≤–∏–ª–∫–∞","—à–∞–ø–∫–∞","—Ç–≤–æ—Ä–æ–≥","–∫–∞—Ä–∞–Ω–¥–∞—à","–ø–µ—Ç–∞—Ä–¥–∞","–ø–∏–Ω–≥–≤–∏–Ω","–¥—Ä–∞–∫–æ–Ω","–∫–æ–º–∞—Ä","–º–æ–ª—å","–∫–∞–ø–∏–±–∞—Ä–∞","–∞–±—Ä–∏–∫–æ—Å","–∫–ª–∞–≤–∏—à–∞"];
    var d = ["–±–µ–∑ —Å–º—ã—Å–ª–∞","–≤ —Å–º—ã—Å–ª–µ —Å–º—ã—Å–ª–∞","–Ω–∞ –≤–∞–π–±–µ","–Ω–∞ —Ä–æ–≤–Ω–æ–º –º–µ—Å—Ç–µ","–∫–∞–∫ –±—É–¥—Ç–æ —Ç–∞–∫ –∏ –Ω–∞–¥–æ","—Å –ª–∏—Ü–æ–º ¬´—è –≤—Å—ë –ø–æ–Ω—è–ª¬ª","–≤ —Ä–µ–∂–∏–º–µ ¬´–Ω—É –ª–∞–¥–Ω–æ¬ª","–≤ —Å—Ç–∏–ª–µ ¬´–Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–π¬ª","–ø–æ –∫—Ä–∞—Å–æ—Ç–µ","–ø–æ –ì–û–°–¢—É"];
    var e = ["—Å—Ç–∞–≤—å –≥–∞–ª–æ—á–∫—É","–¥–µ–ª–∞–π –º–∏–∫—Ä–æ-—à–∞–≥","–Ω–µ —Ç–æ—Ä–≥—É–π—Å—è —Å –ª–µ–Ω—å—é","–≤–æ–∑—å–º–∏ –∏ —Å–¥–µ–ª–∞–π","–Ω–µ –¥—Ä–∞–º–∞—Ç–∏–∑–∏—Ä—É–π","–∑–∞–∫—Ä–æ–π –¥–µ–Ω—å","—Å–æ–±–µ—Ä–∏ –¥–æ–±—ã—á—É","–Ω–µ —Å–ª–∏–≤–∞–π —Å–µ—Ä–∏—é","–ø–æ–π–º–∞–π —Ç–µ–º–ø","–Ω–µ –ª–æ–º–∞–π—Å—è"];
    var f = ["–∏ –º—ã —Å—Ç—Ä–æ–∏–º –ø–ª–æ—Ç–∏–Ω—É","–∏ —ç—Ç–æ +XP","–∏ —ç—Ç–æ –º–æ–Ω–µ—Ç–∫–∏","–∏ —è —Ç–µ–±—è –ø–æ—Ö–≤–∞–ª—é (–º–æ–∂–µ—Ç –±—ã—Ç—å)","–∏ –≤—Å—ë, —Ç—ã –º–æ–ª–æ–¥–µ—Ü","–∏ –Ω–∏–∫—Ç–æ –Ω–µ –ø–æ—Å—Ç—Ä–∞–¥–∞–ª","–∏ –º–∏—Ä —Å—Ç–∞–ª —á—É—Ç—å —Ä–æ–≤–Ω–µ–µ","–∏ –∂–∏–∑–Ω—å –ø–æ—à–ª–∞"];
    var spice = ["—è –Ω–µ AI, —è —Ç–≤–æ—è —Å–æ–≤–µ—Å—Ç—å –≤ –∫–∞—Å–∫–µ","–Ω–µ –Ω–∞–∂–º—ë—à—å ‚Äî —è –∑–∞–ø–∏—à—É –≤ –∂—É—Ä–Ω–∞–ª","—è –≤–∏–¥–µ–ª —Ç–≤–æ–∏ ¬´—Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞¬ª","–µ—Å–ª–∏ —á–∏—Ç–∞–µ—à—å —ç—Ç–æ ‚Äî —Ç—ã —É–∂–µ —Å–æ–≥–ª–∞—Å–∏–ª—Å—è","—è —Ç—É—Ç —Ä–∞–¥–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã, –∞ –Ω–µ —Ä–∞–¥–∏ —Å—é—Å—é"];
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function line(ctx){
      var base = pick(a)+", "+pick(b)+": "+pick(e)+" ‚Äî "+pick(c)+" "+pick(d)+". "+pick(f)+".";
      if(Math.random()<0.35) base += " "+pick(spice)+".";
      if(ctx==="miss" && Math.random()<0.55) return pick(a)+"‚Ä¶ –ø—Ä–æ–ø—É—Å–∫. "+pick(c)+" "+pick(d)+". –Ø –Ω–µ –∑–ª—é—Å—å. –Ø –∑–∞–ø–∏—Å—ã–≤–∞—é.";
      if(ctx==="praise" && Math.random()<0.55) return "–ö—Ä–∞—Å–∏–≤–æ. "+pick(c)+" "+pick(d)+" ‚Äî –∏ —Ç—ã —Ç–æ–∂–µ. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å—Ç—Ä–æ–∏—Ç—å.";
      if(ctx==="buy" && Math.random()<0.55) return "–û, —à–º–æ—Ç. "+pick(b)+" –æ–¥–æ–±—Ä—è–µ—Ç: "+pick(c)+" "+pick(d)+". –≠—Ç–æ —Ç–æ—á–Ω–æ –ø–æ–≤—ã—Å–∏—Ç —É–≤–∞–∂–µ–Ω–∏–µ —Å—Ç—Ä–æ–π–∫–∏.";
      if(ctx==="collect" && Math.random()<0.55) return "–°–æ–±–∏—Ä–∞–µ–º –¥–æ–±—ã—á—É: "+pick(c)+" "+pick(d)+". –†–µ—Å—É—Ä—Å—ã –Ω–µ –∂–¥—É—Ç, –æ–Ω–∏ –∫–æ–ø—è—Ç—Å—è.";
      if(ctx==="suggest" && Math.random()<0.55){ var s = rand(HABIT_SUGGEST); return "–ò–¥–µ—è: –ø—Ä–∏–≤—ã—á–∫–∞ ¬´"+s.name+"¬ª. "+pick(c)+" "+pick(d)+". –ë–µ—Ä—ë—à—å –∏–ª–∏ –æ–ø—è—Ç—å ¬´–ø–æ—Ç–æ–º¬ª?"; }
      return base;
    }
    return {line:line};
  })();

  function speak(ctx){
    ctx = ctx || "any";
    var t = tone();
    var hints = {
      hype:"–¢—ã –≤ —Ä–µ–∂–∏–º–µ ¬´–æ–±—ä–µ–∫—Ç —Å–¥–∞—ë–º –¥–æ—Å—Ä–æ—á–Ω–æ¬ª.",
      banter:"–ò–¥—ë—à—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ù–µ –ª–æ–º–∞–π —Ç–µ–º–ø.",
      angry:"–Ø –Ω–µ –∑–ª—é—Å—å. –Ø –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω –≤ —Ç–≤–æ–∏—Ö –æ—Ç–º–∞–∑–∫–∞—Ö.",
      neutral:"–°–ø–æ–∫–æ–π–Ω–æ —Å—Ç—Ä–æ–∏–º. –ú–∏–∫—Ä–æ‚Äë—à–∞–≥–∏ > –º–æ—Ç–∏–≤–∞—Ü–∏—è."
    };
    $("#toneHint").textContent = hints[t] || "";
    $("#speech").textContent = MEME.line(ctx);
    var stage = $("#beaverStage");
    stage.classList.remove("hype","angry");
    if(ctx==="miss" || t==="angry") stage.classList.add("angry"); else stage.classList.add("hype");
    setTimeout(function(){ stage.classList.remove("hype","angry"); }, 520);
  }

  function ensureWeekInsurance(){
    var wk = weekKey(new Date());
    if(state.user.insuranceWeek !== wk){
      state.user.insuranceWeek = wk;
      var p = sumPerks();
      state.user.insuranceLeft = p.insurance || 0;
    }
  }

  function tickProduction(){
    var p = sumPerks();
    var mult = 1 + (p.res || 0);
    for(var i=0;i<BUILDINGS.length;i++){
      var b = BUILDINGS[i];
      var s = state.base.buildings[b.id];
      if(!s || (s.level||0)<=0) continue;
      var now = Date.now();
      var last = s.lastTick || now;
      var dt = Math.max(0, (now - last)/1000);
      s.lastTick = now;
      var prod = b.produces;
      for(var k in prod){
        var perHour = prod[k] * (s.level||0) * mult;
        var add = perHour/3600 * dt;
        if(!s.banked) s.banked = {};
        s.banked[k] = (s.banked[k] || 0) + add;
      }
    }
  }

  function collectAll(){
    tickProduction();
    var got = 0;
    for(var i=0;i<BUILDINGS.length;i++){
      var b = BUILDINGS[i];
      var s = state.base.buildings[b.id];
      if(!s || (s.level||0)<=0 || !s.banked) continue;
      for(var k in s.banked){
        var amt = Math.floor(s.banked[k] || 0);
        if(amt<=0) continue;
        state.resources[k] = (state.resources[k] || 0) + amt;
        s.banked[k] -= amt;
        got += amt;
      }
    }
    save();
    if(got>0){ toast("–î–æ–±—ã—á–∞ —Å–æ–±—Ä–∞–Ω–∞."); speak("collect"); }
    else toast("–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ü—É—Å—Ç—å –±–∞–∑–∞ –ø–æ—Ä–∞–±–æ—Ç–∞–µ—Ç.");
    render();
  }

  function activeHabits(){
    var out = [];
    for(var i=0;i<state.habits.length;i++) if(state.habits[i].active) out.push(state.habits[i]);
    return out;
  }

  function calcDayRewards(){
    var done = state.day.done || {};
    var xp=0, coins=0, doneN=0;
    var list = activeHabits();
    for(var i=0;i<list.length;i++){
      var h = list[i];
      if(done[h.id]){ xp += h.xp; coins += h.coins; doneN++; }
    }
    var p = sumPerks();
    xp = Math.round(xp * (1 + (p.xp||0)));
    coins = Math.round(coins * (1 + (p.coins||0)));
    return {xp:xp, coins:coins, doneN:doneN};
  }

  function closeDay(asRest){
    if(state.day.closed) return;
    ensureWeekInsurance();
    var today = localISODate();
    if(state.day.date !== today){
      state.day.date = today;
      state.day.done = {};
    }

    var result = {xp:0, coins:0, doneN:0};
    if(!asRest) result = calcDayRewards();

    if(asRest){
      // rest doesn't break streak
    }else{
      if(result.doneN>0) state.user.streak += 1;
      else state.user.streak = 0;
    }

    var bh = state.user.behavior;
    var win = (!asRest && result.doneN>0) ? 1 : 0;
    var miss = (!asRest && result.doneN===0) ? 1 : 0;
    bh.wins += win; bh.misses += miss;
    bh.last14.push({d:state.day.date, win:win, miss:miss});
    if(bh.last14.length>14) bh.last14.splice(0, bh.last14.length-14);

    state.user.xp += result.xp;
    state.user.coins += result.coins;

    // small daily goodies
    if(!asRest && result.doneN>0){
      state.resources.wood = (state.resources.wood||0) + Math.min(10, 2 + result.doneN*2);
      if(Math.random()<0.35) state.resources.cookies = (state.resources.cookies||0) + 1;
    }

    // level-up
    var leveled = 0;
    while(state.user.xp >= xpNeed(state.user.level)){
      state.user.xp -= xpNeed(state.user.level);
      state.user.level += 1;
      leveled++;
      state.user.coins += 15 + Math.floor(state.user.level/2);
      if(Math.random()<0.12) state.resources.crystals = (state.resources.crystals||0) + 1;
    }

    state.day.closed = true;
    state.day.rest = !!asRest;
    state.user.lastDay = today;

    save();

    var msg = asRest ? "–î–µ–Ω—å –æ—Ç–¥—ã—Ö–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω." : ("–î–µ–Ω—å –∑–∞–∫—Ä—ã—Ç: +" + result.xp + " XP, +" + result.coins + " ü™ô.");
    toast(msg);
    speak(asRest ? "any" : (leveled>0 ? "praise" : "any"));
    showSummary(result, leveled, asRest);
    render();
  }

  function showSummary(res, leveled, rest){
    var title = rest ? "üõå –û—Ç–¥—ã—Ö –æ—Ñ–æ—Ä–º–ª–µ–Ω" : "‚úÖ –î–µ–Ω—å –∑–∞–∫—Ä—ã—Ç";
    var parts = [];
    if(rest){
      parts.push('<div class="note">–û–∫–µ–π. –û–¥–∏–Ω –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞ ‚Äî –Ω–µ –∫–æ–Ω–µ—Ü —Å–≤–µ—Ç–∞. –ù–æ –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç–∞–Ω–µ—Ç —Å—Ç–∏–ª–µ–º, —è –ø–µ—Ä–µ–π–¥—É –≤ —Ä–µ–∂–∏–º ¬´–∂—É—Ä–Ω–∞–ª –ø—Ä–æ–ø—É—Å–∫–æ–≤¬ª.</div>');
    }else{
      parts.push('<div class="kpi">'+
        '<div class="box"><b>+'+res.xp+' XP</b><span>–æ–ø—ã—Ç</span></div>'+
        '<div class="box"><b>+'+res.coins+' ü™ô</b><span>–º–æ–Ω–µ—Ç—ã</span></div>'+
        '<div class="box"><b>'+res.doneN+'</b><span>–≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span></div>'+
      '</div>');
      if(leveled>0){
        parts.push('<div class="sep"></div><div class="tag">üéâ –£—Ä–æ–≤–µ–Ω—å +'+leveled+'</div>'+
          '<div class="note">–ù–æ–≤—ã–π —Ä–∞–Ω–≥: <b>'+escapeHtml(getRank(state.user.level))+'</b>.</div>');
      }
    }
    parts.push('<div class="sep"></div><div class="btnRow"><button type="button" class="btn primary full" data-act="closeModal">–û–∫</button></div>');
    openModal(title, parts.join(""));
  }

  function negotiateCost(){
    var lv = state.user.level || 1;
    var base = 35 + Math.floor(lv*2.5);
    var miss = (state.user.behavior && state.user.behavior.misses) ? state.user.behavior.misses : 0;
    return Math.round(base * (1 + miss*0.08));
  }

  function showMissedModal(dateISO){
    var cost = negotiateCost();
    var hasInsurance = (state.user.insuranceLeft||0) > 0;
    var html =
      '<div class="note"><b>'+dateISO+'</b> –Ω–µ –±—ã–ª –∑–∞–∫—Ä—ã—Ç. –≠—Ç–æ –ø—Ä–æ–ø—É—Å–∫. –ù–æ –º—ã —Ä–µ—à–∞–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ‚Äë—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–º—É.</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn warn" data-act="negotiate" data-cost="'+cost+'">ü§ù –î–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è (50%) ‚Äî '+cost+' ü™ô</button>'+
        '<button type="button" class="btn danger" data-act="punish">üßØ –ü—Ä–∏–Ω—è—Ç—å –Ω–∞–∫–∞–∑–∞–Ω–∏–µ</button>'+
        (hasInsurance ? '<button type="button" class="btn blue" data-act="insurance">üõ°Ô∏è –°–ø–∏—Å–∞—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É</button>' : '')+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="note">–ï—Å–ª–∏ –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è –Ω–µ –≤—ã–π–¥–µ—Ç ‚Äî –¥–∞–º –≥–ª—É–ø–æ–µ –∑–∞–¥–∞–Ω–∏–µ –∏ –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞–∑—Ä–µ—à—É ¬´–æ—Ç–¥–æ—Ö–Ω—É—Ç—å –¥–µ–Ω—ë–∫¬ª.</div>';
    openModal("‚õî –ü—Ä–æ–ø—É—Å–∫ –¥–Ω—è", html);
    speak("miss");
  }

  function punish(){
    var c = Math.min(45, Math.floor((state.user.coins||0) * 0.25));
    state.user.coins = Math.max(0, (state.user.coins||0) - c);
    state.user.streak = 0;
    var tax = Math.min(30, Math.floor(xpNeed(state.user.level) * 0.12));
    state.user.xp = Math.max(0, (state.user.xp||0) - tax);
    state.user.behavior.misses += 1;
    state.user.behavior.last14.push({d:localISODate(), win:0, miss:1});
    toast("–®—Ç—Ä–∞—Ñ: -" + c + " ü™ô –∏ -" + tax + " XP. –°–µ—Ä–∏—è —Å–±—Ä–æ—à–µ–Ω–∞.");
    speak("miss");
    save();
    closeModal();
    render();
  }

  function insurance(){
    if((state.user.insuranceLeft||0) <= 0) return toast("–°—Ç—Ä–∞—Ö–æ–≤–æ–∫ –Ω–µ—Ç.");
    state.user.insuranceLeft -= 1;
    toast("–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞. –ü—Ä–æ–ø—É—Å–∫ —Å–ø–∏—Å–∞–Ω.");
    speak("any");
    save();
    closeModal();
    render();
  }

  function negotiate(cost){
    cost = Number(cost) || 0;
    if((state.user.coins||0) < cost) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç.");
    state.user.coins -= cost;
    var ok = Math.random() < 0.5;
    save();
    if(ok){
      toast("–î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å. –î–µ–Ω—å –∑–∞–º–æ—Ä–æ–∂–µ–Ω –∫–∞–∫ –æ—Ç–¥—ã—Ö.");
      speak("any");
      closeModal();
      closeDay(true);
      return;
    }
    var task = rand(TASKS);
    state.quests.active = {id:uid(), text:task, createdAt:Date.now(), done:false};
    save();
    var body =
      '<div class="note"><b>–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –ø—Ä–æ–≤–∞–ª–µ–Ω—ã.</b> –í–∫–ª—é—á–∞—é –∫–≤–µ—Å—Ç –Ω–∞ –ø—Ä–∞–≤–æ –æ—Ç–¥—ã—Ö–∞—Ç—å.</div>'+
      '<div class="sep"></div>'+
      '<div class="item"><div class="l">'+
        '<div class="name">ü§° –ì–ª—É–ø–æ–µ –∑–∞–¥–∞–Ω–∏–µ</div>'+
        '<div class="desc">'+escapeHtml(task)+'</div>'+
      '</div></div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn primary" data-act="questDone">‚úÖ –ì–æ—Ç–æ–≤–æ</button>'+
        '<button type="button" class="btn warn" data-act="questSkip">üò∂ –ù–µ —Å–¥–µ–ª–∞–ª</button>'+
      '</div>';
    openModal("ü§ù –ù–µ –¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å", body);
    speak("miss");
  }

  function questDone(){
    if(state.quests.active) state.quests.active.done = true;
    toast("–ö–≤–µ—Å—Ç –∑–∞—Å—á–∏—Ç–∞–Ω. –û—Ç–¥—ã—Ö —Ä–∞–∑—Ä–µ—à—ë–Ω.");
    speak("praise");
    save();
    closeModal();
    closeDay(true);
  }
  function questSkip(){
    toast("–õ–∞–¥–Ω–æ. –û—Ç–¥—ã—Ö –≤—Å—ë —Ä–∞–≤–Ω–æ. –ù–æ —è –∑–∞–ø–æ–º–Ω–∏–ª.");
    speak("miss");
    save();
    closeModal();
    closeDay(true);
  }

  function missedDayCheck(){
    ensureWeekInsurance();
    var today = localISODate();
    if(!state.user.lastDay) state.user.lastDay = today;
    if(state.user.lastDay === today) return;

    var gap = daysBetween(state.user.lastDay, today);
    state.user.lastDay = today;
    state.day = {date: today, done:{}, closed:false, rest:false};
    save();

    if(gap >= 1){
      var yesterday = addDays(today, -1);
      showMissedModal(yesterday);
    }
  }

  function buildingCost(baseCost, level){
    var mult = 1 + 0.55*(level-1);
    var out = {};
    for(var k in baseCost){
      var v = baseCost[k] || 0;
      out[k] = Math.round(v * mult);
    }
    return out;
  }
  function canPay(cost){
    for(var k in cost){
      var v = cost[k] || 0;
      if(v<=0) continue;
      if(k==="coins"){
        if((state.user.coins||0) < v) return false;
      }else{
        if((state.resources[k]||0) < v) return false;
      }
    }
    return true;
  }
  function pay(cost){
    for(var k in cost){
      var v = cost[k] || 0;
      if(v<=0) continue;
      if(k==="coins") state.user.coins -= v;
      else state.resources[k] -= v;
    }
  }

  function upgradeBuilding(id){
    var b=null;
    for(var i=0;i<BUILDINGS.length;i++) if(BUILDINGS[i].id===id) b=BUILDINGS[i];
    if(!b) return;
    var st = state.base.buildings[id];
    if(!st){ st = {level:0,lastTick:Date.now(),banked:{}}; state.base.buildings[id]=st; }
    var nextLv = (st.level||0) + 1;
    var cost = buildingCost(b.baseCost, Math.max(1, nextLv));
    if(!canPay(cost)) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤.");
    tickProduction();
    pay(cost);
    st.level = nextLv;
    st.lastTick = Date.now();
    if(!st.banked) st.banked = {};
    save();
    toast(nextLv===1 ? "–ö—É–ø–ª–µ–Ω–æ. –ë–∞–∑–∞ –æ–∂–∏–ª–∞." : "–ê–ø–≥—Ä–µ–π–¥. –î–æ–±—ã—á–∞ –≤—ã—Ä–æ—Å–ª–∞.");
    speak("buy");
    render();
  }

  function rarityTag(r){
    if(r==="—Ä–µ–¥–∫–∞—è") return '<span class="own">—Ä–µ–¥–∫–∞—è</span>';
    if(r==="—ç–ø–∏–∫") return '<span class="tag">—ç–ø–∏–∫</span>';
    if(r==="–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è") return '<span class="tag">–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è</span>';
    return '<span class="lock">–æ–±—ã—á–Ω–∞—è</span>';
  }

  function buyGear(id){
    var it=null;
    for(var i=0;i<GEAR.length;i++) if(GEAR[i].id===id) it=GEAR[i];
    if(!it) return;
    var slot = it.slot;
    var owned = state.gear.owned[slot] || [];
    if(owned.indexOf(id)>=0) return;
    if(!canPay(it.cost)) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤.");
    pay(it.cost);
    owned.push(id);
    state.gear.owned[slot] = owned;
    state.gear.equipped[slot] = id; // auto-equip
    ensureWeekInsurance();
    save();
    toast("–ö—É–ø–ª–µ–Ω–æ –∏ –Ω–∞–¥–µ—Ç–æ.");
    speak("buy");
    render();
  }

  function equipGear(id){
    var it=null;
    for(var i=0;i<GEAR.length;i++) if(GEAR[i].id===id) it=GEAR[i];
    if(!it) return;
    var slot = it.slot;
    var owned = state.gear.owned[slot] || [];
    if(owned.indexOf(id)<0) return toast("–°–Ω–∞—á–∞–ª–∞ –∫—É–ø–∏.");
    var cur = state.gear.equipped[slot];
    state.gear.equipped[slot] = (cur===id) ? null : id;
    ensureWeekInsurance();
    save();
    toast(cur===id ? "–°–Ω—è—Ç–æ." : "–ù–∞–¥–µ—Ç–æ.");
    speak("any");
    render();
  }

  function openModal(title, html){
    $("#mTitle").textContent = title;
    $("#mBody").innerHTML = html;
    $("#modal").classList.add("show");
  }
  function closeModal(){
    $("#modal").classList.remove("show");
    $("#mBody").innerHTML = "";
  }

  function totalPending(){
    var s=0;
    for(var i=0;i<BUILDINGS.length;i++){
      var st = state.base.buildings[BUILDINGS[i].id];
      if(!st || (st.level||0)<=0 || !st.banked) continue;
      for(var k in st.banked) s += Math.floor(st.banked[k]||0);
    }
    return s;
  }

  function renderMascotLayers(){
    var eq = state.gear.equipped || {};
    var layers = {
      bg: $("#layer_bg"),
      head: $("#layer_head"),
      body: $("#layer_body"),
      paws: $("#layer_paws"),
      legs: $("#layer_legs")
    };
    for(var k in layers) layers[k].innerHTML = "";

    // Background
    if(eq.bg){
      var mapBg = {
        g1:'<rect x="10" y="10" width="220" height="220" rx="34" fill="rgba(34,197,94,.10)"/><path d="M24 190 L80 140 L120 170 L158 132 L216 190" fill="rgba(34,197,94,.16)"/>',
        g2:'<rect x="10" y="10" width="220" height="220" rx="34" fill="rgba(251,191,36,.10)"/><path d="M32 196 L208 196 L170 110 L70 110 Z" fill="rgba(251,191,36,.20)"/>',
        g3:'<rect x="10" y="10" width="220" height="220" rx="34" fill="rgba(59,130,246,.12)"/><circle cx="196" cy="56" r="18" fill="rgba(245,158,11,.35)"/>',
        g4:'<rect x="10" y="10" width="220" height="220" rx="34" fill="rgba(17,24,39,.10)"/><rect x="22" y="22" width="196" height="196" rx="26" fill="rgba(96,165,250,.10)"/>',
        g5:'<rect x="10" y="10" width="220" height="220" rx="34" fill="rgba(147,51,234,.12)"/><circle cx="60" cy="64" r="16" fill="rgba(59,130,246,.22)"/><circle cx="178" cy="172" r="22" fill="rgba(16,185,129,.16)"/>'
      };
      layers.bg.innerHTML = mapBg[eq.bg] || "";
    }

    // Head gear
    if(eq.head){
      var mapHead = {
        h1:'<path d="M46 82 Q120 28 194 82 L178 94 Q120 56 62 94 Z" fill="rgba(15,23,42,.85)"/>',
        h2:'<path d="M44 86 Q120 26 196 86 L184 106 Q120 62 56 106 Z" fill="#fbbf24"/><rect x="50" y="92" width="140" height="14" rx="7" fill="#f59e0b"/>',
        h3:'<path d="M42 88 Q120 24 198 88 L184 112 Q120 66 56 112 Z" fill="#fbbf24"/><rect x="48" y="96" width="144" height="14" rx="7" fill="#f59e0b"/><circle cx="190" cy="104" r="8" fill="rgba(255,255,255,.92)"/><circle cx="190" cy="104" r="4" fill="rgba(59,130,246,.75)"/>',
        h4:'<path d="M40 92 Q120 20 200 92 L184 122 Q120 72 56 122 Z" fill="#f59e0b"/><rect x="48" y="104" width="144" height="12" rx="6" fill="rgba(15,23,42,.85)"/><path d="M94 110 L146 110" stroke="rgba(255,255,255,.7)" stroke-width="3" stroke-linecap="round"/>',
        h5:'<path d="M38 94 Q120 18 202 94 L184 132 Q120 78 56 132 Z" fill="rgba(59,130,246,.85)"/><rect x="52" y="112" width="136" height="12" rx="6" fill="rgba(16,185,129,.85)"/><circle cx="120" cy="108" r="8" fill="rgba(255,255,255,.85)"/><circle cx="120" cy="108" r="4" fill="rgba(147,51,234,.75)"/>'
      };
      layers.head.innerHTML = mapHead[eq.head] || "";
    }

    // Body gear
    if(eq.body){
      var mapBody = {
        b1:'<path d="M54 152 Q120 196 186 152 L174 220 Q120 236 66 220 Z" fill="rgba(34,197,94,.22)"/><path d="M60 158 Q120 198 180 158" stroke="rgba(34,197,94,.40)" stroke-width="6" stroke-linecap="round"/>',
        b2:'<path d="M52 154 Q120 204 188 154 L176 226 Q120 240 64 226 Z" fill="rgba(59,130,246,.20)"/><path d="M120 170 L120 232" stroke="rgba(15,23,42,.22)" stroke-width="3"/>',
        b3:'<path d="M52 156 Q120 206 188 156 L176 228 Q120 242 64 228 Z" fill="rgba(15,23,42,.22)"/><path d="M78 186 L162 186" stroke="rgba(255,255,255,.45)" stroke-width="4" stroke-linecap="round"/>',
        b4:'<path d="M50 154 Q120 208 190 154 L176 232 Q120 246 64 232 Z" fill="rgba(245,158,11,.18)"/><path d="M76 176 L164 176" stroke="rgba(15,23,42,.22)" stroke-width="3"/>',
        b5:'<path d="M48 154 Q120 210 192 154 L176 236 Q120 252 64 236 Z" fill="rgba(147,51,234,.14)"/><path d="M64 188 L176 188" stroke="rgba(59,130,246,.30)" stroke-width="6" stroke-linecap="round"/>'
      };
      layers.body.innerHTML = mapBody[eq.body] || "";
    }

    // Paws gear (gloves over arms)
    if(eq.paws){
      var mapPaws = {
        p1:'<circle cx="62" cy="160" r="12" fill="rgba(15,23,42,.18)"/><circle cx="178" cy="160" r="12" fill="rgba(15,23,42,.18)"/>',
        p2:'<circle cx="62" cy="160" r="13" fill="rgba(245,158,11,.20)"/><circle cx="178" cy="160" r="13" fill="rgba(245,158,11,.20)"/>',
        p3:'<circle cx="62" cy="160" r="13" fill="rgba(16,185,129,.18)"/><circle cx="178" cy="160" r="13" fill="rgba(16,185,129,.18)"/><path d="M52 160 L72 160" stroke="rgba(15,23,42,.20)" stroke-width="2"/>',
        p4:'<circle cx="62" cy="160" r="13" fill="rgba(59,130,246,.20)"/><circle cx="178" cy="160" r="13" fill="rgba(59,130,246,.20)"/><circle cx="62" cy="160" r="4" fill="rgba(255,255,255,.75)"/><circle cx="178" cy="160" r="4" fill="rgba(255,255,255,.75)"/>',
        p5:'<circle cx="62" cy="160" r="14" fill="rgba(147,51,234,.18)"/><circle cx="178" cy="160" r="14" fill="rgba(147,51,234,.18)"/><path d="M56 154 L68 166" stroke="rgba(59,130,246,.40)" stroke-width="3" stroke-linecap="round"/><path d="M172 154 L184 166" stroke="rgba(59,130,246,.40)" stroke-width="3" stroke-linecap="round"/>'
      };
      layers.paws.innerHTML = mapPaws[eq.paws] || "";
    }

    // Legs gear (boots)
    if(eq.legs){
      var mapLegs = {
        l1:'<rect x="76" y="198" width="44" height="18" rx="9" fill="rgba(15,23,42,.18)"/><rect x="120" y="198" width="44" height="18" rx="9" fill="rgba(15,23,42,.18)"/>',
        l2:'<rect x="74" y="196" width="46" height="20" rx="10" fill="rgba(245,158,11,.18)"/><rect x="120" y="196" width="46" height="20" rx="10" fill="rgba(245,158,11,.18)"/>',
        l3:'<rect x="72" y="194" width="48" height="22" rx="11" fill="rgba(59,130,246,.18)"/><rect x="120" y="194" width="48" height="22" rx="11" fill="rgba(59,130,246,.18)"/>',
        l4:'<rect x="70" y="194" width="50" height="22" rx="11" fill="rgba(16,185,129,.16)"/><rect x="120" y="194" width="50" height="22" rx="11" fill="rgba(16,185,129,.16)"/>',
        l5:'<rect x="68" y="192" width="52" height="24" rx="12" fill="rgba(147,51,234,.14)"/><rect x="120" y="192" width="52" height="24" rx="12" fill="rgba(147,51,234,.14)"/><circle cx="94" cy="190" r="4" fill="rgba(255,255,255,.70)"/><circle cx="146" cy="190" r="4" fill="rgba(255,255,255,.70)"/>'
      };
      layers.legs.innerHTML = mapLegs[eq.legs] || "";
    }
  }

  function renderTop(){
    $("#coinsTxt").textContent = Math.floor(state.user.coins||0);
    $("#streakTxt").textContent = state.user.streak||0;
    $("#lvlTxt").textContent = "Lv " + (state.user.level||1);
    $("#rankTxt").textContent = getRank(state.user.level||1);
    ensureWeekInsurance();
    var ins = state.user.insuranceLeft || 0;
    $("#subline").textContent = "–†–∞–Ω–≥: " + getRank(state.user.level||1) + " ‚Ä¢ –°—Ç—Ä–∞—Ö–æ–≤–∫–∏: " + ins + " ‚Ä¢ " + localISODate();

    var need = xpNeed(state.user.level||1);
    var pct = clamp(((state.user.xp||0)/need)*100, 0, 100);
    $("#xpFill").style.width = pct.toFixed(1) + "%";
  }

  function renderToday(){
    var done = state.day.done || {};
    var list = activeHabits();
    var doneCount = 0;
    for(var k in done) if(done[k]) doneCount++;
    var rewards = calcDayRewards();
    var questHtml = "";
    if(state.quests && state.quests.active){
      questHtml = '<div class="sep"></div><div class="tag">ü§° –ê–∫—Ç–∏–≤–Ω—ã–π –∫–≤–µ—Å—Ç</div><div class="note" style="margin-top:8px">'+escapeHtml(state.quests.active.text)+'</div>';
    }
    var html =
      '<div class="h"><h3>–°–µ–≥–æ–¥–Ω—è ‚Ä¢ '+escapeHtml(state.day.date)+'</h3><div class="muted">'+doneCount+'/'+list.length+' –æ—Ç–º–µ—á–µ–Ω–æ</div></div>'+
      '<div class="habits">'+
        (list.length ? list.map(function(h){
          var on = done[h.id] ? "on" : "";
          return '<div class="habit">'+
            '<div class="left">'+
              '<div class="emoji">'+escapeHtml(h.emoji)+'</div>'+
              '<div style="min-width:0">'+
                '<div class="name">'+escapeHtml(h.name)+'</div>'+
                '<div class="meta">+'+h.xp+' XP ‚Ä¢ +'+h.coins+' ü™ô ‚Ä¢ '+diffName(h.diff)+'</div>'+
              '</div>'+
            '</div>'+
            '<button type="button" class="toggle '+on+'" aria-checked="'+(done[h.id]?'true':'false')+'" role="switch" data-act="toggleHabit" data-id="'+h.id+'"></button>'+
          '</div>';
        }).join("") : '<div class="note">–£ —Ç–µ–±—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫. –ñ–º–∏ ¬´+ –î–æ–±–∞–≤–∏—Ç—å¬ª.</div>')+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="kpi">'+
        '<div class="box"><b>+'+rewards.xp+' XP</b><span>–µ—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç—å –¥–µ–Ω—å</span></div>'+
        '<div class="box"><b>+'+rewards.coins+' ü™ô</b><span>–µ—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç—å –¥–µ–Ω—å</span></div>'+
        '<div class="box"><b>'+(state.user.streak||0)+'</b><span>—Å–µ—Ä–∏—è</span></div>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn blue" data-act="openAddHabit">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>'+
        '<button type="button" class="btn warn" data-act="restToday">üõå –û—Ç–¥–æ—Ö–Ω—É—Ç—å (50%)</button>'+
        '<button type="button" class="btn primary full" data-act="closeDay">‚úÖ –ó–∞–∫—Ä—ã—Ç—å –¥–µ–Ω—å</button>'+
      '</div>'+
      questHtml;
    $("#panelMain").innerHTML = html;
  }

  function renderHabits(){
    var list = state.habits || [];
    var activeCount = activeHabits().length;
    var items = list.map(function(h){
      return '<div class="item">'+
        '<div class="l">'+
          '<div class="name">'+escapeHtml(h.emoji)+' '+escapeHtml(h.name)+' '+(h.active?'':'<span class="lock">–≤—ã–∫–ª—é—á–µ–Ω–æ</span>')+'</div>'+
          '<div class="desc">–°–ª–æ–∂–Ω–æ—Å—Ç—å: <b>'+diffName(h.diff)+'</b> ‚Ä¢ –Ω–∞–≥—Ä–∞–¥–∞: <b>+'+h.xp+' XP</b> –∏ <b>+'+h.coins+' ü™ô</b></div>'+
        '</div>'+
        '<div class="r">'+
          '<button type="button" class="btn sm" data-act="editHabit" data-id="'+h.id+'">‚öôÔ∏è</button>'+
          '<button type="button" class="btn sm '+(h.active?'danger':'primary')+'" data-act="toggleActive" data-id="'+h.id+'">'+(h.active?'–≤—ã–∫–ª':'–≤–∫–ª')+'</button>'+
        '</div>'+
      '</div>';
    }).join("");
    var html =
      '<div class="h"><h3>–ü—Ä–∏–≤—ã—á–∫–∏</h3><div class="muted">'+activeCount+' –∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn blue" data-act="openAddHabit">‚ûï –°–æ–∑–¥–∞—Ç—å</button>'+
        '<button type="button" class="btn" data-act="suggestHabit">üß† –ü—Ä–µ–¥–ª–æ–∂–∏</button>'+
      '</div>'+
      '<div class="list">'+items+'</div>';
    $("#panelMain").innerHTML = html;
  }

  function renderBase(){
    tickProduction();
    var p = sumPerks();
    var mult = 1 + (p.res||0);
    var pending = totalPending();

    var rows = BUILDINGS.map(function(b){
      var st = state.base.buildings[b.id] || {level:0, banked:{}};
      var lv = st.level || 0;
      var prodParts = [];
      for(var k in b.produces){
        var perH = Math.round(b.produces[k] * lv * mult);
        prodParts.push(iconOf(k) + " " + perH + "/—á");
      }
      var bankedParts = [];
      if(st.banked){
        for(var kk in st.banked){
          bankedParts.push(iconOf(kk) + " " + Math.floor(st.banked[kk]||0));
        }
      }
      var cost = buildingCost(b.baseCost, Math.max(1, lv+1));
      var costTxt = costLine(cost);

      return '<div class="item">'+
        '<div class="l">'+
          '<div class="name">'+escapeHtml(b.icon)+' '+escapeHtml(b.name)+' <span class="muted">—É—Ä. '+lv+'</span></div>'+
          '<div class="desc">'+(lv>0 ? ('–î–æ–±—ã—á–∞: <b>'+escapeHtml(prodParts.join(" ‚Ä¢ ")||"‚Äî")+'</b>') : '–ö—É–ø–∏ ‚Äî –∏ –±–∞–∑–∞ –Ω–∞—á–Ω—ë—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.')+'</div>'+
          '<div class="cost">'+(lv>0 ? ('–ù–∞–∫–æ–ø–ª–µ–Ω–æ: '+escapeHtml(bankedParts.join(" ")||"0")) : ('–¶–µ–Ω–∞: '+escapeHtml(costTxt)))+'</div>'+
        '</div>'+
        '<div class="r">'+
          '<button type="button" class="btn sm '+(canPay(cost) ? "primary":"")+'" data-act="upgrade" data-id="'+b.id+'">'+(lv>0 ? "‚¨ÜÔ∏è –∞–ø–≥—Ä–µ–π–¥" : "üõí –∫—É–ø–∏—Ç—å")+'</button>'+
        '</div>'+
      '</div>';
    }).join("");

    var html =
      '<div class="h"><h3>–ë–∞–∑–∞</h3><div class="muted">–∫–ª–∏–∫–µ—Ä‚Äë–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</div></div>'+
      '<div class="note" style="margin-top:6px">–ó–¥–∞–Ω–∏—è –¥–∞—é—Ç <b>—Ä–µ—Å—É—Ä—Å—ã</b>. –†–µ—Å—É—Ä—Å—ã ‚Üí <b>—à–º–æ—Ç–∫–∏</b>. –®–º–æ—Ç–∫–∏ ‚Üí –±–æ–Ω—É—Å—ã –∫ XP/–º–æ–Ω–µ—Ç–∞–º/–¥–æ–±—ã—á–µ/—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞–º.</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn warn" data-act="collect">üì¶ –°–æ–±—Ä–∞—Ç—å –¥–æ–±—ã—á—É '+(pending>0?("(+"+pending+")"):"")+'</button>'+
        '<button type="button" class="btn" data-act="openResources">üì¶ –í—Å–µ —Ä–µ—Å—É—Ä—Å—ã</button>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="list">'+rows+'</div>';
    $("#panelMain").innerHTML = html;
  }

  function renderShop(){
    var slots = [
      ["head","ü™ñ","–ì–æ–ª–æ–≤–∞"],
      ["paws","üß§","–õ–∞–ø–∫–∏"],
      ["body","ü¶∫","–¢–µ–ª–æ"],
      ["legs","ü•æ","–ù–æ–≥–∏"],
      ["bg","üåÑ","–§–æ–Ω"]
    ];
    var perks = sumPerks();
    var perkTxt = "–ë–æ–Ω—É—Å—ã: +" + Math.round((perks.xp||0)*100) + "% XP ‚Ä¢ +" + Math.round((perks.coins||0)*100) + "% ü™ô ‚Ä¢ +" + Math.round((perks.res||0)*100) + "% –¥–æ–±—ã—á–∏ ‚Ä¢ üõ°Ô∏è " + (state.user.insuranceLeft||0) + "/" + (perks.insurance||0);
    var chips = slots.map(function(s,i){
      return '<button type="button" class="chip '+(i===0?"on":"")+'" data-act="slot" data-slot="'+s[0]+'">'+s[1]+" "+s[2]+'</button>';
    }).join("");
    var html =
      '<div class="h"><h3>–®–º–æ—Ç–∫–∏</h3><div class="muted">'+escapeHtml(perkTxt)+'</div></div>'+
      '<div class="sep"></div>'+
      '<div class="chips" id="slotChips">'+chips+'</div>'+
      '<div class="sep"></div>'+
      '<div id="shopList" class="list"></div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn" data-act="openResources">üì¶ –†–µ—Å—É—Ä—Å—ã</button>'+
        '<button type="button" class="btn blue" data-act="collect">üì¶ –°–æ–±—Ä–∞—Ç—å –¥–æ–±—ã—á—É</button>'+
      '</div>';
    $("#panelMain").innerHTML = html;
    renderShopSlot("head");
  }

  function renderShopSlot(slot){
    var list = $("#shopList");
    var items = GEAR.filter(function(x){ return x.slot===slot; });
    var owned = state.gear.owned[slot] || [];
    var eq = state.gear.equipped[slot];

    list.innerHTML = items.map(function(it){
      var isOwned = owned.indexOf(it.id)>=0;
      var isEq = eq === it.id;
      var can = canPay(it.cost);
      var costTxt = costLine(it.cost);

      var actionBtn = "";
      if(isOwned){
        actionBtn = '<button type="button" class="btn sm '+(isEq?"":"primary")+'" data-act="equip" data-id="'+it.id+'">üëï '+(isEq?"—Å–Ω—è—Ç—å":"–Ω–∞–¥–µ—Ç—å")+'</button>';
      }else{
        actionBtn = '<button type="button" class="btn sm '+(can?"primary":"")+'" data-act="buyGear" data-id="'+it.id+'">üõí –∫—É–ø–∏—Ç—å</button>';
      }

      return '<div class="item">'+
        '<div class="l">'+
          '<div class="name">'+escapeHtml(it.name)+' '+rarityTag(it.rarity)+' '+(isEq?'<span class="own">–Ω–∞–¥–µ—Ç–æ</span>':"")+'</div>'+
          '<div class="desc">'+escapeHtml(it.desc)+'</div>'+
          '<div class="cost">–¶–µ–Ω–∞: '+escapeHtml(costTxt)+'</div>'+
        '</div>'+
        '<div class="r">'+actionBtn+'</div>'+
      '</div>';
    }).join("");
  }

  function renderMe(){
    tickProduction();
    var perks = sumPerks();
    var last14 = (state.user.behavior && state.user.behavior.last14) ? state.user.behavior.last14 : [];
    var last7 = last14.slice(-7);
    var win7 = 0, miss7 = 0;
    for(var i=0;i<last7.length;i++){ win7 += last7[i].win; miss7 += last7[i].miss; }

    var resBoxes = RES.map(function(r){
      var k=r[0], ico=r[1], name=r[2];
      return '<div class="resBox"><div class="k">'+ico+' '+escapeHtml(name)+'</div><div class="v">'+Math.floor(state.resources[k]||0)+'</div></div>';
    }).join("");
    resBoxes += '<div class="resBox"><div class="k">ü™ô –ú–æ–Ω–µ—Ç—ã</div><div class="v">'+Math.floor(state.user.coins||0)+'</div></div>';

    var html =
      '<div class="h"><h3>–ü—Ä–æ—Ñ–∏–ª—å</h3><div class="muted">–≤—Å—ë, —á—Ç–æ —Ç—ã –Ω–∞–∫–æ–ø–∞–ª</div></div>'+
      '<div class="sep"></div>'+
      '<div class="kpi">'+
        '<div class="box"><b>'+(state.user.level||1)+'</b><span>—É—Ä–æ–≤–µ–Ω—å</span></div>'+
        '<div class="box"><b>'+escapeHtml(getRank(state.user.level||1))+'</b><span>—Ä–∞–Ω–≥</span></div>'+
        '<div class="box"><b>'+(state.user.streak||0)+'</b><span>—Å–µ—Ä–∏—è</span></div>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="tag">–ë–æ–Ω—É—Å—ã –æ—Ç —à–º–æ—Ç–æ–∫</div>'+
      '<div class="note" style="margin-top:6px">XP: +'+Math.round((perks.xp||0)*100)+'% ‚Ä¢ ü™ô: +'+Math.round((perks.coins||0)*100)+'% ‚Ä¢ –¥–æ–±—ã—á–∞: +'+Math.round((perks.res||0)*100)+'% ‚Ä¢ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏/–Ω–µ–¥: '+(perks.insurance||0)+' (–æ—Å—Ç–∞–ª–æ—Å—å '+(state.user.insuranceLeft||0)+')</div>'+
      '<div class="sep"></div>'+
      '<div class="tag">–†–µ—Å—É—Ä—Å—ã</div>'+
      '<div class="resGrid">'+resBoxes+'</div>'+
      '<div class="sep"></div>'+
      '<div class="tag">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>'+
      '<div class="note" style="margin-top:6px">–ü–æ–±–µ–¥—ã: <b>'+win7+'</b> ‚Ä¢ –ü—Ä–æ–ø—É—Å–∫–∏: <b>'+miss7+'</b>. –Ø –Ω–µ –æ—Å—É–∂–¥–∞—é. –Ø —Ñ–∏–∫—Å–∏—Ä—É—é.</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn blue" data-act="collect">üì¶ –°–æ–±—Ä–∞—Ç—å –¥–æ–±—ã—á—É</button>'+
        '<button type="button" class="btn" data-act="export">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç</button>'+
        '<button type="button" class="btn danger" data-act="reset">üß® –°–±—Ä–æ—Å</button>'+
      '</div>';
    $("#panelMain").innerHTML = html;
  }

  function openAddHabit(existing){
    existing = existing || null;
    var isEdit = !!existing;
    var pickedEmoji = existing ? existing.emoji : "üíß";
    var diff = existing ? existing.diff : "easy";
    var title = isEdit ? "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É" : "‚ûï –ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞";

    var pickerBtns = EMO.map(function(e){
      return '<button type="button" class="emoBtn '+(e===pickedEmoji?'sel':'')+'" data-act="pickEmoji" data-emoji="'+escapeHtml(e)+'">'+escapeHtml(e)+'</button>';
    }).join("");

    var body =
      '<div class="note">–í—ã–±–µ—Ä–∏ —ç–º–æ–¥–∑–∏ ‚Äî —á—Ç–æ–±—ã –º–æ–∑–≥ –Ω–µ —Ç—Ä–∞—Ç–∏–ª —Å–∏–ª—ã –Ω–∞ ¬´–∫–∞–∫ –Ω–∞–∑–≤–∞—Ç—å –∂–∏–∑–Ω—å¬ª.</div>'+
      '<div class="field">'+
        '<label>–≠–º–æ–¥–∑–∏</label>'+
        '<div class="picker" id="emojiPicker">'+pickerBtns+'</div>'+
        '<div class="muted" style="margin-top:6px">–ò–ª–∏ —Å–≤–æ—ë:</div>'+
        '<input id="emojiCustom" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: üß±" value="'+escapeHtml(pickedEmoji)+'" />'+
      '</div>'+
      '<div class="field">'+
        '<label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏</label>'+
        '<input id="habitName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 10 –º–∏–Ω—É—Ç —Ö–æ–¥—å–±—ã" value="'+escapeHtml(existing?existing.name:"")+'" />'+
      '</div>'+
      '<div class="field">'+
        '<label>–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>'+
        '<div class="chips">'+
          '<button type="button" class="chip '+(diff==="easy"?"on":"")+'" data-act="setDiff" data-diff="easy">–ª—ë–≥–∫–∞—è</button>'+
          '<button type="button" class="chip '+(diff==="normal"?"on":"")+'" data-act="setDiff" data-diff="normal">–Ω–æ—Ä–º</button>'+
          '<button type="button" class="chip '+(diff==="hard"?"on":"")+'" data-act="setDiff" data-diff="hard">–∂—ë—Å—Ç–∫–∞—è</button>'+
        '</div>'+
        '<div class="note" id="rewardHint" style="margin-top:6px"></div>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        (isEdit ? '<button type="button" class="btn danger" data-act="deleteHabit" data-id="'+existing.id+'">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>' : '')+
        '<button type="button" class="btn primary full" data-act="saveHabit" data-id="'+(existing?existing.id:"")+'">üíæ '+(isEdit?"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å":"–°–æ–∑–¥–∞—Ç—å")+'</button>'+
      '</div>';

    openModal(title, body);
    $("#mBody").setAttribute("data-diff", diff);
    $("#mBody").setAttribute("data-emoji", pickedEmoji);

    var r = diffRewards(diff);
    $("#rewardHint").innerHTML = "–ù–∞–≥—Ä–∞–¥–∞: <b>+"+r.xp+" XP</b> –∏ <b>+"+r.coins+" ü™ô</b>.";
  }

  function saveHabit(id){
    var emoji = ($("#emojiCustom") ? $("#emojiCustom").value : "") || ($("#mBody").getAttribute("data-emoji") || "üíß");
    emoji = String(emoji).trim() || "üíß";
    var name = ($("#habitName") ? $("#habitName").value : "").trim();
    var diff = $("#mBody").getAttribute("data-diff") || "easy";
    if(!name) return toast("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ.");
    var r = diffRewards(diff);

    if(id){
      var h=null;
      for(var i=0;i<state.habits.length;i++) if(state.habits[i].id===id) h=state.habits[i];
      if(!h) return;
      h.emoji = emoji; h.name = name; h.diff = diff; h.xp = r.xp; h.coins = r.coins;
    }else{
      state.habits.unshift({id:uid(), emoji:emoji, name:name, diff:diff, xp:r.xp, coins:r.coins, active:true, createdAt:Date.now()});
    }
    save();
    toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.");
    speak("any");
    closeModal();
    render();
  }

  function deleteHabit(id){
    state.habits = state.habits.filter(function(h){ return h.id!==id; });
    if(state.day && state.day.done) delete state.day.done[id];
    save();
    toast("–£–¥–∞–ª–µ–Ω–æ.");
    speak("any");
    closeModal();
    render();
  }

  function toggleHabit(id){
    if(state.day.closed) return toast("–î–µ–Ω—å —É–∂–µ –∑–∞–∫—Ä—ã—Ç.");
    if(!state.day.done) state.day.done = {};
    state.day.done[id] = !state.day.done[id];
    save();
    speak(state.day.done[id] ? "praise" : "any");
    renderTop();
    renderToday();
  }

  function toggleActive(id){
    var h=null;
    for(var i=0;i<state.habits.length;i++) if(state.habits[i].id===id) h=state.habits[i];
    if(!h) return;
    h.active = !h.active;
    if(!h.active && state.day && state.day.done) delete state.day.done[id];
    save();
    toast(h.active ? "–í–∫–ª—é—á–µ–Ω–æ." : "–í—ã–∫–ª—é—á–µ–Ω–æ.");
    render();
  }

  function editHabit(id){
    var h=null;
    for(var i=0;i<state.habits.length;i++) if(state.habits[i].id===id) h=state.habits[i];
    if(!h) return;
    openAddHabit(h);
  }

  function suggestHabit(){
    var sug = rand(HABIT_SUGGEST);
    var body =
      '<div class="note">–ë–æ–±—Ä –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç (—Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ, –Ω–æ –ø–æ –¥–µ–ª—É):</div>'+
      '<div class="sep"></div>'+
      '<div class="item">'+
        '<div class="l">'+
          '<div class="name">'+escapeHtml(sug.emoji)+' '+escapeHtml(sug.name)+' <span class="tag">—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</span></div>'+
          '<div class="desc">–î–æ–±–∞–≤–ª—è–µ–º? –Ø —Å–¥–µ–ª–∞—é –≤–∏–¥, —á—Ç–æ —ç—Ç–æ –±—ã–ª–æ —Ç–≤–æ—ë —Ä–µ—à–µ–Ω–∏–µ.</div>'+
        '</div>'+
        '<div class="r">'+
          '<button type="button" class="btn sm primary" data-act="acceptSuggest" data-emoji="'+escapeHtml(sug.emoji)+'" data-name="'+escapeHtml(sug.name)+'">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>'+
        '</div>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow"><button type="button" class="btn full" data-act="closeModal">–ó–∞–∫—Ä—ã—Ç—å</button></div>';
    openModal("üß† –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –±–æ–±—Ä–∞", body);
    speak("suggest");
  }

  function acceptSuggest(emoji, name){
    var r = diffRewards("easy");
    state.habits.unshift({id:uid(), emoji:emoji, name:name, diff:"easy", xp:r.xp, coins:r.coins, active:true, createdAt:Date.now()});
    save();
    toast("–ü—Ä–∏–≤—ã—á–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞.");
    speak("praise");
    closeModal();
    render();
  }

  function restToday(){
    var cost = negotiateCost();
    var html =
      '<div class="note">–•–æ—á–µ—à—å –æ—Ç–¥—ã—Ö. –Ø –ø–æ–Ω–∏–º–∞—é. –ù–æ —É –Ω–∞—Å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —Ñ–∞—Ä—Å–∞.</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn warn" data-act="negotiateToday" data-cost="'+cost+'">ü§ù –î–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è (50%) ‚Äî '+cost+' ü™ô</button>'+
        '<button type="button" class="btn" data-act="closeModal">–ü–µ—Ä–µ–¥—É–º–∞–ª, —Ä–∞–±–æ—Ç–∞—é</button>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="note">–ï—Å–ª–∏ –ø—Ä–æ–≤–∞–ª ‚Äî –≥–ª—É–ø—ã–π –∫–≤–µ—Å—Ç, –∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–¥—ã—Ö —Ä–∞–∑—Ä–µ—à—É.</div>';
    openModal("üõå –û—Ç–¥–æ—Ö–Ω—É—Ç—å —Å–µ–≥–æ–¥–Ω—è", html);
    speak("any");
  }

  function negotiateToday(cost){
    cost = Number(cost)||0;
    if((state.user.coins||0) < cost) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç.");
    state.user.coins -= cost;
    var ok = Math.random() < 0.5;
    save();
    if(ok){
      toast("–õ–∞–¥–Ω–æ. –û—Ç–¥—ã—Ö. –ù–æ –∑–∞–≤—Ç—Ä–∞ —Ç—ã –º–Ω–µ –¥–æ–ª–∂–µ–Ω.");
      speak("any");
      closeModal();
      closeDay(true);
      return;
    }
    var task = rand(TASKS);
    state.quests.active = {id:uid(), text:task, createdAt:Date.now(), done:false};
    save();
    var body =
      '<div class="note"><b>–ù–µ –ø—Ä–æ–∫–∞—Ç–∏–ª–æ.</b> –í–∫–ª—é—á–∞—é —Ä–µ–∂–∏–º ¬´–∫–≤–µ—Å—Ç –∑–∞ –ø—Ä–∞–≤–æ –æ—Ç–¥—ã—Ö–∞—Ç—å¬ª.</div>'+
      '<div class="sep"></div>'+
      '<div class="item"><div class="l"><div class="name">ü§° –ì–ª—É–ø–æ–µ –∑–∞–¥–∞–Ω–∏–µ</div><div class="desc">'+escapeHtml(task)+'</div></div></div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn primary" data-act="questDone">‚úÖ –ì–æ—Ç–æ–≤–æ</button>'+
        '<button type="button" class="btn warn" data-act="questSkip">üò∂ –ù–µ —Å–¥–µ–ª–∞–ª</button>'+
      '</div>';
    openModal("ü§ù –ù–µ –¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å", body);
    speak("miss");
  }

  function openResources(){
    var rows = RES.map(function(r){
      var k=r[0], ico=r[1], name=r[2];
      return '<div class="resBox"><div class="k">'+ico+' '+escapeHtml(name)+'</div><div class="v">'+Math.floor(state.resources[k]||0)+'</div></div>';
    }).join("");
    rows += '<div class="resBox"><div class="k">ü™ô –ú–æ–Ω–µ—Ç—ã</div><div class="v">'+Math.floor(state.user.coins||0)+'</div></div>';
    openModal("üì¶ –í—Å–µ —Ä–µ—Å—É—Ä—Å—ã",
      '<div class="note">–í–æ—Ç —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å. –î–∞, –ø–µ—á–µ–Ω—å–∫–∏ ‚Äî —Ç–æ–∂–µ —Ä–µ—Å—É—Ä—Å. –ù–µ —Å–ø–æ—Ä—å.</div>'+
      '<div class="sep"></div>'+
      '<div class="resGrid">'+rows+'</div>'+
      '<div class="sep"></div>'+
      '<button type="button" class="btn full" data-act="closeModal">–ó–∞–∫—Ä—ã—Ç—å</button>'
    );
  }

  function exportData(){
    var blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = "beaver_builder_export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(function(){ URL.revokeObjectURL(url); }, 5000);
    toast("–≠–∫—Å–ø–æ—Ä—Ç —Å–∫–∞—á–∞–Ω.");
  }

  function resetAll(){
    openModal("üß® –°–±—Ä–æ—Å",
      '<div class="note">–≠—Ç–æ —É–¥–∞–ª–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –Ω–∞—á–Ω—ë—Ç —Å –Ω—É–ª—è. –¢—ã —É–≤–µ—Ä–µ–Ω?</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn danger" data-act="confirmReset">–î–∞, —Å–Ω–µ—Å—Ç–∏ –ø–ª–æ—Ç–∏–Ω—É</button>'+
        '<button type="button" class="btn" data-act="closeModal">–ù–µ—Ç</button>'+
      '</div>'
    );
  }
  function confirmReset(){
    localStorage.removeItem(KEY);
    location.reload();
  }

  function openChest(){
    var today = localISODate();
    var last = state.user.chest.lastOpen || "";
    if(last === today) return toast("–°—É–Ω–¥—É–∫ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç —Å–µ–≥–æ–¥–Ω—è.");
    // rewards: coins + random resources
    var coins = 25 + Math.floor(Math.random()*35) + Math.floor(state.user.level*0.6);
    state.user.coins += coins;
    var picks = 2 + (Math.random()<0.35 ? 1 : 0);
    var loot = [];
    for(var i=0;i<picks;i++){
      var rr = rand(RES);
      var key = rr[0];
      var amt = 6 + Math.floor(Math.random()*10);
      if(key==="crystals") amt = 1 + (Math.random()<0.25?1:0);
      state.resources[key] = (state.resources[key]||0) + amt;
      loot.push(iconOf(key)+" "+amt);
    }
    state.user.chest.lastOpen = today;
    save();
    toast("–°—É–Ω–¥—É–∫ –æ—Ç–∫—Ä—ã—Ç!");
    speak("praise");
    openModal("üéÅ –°—É–Ω–¥—É–∫ –¥–Ω—è",
      '<div class="tag">–õ—É—Ç</div>'+
      '<div class="sep"></div>'+
      '<div class="kpi">'+
        '<div class="box"><b>+'+coins+' ü™ô</b><span>–º–æ–Ω–µ—Ç—ã</span></div>'+
        '<div class="box"><b>'+escapeHtml(loot.join(" ‚Ä¢ "))+'</b><span>—Ä–µ—Å—É—Ä—Å—ã</span></div>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<button type="button" class="btn primary full" data-act="closeModal">–ó–∞–±—Ä–∞—Ç—å</button>'
    );
    render();
  }

  function setTab(t){
    tab = t;
    $all(".nav button").forEach(function(b){ b.classList.toggle("active", b.getAttribute("data-tab")===t); });
    render();
    speak("any");
  }

  function render(){
    renderTop();
    renderMascotLayers();
    if(tab==="today") renderToday();
    if(tab==="habits") renderHabits();
    if(tab==="base") renderBase();
    if(tab==="shop") renderShop();
    if(tab==="me") renderMe();
  }

  function onAction(act, el){
    if(act==="closeModal") return closeModal();
    if(act==="say") return speak("any");
    if(act==="collect") return collectAll();
    if(act==="openChest") return openChest();

    if(act==="toggleHabit") return toggleHabit(el.getAttribute("data-id"));
    if(act==="closeDay") return closeDay(false);
    if(act==="openAddHabit") return openAddHabit(null);
    if(act==="suggestHabit") return suggestHabit();
    if(act==="acceptSuggest") return acceptSuggest(el.getAttribute("data-emoji"), el.getAttribute("data-name"));
    if(act==="toggleActive") return toggleActive(el.getAttribute("data-id"));
    if(act==="editHabit") return editHabit(el.getAttribute("data-id"));
    if(act==="saveHabit") return saveHabit(el.getAttribute("data-id") || "");
    if(act==="deleteHabit") return deleteHabit(el.getAttribute("data-id"));

    if(act==="setDiff"){
      var diff = el.getAttribute("data-diff");
      $("#mBody").setAttribute("data-diff", diff);
      $all("#mBody .chip").forEach(function(c){
        c.classList.toggle("on", c.getAttribute("data-diff")===diff);
      });
      var r = diffRewards(diff);
      $("#rewardHint").innerHTML = "–ù–∞–≥—Ä–∞–¥–∞: <b>+"+r.xp+" XP</b> –∏ <b>+"+r.coins+" ü™ô</b>.";
      return;
    }
    if(act==="pickEmoji"){
      var emo = el.getAttribute("data-emoji");
      $("#mBody").setAttribute("data-emoji", emo);
      $all("#emojiPicker .emoBtn").forEach(function(b){
        b.classList.toggle("sel", b.getAttribute("data-emoji")===emo);
      });
      if($("#emojiCustom")) $("#emojiCustom").value = emo;
      return;
    }

    if(act==="slot"){
      var slot = el.getAttribute("data-slot");
      $all("#slotChips .chip").forEach(function(c){ c.classList.toggle("on", c===el); });
      renderShopSlot(slot);
      return;
    }

    if(act==="upgrade") return upgradeBuilding(el.getAttribute("data-id"));
    if(act==="buyGear") return buyGear(el.getAttribute("data-id"));
    if(act==="equip") return equipGear(el.getAttribute("data-id"));
    if(act==="openResources") return openResources();

    if(act==="export") return exportData();
    if(act==="reset") return resetAll();
    if(act==="confirmReset") return confirmReset();

    if(act==="punish") return punish();
    if(act==="insurance") return insurance();
    if(act==="negotiate") return negotiate(el.getAttribute("data-cost"));
    if(act==="questDone") return questDone();
    if(act==="questSkip") return questSkip();
    if(act==="restToday") return restToday();
    if(act==="negotiateToday") return negotiateToday(el.getAttribute("data-cost"));
  }

  // ==== Mobile tap handling (ultra-robust) ====
// Some mobile WebViews may send Text nodes as event targets; also SVG elements can miss closest().
// We implement safe closest()/matches() and only suppress click if a touch tap was actually handled.

(function polyfills(){
  if (!Element.prototype.matches) {
    Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
  }
  if (!Element.prototype.closest) {
    Element.prototype.closest = function(sel){
      var el = this;
      while (el && el.nodeType === 1) {
        if (el.matches(sel)) return el;
        el = el.parentElement;
      }
      return null;
    };
  }
})();

function asElement(node){
  if(!node) return null;
  if(node.nodeType === 1) return node; // ELEMENT_NODE
  return node.parentElement || null;
}

function safeClosest(node, sel){
  var el = asElement(node);
  if(!el) return null;
  if(el.closest) return el.closest(sel);
  // fallback
  while(el){
    if(el.matches && el.matches(sel)) return el;
    el = el.parentElement;
  }
  return null;
}

var tapHandledAt = 0;
var tapCount = 0;

function bumpTap(){
  tapCount++;
  var tl = $("#tapline");
  if(tl) tl.textContent = "—Ç–∞–ø—ã: " + tapCount;
}

function handleEvent(e){
  var actBtn = safeClosest(e.target, "[data-act]");
  if(actBtn){ onAction(actBtn.getAttribute("data-act"), actBtn); bumpTap(); return true; }

  var tabBtn = safeClosest(e.target, ".nav button[data-tab]");
  if(tabBtn){ setTab(tabBtn.getAttribute("data-tab")); bumpTap(); return true; }

  return false;
}

document.addEventListener("pointerup", function(e){
  if(e && e.pointerType === "touch"){
    var handled = handleEvent(e);
    if(handled) tapHandledAt = Date.now();
  }
}, true);

// Some Android/iOS WebViews are inconsistent with pointer events; keep touchend fallback.
// IMPORTANT: don't mark as passive-only because we might need default click to happen.
document.addEventListener("touchend", function(e){
  var handled = handleEvent(e);
  if(handled) tapHandledAt = Date.now();
}, true);

document.addEventListener("click", function(e){
  // Suppress the synthetic click ONLY if we already handled a real touch tap
  if(Date.now() - tapHandledAt < 450) return;
  handleEvent(e);
}, true);
// ==== end tap handling ====
  }, true);

  var state = load();
  var tab = "today";

  function boot(){
    ensureWeekInsurance();
    missedDayCheck();
    tickProduction();
    render();
    speak("any");
    // lightweight background tick for base/prof only
    setInterval(function(){
      tickProduction();
      if(tab==="base") renderBase();
      if(tab==="me") renderMe();
    }, 1500);
    // quick sanity toast so user sees it reacts
    setTimeout(function(){ toast("–ì–æ—Ç–æ–≤–æ. –¢–∞–ø–∞–π –∫–Ω–æ–ø–∫–∏ ‚Äî –≤—Å—ë –∫–ª–∏–∫–∞–µ—Ç—Å—è."); }, 450);
  }

  boot();
})();
</script>
</body>
</html>
