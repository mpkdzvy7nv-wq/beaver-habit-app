<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ü¶´ Beaver Builder ‚Äî —Ç—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫ (v11.1)</title>
<style>
:root{
  --bg1:#eaf4ff; --bg2:#fff7e8;
  --card:#ffffff; --text:#0b1220; --muted:#6b7280;
  --brand:#34d399; --brand2:#60a5fa; --warn:#f59e0b; --danger:#ef4444;
  --shadow:0 14px 40px rgba(0,0,0,.10);
  --r:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  color:var(--text);
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
}
button{font:inherit; touch-action:manipulation}
a{color:inherit}
#app{min-height:100%; padding-bottom:92px;}
.wrap{max-width:980px;margin:0 auto;padding:12px 12px 0}
.topbar{
  display:flex;gap:10px;align-items:center;justify-content:space-between;
  padding:12px;
  background:rgba(255,255,255,.90);
  border:1px solid rgba(17,24,39,.08);
  border-radius:24px;
  box-shadow: var(--shadow);
}
.title{font-weight:1000;letter-spacing:.2px}
.sub{font-size:12px;color:var(--muted);font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width: 52vw}
.stats{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pill{
  display:flex;gap:8px;align-items:center;
  padding:7px 10px;border-radius:999px;
  background:#fff;border:1px solid rgba(17,24,39,.10);
  font-weight:900;font-size:13px;
}
.pill small{font-size:12px;color:var(--muted);font-weight:800}
.xpbar{height:10px;border-radius:999px;background:rgba(17,24,39,.10);overflow:hidden;margin-top:6px}
.xpbar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2));border-radius:999px;transition:width .45s ease}

.grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
@media (min-width:860px){.grid{grid-template-columns:1.05fr .95fr}}
.card{
  background:var(--card);
  border-radius:calc(var(--r) + 6px);
  box-shadow: var(--shadow);
  border:1px solid rgba(17,24,39,.06);
  padding:14px;
}
.h{display:flex;align-items:center;justify-content:space-between;gap:10px}
.h h3{margin:0;font-size:16px}
.muted{color:var(--muted);font-size:12px;font-weight:800}
.sep{height:1px;background:rgba(17,24,39,.08);margin:12px 0}

.btn{
  border:1px solid rgba(17,24,39,.14);
  background:#fff;
  padding:10px 12px;border-radius:14px;
  font-weight:1000;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
  transition: transform .06s ease, filter .15s ease;
}
.btn:active{transform: translateY(1px) scale(.99)}
.btn.primary{background:linear-gradient(135deg,var(--brand),#a7f3d0); border-color:rgba(16,185,129,.35); color:#064e3b}
.btn.blue{background:linear-gradient(135deg,var(--brand2),#bfdbfe); border-color:rgba(59,130,246,.35); color:#0b2a55}
.btn.warn{background:linear-gradient(135deg,#fbbf24,#fde68a); border-color:rgba(245,158,11,.35); color:#3a2a00}
.btn.danger{background:linear-gradient(135deg,#fb7185,#fecdd3); border-color:rgba(239,68,68,.35); color:#7f1d1d}
.btn.ghost{background:transparent}
.btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none;filter:saturate(.8)}
.btn.sm{padding:8px 10px;border-radius:12px;font-size:13px}
.btn.full{width:100%}
.btnRow{display:flex;gap:10px;flex-wrap:wrap}
.tag{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 9px;border-radius:999px;
  background:rgba(52,211,153,.14);
  border:1px solid rgba(52,211,153,.28);
  color:#065f46;
  font-weight:1000;font-size:12px;
}
.lock{background:rgba(17,24,39,.06);border:1px solid rgba(17,24,39,.10);padding:4px 9px;border-radius:999px;font-weight:1000;font-size:12px;color:#334155}
.own{background:rgba(52,211,153,.18);border:1px solid rgba(52,211,153,.30);padding:4px 9px;border-radius:999px;font-weight:1000;font-size:12px;color:#065f46}

.habits{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.habit{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(17,24,39,.08);
  background:linear-gradient(180deg,#ffffff,#f8fafc);
}
.habit .left{display:flex;gap:10px;align-items:center;min-width:0}
.habit .emoji{font-size:22px}
.habit .name{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.habit .meta{font-size:12px;color:var(--muted);font-weight:800}
.toggle{
  width:56px;height:34px;border-radius:999px;
  border:1px solid rgba(17,24,39,.12);
  background:rgba(17,24,39,.12);
  position:relative;
  cursor:pointer;
  padding:0;
}
.toggle::after{
  content:"";
  position:absolute;top:50%;left:3px;
  width:28px;height:28px;border-radius:999px;
  background:#fff;
  transform: translateY(-50%);
  box-shadow:0 8px 20px rgba(0,0,0,.12);
  transition:left .18s ease, background .18s ease;
}
.toggle.on{background:rgba(52,211,153,.32);border-color:rgba(52,211,153,.35)}
.toggle.on::after{left:25px;background:#ecfdf5}

.kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi .box{
  flex:1; min-width: 110px;
  border-radius:16px;
  padding:10px 12px;
  border:1px solid rgba(17,24,39,.08);
  background:linear-gradient(180deg,#fff,#f8fafc);
}
.kpi .box b{display:block;font-size:14px}
.kpi .box span{display:block;font-size:12px;color:var(--muted);font-weight:900;margin-top:3px}
.note{font-size:12px;color:var(--muted);font-weight:800;line-height:1.35}

.nav{
  position:fixed;left:0;right:0;bottom:0;
  padding:10px 12px calc(10px + env(safe-area-inset-bottom));
  background:rgba(255,255,255,.92);
  border-top:1px solid rgba(17,24,39,.10);
  display:flex;justify-content:space-between;gap:8px;
  z-index:50;
}
.nav button{
  flex:1;
  border:1px solid rgba(17,24,39,.10);
  background:linear-gradient(180deg,#fff,#f8fafc);
  padding:10px 8px;border-radius:16px;
  font-weight:1000;font-size:12px;
  cursor:pointer;
  display:flex;flex-direction:column;align-items:center;gap:4px;
  -webkit-tap-highlight-color: transparent;
}
.nav button.active{border-color:rgba(52,211,153,.50);box-shadow:0 10px 30px rgba(16,185,129,.18)}
.nav .ico{font-size:18px;line-height:1}

.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.42);
  display:none;
  align-items:flex-end;
  justify-content:center;
  z-index:100;
}
.modal.show{display:flex}
.sheet{
  width:min(920px,100%);
  border-radius:24px 24px 0 0;
  background:#fff;
  box-shadow:0 -20px 60px rgba(0,0,0,.25);
  padding:14px;
  max-height: 90vh;
  overflow:auto;
}
.sheet h2{margin:0 0 8px;font-size:18px}
.field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
.field label{font-size:12px;color:var(--muted);font-weight:1000}
input{
  border:1px solid rgba(17,24,39,.14);
  border-radius:14px;
  padding:12px;
  font-weight:900;
  outline:none;
}
.picker{
  display:grid;grid-template-columns:repeat(10,1fr);
  gap:6px;
  background:linear-gradient(180deg,#fff,#f8fafc);
  border:1px solid rgba(17,24,39,.08);
  padding:10px;border-radius:16px;
}
@media (max-width:420px){.picker{grid-template-columns:repeat(8,1fr)}}
.emoBtn{
  border:1px solid rgba(17,24,39,.10);
  background:#fff;
  border-radius:12px;
  padding:8px;
  font-size:18px;
  cursor:pointer;
}
.emoBtn.sel{outline:3px solid rgba(52,211,153,.35)}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{
  border:1px solid rgba(17,24,39,.12);
  background:#fff;
  padding:8px 10px;border-radius:999px;
  font-weight:1000;font-size:12px;
  cursor:pointer;
}
.chip.on{background:rgba(96,165,250,.16);border-color:rgba(96,165,250,.35)}

.list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.item{
  border:1px solid rgba(17,24,39,.10);
  border-radius:18px;
  background:linear-gradient(180deg,#fff,#f8fafc);
  padding:12px;
  display:flex;gap:12px;justify-content:space-between;align-items:flex-start;
}
.item .l{min-width:0}
.item .name{font-weight:1100}
.item .desc{font-size:12px;color:var(--muted);font-weight:800;margin-top:4px;line-height:1.25}
.item .cost{margin-top:8px;font-size:12px;color:#0f172a;font-weight:1000}
.item .r{display:flex;flex-direction:column;gap:8px;align-items:flex-end}

.resGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
@media (min-width:520px){.resGrid{grid-template-columns:repeat(4,1fr)}}
.resBox{
  padding:10px 12px;border-radius:16px;
  background:linear-gradient(180deg,#fff,#f8fafc);
  border:1px solid rgba(17,24,39,.08);
  font-weight:1100;
}
.resBox .k{font-size:12px;color:var(--muted);font-weight:1000}
.resBox .v{font-size:18px;margin-top:2px}

.toast{
  position:fixed;left:50%;bottom:96px;
  transform:translateX(-50%);
  padding:10px 12px;border-radius:999px;
  background:rgba(17,24,39,.92);
  color:#fff;font-weight:1000;font-size:13px;
  opacity:0;pointer-events:none;
  transition: opacity .2s ease, transform .2s ease;
  z-index:200;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-2px)}

/* Mascot */
.mascotWrap{display:flex;flex-direction:column;gap:10px}
.mascotTop{display:flex;gap:12px;align-items:center;justify-content:space-between}
.bubble{
  flex:1;
  border-radius:20px;
  background:linear-gradient(180deg,#ffffff,#f8fafc);
  border:1px solid rgba(17,24,39,.08);
  padding:10px 12px;
  font-weight:1100;
  line-height:1.25;
  min-height:74px;
  position:relative;
}
.bubble::after{
  content:"";
  position:absolute;
  left:-8px;top:18px;
  width:16px;height:16px;
  background:linear-gradient(180deg,#fff,#f8fafc);
  border-left:1px solid rgba(17,24,39,.08);
  border-bottom:1px solid rgba(17,24,39,.08);
  transform: rotate(45deg);
}
#beaverStage{
  width:196px; height:196px;
  border-radius:34px;
  background: radial-gradient(circle at 30% 25%, #ffffff, #dbeafe);
  border:1px solid rgba(17,24,39,.08);
  box-shadow:0 16px 40px rgba(59,130,246,.15);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
  position:relative;
}
#beaverSVG{width:186px;height:186px}
#beaverStage.float #beaverSVG{animation: floaty 2.6s ease-in-out infinite}
@keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
#beaverStage.hype #beaverSVG{animation: hype .55s ease-in-out 1}
@keyframes hype{0%{transform:scale(1)}35%{transform:scale(1.05) rotate(-1deg)}70%{transform:scale(1.02) rotate(1deg)}100%{transform:scale(1)}}
#beaverStage.angry #beaverSVG{animation: angry .45s ease-in-out 1}
@keyframes angry{0%{transform:translateX(0)}20%{transform:translateX(-3px)}40%{transform:translateX(3px)}60%{transform:translateX(-2px)}80%{transform:translateX(2px)}100%{transform:translateX(0)}}
.blink{animation: blink 6s infinite}
@keyframes blink{0%,96%,100%{transform:scaleY(1)}97%{transform:scaleY(.15)}98%{transform:scaleY(1)}}

/* Micro-animations */
@keyframes pop {0%{transform:scale(.98)} 45%{transform:scale(1.04)} 100%{transform:scale(1)}}
@keyframes wobble {0%{transform:rotate(0)} 20%{transform:rotate(-2deg)} 40%{transform:rotate(2deg)} 60%{transform:rotate(-1deg)} 100%{transform:rotate(0)}}
@keyframes shake {0%{transform:translateX(0)} 20%{transform:translateX(-2px)} 40%{transform:translateX(2px)} 60%{transform:translateX(-1px)} 80%{transform:translateX(1px)} 100%{transform:translateX(0)}}
#beaverStage.hype{animation:pop .28s ease}
#beaverStage.angry{animation:shake .28s ease}
#beaverStage.wobble{animation:wobble .6s ease}

/* Calendar */
.calGrid{display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-top:10px}
.calCell{border:0; border-radius:12px; padding:10px 0; font-weight:800; box-shadow:0 6px 18px rgba(0,0,0,.08); background:#fff; color:#0b1220}
.calCell.empty{opacity:.35}
.calCell.great{background:rgba(34,197,94,.18)}
.calCell.ok{background:rgba(96,165,250,.18)}
.calCell.meh{background:rgba(245,158,11,.18)}
.calCell.bad{background:rgba(239,68,68,.18)}
.calCell.rest{background:rgba(168,85,247,.18)}
.calLegend{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; color:var(--muted); font-size:12px}
.calLegend .dot{width:10px;height:10px;border-radius:999px; display:inline-block; margin-right:4px}
.calLegend .dot.great{background:rgba(34,197,94,.5)}
.calLegend .dot.ok{background:rgba(96,165,250,.5)}
.calLegend .dot.meh{background:rgba(245,158,11,.5)}
.calLegend .dot.bad{background:rgba(239,68,68,.5)}
.calLegend .dot.rest{background:rgba(168,85,247,.5)}

/* ===== Onboarding / Guide ===== */
.guideWrap{display:flex;flex-direction:column;gap:12px}
.guideHero{
  border-radius:18px;
  padding:12px 12px;
  background:linear-gradient(135deg, rgba(96,165,250,.18), rgba(52,211,153,.18));
  border:1px solid rgba(17,24,39,.08);
}
.guideHero .t{font-weight:1100;font-size:16px;margin:0 0 6px 0}
.guideHero .p{margin:0;color:var(--muted);font-weight:800;line-height:1.35;font-size:13px}
.guideCard{
  border-radius:18px;
  padding:12px 12px;
  background:linear-gradient(180deg,#ffffff,#f8fafc);
  border:1px solid rgba(17,24,39,.08);
}
.guideCard h4{margin:0 0 8px 0;font-size:15px}
.guideCard ul{margin:0;padding-left:18px;color:#0b1220;font-weight:900;line-height:1.35}
.guideCard li{margin:6px 0}
.dots{display:flex;gap:6px;justify-content:center;margin-top:2px}
.dots span{width:7px;height:7px;border-radius:999px;background:rgba(17,24,39,.18)}
.dots span.on{background:rgba(59,130,246,.75)}
/* ===== Micro interactions ===== */
.btn{position:relative;overflow:hidden}
.btn.rip::after{
  content:"";
  position:absolute;left:50%;top:50%;
  width:10px;height:10px;border-radius:999px;
  background:rgba(255,255,255,.55);
  transform:translate(-50%,-50%) scale(1);
  opacity:0;
  animation:ripple .55s ease;
}
@keyframes ripple{
  0%{opacity:.0;transform:translate(-50%,-50%) scale(.2)}
  20%{opacity:.75}
  100%{opacity:0;transform:translate(-50%,-50%) scale(14)}
}
.habit.flash{animation:flash .45s ease}
@keyframes flash{0%{transform:translateY(0)}30%{transform:translateY(-1px)}100%{transform:translateY(0)}}
/* Confetti */
#fx{position:fixed;inset:0;pointer-events:none;z-index:50;overflow:hidden}
.conf{position:absolute;top:-10px;width:8px;height:14px;border-radius:3px;opacity:.9;animation:confFall 1.15s linear forwards}
@keyframes confFall{0%{transform:translateY(0) rotate(0deg)}100%{transform:translateY(calc(100vh + 20px)) rotate(540deg);opacity:0.9}}
/* ===== Calendar tab ===== */
.calHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
.calMeta{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.calMeta .box{flex:1;min-width:120px}


  .chipRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .chip{border:1px solid rgba(17,24,39,.12);background:rgba(255,255,255,.75);padding:10px 10px;border-radius:14px;display:flex;align-items:center;gap:8px;font-weight:800}
  .chip small{font-weight:700;color:var(--muted)}
  .chip.on{border-color:rgba(59,130,246,.55);box-shadow:0 10px 24px rgba(59,130,246,.12);background:rgba(219,234,254,.85)}
  .guideCard h4{margin:0 0 8px 0}
  .guideCard .muted{color:var(--muted);font-weight:700;font-size:13px}

</style>
</head>
<body>
<div id="app">
  <div class="wrap">
    <div class="topbar">
      <div style="min-width:0">
        <div class="title">ü¶´ Beaver Builder</div>
        <div class="sub" id="subline">–¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫ ‚Ä¢ —à–º–æ—Ç –∏ –±–∞–∑–∞</div>
<div class="xpbar"><div id="xpFill"></div></div>
      </div>
      <div class="stats">
        <div class="pill"><span id="lvlTxt">Lv 1</span> <small id="rankTxt">–°–∞–∂–µ–Ω–µ—Ü</small></div>
        <div class="pill">ü™ô <span id="coinsTxt">0</span></div>
        <div class="pill">ü™µ <span id="woodTxt">0</span></div>
        <div class="pill">üî© <span id="metalTxt">0</span></div>
        <div class="pill">üî• <span id="streakTxt">0</span></div>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="panelMain"></div>

      <div class="card">
        <div class="mascotWrap">
          <div class="mascotTop">
            <div id="beaverStage" class="float" aria-label="–ë–æ–±—Ä-–º–∞—Å–∫–æ—Ç">
              <svg id="beaverSVG" viewBox="0 0 240 240" role="img" aria-label="–ë–æ–±—Ä —Å—Ç—Ä–æ–∏—Ç–µ–ª—å (–ø–æ–ª–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂)">
                <defs>
                  <radialGradient id="fur" cx="35%" cy="25%" r="85%">
                    <stop offset="0%" stop-color="#e0b089"/>
                    <stop offset="55%" stop-color="#b97a4a"/>
                    <stop offset="100%" stop-color="#7a4e28"/>
                  </radialGradient>
                  <radialGradient id="fur2" cx="35%" cy="25%" r="85%">
                    <stop offset="0%" stop-color="#c9976a"/>
                    <stop offset="100%" stop-color="#6a3f1f"/>
                  </radialGradient>
                  <linearGradient id="shine" x1="0" x2="1">
                    <stop offset="0" stop-color="rgba(255,255,255,.75)"/>
                    <stop offset="1" stop-color="rgba(255,255,255,0)"/>
                  </linearGradient>
                  <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="0" dy="6" stdDeviation="6" flood-opacity="0.25"/>
                  </filter>
                
                  <linearGradient id="g_cloth" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#93c5fd"/>
                    <stop offset="55%" stop-color="#60a5fa"/>
                    <stop offset="100%" stop-color="#1d4ed8"/>
                  </linearGradient>
                  <linearGradient id="g_yellow" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#fde68a"/>
                    <stop offset="55%" stop-color="#fbbf24"/>
                    <stop offset="100%" stop-color="#d97706"/>
                  </linearGradient>
                  <linearGradient id="g_metal" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#e5e7eb"/>
                    <stop offset="55%" stop-color="#94a3b8"/>
                    <stop offset="100%" stop-color="#334155"/>
                  </linearGradient>
                  <linearGradient id="g_leather" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#d6a77a"/>
                    <stop offset="55%" stop-color="#b97a4a"/>
                    <stop offset="100%" stop-color="#7a4e28"/>
                  </linearGradient>
                  <linearGradient id="g_neon" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#a7f3d0"/>
                    <stop offset="55%" stop-color="#34d399"/>
                    <stop offset="100%" stop-color="#047857"/>
                  </linearGradient>

                </defs>

                <!-- BG layer -->
                <g id="layer_bg"></g>

                <!-- Tail -->
                <g filter="url(#shadow)">
                  <path d="M170 160 C210 170 215 205 185 220 C165 230 145 220 150 200 C155 185 155 170 170 160Z" fill="rgba(135,80,40,.55)"/>
                  <path d="M168 170 C200 178 202 202 182 210" stroke="rgba(255,255,255,.25)" stroke-width="5" stroke-linecap="round"/>
                </g>

                <!-- Body + Head -->
                <g filter="url(#shadow)">
                  <!-- Legs base -->
                  <ellipse cx="98" cy="196" rx="22" ry="16" fill="url(#fur2)"/>
                  <ellipse cx="142" cy="196" rx="22" ry="16" fill="url(#fur2)"/>
                  <!-- Torso -->
                  <ellipse cx="120" cy="156" rx="70" ry="64" fill="url(#fur)"/>
                  <ellipse cx="120" cy="172" rx="54" ry="44" fill="rgba(255,255,255,.10)"/>
                  <!-- Arms -->
                  <ellipse cx="62" cy="160" rx="20" ry="18" fill="url(#fur2)"/>
                  <ellipse cx="178" cy="160" rx="20" ry="18" fill="url(#fur2)"/>
                  <!-- Head -->
                  <ellipse cx="120" cy="92" rx="74" ry="64" fill="url(#fur)"/>
                  <!-- Ears -->
                  <ellipse cx="72" cy="44" rx="18" ry="20" fill="url(#fur2)"/>
                  <ellipse cx="168" cy="44" rx="18" ry="20" fill="url(#fur2)"/>
                  <ellipse cx="72" cy="48" rx="10" ry="11" fill="rgba(255,255,255,.18)"/>
                  <ellipse cx="168" cy="48" rx="10" ry="11" fill="rgba(255,255,255,.18)"/>
                  <!-- Face patch -->
                  <ellipse cx="120" cy="110" rx="58" ry="42" fill="rgba(255,255,255,.10)"/>
                  <!-- Eyes -->
                  <g class="blink" style="transform-origin:120px 86px">
                    <circle cx="94" cy="86" r="9" fill="#0b0f19"/>
                    <circle cx="146" cy="86" r="9" fill="#0b0f19"/>
                    <circle cx="91" cy="83" r="3" fill="#fff"/>
                    <circle cx="143" cy="83" r="3" fill="#fff"/>
                  </g>
                  <!-- Nose -->
                  <path d="M116 98 Q120 90 124 98 Q120 104 116 98Z" fill="#0b0f19"/>
                  <!-- Teeth -->
                  <rect x="108" y="120" width="12" height="24" rx="4" fill="#fff"/>
                  <rect x="122" y="120" width="12" height="24" rx="4" fill="#fff"/>
                  <rect x="120" y="120" width="1" height="24" fill="rgba(17,24,39,.22)"/>
                  <!-- Blush -->
                  <circle cx="86" cy="112" r="8" fill="rgba(244,63,94,.12)"/>
                  <circle cx="154" cy="112" r="8" fill="rgba(244,63,94,.12)"/>
                </g>

                <!-- Gear overlays -->
                <g id="layer_body"></g>
                <g id="layer_paws"></g>
                <g id="layer_legs"></g>
                <g id="layer_head"></g>

                <!-- Gloss -->
                <path d="M52 82 C70 40 104 28 138 28 C110 46 92 70 84 98 C78 90 64 88 52 82Z" fill="url(#shine)" opacity=".45"/>
              </svg>
            </div>
            <div class="bubble" id="speech">–ó–∞–≥—Ä—É–∂–∞—é —Å—Ç—Ä–æ–π–∫—É‚Ä¶</div>
          </div>

          <div class="btnRow">
            <button type="button" class="btn sm blue" data-act="suggestHabit">üß† –ü–æ–¥–∫–∏–Ω—å –ø—Ä–∏–≤—ã—á–∫—É</button>
            <button type="button" class="btn sm warn" data-act="collect">üì¶ –°–æ–±—Ä–∞—Ç—å –¥–æ–±—ã—á—É</button>
            <button type="button" class="btn sm" data-act="openChest">üéÅ –°—É–Ω–¥—É–∫ –¥–Ω—è</button>
            <button type="button" class="btn sm ghost" data-act="say">üé≠ –ï—â—ë</button>
          </div>
          <div class="note" id="toneHint"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="nav" role="navigation" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
    <button type="button" data-tab="today" class="active"><div class="ico">‚úÖ</div><div>–°–µ–≥–æ–¥–Ω—è</div></button>
    <button type="button" data-tab="calendar"><div class="ico">üóìÔ∏è</div><div>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div></button>
    <button type="button" data-tab="habits"><div class="ico">üßæ</div><div>–ü—Ä–∏–≤—ã—á–∫–∏</div></button>
    <button type="button" data-tab="base"><div class="ico">üèóÔ∏è</div><div>–ë–∞–∑–∞</div></button>
    <button type="button" data-tab="shop"><div class="ico">üõ†Ô∏è</div><div>–®–º–æ—Ç–∫–∏</div></button>
    <button type="button" data-tab="me"><div class="ico">üì¶</div><div>–ü—Ä–æ—Ñ–∏–ª—å</div></button>
  </div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="sheet" role="dialog" aria-modal="true" aria-label="–û–∫–Ω–æ">
    <div class="h">
      <h2 id="mTitle">–û–∫–Ω–æ</h2>
      <button type="button" class="btn sm ghost" data-act="closeModal">‚úï</button>
    </div>
    <div id="mBody"></div>
  </div>
</div>

<div id="fx" aria-hidden="true"></div>

<div class="toast" id="toast"></div>

<script>
(function(){
  var KEY = "beaver_habit_builder_mobile_v3";
  function $(s,r){ return (r||document).querySelector(s); }
  function $all(s,r){ return Array.prototype.slice.call((r||document).querySelectorAll(s)); }
  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
  function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  // If JS fails (old browsers), show visible hint
  window.onerror = function(msg, src, line, col){
    try{
      var t = $("#toast");
      t.textContent = "–û—à–∏–±–∫–∞: " + msg + " (–æ–±–Ω–æ–≤–∏ –±—Ä–∞—É–∑–µ—Ä)";
      t.classList.add("show");
    }catch(e){}
  };

  var RES = [
    ["wood","ü™µ","–î–µ—Ä–µ–≤–æ"],
    ["metal","üî©","–ú–µ—Ç–∞–ª–ª"]
  ];



  var EMO = ["üíß","üèÉ","üìö","üß†","ü•¶","üßò","üò¥","ü¶∑","üßº","üßπ","üìù","üéØ","üö∂","üí™","üçé","ü•õ","üéß","üìµ","üïØÔ∏è","üß©","üéπ","üó£Ô∏è","üåø","üß±","üõ†Ô∏è","üì¶","üßØ","‚òÄÔ∏è","‚è≥","üß¥","üßΩ","üõèÔ∏è","üßä","ü´ó","üßò‚Äç‚ôÇÔ∏è"];

  var RANKS = [
    {min:1, name:"–°–∞–∂–µ–Ω–µ—Ü"},
    {min:5, name:"–ü–æ–¥–º–∞—Å—Ç–µ—Ä—å–µ"},
    {min:10, name:"–ü–ª–æ—Ç–Ω–∏–∫ –¥–Ω—è"},
    {min:18, name:"–ü—Ä–æ—Ä–∞–±"},
    {min:28, name:"–ò–Ω–∂–µ–Ω–µ—Ä —Å—Ç—Ä–æ–π–∫–∏"},
    {min:40, name:"–ì–ª–∞–≤–±–æ–±—Ä"},
    {min:55, name:"–õ–µ–≥–µ–Ω–¥–∞ –ø–ª–æ—Ç–∏–Ω—ã"}
  ];

  var BUILDINGS = [
    // –ë–∞–ª–∞–Ω—Å: —Å—Ç–æ–∏–º–æ—Å—Ç—å ‚Üî –¥–æ—Ö–æ–¥ ‚Üî —Å–º—ã—Å–ª. "–°–∫–ª–∞–¥‚Äë–¥–µ–ø–æ" ‚Äî –º–µ–Ω—å—à–µ –¥–æ—Ö–æ–¥, –Ω–æ –¥–∞—ë—Ç –∫–∞–ø —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∫–∞–ø –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –≤ –∑–¥–∞–Ω–∏—è—Ö.
    {id:"sawmill", name:"–õ–µ—Å–æ–ø–∏–ª–∫–∞",  icon:"ü™µ", capHours:6,  produces:{wood:12},            baseCost:{coins:45,  wood:0,  metal:8}},
    {id:"foundry", name:"–ü–ª–∞–≤–∏–ª—å–Ω—è",  icon:"üî©", capHours:6,  produces:{metal:8},           baseCost:{coins:45,  wood:12, metal:0}},
    {id:"yard",    name:"–°—Ç—Ä–æ–π‚Äë–¥–≤–æ—Ä", icon:"üèóÔ∏è", capHours:8,  produces:{wood:7, metal:5},   baseCost:{coins:95,  wood:26, metal:18}},
    {id:"depot",   name:"–°–∫–ª–∞–¥‚Äë–¥–µ–ø–æ", icon:"üì¶", capHours:10, produces:{wood:4, metal:4},   baseCost:{coins:140, wood:55, metal:42},
      special:"–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ª–∏–º–∏—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è ü™µ/üî© –∏ –ª–∏–º–∏—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–æ–±—ã—á–∏ –≤ –∑–¥–∞–Ω–∏—è—Ö."
    }
  ];



  var GEAR = [
    // === –ì–û–õ–û–í–ê (5) ===
    {slot:"head", id:"h1", name:"–ë–∞–Ω–¥–∞–Ω–∞ —Å—Ç–∞–∂—ë—Ä–∞", rarity:"–æ–±—ã—á–Ω–∞—è",  cost:{coins:30, wood:12}, perks:{xp:0.04}, desc:"+4% XP. –£–∑–µ–ª –¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ —á–µ—Å—Ç–Ω–æ–º —Å–ª–æ–≤–µ."},
    {slot:"head", id:"h2", name:"–ö–∞—Å–∫–∞ –Ω–æ–≤–∏—á–∫–∞",   rarity:"—Ä–µ–¥–∫–∞—è",   cost:{coins:90, wood:18, metal:14}, perks:{xp:0.08, coins:0.04}, desc:"+8% XP, +4% ü™ô. –ì–æ–ª–æ–≤–∞ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –ø–ª–∞–Ω—ã ‚Äî –Ω–µ—Ç."},
    {slot:"head", id:"h3", name:"–ö–∞—Å–∫–∞ —Å —Ñ–æ–Ω–∞—Ä—ë–º", rarity:"—ç–ø–∏–∫",     cost:{coins:160, wood:30, metal:30}, perks:{xp:0.12, res:0.06}, desc:"+12% XP, +6% –¥–æ–±—ã—á–∏. –°–≤–µ—Ç–∏—Ç –¥–∞–∂–µ –≤ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏—è—Ö."},
    {slot:"head", id:"h4", name:"–®–ª–µ–º –ø—Ä–æ—Ä–∞–±–∞",    rarity:"—ç–ø–∏–∫",     cost:{coins:260, wood:45, metal:60}, perks:{xp:0.16, coins:0.08, insurance:1}, desc:"+16% XP, +8% ü™ô. +1 —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞/–Ω–µ–¥."},
    {slot:"head", id:"h5", name:"–≠–∫–∑–æ‚Äë—à–ª–µ–º –ì–ª–∞–≤–±–æ–±—Ä–∞", rarity:"–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è", cost:{coins:420, wood:90, metal:120}, perks:{xp:0.22, coins:0.12, res:0.12, insurance:2}, desc:"+22% XP, +12% ü™ô, +12% –¥–æ–±—ã—á–∏. +2 —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏/–Ω–µ–¥."},

    // === –õ–ê–ü–ö–ò (5) ===
    {slot:"paws", id:"p1", name:"–ü–µ—Ä—á–∞—Ç–∫–∏ —Ä–∞–±–æ—Ç—è–≥–∏", rarity:"–æ–±—ã—á–Ω–∞—è", cost:{coins:35, metal:10}, perks:{coins:0.04}, desc:"+4% ü™ô. –õ–∞–π–∫, –µ—Å–ª–∏ –ª–∞–ø—ã –Ω–µ –º–µ—Ä–∑–Ω—É—Ç."},
    {slot:"paws", id:"p2", name:"–ú–æ–ª–æ—Ç–æ–∫ ¬´–ø–æ‚Äë–¥–µ–ª—É¬ª", rarity:"—Ä–µ–¥–∫–∞—è",  cost:{coins:95, wood:20, metal:18}, perks:{coins:0.08}, desc:"+8% ü™ô. –û–¥–∏–Ω —Å—Ç—É–∫ ‚Äî –∏ —Ç—ã –≤–Ω–µ–∑–∞–ø–Ω–æ —Å–æ–±—Ä–∞–ª—Å—è."},
    {slot:"paws", id:"p3", name:"–®—É—Ä—É–ø–æ–≤—ë—Ä—Ç ¬´–Ω–µ —Å–µ–π—á–∞—Å¬ª", rarity:"—ç–ø–∏–∫", cost:{coins:180, wood:35, metal:40}, perks:{res:0.10}, desc:"+10% –¥–æ–±—ã—á–∏. –í–∫—Ä—É—á–∏–≤–∞–µ—Ç –º–æ—Ç–∏–≤–∞—Ü–∏—é –±–µ–∑ —Å–ø—Ä–æ—Å–∞."},
    {slot:"paws", id:"p4", name:"–ü–ª–∞–Ω—à–µ—Ç –ø—Ä–æ—Ä–∞–±–∞",  rarity:"—ç–ø–∏–∫",     cost:{coins:280, wood:55, metal:70}, perks:{xp:0.14}, desc:"+14% XP. –¢—É—Ç –≤—Å—ë —Ä–∞—Å–ø–∏—Å–∞–Ω–æ ‚Äî –∫—Ä–æ–º–µ —Ç–≤–æ–∏—Ö –æ—Ç–º–∞–∑–æ–∫."},
    {slot:"paws", id:"p5", name:"–ú–µ—Ö‚Äë–∫—Ä–∞–≥–∏ ¬´—É–ª—å—Ç—Ä–∞¬ª", rarity:"–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è", cost:{coins:450, wood:90, metal:140}, perks:{xp:0.10, coins:0.10, res:0.10}, desc:"+10% XP/ü™ô/–¥–æ–±—ã—á–∏. –õ–∞–ø–∫–∏ —Ç–µ–ø–µ—Ä—å –≤ —Ä–µ–∂–∏–º–µ –±–æ—Å—Å–∞."},

    // === –¢–ï–õ–û (5) ===
    {slot:"body", id:"b1", name:"–ú–∞–π–∫–∞ —Å—Ç—Ä–æ–π‚Äë—Ä–µ–∂–∏–º", rarity:"–æ–±—ã—á–Ω–∞—è", cost:{coins:40, wood:14}, perks:{xp:0.04}, desc:"+4% XP. –í–æ–∑–¥—É—Ö –≤ –º–∞–π–∫–µ = –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –¥—É—à–µ."},
    {slot:"body", id:"b2", name:"–ñ–∏–ª–µ—Ç–∫–∞ ¬´–≤–∏–¥–Ω–æ –∏–∑ –∫–æ—Å–º–æ—Å–∞¬ª", rarity:"—Ä–µ–¥–∫–∞—è", cost:{coins:110, wood:20, metal:16}, perks:{coins:0.06}, desc:"+6% ü™ô. –ï—Å–ª–∏ –ø–æ—Ç–µ—Ä—è–ª—Å—è ‚Äî —Ç–µ–±—è –Ω–∞–π–¥—É—Ç."},
    {slot:"body", id:"b3", name:"–ö–æ–º–±–∏–Ω–µ–∑–æ–Ω –º–∞—Å—Ç–µ—Ä–∞", rarity:"—ç–ø–∏–∫",   cost:{coins:210, wood:45, metal:35}, perks:{xp:0.10, res:0.06}, desc:"+10% XP, +6% –¥–æ–±—ã—á–∏. –°–∏–¥–∏—Ç –∫–∞–∫ –Ω–∞–¥–æ (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Ä–µ–∂–∏–º–∞ —Å–Ω–∞)."},
    {slot:"body", id:"b4", name:"–ö—É—Ä—Ç–∫–∞ –ø—Ä–æ—Ä–∞–±–∞",     rarity:"—ç–ø–∏–∫",   cost:{coins:320, wood:70, metal:70}, perks:{xp:0.12, coins:0.10, insurance:1}, desc:"+12% XP, +10% ü™ô. +1 —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞/–Ω–µ–¥."},
    {slot:"body", id:"b5", name:"–≠–∫–∑–æ‚Äë–±—Ä–æ–Ω—è ¬´—Å—Ç—Ä–æ–π‚Äë–±–æ–≥¬ª", rarity:"–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è", cost:{coins:520, wood:120, metal:160}, perks:{xp:0.18, coins:0.12, res:0.12, insurance:1}, desc:"+18% XP, +12% ü™ô, +12% –¥–æ–±—ã—á–∏. –ë–æ—Å—Å‚Äë–≤–∏–±—Ä–∞—Ü–∏–∏."},

    // === –ù–û–ì–ò (5) ===
    {slot:"legs", id:"l1", name:"–ö–µ–¥—ã ¬´–¥–æ –º–∞–≥–∞–∑–∏–Ω–∞¬ª", rarity:"–æ–±—ã—á–Ω–∞—è", cost:{coins:35, wood:10}, perks:{xp:0.03}, desc:"+3% XP. –¢–∏—Ö–æ –ø–æ–¥–æ—à—ë–ª ‚Äî —Ç–∏—Ö–æ —Å–¥–µ–ª–∞–ª."},
    {slot:"legs", id:"l2", name:"–ë–æ—Ç–∏–Ω–∫–∏ —Ä–∞–±–æ—Ç—è–≥–∏",   rarity:"—Ä–µ–¥–∫–∞—è", cost:{coins:100, wood:18, metal:18}, perks:{xp:0.06}, desc:"+6% XP. –®–∞–≥–∏ —É–≤–µ—Ä–µ–Ω–Ω—ã–µ, –º—ã—Å–ª–∏‚Ä¶ —Å–ø–æ—Ä–Ω–æ."},
    {slot:"legs", id:"l3", name:"–ë–µ—Ä—Ü—ã —Å –Ω–æ—Å–∫–æ–º",     rarity:"—ç–ø–∏–∫",   cost:{coins:190, wood:28, metal:45}, perks:{res:0.08}, desc:"+8% –¥–æ–±—ã—á–∏. –¢–æ–ø–∞–µ—Ç ‚Äî –∏ —Ä–µ—Å—É—Ä—Å—ã —Å–∞–º–∏ –∏–¥—É—Ç."},
    {slot:"legs", id:"l4", name:"–°–∞–ø–æ–≥–∏ –ø—Ä–æ—Ä–∞–±–∞",     rarity:"—ç–ø–∏–∫",   cost:{coins:290, wood:45, metal:75}, perks:{xp:0.10, coins:0.06}, desc:"+10% XP, +6% ü™ô. –°—Ç—É–ø–∏–ª ‚Äî –∏ –¥–µ–Ω—å –∑–∞–∫—Ä—ã–ª—Å—è."},
    {slot:"legs", id:"l5", name:"–≠–∫–∑–æ‚Äë–±–æ—Ç—ã ¬´—Ä–µ–∞–∫—Ç–∏–≤¬ª", rarity:"–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è", cost:{coins:480, wood:80, metal:150}, perks:{xp:0.12, res:0.12}, desc:"+12% XP, +12% –¥–æ–±—ã—á–∏. –í—á–µ—Ä–∞—à–Ω–∏–π —Ç—ã –≤ —à–æ–∫–µ."},

    // === –§–û–ù (5) ===
    {slot:"bg", id:"g1", name:"–î–≤–æ—Ä‚Äë—Å—Ç—Ä–æ–π–∫–∞",       rarity:"–æ–±—ã—á–Ω–∞—è", cost:{coins:25, wood:10}, perks:{}, desc:"–ü—Ä–æ—Å—Ç–æ —É—é—Ç–Ω–æ. –ö–∞–∫ –±—É–¥—Ç–æ –∂–∏–∑–Ω—å –≤ –ø–æ—Ä—è–¥–∫–µ (—Ö–∞—Ö–∞)."},
    {slot:"bg", id:"g2", name:"–ß–µ—Ä—Ç—ë–∂‚Äë—Å–µ—Ç–∫–∞",       rarity:"—Ä–µ–¥–∫–∞—è",  cost:{coins:90, wood:25}, perks:{xp:0.06}, desc:"+6% XP. –°–µ—Ç–∫–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã ‚Äî –Ω–µ –æ–±—Å—É–∂–¥–∞–µ—Ç—Å—è."},
    {slot:"bg", id:"g3", name:"–ö—Ä–∞–Ω –Ω–∞ –∑–∞–∫–∞—Ç–µ",     rarity:"—ç–ø–∏–∫",    cost:{coins:180, wood:35, metal:30}, perks:{coins:0.08}, desc:"+8% ü™ô. –ö—Ä–∞—Å–∏–≤–æ, –∞ –∑–Ω–∞—á–∏—Ç ‚Äî –Ω–∞–¥–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å–µ—Ä–∏—é."},
    {slot:"bg", id:"g4", name:"–ù–æ—á–Ω–∞—è —Å–º–µ–Ω–∞",       rarity:"—ç–ø–∏–∫",    cost:{coins:260, wood:45, metal:55}, perks:{res:0.10}, desc:"+10% –¥–æ–±—ã—á–∏. –¢—ë–º–Ω–æ, –Ω–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ."},
    {slot:"bg", id:"g5", name:"–®—Ç–∞–±‚Äë–∫–≤–∞—Ä—Ç–∏—Ä–∞ –ì–ª–∞–≤–±–æ–±—Ä–∞", rarity:"–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è", cost:{coins:420, wood:90, metal:110}, perks:{xp:0.10, coins:0.10, res:0.10}, desc:"+10% XP/ü™ô/–¥–æ–±—ã—á–∏. –ú–∞–∫—Å–∏–º—É–º ¬´—è —Ç—É—Ç –≥–ª–∞–≤–Ω—ã–π¬ª."}
  ];

  // –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: –≥–æ—Ç–æ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ —Å –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–æ–π (—á—Ç–æ–±—ã —á–µ–ª–æ–≤–µ–∫ –Ω–µ –¥—É–º–∞–ª —Å –Ω—É–ª—è)
  var PRESET_HABITS = [
    {title:"–û—Ç–∂–∏–º–∞–Ω–∏—è 15 —Ä–∞–∑", emoji:"üí™", diff:"medium"},
    {title:"1.5 –ª–∏—Ç—Ä–∞ –≤–æ–¥—ã", emoji:"üíß", diff:"easy"},
    {title:"–ß—Ç–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç", emoji:"üìö", diff:"easy"},
    {title:"–ü—Ä–æ–≥—É–ª–∫–∞ 20 –º–∏–Ω—É—Ç", emoji:"üö∂", diff:"easy"},
    {title:"–ü—Ä–µ—Å—Å 3√ó20", emoji:"üî•", diff:"medium"},
    {title:"–ü–ª–∞–Ω –¥–Ω—è 5 –º–∏–Ω—É—Ç", emoji:"üóíÔ∏è", diff:"easy"},
    {title:"–†–∞—Å—Ç—è–∂–∫–∞ 10 –º–∏–Ω—É—Ç", emoji:"üßò", diff:"easy"},
    {title:"–ë–µ–∑ —Å–ª–∞–¥–∫–æ–≥–æ —Å–µ–≥–æ–¥–Ω—è", emoji:"üç©üö´", diff:"hard"},
    {title:"–õ–µ—á—å –¥–æ 23:30", emoji:"üåô", diff:"medium"},
    {title:"–£—á—ë–±–∞/–Ω–∞–≤—ã–∫ 20 –º–∏–Ω—É—Ç", emoji:"üß†", diff:"medium"}
  ];

  // –ê–≤—Ç–æ—Ç–∏—Ä –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ (–¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç–æ–ø-–ª—É—Ç–∞ –∑–∞ —Å–µ—Ä–∏–∏)
  (function(){
    var epicCount = {};
    for(var i=0;i<GEAR.length;i++){
      var it = GEAR[i];
      if(it.rarity==="–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è"){ it.tier = 5; continue; }
      if(it.rarity==="—Ä–µ–¥–∫–∞—è"){ it.tier = 2; continue; }
      if(it.rarity==="—ç–ø–∏–∫"){
        epicCount[it.slot] = (epicCount[it.slot]||0) + 1;
        it.tier = (epicCount[it.slot]===1) ? 3 : 4;
        continue;
      }
      it.tier = 1;
    }
  })();


  var HABIT_SUGGEST = [
    {emoji:"üíß", name:"–í–æ–¥–∞ 1.5–ª"},
    {emoji:"üèÉ", name:"10 –º–∏–Ω—É—Ç —Ö–æ–¥—å–±—ã"},
    {emoji:"üìö", name:"15 –º–∏–Ω—É—Ç —á—Ç–µ–Ω–∏—è"},
    {emoji:"ü¶∑", name:"–ù–∏—Ç—å –¥–ª—è –∑—É–±–æ–≤"},
    {emoji:"üßò", name:"3 –º–∏–Ω—É—Ç—ã –¥—ã—Ö–∞–Ω–∏—è"},
    {emoji:"üìµ", name:"–ë–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∑–∞ —á–∞—Å –¥–æ —Å–Ω–∞"},
    {emoji:"üìù", name:"3 —Å—Ç—Ä–æ–∫–∏ –¥–Ω–µ–≤–Ω–∏–∫–∞"},
    {emoji:"ü•¶", name:"–û–≤–æ—â–∏ —Å–µ–≥–æ–¥–Ω—è"},
    {emoji:"üí™", name:"15 –æ—Ç–∂–∏–º–∞–Ω–∏–π"},
    {emoji:"üõèÔ∏è", name:"–õ–æ–∂—É—Å—å –¥–æ 00:30"}
  ];

  var TASKS = [
    "–°–¥–µ–ª–∞–π 10 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π. –î–∞, –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å. –Ø —Å–º–æ—Ç—Ä—é.",
    "–ü–æ—Å—Ç–∞–≤—å —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã —Ä—è–¥–æ–º. –í—ã–ø—å–µ—à—å ‚Äî –≤–µ—Ä–Ω—ë—à—å—Å—è –∫–∞–∫ –≥–µ—Ä–æ–π.",
    "–û—Ç–∫—Ä–æ–π –æ–∫–Ω–æ –Ω–∞ 30 —Å–µ–∫—É–Ω–¥. –í–¥–æ—Ö–Ω–∏. –ñ–∏–∑–Ω—å –Ω–µ –±–∞–≥, —Ç—ã –ø—Ä–æ—Å—Ç–æ –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏.",
    "–ù–∞–ø–∏—à–∏ –æ–¥–Ω—É —Ü–µ–ª—å –Ω–∞ –∑–∞–≤—Ç—Ä–∞. –û–¥–Ω—É. –ù–µ —Å–ø–∏—Å–æ–∫ –Ω–∞ 47 –ø—É–Ω–∫—Ç–æ–≤.",
    "–£–±–µ—Ä–∏ 3 –≤–µ—â–∏ –Ω–∞ –º–µ—Å—Ç–æ. –Ø —Å—á–∏—Ç–∞—é.",
    "–ü–æ—Ç—è–Ω–∏—Å—å 20 —Å–µ–∫—É–Ω–¥. –¢—ã –Ω–µ –±—Ä–µ–≤–Ω–æ. –•–æ—Ç—è‚Ä¶ –±—Ä–µ–≤–Ω–æ ‚Äî —ç—Ç–æ —Ä–µ—Å—É—Ä—Å.",
    "–ü—Ä–æ–π–¥–∏ 200 —à–∞–≥–æ–≤ –ø–æ –∫–æ–º–Ω–∞—Ç–µ. –î–∞, –∑–≤—É—á–∏—Ç –≥–ª—É–ø–æ. –ü–æ—ç—Ç–æ–º—É —Ä–∞–±–æ—Ç–∞–µ—Ç."
  ];

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, function(m){
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }

  function localISODate(d){
    d = d || new Date();
    var y = d.getFullYear();
    var m = String(d.getMonth()+1).padStart(2,"0");
    var day = String(d.getDate()).padStart(2,"0");
    return y + "-" + m + "-" + day;
  }
  // alias used by calendar / legacy code
  function isoDate(d){ return localISODate(d); }
  function addDays(iso,n){
    var p = iso.split("-"); var y=+p[0], m=+p[1], d=+p[2];
    var dt = new Date(y,m-1,d); dt.setDate(dt.getDate()+n);
    return localISODate(dt);
  }
  function daysBetween(a,b){
    var pa=a.split("-"), pb=b.split("-");
    var ta = new Date(+pa[0],+pa[1]-1,+pa[2]).getTime();
    var tb = new Date(+pb[0],+pb[1]-1,+pb[2]).getTime();
    return Math.round((tb-ta)/86400000);
  }
  function weekKey(d){
    d = d || new Date();
    var dt = new Date(d.getTime()); dt.setHours(0,0,0,0);
    dt.setDate(dt.getDate() + 3 - (dt.getDay()+6)%7);
    var week1 = new Date(dt.getFullYear(),0,4);
    var w = 1 + Math.round(((dt - week1)/86400000 - 3 + (week1.getDay()+6)%7)/7);
    return dt.getFullYear() + "-W" + String(w).padStart(2,"0");
  }

  function xpNeed(level){
    return Math.round(80 * Math.pow(level, 1.35));
  }
  function getRank(level){
    var r = RANKS[0].name;
    for(var i=0;i<RANKS.length;i++){
      if(level>=RANKS[i].min) r = RANKS[i].name;
    }
    return r;
  }

  function diffRewards(d){
    if(d==="hard") return {xp:22, coins:12};
    if(d==="normal") return {xp:14, coins:8};
    return {xp:10, coins:6};
  }
  function diffName(d){
    return d==="easy" ? "–ª—ë–≥–∫–∞—è" : (d==="hard" ? "–∂—ë—Å—Ç–∫–∞—è" : "–Ω–æ—Ä–º");
  }

  
  function addHabitFromPreset(p){
    // –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –¥—É–±–ª—å –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–≥—Ä—É–±–∞—è –∑–∞—â–∏—Ç–∞)
    var name = (p.title||"").trim();
    if(!name) return;
    for(var i=0;i<state.habits.length;i++){
      if((state.habits[i].name||"").trim().toLowerCase()===name.toLowerCase()){
        continue;
      }
    }
    var d = p.diff || "easy";
    var r = diffRewards(d);
    state.habits.push({
      id: uid(),
      emoji: p.emoji || "‚úÖ",
      name: name,
      diff: d,
      xp: r.xp,
      coins: r.coins,
      active: true
    });
  }
function defaultState(){
    var now = localISODate();
    var habits = [
      {id:uid(), emoji:"üíß", name:"–í–æ–¥–∞", diff:"easy", xp:10, coins:6, active:true, createdAt:Date.now()},
      {id:uid(), emoji:"üèÉ", name:"10 –º–∏–Ω—É—Ç —Ö–æ–¥—å–±—ã", diff:"easy", xp:10, coins:6, active:true, createdAt:Date.now()},
      {id:uid(), emoji:"üìö", name:"–ß—Ç–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç", diff:"normal", xp:14, coins:8, active:true, createdAt:Date.now()},
      {id:uid(), emoji:"ü¶∑", name:"–ù–∏—Ç—å –¥–ª—è –∑—É–±–æ–≤", diff:"easy", xp:10, coins:6, active:true, createdAt:Date.now()}
    ];
    var b = {};
    for(var i=0;i<BUILDINGS.length;i++){
      var x = BUILDINGS[i];
      b[x.id] = {level: (x.id==="sawmill"?1:0), lastTick: Date.now(), banked:{}};
    }
    var owned = {head:[],paws:[],body:[],legs:[],bg:[]};
    return {
      v:4,
      user:{
        xp:0, level:1, coins:120, streak:0, perfectStreak:0,
        insuranceLeft:0, insuranceWeek:weekKey(new Date()),
        lastDay: now,
        behavior:{wins:0, misses:0, last14:[]},
        chest:{lastOpen:""}, seenGuide:false
      },
      day:{date: now, done:{}, closed:false, rest:false},
      habits: habits,
      resources:{wood:50, metal:25},
      base:{buildings:b},
      gear:{owned:owned, equipped:{head:null,paws:null,body:null,legs:null,bg:null}},
      quests:{active:null},
      logs:{}
    };
  }

  function migrateV3toV4(st){
    // –ø–µ—Ä–µ–Ω–æ—Å–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–æ —Å—Ç–∞—Ä–æ–π —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∫ –Ω–æ–≤–æ–π (wood + metal)
    st.v = 4;

    st.resources = st.resources || {};
    // wood –æ—Å—Ç–∞—ë—Ç—Å—è
    var wood = Number(st.resources.wood||0);
    // –º–µ—Ç–∞–ª–ª —Å–æ–±–∏—Ä–∞–µ–º –∏–∑ –∫–∞–º–Ω—è + –≥–≤–æ–∑–¥–µ–π + —à–µ—Å—Ç–µ—Ä—ë–Ω–æ–∫ (–µ—Å–ª–∏ –±—ã–ª–∏)
    var metal = 0;
    if(st.resources.stone) metal += Number(st.resources.stone||0);
    if(st.resources.nails) metal += Math.floor(Number(st.resources.nails||0) * 0.75);
    if(st.resources.gears) metal += Math.floor(Number(st.resources.gears||0) * 1.25);
    if(st.resources.crystals) metal += Math.floor(Number(st.resources.crystals||0) * 6);
    // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –º–∏–Ω–∏–º—É–º, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –Ω—É–ª—è –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
    st.resources = {wood: Math.max(0, Math.floor(wood)), metal: Math.max(0, Math.floor(metal))};

    // –±–∞–∑–∞: –ø–µ—Ä–µ–Ω–æ—Å —É—Ä–æ–≤–Ω–µ–π
    st.base = st.base || {buildings:{}};
    st.base.buildings = st.base.buildings || {};

    function pickLevel(id){
      var b = st.base.buildings[id];
      return b && b.level ? Number(b.level) : 0;
    }

    var saw = pickLevel("sawmill");
    var foundry = Math.max(pickLevel("quarry"), pickLevel("workshop"));
    var yard = Math.max(pickLevel("paintbooth"), pickLevel("bakery"));
    var depot = pickLevel("lab");

    var newBuildings = {
      sawmill:{level:saw, banked:{}},
      foundry:{level:foundry, banked:{}},
      yard:{level:yard, banked:{}},
      depot:{level:depot, banked:{}}
    };
    st.base.buildings = newBuildings;

    // —à–º–æ—Ç: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ, —á—Ç–æ –±—ã–ª–æ (id —Å–æ–≤–ø–∞–¥–∞—é—Ç), –Ω–æ —á–∏—Å—Ç–∏–º –≤–ª–∞–¥–µ–Ω–∏–µ
    st.gear = st.gear || {owned:{}, equipped:{}};
    st.gear.owned = st.gear.owned || {};
    st.gear.equipped = st.gear.equipped || {};

    return st;
  }

function load(){
    try{
      var raw = localStorage.getItem(KEY);
      if(!raw) return defaultState();
      var st = JSON.parse(raw);
      if(!st || (st.v!==3 && st.v!==4)) return defaultState();
      if(st.v===3) st = migrateV3toV4(st);

      // backfill missing keys safely
      if(!st.user) st.user = defaultState().user;
      if(!st.user.behavior) st.user.behavior = {wins:0, misses:0, last14:[]};
      if(!st.user.chest) st.user.chest = {lastOpen:""};
      if(st.user.perfectStreak==null) st.user.perfectStreak = 0;
      if(!st.base || !st.base.buildings) st.base = defaultState().base;
      if(!st.gear || !st.gear.owned || !st.gear.equipped) st.gear = defaultState().gear;
      if(!st.resources) st.resources = defaultState().resources;
      if(!st.day) st.day = defaultState().day;
      if(!st.habits) st.habits = defaultState().habits;
      return st;
    }catch(e){
      return defaultState();
    }
  }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  
  function spawnConfetti(){
    var fx = $("#fx");
    if(!fx) return;
    var W = window.innerWidth || 360;
    var colors = ["rgba(34,197,94,.95)","rgba(96,165,250,.95)","rgba(251,191,36,.95)","rgba(244,63,94,.90)","rgba(147,51,234,.90)"];
    for(var i=0;i<26;i++){
      var d=document.createElement("div");
      d.className="conf";
      d.style.left = Math.floor(Math.random()*W) + "px";
      d.style.background = colors[i%colors.length];
      d.style.animationDuration = (0.9 + Math.random()*0.7).toFixed(2) + "s";
      fx.appendChild(d);
      setTimeout((function(el){ return function(){ if(el && el.parentNode) el.parentNode.removeChild(el); };})(d), 1800);
    }
  }
function toast(msg){
    var t = $("#toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(function(){ t.classList.remove("show"); }, 1600);
  }

  function iconOf(key){
    if(key==="coins") return "ü™ô";
    for(var i=0;i<RES.length;i++) if(RES[i][0]===key) return RES[i][1];
    return "‚Ä¢";
  }
  function costLine(cost){
    var parts = [];
    for(var k in cost){
      var v = cost[k] || 0;
      if(v<=0) continue;
      parts.push(iconOf(k) + " " + v);
    }
    return parts.join(" ‚Ä¢ ") || "‚Äî";
  }

  function sumPerks(){
    var eq = state.gear.equipped;
    var out = {xp:0, coins:0, res:0, insurance:0};
    for(var slot in eq){
      var id = eq[slot];
      if(!id) continue;
      for(var i=0;i<GEAR.length;i++){
        if(GEAR[i].id===id){
          var p = GEAR[i].perks || {};
          if(p.xp) out.xp += p.xp;
          if(p.coins) out.coins += p.coins;
          if(p.res) out.res += p.res;
          if(p.insurance) out.insurance += p.insurance;
          break;
        }
      }
    }
    return out;
  }

  function tone(){
    var b = state.user.behavior;
    var miss = b.misses || 0;
    var win = b.wins || 0;
    var ratio = win / Math.max(1, win + miss);
    if(state.user.streak >= 7 && ratio >= 0.75) return "hype";
    if(state.user.streak >= 3 && ratio >= 0.55) return "banter";
    if(miss >= 2 && ratio < 0.5) return "angry";
    return "neutral";
  }

  // Meme generator: produces thousands (>>400)
  var MEME = (function(){
    // Curated, –º–µ–Ω—å—à–µ –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚Äî –±–æ–ª—å—à–µ —Å–º—ã—Å–ª–∞.
    // ctx: any | praise | miss | suggest | buy | equip | build | chest | guide
    var pool = {
      any:[
        "–Ø —Ç—É—Ç. –¢—ã —Ç–∞–º. –î–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º –≤–∏–¥, —á—Ç–æ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞.",
        "–¢–∞–ø–Ω–∏ —á–µ–∫–ª–∏—Å—Ç ‚Äî –º–æ–∑–≥ –ª—é–±–∏—Ç –∫–Ω–æ–ø–∫–∏ –±–æ–ª—å—à–µ, —á–µ–º –º–µ—á—Ç—ã.",
        "–°–µ–≥–æ–¥–Ω—è –±–µ–∑ –≥–µ—Ä–æ–π—Å—Ç–≤–∞: –º–∞–ª–µ–Ω—å–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ, –æ—Ç–º–µ—Ç–∫–∞, –ª—É—Ç.",
        "–°–µ—Ä–∏—è –¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏. –ù–∞ —Å–ª–µ–¥—É—é—â–µ–º. –ò –Ω–∞ –µ—â—ë –æ–¥–Ω–æ–º.",
        "–ù–µ —É—Å–ª–æ–∂–Ω—è–π: —Å–¥–µ–ª–∞–ª ‚Äî –æ—Ç–º–µ—Ç–∏–ª. –ù–µ —Å–¥–µ–ª–∞–ª ‚Äî —Ç–æ–∂–µ –æ—Ç–º–µ—Ç–∏–ª, –Ω–æ —á–µ—Å—Ç–Ω–æ.",
        "–•–æ—á–µ—à—å –º–æ—Ç–∏–≤–∞—Ü–∏—é? –í–æ—Ç –æ–Ω–∞: ü™ô.",
        "–ë–∞–∑–∞ —Ä–∞—Å—Ç—ë—Ç —Å–∞–º–∞. –ö–∞–∫ —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å. –¢–æ–ª—å–∫–æ –ø–æ–ª–µ–∑–Ω–æ.",
        "–ï—Å–ª–∏ —Ç—ã —ç—Ç–æ —á–∏—Ç–∞–µ—à—å ‚Äî —Ç—ã —É–∂–µ –≤–µ—Ä–Ω—É–ª—Å—è. –≠—Ç–æ –≤–∞–∂–Ω–æ.",
        "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî —ç—Ç–æ —Å–∫—É—á–Ω–æ. –ü–æ—ç—Ç–æ–º—É –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç.",
        "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ –≤—Ä—ë—Ç. –û–Ω –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç.",
        "–°–µ–π—á–∞—Å –±—ã –ø—Ä–∏–≤—ã—á–∫—É, –∞ –Ω–µ –µ—â—ë –æ–¥–Ω—É –≤–∫–ª–∞–¥–∫—É.",
        "–û—Ç–∫—Ä—ã–≤–∞–π –¥–µ–Ω—å. –ó–∞–∫—Ä—ã–≤–∞–π –¥–µ–Ω—å. –ü–æ–≤—Ç–æ—Ä—è–π. –í—Å—ë."
      ],
      guide:[
        "–û–∫–µ–π, —ç–∫—Å–∫—É—Ä—Å–∏—è –ø–æ —Å—Ç—Ä–æ–π–∫–µ. –ù–µ –ø–æ—Ç–µ—Ä—è–π—Å—è –º–µ–∂–¥—É ¬´—Å–¥–µ–ª–∞—é¬ª –∏ ¬´—Å–¥–µ–ª–∞–ª¬ª.",
        "–°–µ–π—á–∞—Å –æ–±—ä—è—Å–Ω—é –º–µ—Ö–∞–Ω–∏–∫—É —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏—à–ª–æ—Å—å –≥—É–≥–ª–∏—Ç—å –∂–∏–∑–Ω—å.",
        "–¢—É—Ç–æ—Ä–∏–∞–ª –∫–æ—Ä–æ—Ç–∫–∏–π. –ö–∞–∫ —Ç–≤–æ—è –æ—Ç–º–∞–∑–∫–∞ ¬´—É –º–µ–Ω—è –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏¬ª.",
        "–Ø –≤ —Ä–æ–ª–∏ –º—É–¥—Ä–æ–≥–æ –±–æ–±—Ä–∞. –î–∞, –∑–≤—É—á–∏—Ç —Å—Ç—Ä–∞–Ω–Ω–æ. –ù–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ."
      ],
      praise:[
        "‚úÖ –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ. –¢–µ–ø–µ—Ä—å –Ω–µ –∏—Å–ø–æ—Ä—Ç—å —ç—Ç–æ —Ñ–∏–ª–æ—Å–æ—Ñ–∏–µ–π.",
        "–ù–µ–ø–ª–æ—Ö–æ. –†–µ–∞–ª—å–Ω–æ. –î–∞–∂–µ —è –Ω–∞ —Å–µ–∫—É–Ω–¥—É —Å—Ç–∞–ª –¥–æ–±—Ä–µ–µ. –ù–∞ —Å–µ–∫—É–Ω–¥—É.",
        "–í–æ—Ç —ç—Ç–æ —Ç–µ–º–ø. –ï—â—ë —á—É—Ç—å-—á—É—Ç—å ‚Äî –∏ –ø—Ä–∏–≤—ã—á–∫–∞ —Å—Ç–∞–Ω–µ—Ç —Ñ–æ–Ω–æ–º.",
        "–°–¥–µ–ª–∞–ª –¥–µ–ª–æ ‚Äî –ø–æ–ª—É—á–∏ ü™ô. –ö–∞–ø–∏—Ç–∞–ª–∏–∑–º, –Ω–æ –∑–¥–æ—Ä–æ–≤—ã–π.",
        "–¢—ã –≤—ã–±—Ä–∞–ª –¥–µ–π—Å—Ç–≤–∏–µ, –∞ –Ω–µ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–µ. –≠—Ç–æ —Ä–µ–¥–∫–∏–π –∂–∞–Ω—Ä.",
        "–°–µ—Ä–∏—è —Ä–∞—Å—Ç—ë—Ç. –Ø –±—ã —Ö–ª–æ–ø–∞–ª, –Ω–æ —É –º–µ–Ω—è –ª–∞–ø—ã –∑–∞–Ω—è—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º.",
        "–ö—Ä–∞—Å–∏–≤–æ. –ü–æ‚Äë—Ä–∞–±–æ—á–µ–º—É. –ë–µ–∑ —à–æ—É.",
        "–ü–ª—é—Å –∫ —Ä–∞–Ω–≥—É. –ú–∏–Ω—É—Å –∫ —Ö–∞–æ—Å—É."
      ],
      miss:[
        "–ü—Ä–æ–ø—É—Å–∫. –Ø –Ω–µ –∑–ª—é—Å—å. –Ø –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞—é –≤ –ø–∞–ø–∫—É ¬´–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ¬ª.",
        "–û–∫–µ–π, —Ñ–µ–π–ª. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –µ–≥–æ –≤ —Å–µ—Ä–∏–∞–ª.",
        "–°–µ—Ä–∏—è —É–ø–∞–ª–∞. –ù–∏—á–µ–≥–æ. –ü–æ–¥–Ω–∏–º–µ–º. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫. –ü–æ—á—Ç–∏.",
        "–°–µ–π—á–∞—Å –±—É–¥–µ—Ç –Ω–∞–∫–∞–∑–∞–Ω–∏–µ –∏–ª–∏ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±—é—Ä–æ–∫—Ä–∞—Ç–∏—é –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã.",
        "–ù–µ –Ω–∞–¥–æ –¥—Ä–∞–º. –ù–∞–¥–æ –∫–Ω–æ–ø–∫–∏.",
        "–û—Ç–¥—ã—Ö ‚Äî –Ω–æ—Ä–º. ¬´–°–ª–∏–ª—Å—è¬ª ‚Äî –Ω–µ –Ω–æ—Ä–º. –†–∞–∑–Ω–∏—Ü–∞ —Ç–æ–Ω–∫–∞—è, –Ω–æ –≤–∏–¥–Ω–∞.",
        "–¢—ã –∑–Ω–∞–µ—à—å, —á—Ç–æ –¥–µ–ª–∞—Ç—å. –ò –¥–∞, —è —Ç–æ–∂–µ –∑–Ω–∞—é, —á—Ç–æ —Ç—ã –∑–Ω–∞–µ—à—å.",
        "–°–∫–∞–∂–∏ —á–µ—Å—Ç–Ω–æ: —ç—Ç–æ –±—ã–ª –æ—Ç–¥—ã—Ö –∏–ª–∏ ¬´—Å–ª—É—á–∞–π–Ω–æ —Ç—Ä–∏ —á–∞—Å–∞¬ª?"
      ],
      suggest:[
        "–ü–æ–¥–∫–∏–Ω—É –∏–¥–µ—é. –ù–µ –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç—ã –ø—Ä–æ—Å–∏–ª. –ê –ø–æ—Ç–æ–º—É —á—Ç–æ —è –º–æ–≥—É.",
        "–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞: –º–∞–ª–µ–Ω—å–∫–∞—è –∏ –Ω–∞–≥–ª–∞—è. –ß—Ç–æ–±—ã –Ω–µ –æ—Ç–≤–µ—Ä—Ç–µ—Ç—å—Å—è.",
        "–î–æ–±–∞–≤—å —á—Ç–æ‚Äë—Ç–æ –Ω–∞ 5 –º–∏–Ω—É—Ç. –ë–æ–ª—å—à–æ–µ —Ç—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–ª–æ–∂–∏—à—å.",
        "–í–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç. –ï—Å–ª–∏ –Ω–µ –∑–∞–π–¥—ë—Ç ‚Äî –Ω–∞–∑–æ–≤—ë–º —ç—Ç–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–º.",
        "–î–∞–≤–∞–π –ø—Ä–∏–≤—ã—á–∫—É, –∫–æ—Ç–æ—Ä–∞—è –∑–≤—É—á–∏—Ç –∫–∞–∫ –º–µ–º, –∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –º–æ–ª–æ—Ç–æ–∫.",
        "–°–µ–π—á–∞—Å –±—É–¥–µ—Ç –ø—Ä–∏–≤—ã—á–∫–∞. –ê –ø–æ—Ç–æ–º —Ç—ã —Å–∫–∞–∂–µ—à—å ¬´—è –≤—Å–µ–≥–¥–∞ —Ö–æ—Ç–µ–ª¬ª. –ö–æ–Ω–µ—á–Ω–æ.",
        "–ú–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å ¬´–∫–æ—Ç‚Ä¶ –æ–≥—É—Ä–µ—Ü¬ª-—É—Ä–æ–≤–Ω—è –∞–±—Å—É—Ä–¥. –ù–æ –æ—Ç–º–µ—á–∞—Ç—å –±—É–¥–µ—Ç –ø—Ä–∏—è—Ç–Ω–æ.",
        "–Ø –ø—Ä–µ–¥–ª–∞–≥–∞—é. –¢—ã —Å–æ–≥–ª–∞—à–∞–µ—à—å—Å—è. –ü–æ—Ç–æ–º –≥–æ–≤–æ—Ä–∏—à—å, —á—Ç–æ —Å–∞–º –ø—Ä–∏–¥—É–º–∞–ª. –°–¥–µ–ª–∫–∞?"
      ],
      buy:[
        "–ü–æ–∫—É–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞. –¢—ã –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–ª –≤ –±–æ–±—Ä–∞.",
        "–®–º–æ—Ç –∫—É–ø–ª–µ–Ω. –¢–µ–ø–µ—Ä—å –±–æ–Ω—É—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç, –∞ —Ç—ã –ø—Ä–∏—Ç–≤–æ—Ä—è–π—Å—è, —á—Ç–æ —ç—Ç–æ –Ω–µ RPG.",
        "–†–µ—Å—É—Ä—Å—ã –Ω–µ –∑—Ä—è –∫–æ–ø–∏–ª–∏—Å—å. –û–Ω–∏ —Ç–æ–∂–µ —Ö–æ—Ç–µ–ª–∏ —Å–º—ã—Å–ª–∞.",
        "–°–¥–µ–ª–∫–∞ —á–∏—Å—Ç–∞—è. –†—É–∫–∏ ‚Äî –≤ –ø–µ—Ä—á–∞—Ç–∫–∞—Ö. –•–∞—Ä–∞–∫—Ç–µ—Ä ‚Äî –≤ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ.",
        "–®–º–æ—Ç–∫–∞ –ø—Ä–∏–ª–µ—Ç–µ–ª–∞. –ë–æ–±—Ä —Å—Ç–∞–ª —á—É—Ç—å –±–æ–ª–µ–µ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–º."
      ],
      equip:[
        "–ù–∞–¥–µ–ª. –¢–µ–ø–µ—Ä—å —Ç—ã –≤—ã–≥–ª—è–¥–∏—à—å –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—ã–π ¬´—Ç–æ—á–Ω–æ –Ω–∞—á–Ω—ë—Ç –∑–∞–≤—Ç—Ä–∞¬ª. –ù–æ –ª—É—á—à–µ —Å–µ–≥–æ–¥–Ω—è.",
        "–°–∏–¥–∏—Ç –∫–∞–∫ –≤ –∏–≥—Ä–µ. –î–∞, —ç—Ç–æ –≤–∞–∂–Ω–æ.",
        "–ê–ø–≥—Ä–µ–π–¥ –≤–Ω–µ—à–∫–∏ –ø—Ä–∏–Ω—è—Ç. –ê–ø–≥—Ä–µ–π–¥ –ø—Ä–∏–≤—ã—á–µ–∫ ‚Äî —Ç–≤–æ—è –æ—á–µ—Ä–µ–¥—å.",
        "–®–º–æ—Ç –Ω–∞ –º–µ—Å—Ç–µ. –ë–æ–Ω—É—Å—ã –≤–∫–ª—é—á–µ–Ω—ã. –û—Ç–≥–æ–≤–æ—Ä–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω—ã.",
        "–ö—Ä–∞—Å–∏–≤–æ. –¢–µ–ø–µ—Ä—å –∑–∞–∫—Ä–µ–ø–∏ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ–º."
      ],
      build:[
        "–ê–ø–≥—Ä–µ–π–¥ –≥–æ—Ç–æ–≤. –ë–∞–∑–∞ —Ä–∞—Å—Ç—ë—Ç ‚Äî –∫–∞–∫ —Å–ø–∏—Å–æ–∫ –¥–µ–ª, –µ—Å–ª–∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å.",
        "–ü–æ—Å—Ç—Ä–æ–∏–ª–∏. –¢–µ–ø–µ—Ä—å —Ä–µ—Å—É—Ä—Å—ã –∫–∞–ø–∞—é—Ç, –∫–∞–∫ —Å–æ–≤–µ—Å—Ç—å –≤ 23:40.",
        "–°—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞. –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ—Ä–∞–± –¥–æ–≤–æ–ª–µ–Ω.",
        "–ë–∞–∑–∞ —Å—Ç–∞–ª–∞ –º–æ—â–Ω–µ–µ. –¢–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –ø—Ä–∏—è—Ç–Ω–µ–µ.",
        "–ó–¥–∞–Ω–∏–µ –≤—Å—Ç–∞–ª–æ. –¢—ã ‚Äî —Ç–æ–∂–µ –≤—Å—Ç–∞–Ω—å –Ω–∞ –ø—Ä–∏–≤—ã—á–∫—É."
      ],
      chest:[
        "–°—É–Ω–¥—É–∫ –¥–Ω—è ‚Äî —ç—Ç–æ –∫–∞–∫ –Ω–∞–¥–µ–∂–¥–∞: –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –∏ –≤–µ—Ä–∏—à—å –≤ —Ü–∏—Ñ—Ä—ã.",
        "–û, –ª—É—Ç. –ë–µ—Ä—ë–º. –ù–µ –æ–±—Å—É–∂–¥–∞–µ–º.",
        "–í—Å–µ–ª–µ–Ω–Ω–∞—è: ¬´–ª–∞–¥–Ω–æ, —Å–µ–≥–æ–¥–Ω—è —Ç—ã –º–æ–ª–æ–¥–µ—Ü¬ª.",
        "–õ—É—Ç –ø—Ä–∏–ª–µ—Ç–µ–ª. –¢–µ–ø–µ—Ä—å —Ä–µ—Å—É—Ä—Å–æ–≤ –±–æ–ª—å—à–µ, —á–µ–º –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–π. –ù–∞–¥–µ—é—Å—å.",
        "–°—É–Ω–¥—É–∫ –æ—Ç–∫—Ä—ã—Ç. –≠—Ç–æ –Ω–µ –∞–∑–∞—Ä—Ç. –≠—Ç–æ –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞."
      ]
    };
    function line(ctx){
      ctx = ctx || "any";
      var arr = pool[ctx] || pool.any;
      return rand(arr);
    }
    return {line:line};
  })();

  function speak(ctx){
    ctx = ctx || "any";
    var t = tone();
    var hints = {
      hype:"–¢—ã –≤ —Ä–µ–∂–∏–º–µ ¬´–æ–±—ä–µ–∫—Ç —Å–¥–∞—ë–º –¥–æ—Å—Ä–æ—á–Ω–æ¬ª.",
      banter:"–ò–¥—ë—à—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ù–µ –ª–æ–º–∞–π —Ç–µ–º–ø.",
      angry:"–Ø –Ω–µ –∑–ª—é—Å—å. –Ø –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω –≤ —Ç–≤–æ–∏—Ö –æ—Ç–º–∞–∑–∫–∞—Ö.",
      neutral:"–°–ø–æ–∫–æ–π–Ω–æ —Å—Ç—Ä–æ–∏–º. –ú–∏–∫—Ä–æ‚Äë—à–∞–≥–∏ > –º–æ—Ç–∏–≤–∞—Ü–∏—è."
    };
    $("#toneHint").textContent = hints[t] || "";
    $("#speech").textContent = MEME.line(ctx);
    var stage = $("#beaverStage");
    stage.classList.remove("hype","angry");
    if(ctx==="miss" || t==="angry") stage.classList.add("angry"); else stage.classList.add("hype");
    setTimeout(function(){ stage.classList.remove("hype","angry"); }, 520);
  }

  // ===== Guide (first run) =====
  function maybeShowGuide(){
    if(state.user && !state.user.seenGuide){
      openGuide(0);
    }
  }
  function openGuide(step){
    var steps = [
      { t:"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Å—Ç—Ä–æ–π–∫—É –ø—Ä–∏–≤—ã—á–µ–∫",
        hero:"–¢—É—Ç –Ω–µ –ø—Ä–æ ¬´–Ω–æ–≤—É—é –∂–∏–∑–Ω—å —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞¬ª, –∞ –ø—Ä–æ –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–±–µ–¥—ã –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.",
        h:"1) –î–æ–±–∞–≤—å –ø—Ä–∏–≤—ã—á–∫–∏",
        bullets:["–í—ã–±–µ—Ä–∏ 1‚Äì3 –ø—Ä–∏–≤—ã—á–∫–∏ –Ω–∞ —Å—Ç–∞—Ä—Ç.","–î–µ–ª–∞–π –∏—Ö –ø—Ä–æ—Å—Ç—ã–º–∏ (5‚Äì10 –º–∏–Ω—É—Ç).","–≠–º–æ–¥–∑–∏ ‚Äî —á—Ç–æ–±—ã –º–æ–∑–≥—É –±—ã–ª–æ –ø—Ä–∏—è—Ç–Ω–æ."],
        cta:"‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É",
        act:"openAddHabit"
      },
      { t:"–ö–∞–∫ –∏–≥—Ä–∞—Ç—å –≤ –¥–µ–Ω—å",
        hero:"–°–µ–≥–æ–¥–Ω—è ‚Äî —Ç–≤–æ–π —á–µ–∫–ª–∏—Å—Ç. –û—Ç–º–µ—á–∞–π —Å–¥–µ–ª–∞–Ω–Ω–æ–µ –∏ —Å–æ–±–∏—Ä–∞–π –Ω–∞–≥—Ä–∞–¥—ã.",
        h:"2) –û—Ç–º–µ—á–∞–π –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ",
        bullets:["–¢–∞–ø –ø–æ —Ç—É–º–±–ª–µ—Ä—É ‚Äî –∑–∞—Å—á–∏—Ç–∞–ª–æ—Å—å.","–ó–∞ –∫–∞–∂–¥—É—é –≥–∞–ª–æ—á–∫—É: XP + –º–æ–Ω–µ—Ç—ã.","–ë–æ–±—Ä —Ä–µ–∞–≥–∏—Ä—É–µ—Ç (–∏–Ω–æ–≥–¥–∞ —Ç–æ–∫—Å–∏—á–Ω–æ, –Ω–æ –ø–æ –¥–µ–ª—É)."],
        cta:"‚úÖ –ü–µ—Ä–µ–π—Ç–∏ –≤ ¬´–°–µ–≥–æ–¥–Ω—è¬ª",
        act:"goToday"
      },
      { t:"–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ",
        hero:"–ë–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–Ω—è –Ω–∞–≥—Ä–∞–¥—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—Ç—Å—è. –≠—Ç–æ –∫–∞–∫ —É–π—Ç–∏ —Å–æ —Å—Ç—Ä–æ–π–∫–∏, –Ω–µ —Å–¥–∞–≤ –æ–±—ä–µ–∫—Ç.",
        h:"3) –ó–∞–∫—Ä–æ–π –¥–µ–Ω—å",
        bullets:["–ù–∞–∂–º–∏ ¬´‚úÖ –ó–∞–∫—Ä—ã—Ç—å –¥–µ–Ω—å¬ª.","–ï—Å–ª–∏ —Å–æ–≤—Å–µ–º —Ç—è–∂–∫–æ ‚Äî ¬´–û—Ç–¥–æ—Ö–Ω—É—Ç—å (50%)¬ª.","–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ 28 –¥–Ω–µ–π."],
        cta:"üóìÔ∏è –û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å",
        act:"goCalendar"
      },
      { t:"–ü—Ä–æ–∫–∞—á–∫–∞ –∏ —à–º–æ—Ç",
        hero:"–®–º–æ—Ç ‚Äî —ç—Ç–æ –Ω–µ –∫–æ—Å–º–µ—Ç–∏–∫–∞. –û–Ω –¥–∞—ë—Ç –±–æ–Ω—É—Å—ã –∫ XP, –º–æ–Ω–µ—Ç–∞–º –∏ –¥–æ–±—ã—á–µ.",
        h:"4) –°–¥–µ–ª–∞–π –±–æ–±—Ä–∞ –∫—Ä—É—Ç—ã–º",
        bullets:["–ë–∞–∑–∞ –ø—Ä–∏–Ω–æ—Å–∏—Ç —Ä–µ—Å—É—Ä—Å—ã –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.","–†–µ—Å—É—Ä—Å—ã ‚Üí —à–º–æ—Ç.","–î–æ—Ä–æ–≥–æ–π —à–º–æ—Ç ‚Äî –∑–∞–º–µ—Ç–Ω–æ —Å–∏–ª—å–Ω–µ–µ."],
        cta:"üõ†Ô∏è –û—Ç–∫—Ä—ã—Ç—å —à–º–æ—Ç–∫–∏",
        act:"goShop"
      }
    ];
    step = clamp(step, 0, steps.length-1);
    var s = steps[step];
    var presetUI = "";
    if(step===0){
      if(!state.tmp) state.tmp = {};
      if(!state.tmp.presetSel) state.tmp.presetSel = {};
      var selCount = Object.keys(state.tmp.presetSel).filter(function(k){return state.tmp.presetSel[k];}).length;
      presetUI =
        '<div class="guideCard" style="margin-top:10px">'+
          '<h4>–ì–æ—Ç–æ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ (–≤—ã–±–µ—Ä–∏ –¥–æ 3)</h4>'+
          '<div class="muted">–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞ 30 —Å–µ–∫—É–Ω–¥ ‚Äî –±–µ–∑ –≤—ã–¥—É–º—ã–≤–∞–Ω–∏–π.</div>'+
          '<div class="chipRow">'+
            PRESET_HABITS.map(function(p,i){var on=!!state.tmp.presetSel[i]; return '<button type="button" class="chip '+(on?'on':'')+'" data-act="presetToggle" data-idx="'+i+'">'+
              '<span>'+escapeHtml(p.emoji)+'</span><span>'+escapeHtml(p.title)+'</span>'+
              '</button>';}).join('')+
          '</div>'+
          '<div class="sep"></div>'+
          '<div class="btnRow">'+
            '<button type="button" class="btn blue full" data-act="presetAdd">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ('+selCount+'/3)</button>'+
          '</div>'+
        '</div>';
    }
    var dots = '<div class="dots">' + steps.map(function(_,i){return '<span class="'+(i===step?'on':'')+'"></span>';}).join('') + '</div>';
    openModal(
      'üß≠ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç ‚Ä¢ '+(step+1)+'/'+steps.length,
      '<div class="guideWrap">'+
        '<div class="guideHero">'+
          '<div class="t">'+escapeHtml(s.t)+'</div>'+
          '<div class="p">'+escapeHtml(s.hero)+'</div>'+
          dots+
        '</div>'+
        '<div class="guideCard">'+
          '<h4>'+escapeHtml(s.h)+'</h4>'+
          '<ul>'+s.bullets.map(function(b){return '<li>'+escapeHtml(b)+'</li>';}).join('')+'</ul>'+
        '</div>'+
        '<div class="btnRow">'+
          '<button type="button" class="btn blue full" data-act="guideCta" data-step="'+step+'">'+escapeHtml(s.cta)+'</button>'+
          '<button type="button" class="btn" data-act="guideNext" data-step="'+step+'">'+(step<steps.length-1?'–î–∞–ª—å—à–µ':'–ì–æ—Ç–æ–≤–æ')+'</button>'+
          '<button type="button" class="btn ghost" data-act="guideSkip">–ü–æ–∫–∞ –Ω–µ –Ω–∞–¥–æ</button>'+
        '</div>'+
      '</div>'
    );
    speak("guide");
  }

  // ===== Logs + calendar =====
  function ensureLogs(){ if(!state.logs) state.logs = {}; }
  function logTodayPreview(){
    ensureLogs();
    var list = activeHabits();
    var done = state.day.done || {};
    var doneN=0;
    for(var k in done) if(done[k]) doneN++;
    state.logs[state.day.date] = state.logs[state.day.date] || {date:state.day.date};
    state.logs[state.day.date].preview = true;
    state.logs[state.day.date].done = doneN;
    state.logs[state.day.date].total = list.length;
    state.logs[state.day.date].rest = !!state.day.rest;
    state.logs[state.day.date].closed = !!state.day.closed;
  }
  function calTone(e){
    if(!e) return "empty";
    if(e.rest) return "rest";
    if(!e.total) return "empty";
    if(e.closed && e.done===0) return "bad";
    var s = e.done/e.total;
    if(s>=0.85) return "great";
    if(s>=0.45) return "ok";
    return "meh";
  }
  function renderCalendarCompact(){
    ensureLogs();
    logTodayPreview();
    var today = localISODate();
    var d0 = new Date(today+"T00:00:00");
    var cells=[];
    for(var i=27;i>=0;i--){
      var d = new Date(d0); d.setDate(d.getDate()-i);
      var iso = isoDate(d);
      var e = state.logs[iso];
      var tone = calTone(e);
      var lab = String(d.getDate());
      cells.push('<button type="button" class="calCell '+tone+'" data-act="openDay" data-date="'+iso+'">'+lab+'</button>');
    }
    return (
      '<div class="sep"></div>'+
      '<div class="h"><h3>–ö–∞–ª–µ–Ω–¥–∞—Ä—å (28 –¥–Ω–µ–π)</h3><div class="muted">—Ç–∞–ø–Ω–∏ –¥–µ–Ω—å ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div></div>'+
      '<div class="calGrid">'+cells.join("")+'</div>'+
      '<div class="calLegend">'+
        '<span class="dot great"></span><span>—Ç–æ–ø</span>'+
        '<span class="dot ok"></span><span>–Ω–æ—Ä–º</span>'+
        '<span class="dot meh"></span><span>—Ç–∞–∫ —Å–µ–±–µ</span>'+
        '<span class="dot bad"></span><span>–ø—Ä–æ–≤–∞–ª</span>'+
        '<span class="dot rest"></span><span>–æ—Ç–¥—ã—Ö</span>'+
      '</div>'
    );
  }
  
  function renderCalendar(){
    ensureLogs();
    logTodayPreview();
    var today = localISODate();
    var d0 = new Date(today+"T00:00:00");
    var cells=[];
    var great=0, ok=0, meh=0, bad=0, rest=0;
    for(var i=27;i>=0;i--){
      var d = new Date(d0); d.setDate(d.getDate()-i);
      var iso = isoDate(d);
      var e = state.logs[iso];
      var tone = calTone(e);
      if(tone==="great") great++;
      else if(tone==="ok") ok++;
      else if(tone==="meh") meh++;
      else if(tone==="bad") bad++;
      else if(tone==="rest") rest++;
      var lab = String(d.getDate());
      cells.push('<button type="button" class="calCell '+tone+'" data-act="openDay" data-date="'+iso+'">'+lab+'</button>');
    }
    var summary =
      '<div class="calMeta">'+
        '<div class="box"><b>'+great+'</b><span>—Ç–æ–ø</span></div>'+
        '<div class="box"><b>'+ok+'</b><span>–Ω–æ—Ä–º</span></div>'+
        '<div class="box"><b>'+meh+'</b><span>—Ç–∞–∫ —Å–µ–±–µ</span></div>'+
        '<div class="box"><b>'+bad+'</b><span>–ø—Ä–æ–≤–∞–ª</span></div>'+
        '<div class="box"><b>'+rest+'</b><span>–æ—Ç–¥—ã—Ö</span></div>'+
      '</div>';
    var html =
      '<div class="calHead"><h3 style="margin:0">–ö–∞–ª–µ–Ω–¥–∞—Ä—å ‚Ä¢ 28 –¥–Ω–µ–π</h3><div class="muted">—Ç–∞–ø–Ω–∏ –¥–µ–Ω—å ‚Äî –¥–µ—Ç–∞–ª–∏</div></div>'+
      summary+
      '<div class="sep"></div>'+
      '<div class="calGrid">'+cells.join("")+'</div>'+
      '<div class="calLegend">'+
        '<span class="dot great"></span><span>—Ç–æ–ø</span>'+
        '<span class="dot ok"></span><span>–Ω–æ—Ä–º</span>'+
        '<span class="dot meh"></span><span>—Ç–∞–∫ —Å–µ–±–µ</span>'+
        '<span class="dot bad"></span><span>–ø—Ä–æ–≤–∞–ª</span>'+
        '<span class="dot rest"></span><span>–æ—Ç–¥—ã—Ö</span>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn blue" data-act="goToday">‚úÖ –°–µ–≥–æ–¥–Ω—è</button>'+
        '<button type="button" class="btn" data-act="openResources">üì¶ –†–µ—Å—É—Ä—Å—ã</button>'+
      '</div>';
    $("#panelMain").innerHTML = html;
  }
function openDay(date){
    ensureLogs();
    var e = state.logs[date];
    if(!e){
      return openModal(
        "üìÖ " + escapeHtml(date),
        '<div class="h"><div class="muted">–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>'
        + '<div class="note">–í —ç—Ç–æ—Ç –¥–µ–Ω—å —Ç—ã –ª–∏–±–æ –Ω–µ –∑–∞—Ö–æ–¥–∏–ª, –ª–∏–±–æ –µ—â—ë –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª –¥–µ–Ω—å. –í—Å—ë –Ω–æ—Ä–º ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–Ω–∏ —Å —Å–µ–≥–æ–¥–Ω—è.</div>'
        + '<div class="sep"></div><div class="btnRow"><button type="button" class="btn blue" data-act="closeModal">–û–∫</button></div>'
      );
    }
    var total = e.total||0, done = e.done||0;
    var pct = total? Math.round(done/total*100):0;
    var badge = e.rest? "üõå –æ—Ç–¥—ã—Ö" : (e.closed? "‚úÖ –∑–∞–∫—Ä—ã—Ç" : "üü° –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ");
    var txt = e.rest ? "–¢—ã –æ—Ñ–æ—Ä–º–∏–ª –æ—Ç–¥—ã—Ö. –°—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–º–ø–∞." : ("–í—ã–ø–æ–ª–Ω–µ–Ω–æ: <b>"+done+"/"+total+"</b> ("+pct+"%).");
    openModal(
      '<div class="h"><h3>üìÖ '+escapeHtml(date)+'</h3><div class="muted">'+badge+'</div></div>'+
      '<div class="note" style="margin-top:10px">'+txt+'</div>'+
      '<div class="sep"></div><div class="btnRow"><button type="button" class="btn blue" data-act="closeModal">–ó–∞–∫—Ä—ã—Ç—å</button></div>'
    );
  }

  function ensureWeekInsurance(){
    var wk = weekKey(new Date());
    if(state.user.insuranceWeek !== wk){
      state.user.insuranceWeek = wk;
      var p = sumPerks();
      state.user.insuranceLeft = p.insurance || 0;
    }
  }

  function depotLevel(){
    var d = state.base && state.base.buildings && state.base.buildings.depot;
    return (d && d.level) ? d.level : 0;
  }
  function storageCap(kind){
    // —á—Ç–æ–±—ã –∑–∞ –ø–∞—Ä—É –¥–Ω–µ–π –Ω–µ –Ω–∞–±—Ä–∞—Ç—å "–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å" ‚Äî –¥–µ–ª–∞–µ–º –º—è–≥–∫–∏–π, –Ω–æ —Ä–∞—Å—à–∏—Ä—è–µ–º—ã–π –ø–æ—Ç–æ–ª–æ–∫.
    // –º–æ–Ω–µ—Ç—ã (ü™ô) –Ω–µ –∫–∞–ø–∞–µ–º ‚Äî —ç—Ç–æ –Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è.
    if(kind==="coins") return 1e15;
    var dl = depotLevel();
    // –±–∞–∑–æ–≤—ã–π –∫–∞–ø + –∞–ø–≥—Ä–µ–π–¥—ã –¥–µ–ø–æ
    var base = 600;
    var perLevel = 350;
    return base + dl*perLevel;
  }
  function bankCapHours(building){
    var dl = depotLevel();
    // –¥–µ–ø–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –≤ –∑–¥–∞–Ω–∏—è—Ö (—á—Ç–æ–±—ã –±—ã–ª–æ –ø—Ä–∏—è—Ç–Ω–æ –∞–ø–≥—Ä–µ–π–¥–∏—Ç—å)
    var add = dl>0 ? (2 + (dl-1)*1) : 0; // 2—á –∑–∞ 1 lvl, –ø–æ—Ç–æ–º +1—á –∑–∞ —É—Ä–æ–≤–µ–Ω—å
    return (building.capHours||6) + add;
  }

  function tickProduction(){
    var p = sumPerks();
    var mult = 1 + (p.res || 0);
    for(var i=0;i<BUILDINGS.length;i++){
      var b = BUILDINGS[i];
      var s = state.base.buildings[b.id];
      if(!s || (s.level||0)<=0) continue;
      var now = Date.now();
      var last = s.lastTick || now;
      // –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω‚Äë–ø—Ä—ã–∂–∫–∏, —á—Ç–æ–±—ã —ç–∫–æ–Ω–æ–º–∏–∫–∞ –Ω–µ –ª–æ–º–∞–ª–∞—Å—å.
      var dt = Math.min(6*3600, Math.max(0, (now - last)/1000)); // –º–∞–∫—Å–∏–º—É–º 6 —á–∞—Å–æ–≤ –∑–∞ —Ç–∏–∫
      s.lastTick = now;
      var prod = b.produces;
      for(var k in prod){
        var perHour = prod[k] * (s.level||0) * mult;
        var add = perHour/3600 * dt;
        if(!s.banked) s.banked = {};
        var cap = perHour * bankCapHours(b);
        s.banked[k] = Math.min(cap, (s.banked[k] || 0) + add);
      }
    }
  }

  function collectAll(){
    tickProduction();
    var got = 0, lost = 0;
    var overflowKinds = {};
    for(var i=0;i<BUILDINGS.length;i++){
      var b = BUILDINGS[i];
      var s = state.base.buildings[b.id];
      if(!s || (s.level||0)<=0 || !s.banked) continue;
      for(var k in s.banked){
        var amt = Math.floor(s.banked[k] || 0);
        if(amt<=0) continue;

        var cap = storageCap(k);
        var cur = state.resources[k] || 0;
        var add = Math.min(amt, Math.max(0, cap - cur));
        var spill = amt - add;

        if(add>0){
          state.resources[k] = cur + add;
          got += add;
        }
        if(spill>0){
          lost += spill;
          overflowKinds[k] = true;
        }
        s.banked[k] -= amt; // –∑–∞–±–∏—Ä–∞–µ–º –≤—Å—ë –∏–∑ –±–∞–Ω–∫–∞ (–ª–∏—à–Ω–µ–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è "—É–ø–∞–ª–æ –≤ –≤–æ–¥—É")
      }
    }
    save();
    if(got>0){
      toast(lost>0 ? "–î–æ–±—ã—á–∞ —Å–æ–±—Ä–∞–Ω–∞. –ß–∞—Å—Ç—å –Ω–µ –≤–ª–µ–∑–ª–∞ –≤ —Å–∫–ª–∞–¥." : "–î–æ–±—ã—á–∞ —Å–æ–±—Ä–∞–Ω–∞.");
      speak("collect");
    }else{
      toast("–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ü—É—Å—Ç—å –±–∞–∑–∞ –ø–æ—Ä–∞–±–æ—Ç–∞–µ—Ç.");
    }
    if(lost>0){
      var kinds = Object.keys(overflowKinds).map(function(k){return k==="wood"?"ü™µ":"üî©";}).join(" ");
      speak("overflow");
      openModal("–°–∫–ª–∞–¥ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω", '<div class="note">–õ–∏–º–∏—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ—Å—Ç–∏–≥–Ω—É—Ç ('+kinds+').<br>–ü—Ä–æ–∫–∞—á–∞–π ¬´–°–∫–ª–∞–¥‚Äë–¥–µ–ø–æ¬ª –∏–ª–∏ –ø–æ—Ç—Ä–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã –Ω–∞ –∞–ø–≥—Ä–µ–π–¥—ã/—à–º–æ—Ç.</div><div class="sep"></div><div class="btnRow"><button type="button" class="btn blue" data-act="closeModal">–ü–æ–Ω—è–ª</button></div>');
    }
    render();
  }

  function activeHabits(){
    var out = [];
    for(var i=0;i<state.habits.length;i++) if(state.habits[i].active) out.push(state.habits[i]);
    return out;
  }

  function calcDayRewards(){
    var done = state.day.done || {};
    var xp=0, coins=0, doneN=0;
    var list = activeHabits();
    for(var i=0;i<list.length;i++){
      var h = list[i];
      if(done[h.id]){ xp += h.xp; coins += h.coins; doneN++; }
    }
    var p = sumPerks();
    xp = Math.round(xp * (1 + (p.xp||0)));
    coins = Math.round(coins * (1 + (p.coins||0)));
    return {xp:xp, coins:coins, doneN:doneN};
  }

  function closeDay(asRest){
    if(state.day.closed) return;
    ensureWeekInsurance();
    var today = localISODate();
    if(state.day.date !== today){
      state.day.date = today;
      state.day.done = {};
    }

    var result = {xp:0, coins:0, doneN:0};
    if(!asRest) result = calcDayRewards();
    var resDoneN = asRest ? 0 : (result.doneN||0);
    var resTotal = activeHabits().length;
    var perfect = (!asRest && resTotal>0 && result.doneN===resTotal);
    var prevTier = shopTier();

    if(asRest){
      // rest doesn't break streak
    }else{
      if(result.doneN>0) state.user.streak += 1;
      else state.user.streak = 0;
    }

    if(!asRest){
      if(perfect) state.user.perfectStreak = (state.user.perfectStreak||0) + 1;
      else state.user.perfectStreak = 0;
    }

    var bh = state.user.behavior;
    var win = (!asRest && result.doneN>0) ? 1 : 0;
    var miss = (!asRest && result.doneN===0) ? 1 : 0;
    bh.wins += win; bh.misses += miss;
    bh.last14.push({d:state.day.date, win:win, miss:miss});
    if(bh.last14.length>14) bh.last14.splice(0, bh.last14.length-14);

    state.user.xp += result.xp;
    state.user.coins += result.coins;

    // small daily goodies
    if(!asRest && result.doneN>0){
      state.resources.wood = (state.resources.wood||0) + Math.min(10, 2 + result.doneN*2);
      if(Math.random()<0.35) state.resources.wood = (state.resources.wood||0) + 5;
    }

    // level-up
    var leveled = 0;
    while(state.user.xp >= xpNeed(state.user.level)){
      state.user.xp -= xpNeed(state.user.level);
      state.user.level += 1;
      leveled++;
      state.user.coins += 15 + Math.floor(state.user.level/2);
      if(Math.random()<0.12) state.resources.metal = (state.resources.metal||0) + 3;
    }

    state.day.closed = true;
    state.day.rest = !!asRest;

    ensureLogs();
    state.logs[state.day.date] = {
      date: state.day.date,
      done: resDoneN,
      total: resTotal,
      closed: true,
      rest: !!asRest,
      xp: result.xp,
      coins: result.coins,
      leveled: leveled,
      perfect: perfect
    };
    state.user.lastDay = today;

    save();

    var newTier = shopTier();
    if(newTier>prevTier){
      toast('üîì –û—Ç–∫—Ä—ã–ª–∞—Å—å –Ω–æ–≤–∞—è —Ä–µ–¥–∫–æ—Å—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ: '+tierName(newTier)+'!');
    }

    var msg = asRest ? "–î–µ–Ω—å –æ—Ç–¥—ã—Ö–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω." : ("–î–µ–Ω—å –∑–∞–∫—Ä—ã—Ç: +" + result.xp + " XP, +" + result.coins + " ü™ô.");
    toast(msg);
    speak(asRest ? "any" : (leveled>0 ? "praise" : "any"));
    showSummary(result, leveled, asRest);
    render();
  }

  function showSummary(res, leveled, rest){
    var title = rest ? "üõå –û—Ç–¥—ã—Ö –æ—Ñ–æ—Ä–º–ª–µ–Ω" : "‚úÖ –î–µ–Ω—å –∑–∞–∫—Ä—ã—Ç";
    var parts = [];
    if(rest){
      parts.push('<div class="note">–û–∫–µ–π. –û–¥–∏–Ω –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞ ‚Äî –Ω–µ –∫–æ–Ω–µ—Ü —Å–≤–µ—Ç–∞. –ù–æ –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç–∞–Ω–µ—Ç —Å—Ç–∏–ª–µ–º, —è –ø–µ—Ä–µ–π–¥—É –≤ —Ä–µ–∂–∏–º ¬´–∂—É—Ä–Ω–∞–ª –ø—Ä–æ–ø—É—Å–∫–æ–≤¬ª.</div>');
    }else{
      parts.push('<div class="kpi">'+
        '<div class="box"><b>+'+res.xp+' XP</b><span>–æ–ø—ã—Ç</span></div>'+
        '<div class="box"><b>+'+res.coins+' ü™ô</b><span>–º–æ–Ω–µ—Ç—ã</span></div>'+
        '<div class="box"><b>'+res.doneN+'</b><span>–≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span></div>'+
      '</div>');
      if(leveled>0){
        parts.push('<div class="sep"></div><div class="tag">üéâ –£—Ä–æ–≤–µ–Ω—å +'+leveled+'</div>'+
          '<div class="note">–ù–æ–≤—ã–π —Ä–∞–Ω–≥: <b>'+escapeHtml(getRank(state.user.level))+'</b>.</div>');
      }
    }
    parts.push('<div class="sep"></div><div class="btnRow"><button type="button" class="btn primary full" data-act="closeModal">–û–∫</button></div>');
    openModal(title, parts.join(""));
  }

  function negotiateCost(){
    var lv = state.user.level || 1;
    var base = 35 + Math.floor(lv*2.5);
    var miss = (state.user.behavior && state.user.behavior.misses) ? state.user.behavior.misses : 0;
    return Math.round(base * (1 + miss*0.08));
  }

  function showMissedModal(dateISO){
    var cost = negotiateCost();
    var hasInsurance = (state.user.insuranceLeft||0) > 0;
    var html =
      '<div class="note"><b>'+dateISO+'</b> –Ω–µ –±—ã–ª –∑–∞–∫—Ä—ã—Ç. –≠—Ç–æ –ø—Ä–æ–ø—É—Å–∫. –ù–æ –º—ã —Ä–µ—à–∞–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ‚Äë—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–º—É.</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn warn" data-act="negotiate" data-cost="'+cost+'">ü§ù –î–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è (50%) ‚Äî '+cost+' ü™ô</button>'+
        '<button type="button" class="btn danger" data-act="punish">üßØ –ü—Ä–∏–Ω—è—Ç—å –Ω–∞–∫–∞–∑–∞–Ω–∏–µ</button>'+
        (hasInsurance ? '<button type="button" class="btn blue" data-act="insurance">üõ°Ô∏è –°–ø–∏—Å–∞—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É</button>' : '')+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="note">–ï—Å–ª–∏ –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è –Ω–µ –≤—ã–π–¥–µ—Ç ‚Äî –¥–∞–º –≥–ª—É–ø–æ–µ –∑–∞–¥–∞–Ω–∏–µ –∏ –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞–∑—Ä–µ—à—É ¬´–æ—Ç–¥–æ—Ö–Ω—É—Ç—å –¥–µ–Ω—ë–∫¬ª.</div>';
    openModal("‚õî –ü—Ä–æ–ø—É—Å–∫ –¥–Ω—è", html);
    speak("miss");
  }

  function punish(){
    var c = Math.min(45, Math.floor((state.user.coins||0) * 0.25));
    state.user.coins = Math.max(0, (state.user.coins||0) - c);
    state.user.streak = 0;
    var tax = Math.min(30, Math.floor(xpNeed(state.user.level) * 0.12));
    state.user.xp = Math.max(0, (state.user.xp||0) - tax);
    state.user.behavior.misses += 1;
    state.user.behavior.last14.push({d:localISODate(), win:0, miss:1});
    toast("–®—Ç—Ä–∞—Ñ: -" + c + " ü™ô –∏ -" + tax + " XP. –°–µ—Ä–∏—è —Å–±—Ä–æ—à–µ–Ω–∞.");
    speak("miss");
    save();
    closeModal();
    render();
  }

  function insurance(){
    if((state.user.insuranceLeft||0) <= 0) return toast("–°—Ç—Ä–∞—Ö–æ–≤–æ–∫ –Ω–µ—Ç.");
    state.user.insuranceLeft -= 1;
    toast("–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞. –ü—Ä–æ–ø—É—Å–∫ —Å–ø–∏—Å–∞–Ω.");
    speak("any");
    save();
    closeModal();
    render();
  }

  function negotiate(cost){
    cost = Number(cost) || 0;
    if((state.user.coins||0) < cost) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç.");
    state.user.coins -= cost;
    var ok = Math.random() < 0.5;
    save();
    if(ok){
      toast("–î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å. –î–µ–Ω—å –∑–∞–º–æ—Ä–æ–∂–µ–Ω –∫–∞–∫ –æ—Ç–¥—ã—Ö.");
      speak("any");
      closeModal();
      closeDay(true);
      return;
    }
    var task = rand(TASKS);
    state.quests.active = {id:uid(), text:task, createdAt:Date.now(), done:false};
    save();
    var body =
      '<div class="note"><b>–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –ø—Ä–æ–≤–∞–ª–µ–Ω—ã.</b> –í–∫–ª—é—á–∞—é –∫–≤–µ—Å—Ç –Ω–∞ –ø—Ä–∞–≤–æ –æ—Ç–¥—ã—Ö–∞—Ç—å.</div>'+
      '<div class="sep"></div>'+
      '<div class="item"><div class="l">'+
        '<div class="name">ü§° –ì–ª—É–ø–æ–µ –∑–∞–¥–∞–Ω–∏–µ</div>'+
        '<div class="desc">'+escapeHtml(task)+'</div>'+
      '</div></div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn primary" data-act="questDone">‚úÖ –ì–æ—Ç–æ–≤–æ</button>'+
        '<button type="button" class="btn warn" data-act="questSkip">üò∂ –ù–µ —Å–¥–µ–ª–∞–ª</button>'+
      '</div>';
    openModal("ü§ù –ù–µ –¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å", body);
    speak("miss");
  }

  function questDone(){
    if(state.quests.active) state.quests.active.done = true;
    toast("–ö–≤–µ—Å—Ç –∑–∞—Å—á–∏—Ç–∞–Ω. –û—Ç–¥—ã—Ö —Ä–∞–∑—Ä–µ—à—ë–Ω.");
    speak("praise");
    save();
    closeModal();
    closeDay(true);
  }
  function questSkip(){
    toast("–õ–∞–¥–Ω–æ. –û—Ç–¥—ã—Ö –≤—Å—ë —Ä–∞–≤–Ω–æ. –ù–æ —è –∑–∞–ø–æ–º–Ω–∏–ª.");
    speak("miss");
    save();
    closeModal();
    closeDay(true);
  }

  function missedDayCheck(){
    ensureWeekInsurance();
    var today = localISODate();
    if(!state.user.lastDay) state.user.lastDay = today;
    if(state.user.lastDay === today) return;

    var gap = daysBetween(state.user.lastDay, today);
    state.user.lastDay = today;
    state.day = {date: today, done:{}, closed:false, rest:false};
    save();

    if(gap >= 1){
      var yesterday = addDays(today, -1);
      showMissedModal(yesterday);
    }
  }

  function buildingCost(baseCost, level){
    var mult = 1 + 0.55*(level-1);
    var out = {};
    for(var k in baseCost){
      var v = baseCost[k] || 0;
      out[k] = Math.round(v * mult);
    }
    return out;
  }
  function canPay(cost){
    for(var k in cost){
      var v = cost[k] || 0;
      if(v<=0) continue;
      if(k==="coins"){
        if((state.user.coins||0) < v) return false;
      }else{
        if((state.resources[k]||0) < v) return false;
      }
    }
    return true;
  }
  function pay(cost){
    for(var k in cost){
      var v = cost[k] || 0;
      if(v<=0) continue;
      if(k==="coins") state.user.coins -= v;
      else state.resources[k] -= v;
    }
  }

  function upgradeBuilding(id){
    var b=null;
    for(var i=0;i<BUILDINGS.length;i++) if(BUILDINGS[i].id===id) b=BUILDINGS[i];
    if(!b) return;
    var st = state.base.buildings[id];
    if(!st){ st = {level:0,lastTick:Date.now(),banked:{}}; state.base.buildings[id]=st; }
    var nextLv = (st.level||0) + 1;
    var cost = buildingCost(b.baseCost, Math.max(1, nextLv));
    if(!canPay(cost)) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤.");
    tickProduction();
    pay(cost);
    st.level = nextLv;
    st.lastTick = Date.now();
    if(!st.banked) st.banked = {};
    save();
    toast(nextLv===1 ? "–ö—É–ø–ª–µ–Ω–æ. –ë–∞–∑–∞ –æ–∂–∏–ª–∞." : "–ê–ø–≥—Ä–µ–π–¥. –î–æ–±—ã—á–∞ –≤—ã—Ä–æ—Å–ª–∞.");
    speak("buy");
    render();
  }

  function rarityTag(r){
    if(r==="—Ä–µ–¥–∫–∞—è") return '<span class="own">—Ä–µ–¥–∫–∞—è</span>';
    if(r==="—ç–ø–∏–∫") return '<span class="tag">—ç–ø–∏–∫</span>';
    if(r==="–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è") return '<span class="tag">–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è</span>';
    return '<span class="lock">–æ–±—ã—á–Ω–∞—è</span>';
  }

  function tierName(t){
    if(t<=1) return "–æ–±—ã—á–Ω–∞—è";
    if(t===2) return "—Ä–µ–¥–∫–∞—è";
    if(t===3) return "—ç–ø–∏–∫";
    if(t===4) return "—ç–ø–∏–∫+";
    return "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è";
  }

  // –ú–∞–≥–∞–∑–∏–Ω —Ä–µ–¥–∫–æ—Å—Ç–µ–π –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∑–∞ —Å–µ—Ä–∏–∏
  // tier 2: —Å–µ—Ä–∏—è 3
  // tier 3: —Å–µ—Ä–∏—è 7
  // tier 4: 10 –∏–¥–µ–∞–ª—å–Ω—ã—Ö –¥–Ω–µ–π (–ø–æ–¥—Ä—è–¥)
  // tier 5: 14 –∏–¥–µ–∞–ª—å–Ω—ã—Ö –¥–Ω–µ–π (–ø–æ–¥—Ä—è–¥)
  function shopTier(){
    var s = state.user.streak||0;
    var ps = state.user.perfectStreak||0;
    var t = 1;
    if(s>=3) t = 2;
    if(s>=7) t = 3;
    if(ps>=10) t = 4;
    if(ps>=14) t = 5;
    return t;
  }

  function nextTierHint(){
    var s = state.user.streak||0;
    var ps = state.user.perfectStreak||0;
    var t = shopTier();
    if(t>=5) return "–û—Ç–∫—Ä—ã—Ç–æ –≤—Å—ë. –¢–µ–ø–µ—Ä—å —Ç—ã –ø—Ä–æ—Å—Ç–æ —Å–æ–±–∏—Ä–∞–µ—à—å –ª–µ–≥–µ–Ω–¥—ã.";
    if(t===1) return "–î–æ —Ä–µ–¥–∫–∏—Ö: —Å–µ—Ä–∏—è 3 (—Å–µ–π—á–∞—Å "+s+").";
    if(t===2) return "–î–æ —ç–ø–∏–∫–∞: —Å–µ—Ä–∏—è 7 (—Å–µ–π—á–∞—Å "+s+").";
    if(t===3) return "–î–æ —ç–ø–∏–∫+: 10 –∏–¥–µ–∞–ª—å–Ω—ã—Ö –¥–Ω–µ–π (—Å–µ–π—á–∞—Å "+ps+").";
    return "–î–æ –ª–µ–≥–µ–Ω–¥–∞—Ä–æ–∫: 14 –∏–¥–µ–∞–ª—å–Ω—ã—Ö –¥–Ω–µ–π (—Å–µ–π—á–∞—Å "+ps+").";
  }

  function gearLockReason(it){
    var need = it.tier || 1;
    var t = shopTier();
    if(need<=t) return "";
    if(need===2) return "–Ω—É–∂–Ω–∞ —Å–µ—Ä–∏—è 3";
    if(need===3) return "–Ω—É–∂–Ω–∞ —Å–µ—Ä–∏—è 7";
    if(need===4) return "–Ω—É–∂–Ω—ã 10 –∏–¥–µ–∞–ª.–¥–Ω–µ–π";
    return "–Ω—É–∂–Ω—ã 14 –∏–¥–µ–∞–ª.–¥–Ω–µ–π";
  }

    function perkLine(p){
    p = p || {};
    var parts = [];
    if(p.xp) parts.push("üß† +" + Math.round(p.xp*100) + "%");
    if(p.coins) parts.push("ü™ô +" + Math.round(p.coins*100) + "%");
    if(p.res) parts.push("üì¶ +" + Math.round(p.res*100) + "%");
    if(p.insurance) parts.push("üõ°Ô∏è +" + p.insurance + "/–Ω–µ–¥");
    return parts.join(" ‚Ä¢ ") || "‚Äî";
  }

function buyGear(id){
    var it=null;
    for(var i=0;i<GEAR.length;i++) if(GEAR[i].id===id) it=GEAR[i];
    if(!it) return;
    var slot = it.slot;
    var owned = state.gear.owned[slot] || [];
    if(owned.indexOf(id)>=0) return;
    if(!canPay(it.cost)) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤.");
    pay(it.cost);
    owned.push(id);
    state.gear.owned[slot] = owned;
    state.gear.equipped[slot] = id; // auto-equip
    ensureWeekInsurance();
    save();
    toast("–ö—É–ø–ª–µ–Ω–æ –∏ –Ω–∞–¥–µ—Ç–æ.");
    speak("buy");
    render();
  }

  function equipGear(id){
    var it=null;
    for(var i=0;i<GEAR.length;i++) if(GEAR[i].id===id) it=GEAR[i];
    if(!it) return;
    var slot = it.slot;
    var owned = state.gear.owned[slot] || [];
    if(owned.indexOf(id)<0) return toast("–°–Ω–∞—á–∞–ª–∞ –∫—É–ø–∏.");
    var cur = state.gear.equipped[slot];
    state.gear.equipped[slot] = (cur===id) ? null : id;
    ensureWeekInsurance();
    save();
    toast(cur===id ? "–°–Ω—è—Ç–æ." : "–ù–∞–¥–µ—Ç–æ.");
    speak("any");
    render();
  }

  function openModal(title, html){
    $("#mTitle").textContent = title;
    $("#mBody").innerHTML = (html||"");
    $("#modal").classList.add("show");
  }
  function closeModal(){
    $("#modal").classList.remove("show");
    $("#mBody").innerHTML = "";
  }

  function totalRatesPerHour(){
    tickProduction();
    var p = sumPerks();
    var mult = 1 + (p.res||0);
    var out = {wood:0, metal:0};
    for(var i=0;i<BUILDINGS.length;i++){
      var b = BUILDINGS[i];
      var st = state.base.buildings[b.id] || {level:0};
      var lv = st.level||0;
      if(lv<=0) continue;
      for(var k in b.produces){
        var r = (b.produces[k]||0) * lv * mult;
        if(out[k]==null) out[k]=0;
        out[k]+=r;
      }
    }
    return out;
  }

function totalPending(){
    var s=0;
    for(var i=0;i<BUILDINGS.length;i++){
      var st = state.base.buildings[BUILDINGS[i].id];
      if(!st || (st.level||0)<=0 || !st.banked) continue;
      for(var k in st.banked) s += Math.floor(st.banked[k]||0);
    }
    return s;
  }

  function renderMascotLayers(){
    var eq = state.gear.equipped || {};
    var layers = { bg:$("#layer_bg"), head:$("#layer_head"), body:$("#layer_body"), paws:$("#layer_paws"), legs:$("#layer_legs") };
    for(var k in layers) layers[k].innerHTML = "";

    // BG (5) ‚Äî —á—É—Ç—å "–∏–≥—Ä–æ–≤–µ–µ"
    if(eq.bg){
      var mapBg = {
        g1:'<rect x="10" y="10" width="220" height="220" rx="34" fill="rgba(34,197,94,.10)"/><path d="M22 188 L86 132 L132 168 L170 126 L218 188" fill="rgba(34,197,94,.18)"/><path d="M18 60 L42 60" stroke="rgba(34,197,94,.25)" stroke-width="8" stroke-linecap="round"/>',
        g2:'<rect x="10" y="10" width="220" height="220" rx="34" fill="rgba(59,130,246,.10)"/><path d="M18 28 H222" stroke="rgba(255,255,255,.35)" stroke-width="2"/><path d="M18 56 H222" stroke="rgba(255,255,255,.22)" stroke-width="2"/><path d="M18 84 H222" stroke="rgba(255,255,255,.18)" stroke-width="2"/><path d="M38 10 V230" stroke="rgba(255,255,255,.16)" stroke-width="2"/><path d="M78 10 V230" stroke="rgba(255,255,255,.12)" stroke-width="2"/>',
        g3:'<rect x="10" y="10" width="220" height="220" rx="34" fill="rgba(251,191,36,.10)"/><circle cx="182" cy="54" r="18" fill="rgba(244,63,94,.18)"/><path d="M60 190 H190" stroke="rgba(15,23,42,.16)" stroke-width="10" stroke-linecap="round"/><path d="M160 70 V190" stroke="rgba(15,23,42,.16)" stroke-width="10" stroke-linecap="round"/><path d="M160 70 L112 108" stroke="rgba(15,23,42,.16)" stroke-width="10" stroke-linecap="round"/>',
        g4:'<rect x="10" y="10" width="220" height="220" rx="34" fill="rgba(17,24,39,.12)"/><rect x="18" y="18" width="204" height="204" rx="30" fill="rgba(96,165,250,.08)"/><circle cx="74" cy="74" r="3" fill="rgba(255,255,255,.55)"/><circle cx="154" cy="128" r="2" fill="rgba(255,255,255,.35)"/><circle cx="190" cy="78" r="2" fill="rgba(255,255,255,.35)"/>',
        g5:'<rect x="10" y="10" width="220" height="220" rx="34" fill="rgba(147,51,234,.12)"/><path d="M22 196 H218" stroke="rgba(255,255,255,.22)" stroke-width="10" stroke-linecap="round"/><path d="M44 52 H196" stroke="rgba(59,130,246,.18)" stroke-width="12" stroke-linecap="round"/><circle cx="62" cy="64" r="10" fill="rgba(16,185,129,.16)"/>'
      };
      layers.bg.innerHTML = mapBg[eq.bg] || "";
    }

    // HEAD (5) ‚Äî –±–∞–Ω–¥–∞–Ω–∞/–∫–∞—Å–∫–∞/—Ñ–æ–Ω–∞—Ä—å/–ø—Ä–æ—Ä–∞–±/—ç–∫–∑–æ
    if(eq.head){
      var mapHead = {
        h1:'<path d="M56 96 Q120 58 184 96" stroke="rgba(15,23,42,.25)" stroke-width="10" stroke-linecap="round"/><path d="M52 90 Q120 46 188 90 L172 104 Q120 74 68 104 Z" fill="url(#g_cloth)"/><path d="M150 92 C168 100 176 110 172 122 C160 114 146 108 136 110" fill="rgba(29,78,216,.55)"/>',
        h2:'<path d="M46 96 Q120 40 194 96 L182 118 Q120 82 58 118 Z" fill="url(#g_yellow)"/><path d="M52 104 H188" stroke="rgba(15,23,42,.22)" stroke-width="6" stroke-linecap="round"/><path d="M66 100 Q120 70 174 100" stroke="rgba(255,255,255,.35)" stroke-width="4" stroke-linecap="round"/>',
        h3:'<path d="M44 98 Q120 38 196 98 L182 122 Q120 86 58 122 Z" fill="url(#g_yellow)"/><path d="M52 108 H188" stroke="rgba(15,23,42,.22)" stroke-width="6" stroke-linecap="round"/><circle cx="186" cy="114" r="10" fill="rgba(255,255,255,.90)"/><circle cx="186" cy="114" r="5" fill="rgba(59,130,246,.70)"/><path d="M86 112 C94 104 110 104 118 112" stroke="rgba(15,23,42,.24)" stroke-width="6" stroke-linecap="round"/>',
        h4:'<path d="M42 104 Q120 32 198 104 L182 132 Q120 94 58 132 Z" fill="rgba(15,23,42,.82)"/><path d="M54 114 H186" stroke="rgba(255,255,255,.18)" stroke-width="6" stroke-linecap="round"/><path d="M100 120 H140" stroke="rgba(251,191,36,.75)" stroke-width="6" stroke-linecap="round"/><circle cx="120" cy="104" r="6" fill="rgba(251,191,36,.85)"/>',
        h5:'<path d="M40 106 Q120 30 200 106 L182 140 Q120 100 58 140 Z" fill="url(#g_metal)"/><path d="M64 120 Q120 92 176 120" stroke="rgba(16,185,129,.55)" stroke-width="10" stroke-linecap="round"/><circle cx="120" cy="112" r="9" fill="rgba(255,255,255,.80)"/><circle cx="120" cy="112" r="5" fill="rgba(147,51,234,.70)"/>'
      };
      layers.head.innerHTML = mapHead[eq.head] || "";
    }

    // BODY (5) ‚Äî –æ–¥–µ–∂–¥–∞ —Å–∏–¥–∏—Ç –Ω–∞ —Ç–æ—Ä—Å–µ
    if(eq.body){
      var mapBody = {
        b1:'<path d="M62 150 Q120 194 178 150 L170 228 Q120 242 70 228 Z" fill="rgba(96,165,250,.18)"/><path d="M92 160 Q120 178 148 160" stroke="rgba(255,255,255,.35)" stroke-width="6" stroke-linecap="round"/><rect x="104" y="188" width="32" height="28" rx="10" fill="rgba(15,23,42,.10)"/>',
        b2:'<path d="M60 148 Q120 198 180 148 L170 230 Q120 246 70 230 Z" fill="rgba(251,191,36,.22)"/><path d="M72 166 L168 166" stroke="rgba(255,255,255,.45)" stroke-width="8" stroke-linecap="round"/><path d="M72 184 L168 184" stroke="rgba(15,23,42,.14)" stroke-width="6" stroke-linecap="round"/>',
        b3:'<path d="M58 148 Q120 202 182 148 L172 234 Q120 250 68 234 Z" fill="rgba(59,130,246,.18)"/><path d="M88 146 L104 176" stroke="rgba(15,23,42,.18)" stroke-width="10" stroke-linecap="round"/><path d="M152 146 L136 176" stroke="rgba(15,23,42,.18)" stroke-width="10" stroke-linecap="round"/><rect x="94" y="178" width="52" height="46" rx="14" fill="rgba(15,23,42,.10)"/><path d="M120 178 V224" stroke="rgba(15,23,42,.18)" stroke-width="4"/>',
        b4:'<path d="M56 146 Q120 206 184 146 L172 238 Q120 254 68 238 Z" fill="url(#g_leather)"/><path d="M84 176 H156" stroke="rgba(255,255,255,.22)" stroke-width="8" stroke-linecap="round"/><circle cx="150" cy="196" r="6" fill="rgba(251,191,36,.70)"/><path d="M92 210 H148" stroke="rgba(15,23,42,.18)" stroke-width="8" stroke-linecap="round"/>',
        b5:'<path d="M54 146 Q120 210 186 146 L172 242 Q120 258 68 242 Z" fill="url(#g_metal)"/><path d="M76 176 H164" stroke="rgba(16,185,129,.42)" stroke-width="8" stroke-linecap="round"/><path d="M92 198 H148" stroke="rgba(147,51,234,.35)" stroke-width="8" stroke-linecap="round"/><circle cx="120" cy="210" r="7" fill="rgba(255,255,255,.70)"/><circle cx="120" cy="210" r="4" fill="rgba(16,185,129,.70)"/>'
      };
      layers.body.innerHTML = mapBody[eq.body] || "";
    }

    // PAWS (5) ‚Äî –ø–µ—Ä—á–∞—Ç–∫–∏ + –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
    if(eq.paws){
      var mapPaws = {
        p1:'<circle cx="62" cy="160" r="14" fill="rgba(15,23,42,.16)"/><circle cx="178" cy="160" r="14" fill="rgba(15,23,42,.16)"/><path d="M52 156 H72" stroke="rgba(255,255,255,.25)" stroke-width="3" stroke-linecap="round"/>',
        p2:'<circle cx="62" cy="160" r="14" fill="rgba(251,191,36,.16)"/><circle cx="178" cy="160" r="14" fill="rgba(251,191,36,.16)"/><path d="M178 150 V178" stroke="rgba(15,23,42,.25)" stroke-width="8" stroke-linecap="round"/><rect x="170" y="144" width="16" height="12" rx="4" fill="rgba(15,23,42,.28)"/>',
        p3:'<circle cx="62" cy="160" r="14" fill="rgba(59,130,246,.16)"/><circle cx="178" cy="160" r="14" fill="rgba(59,130,246,.16)"/><rect x="168" y="150" width="34" height="16" rx="8" fill="rgba(15,23,42,.22)"/><rect x="198" y="154" width="10" height="8" rx="3" fill="rgba(16,185,129,.45)"/>',
        p4:'<circle cx="62" cy="160" r="14" fill="rgba(96,165,250,.16)"/><circle cx="178" cy="160" r="14" fill="rgba(96,165,250,.16)"/><rect x="40" y="148" width="26" height="18" rx="5" fill="rgba(15,23,42,.22)"/><path d="M44 154 H62" stroke="rgba(255,255,255,.25)" stroke-width="2"/><path d="M44 160 H62" stroke="rgba(255,255,255,.18)" stroke-width="2"/>',
        p5:'<circle cx="62" cy="160" r="15" fill="url(#g_metal)"/><circle cx="178" cy="160" r="15" fill="url(#g_metal)"/><path d="M52 160 H72" stroke="rgba(16,185,129,.45)" stroke-width="5" stroke-linecap="round"/><path d="M168 160 H188" stroke="rgba(147,51,234,.35)" stroke-width="5" stroke-linecap="round"/>'
      };
      layers.paws.innerHTML = mapPaws[eq.paws] || "";
    }

    // LEGS (5) ‚Äî –æ–±—É–≤—å
    if(eq.legs){
      var mapLegs = {
        l1:'<rect x="74" y="196" width="48" height="22" rx="11" fill="rgba(59,130,246,.16)"/><rect x="118" y="196" width="48" height="22" rx="11" fill="rgba(59,130,246,.16)"/><path d="M80 206 H114" stroke="rgba(255,255,255,.25)" stroke-width="3" stroke-linecap="round"/>',
        l2:'<rect x="72" y="194" width="50" height="24" rx="12" fill="rgba(15,23,42,.16)"/><rect x="118" y="194" width="50" height="24" rx="12" fill="rgba(15,23,42,.16)"/><path d="M78 204 H112" stroke="rgba(251,191,36,.35)" stroke-width="4" stroke-linecap="round"/>',
        l3:'<rect x="70" y="192" width="52" height="26" rx="13" fill="rgba(15,23,42,.18)"/><rect x="118" y="192" width="52" height="26" rx="13" fill="rgba(15,23,42,.18)"/><rect x="72" y="200" width="48" height="8" rx="4" fill="rgba(148,163,184,.35)"/><rect x="120" y="200" width="48" height="8" rx="4" fill="rgba(148,163,184,.35)"/>',
        l4:'<rect x="68" y="192" width="54" height="26" rx="13" fill="rgba(251,191,36,.14)"/><rect x="118" y="192" width="54" height="26" rx="13" fill="rgba(251,191,36,.14)"/><path d="M72 192 V218" stroke="rgba(16,185,129,.25)" stroke-width="4"/><path d="M122 192 V218" stroke="rgba(16,185,129,.25)" stroke-width="4"/>',
        l5:'<rect x="66" y="190" width="56" height="28" rx="14" fill="url(#g_metal)"/><rect x="118" y="190" width="56" height="28" rx="14" fill="url(#g_metal)"/><path d="M72 202 H116" stroke="rgba(16,185,129,.45)" stroke-width="6" stroke-linecap="round"/><path d="M124 202 H168" stroke="rgba(147,51,234,.35)" stroke-width="6" stroke-linecap="round"/>'
      };
      layers.legs.innerHTML = mapLegs[eq.legs] || "";
    }
  }

  function renderTop(){
    $("#coinsTxt").textContent = Math.floor(state.user.coins||0);
    $("#woodTxt").textContent = Math.floor(state.resources.wood||0);
    $("#metalTxt").textContent = Math.floor(state.resources.metal||0);
    $("#streakTxt").textContent = state.user.streak||0;
    $("#lvlTxt").textContent = "Lv " + (state.user.level||1);
    $("#rankTxt").textContent = getRank(state.user.level||1);
    ensureWeekInsurance();
    var ins = state.user.insuranceLeft || 0;
    $("#subline").textContent = "–†–∞–Ω–≥: " + getRank(state.user.level||1) + " ‚Ä¢ –°—Ç—Ä–∞—Ö–æ–≤–∫–∏: " + ins + " ‚Ä¢ " + localISODate();

    var need = xpNeed(state.user.level||1);
    var pct = clamp(((state.user.xp||0)/need)*100, 0, 100);
    $("#xpFill").style.width = pct.toFixed(1) + "%";
  }

  function renderToday(){
    var done = state.day.done || {};
    var list = activeHabits();
    var doneCount = 0;
    for(var k in done) if(done[k]) doneCount++;
    var rewards = calcDayRewards();

    var header =
      '<div class="h"><h3>–°–µ–≥–æ–¥–Ω—è ‚Ä¢ '+escapeHtml(state.day.date)+'</h3><div class="muted">'+doneCount+'/'+list.length+' –æ—Ç–º–µ—á–µ–Ω–æ</div></div>';

    var emptyBlock =
      '<div class="note">'+
        '<b>–ü–æ—Ö–æ–∂–µ, –ø—Ä–∏–≤—ã—á–µ–∫ –µ—â—ë –Ω–µ—Ç.</b><br>–î–∞–≤–∞–π –¥–æ–±–∞–≤–∏–º 1‚Äì3 —à—Ç—É–∫–∏ –∏ –Ω–∞—á–Ω—ë–º.'+
        '<div class="sep"></div>'+
        '<button type="button" class="btn blue full" data-act="openAddHabit">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É</button>'+
      '</div>';

    var habitList = (list.length ? list.map(function(h){
      var on = done[h.id] ? "on" : "";
      return '<div class="habit">'+
        '<div class="left">'+
          '<div class="emoji">'+escapeHtml(h.emoji)+'</div>'+
          '<div style="min-width:0">'+
            '<div class="name">'+escapeHtml(h.name)+'</div>'+
            '<div class="meta">+'+h.xp+' XP ‚Ä¢ +'+h.coins+' ü™ô ‚Ä¢ '+diffName(h.diff)+'</div>'+
          '</div>'+
        '</div>'+
        '<button type="button" class="toggle '+on+'" aria-checked="'+(done[h.id]?'true':'false')+'" role="switch" data-act="toggleHabit" data-id="'+h.id+'"></button>'+
      '</div>';
    }).join("") : emptyBlock);

    var rewardRow =
      '<div class="kpi">'+
        '<div class="box"><b>+'+rewards.xp+' XP</b><span>–∑–∞ –∑–∞–∫—Ä—ã—Ç–∏–µ –¥–Ω—è</span></div>'+
        '<div class="box"><b>'+rewards.coins+' ü™ô</b><span>–∑–∞ –∑–∞–∫—Ä—ã—Ç–∏–µ –¥–Ω—è</span></div>'+
        '<div class="box"><b>'+(state.user.streak||0)+'</b><span>—Å–µ—Ä–∏—è</span></div>'+
        '<div class="box"><b>'+(state.user.perfectStreak||0)+'</b><span>–∏–¥–µ–∞–ª—å–Ω–æ</span></div>'+
      '</div>';

    var primary =
      '<div class="sep"></div>'+
      '<button type="button" class="btn primary full" data-act="closeDay">‚úÖ –ó–∞–∫—Ä—ã—Ç—å –¥–µ–Ω—å</button>'+
      '<div class="btnRow" style="margin-top:10px">'+
        '<button type="button" class="btn blue" data-act="openAddHabit">‚ûï –ü—Ä–∏–≤—ã—á–∫–∞</button>'+
        '<button type="button" class="btn" data-act="goCalendar">üóìÔ∏è –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>'+
        '<button type="button" class="btn warn" data-act="restToday">üõå –û—Ç–¥–æ—Ö–Ω—É—Ç—å (50%)</button>'+
      '</div>';

    $("#panelMain").innerHTML =
      header+
      '<div class="sep"></div>'+
      '<div class="tag">üìã –ß–µ–∫–ª–∏—Å—Ç</div>'+
      '<div class="habits" style="margin-top:10px">'+habitList+'</div>'+
      '<div class="sep"></div>'+
      '<div class="tag">üéÅ –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –¥–µ–Ω—å</div>'+
      rewardRow+
      primary;
  }

  function renderHabits(){
    var list = state.habits || [];
    var activeCount = activeHabits().length;
    var items = list.map(function(h){
      return '<div class="item">'+
        '<div class="l">'+
          '<div class="name">'+escapeHtml(h.emoji)+' '+escapeHtml(h.name)+' '+(h.active?'':'<span class="lock">–≤—ã–∫–ª—é—á–µ–Ω–æ</span>')+'</div>'+
          '<div class="desc">–°–ª–æ–∂–Ω–æ—Å—Ç—å: <b>'+diffName(h.diff)+'</b> ‚Ä¢ –Ω–∞–≥—Ä–∞–¥–∞: <b>+'+h.xp+' XP</b> –∏ <b>+'+h.coins+' ü™ô</b></div>'+
        '</div>'+
        '<div class="r">'+
          '<button type="button" class="btn sm" data-act="editHabit" data-id="'+h.id+'">‚öôÔ∏è</button>'+
          '<button type="button" class="btn sm '+(h.active?'danger':'primary')+'" data-act="toggleActive" data-id="'+h.id+'">'+(h.active?'–≤—ã–∫–ª':'–≤–∫–ª')+'</button>'+
        '</div>'+
      '</div>';
    }).join("");
    var html =
      '<div class="h"><h3>–ü—Ä–∏–≤—ã—á–∫–∏</h3><div class="muted">'+activeCount+' –∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn blue" data-act="openAddHabit">‚ûï –°–æ–∑–¥–∞—Ç—å</button>'+
        '<button type="button" class="btn" data-act="suggestHabit">üß† –ü—Ä–µ–¥–ª–æ–∂–∏</button>'+
      '</div>'+
      '<div class="list">'+items+'</div>';
    $("#panelMain").innerHTML = html;
  }

  function renderBase(){
    tickProduction();
    var p = sumPerks();
    var mult = 1 + (p.res||0);
    var rates = totalRatesPerHour();
    var pending = totalPending();
    var perDay = {wood:Math.round((rates.wood||0)*24), metal:Math.round((rates.metal||0)*24)};

    function prodLine(obj, lv){
      var parts=[];
      for(var k in obj){
        var perH = Math.round((obj[k]||0) * lv * mult);
        if(perH<=0) continue;
        parts.push(iconOf(k)+" "+perH+"/—á ("+Math.round(perH*24)+"/–¥)");
      }
      return parts.join(" ‚Ä¢ ") || "‚Äî";
    }

    var rows = BUILDINGS.map(function(b){
      var st = state.base.buildings[b.id] || {level:0, banked:{}};
      var lv = st.level || 0;
      var nextLv = lv+1;
      var curLine = lv>0 ? prodLine(b.produces, lv) : "‚Äî";
      var nextLine = prodLine(b.produces, nextLv);

      var cost = buildingCost(b.baseCost, Math.max(1, nextLv));
      var costTxt = costLine(cost);

      var bankedParts = [];
      if(st.banked){
        for(var kk in st.banked){
          var vv = Math.floor(st.banked[kk]||0);
          if(vv>0) bankedParts.push(iconOf(kk) + " " + vv);
        }
      }

      var desc = (lv>0)
        ? ('–°–µ–π—á–∞—Å: <b>'+escapeHtml(curLine)+'</b><br><span class="muted">–°–ª–µ–¥. —É—Ä.: '+escapeHtml(nextLine)+'</span>')
        : ('–ö—É–ø–∏ –∏ –∑–∞–ø—É—Å—Ç–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ: <b>'+escapeHtml(nextLine)+'</b>');
      var foot = (lv>0)
        ? ('–ù–∞–∫–æ–ø–ª–µ–Ω–æ: '+escapeHtml((bankedParts.join(" ‚Ä¢ ")||"0"))+'<br><span class="muted">–ê–ø–≥—Ä–µ–π–¥: '+escapeHtml(costTxt)+'</span>')
        : ('–¶–µ–Ω–∞: '+escapeHtml(costTxt));

      return '<div class="item">'+
        '<div class="l">'+
          '<div class="name">'+escapeHtml(b.icon)+' '+escapeHtml(b.name)+' <span class="muted">—É—Ä. '+lv+'</span></div>'+
          '<div class="desc">'+desc+'</div>'+
          '<div class="cost">'+foot+'</div>'+
        '</div>'+
        '<div class="r">'+
          '<button type="button" class="btn sm '+(canPay(cost) ? "primary":"")+'" data-act="upgrade" data-id="'+b.id+'">'+(lv>0 ? "‚¨ÜÔ∏è –∞–ø–≥—Ä–µ–π–¥" : "üõí –∫—É–ø–∏—Ç—å")+'</button>'+
        '</div>'+
      '</div>';
    }).join("");

    var html =
      '<div class="h"><h3>–ë–∞–∑–∞</h3><div class="muted">–ø–∞—Å—Å–∏–≤–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</div></div>'+
      '<div class="note" style="margin-top:6px">–ë–∞–∑–∞ –ø—Ä–∏–Ω–æ—Å–∏—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å–∞–º–∞. –¢—ã –∑–∞—Ö–æ–¥–∏—à—å ‚Üí <b>—Å–æ–±–∏—Ä–∞–µ—à—å</b> ‚Üí —Ç—Ä–∞—Ç–∏—à—å –Ω–∞ <b>—à–º–æ—Ç</b> –∏ <b>–∞–ø–≥—Ä–µ–π–¥—ã</b>. –®–º–æ—Ç –¥–∞—ë—Ç –±–æ–Ω—É—Å—ã –∫ XP/–º–æ–Ω–µ—Ç–∞–º/–¥–æ–±—ã—á–µ/—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞–º.</div>'+
      '<div class="sep"></div>'+
      '<div class="resGrid">'+
        '<div class="resBox"><div class="k">ü™µ –î–µ—Ä–µ–≤–æ</div><div class="v">'+Math.floor(state.resources.wood||0)+'</div><div class="muted">+'+Math.round(rates.wood||0)+'/—á ‚Ä¢ '+perDay.wood+'/–¥</div></div>'+
        '<div class="resBox"><div class="k">üî© –ú–µ—Ç–∞–ª–ª</div><div class="v">'+Math.floor(state.resources.metal||0)+'</div><div class="muted">+'+Math.round(rates.metal||0)+'/—á ‚Ä¢ '+perDay.metal+'/–¥</div></div>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn warn" data-act="collect">üì¶ –°–æ–±—Ä–∞—Ç—å –¥–æ–±—ã—á—É '+(pending>0?("(+"+pending+")"):"")+'</button>'+
        '<button type="button" class="btn" data-act="openResources">üì¶ –†–µ—Å—É—Ä—Å—ã</button>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="list">'+rows+'</div>';
    $("#panelMain").innerHTML = html;
  }

  function shopSlot(slot, btn){
    // highlight chip
    try{
      var wrap = $("#slotChips");
      if(wrap){
        $all(".chip", wrap).forEach(function(c){
          c.classList.toggle("on", c.getAttribute("data-slot")===slot);
        });
      }
    }catch(e){}
    renderShopSlot(slot);
    speak("any");
  }

  function renderShop(){
    var slots = [
      ["head","ü™ñ","–ì–æ–ª–æ–≤–∞"],
      ["paws","üß§","–õ–∞–ø–∫–∏"],
      ["body","ü¶∫","–¢–µ–ª–æ"],
      ["legs","ü•æ","–ù–æ–≥–∏"],
      ["bg","üåÑ","–§–æ–Ω"]
    ];
    var perks = sumPerks();
    var perkTxt = "–ë–æ–Ω—É—Å—ã: +" + Math.round((perks.xp||0)*100) + "% XP ‚Ä¢ +" + Math.round((perks.coins||0)*100) + "% ü™ô ‚Ä¢ +" + Math.round((perks.res||0)*100) + "% –¥–æ–±—ã—á–∏ ‚Ä¢ üõ°Ô∏è " + (state.user.insuranceLeft||0) + "/" + (perks.insurance||0);
    var lockTxt = "–î–æ—Å—Ç—É–ø–Ω–æ: "+tierName(shopTier())+" ‚Ä¢ "+nextTierHint();
    var chips = slots.map(function(s,i){
      return '<button type="button" class="chip '+(i===0?"on":"")+'" data-act="slot" data-slot="'+s[0]+'">'+s[1]+" "+s[2]+'</button>';
    }).join("");
    var html =
      '<div class="h"><h3>–®–º–æ—Ç–∫–∏</h3><div class="muted">'+escapeHtml(perkTxt)+'</div><div class="muted">'+escapeHtml(lockTxt)+'</div></div>'+
      '<div class="sep"></div>'+
      '<div class="chips" id="slotChips">'+chips+'</div>'+
      '<div class="sep"></div>'+
      '<div id="shopList" class="list"></div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn" data-act="openResources">üì¶ –†–µ—Å—É—Ä—Å—ã</button>'+
        '<button type="button" class="btn blue" data-act="collect">üì¶ –°–æ–±—Ä–∞—Ç—å –¥–æ–±—ã—á—É</button>'+
      '</div>';
    $("#panelMain").innerHTML = html;
    renderShopSlot("head");
  }

  function renderShopSlot(slot){
    var list = $("#shopList");
    var items = GEAR.filter(function(x){ return x.slot===slot; });
    var owned = state.gear.owned[slot] || [];
    var eq = state.gear.equipped[slot];

    list.innerHTML = items.map(function(it){
      var isOwned = owned.indexOf(it.id)>=0;
      var isEq = eq === it.id;
      var lock = gearLockReason(it);
      var locked = (!isOwned && !!lock);
      var can = locked ? false : canPay(it.cost);
      var costTxt = costLine(it.cost);

      var actionBtn = "";
      if(isOwned){
        actionBtn = '<button type="button" class="btn sm '+(isEq?"":"primary")+'" data-act="equip" data-id="'+it.id+'">üëï '+(isEq?"—Å–Ω—è—Ç—å":"–Ω–∞–¥–µ—Ç—å")+'</button>';
      }else{
        if(locked){
          actionBtn = '<button type="button" class="btn sm" disabled>üîí '+escapeHtml(lock)+'</button>';
        }else{
          actionBtn = '<button type="button" class="btn sm '+(can?"primary":"")+'" data-act="buyGear" data-id="'+it.id+'">üõí –∫—É–ø–∏—Ç—å</button>';
        }
      }

      return '<div class="item">'+
        '<div class="l">'+
          '<div class="name">'+escapeHtml(it.name)+' '+rarityTag(it.rarity)+' '+(locked?'<span class="lock">üîí '+escapeHtml(lock)+'</span>':"")+' '+(isEq?'<span class="own">–Ω–∞–¥–µ—Ç–æ</span>':"")+'</div>'+
          '<div class="desc">'+escapeHtml(it.desc)+'</div>'+
          '<div class="muted">–ë–æ–Ω—É—Å—ã: '+perkLine(it.perks)+'</div>'+

          '<div class="cost">–¶–µ–Ω–∞: '+escapeHtml(costTxt)+'</div>'+
        '</div>'+
        '<div class="r">'+actionBtn+'</div>'+
      '</div>';
    }).join("");
  }

  function renderMe(){
    tickProduction();
    var perks = sumPerks();
    var last14 = (state.user.behavior && state.user.behavior.last14) ? state.user.behavior.last14 : [];
    var last7 = last14.slice(-7);
    var win7 = 0, miss7 = 0;
    for(var i=0;i<last7.length;i++){ win7 += last7[i].win; miss7 += last7[i].miss; }

    var resBoxes = RES.map(function(r){
      var k=r[0], ico=r[1], name=r[2];
      return '<div class="resBox"><div class="k">'+ico+' '+escapeHtml(name)+'</div><div class="v">'+Math.floor(state.resources[k]||0)+'</div></div>';
    }).join("");
    resBoxes += '<div class="resBox"><div class="k">ü™ô –ú–æ–Ω–µ—Ç—ã</div><div class="v">'+Math.floor(state.user.coins||0)+'</div></div>';

    var html =
      '<div class="h"><h3>–ü—Ä–æ—Ñ–∏–ª—å</h3><div class="muted">–≤—Å—ë, —á—Ç–æ —Ç—ã –Ω–∞–∫–æ–ø–∞–ª</div></div>'+
      '<div class="sep"></div>'+
      '<div class="kpi">'+
        '<div class="box"><b>'+(state.user.level||1)+'</b><span>—É—Ä–æ–≤–µ–Ω—å</span></div>'+
        '<div class="box"><b>'+escapeHtml(getRank(state.user.level||1))+'</b><span>—Ä–∞–Ω–≥</span></div>'+
        '<div class="box"><b>'+(state.user.streak||0)+'</b><span>—Å–µ—Ä–∏—è</span></div>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="tag">–ë–æ–Ω—É—Å—ã –æ—Ç —à–º–æ—Ç–æ–∫</div>'+
      '<div class="note" style="margin-top:6px">XP: +'+Math.round((perks.xp||0)*100)+'% ‚Ä¢ ü™ô: +'+Math.round((perks.coins||0)*100)+'% ‚Ä¢ –¥–æ–±—ã—á–∞: +'+Math.round((perks.res||0)*100)+'% ‚Ä¢ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏/–Ω–µ–¥: '+(perks.insurance||0)+' (–æ—Å—Ç–∞–ª–æ—Å—å '+(state.user.insuranceLeft||0)+')</div>'+
      '<div class="sep"></div>'+
      '<div class="tag">–†–µ—Å—É—Ä—Å—ã</div>'+
      '<div class="resGrid">'+resBoxes+'</div>'+
      '<div class="sep"></div>'+
      '<div class="tag">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>'+
      '<div class="note" style="margin-top:6px">–ü–æ–±–µ–¥—ã: <b>'+win7+'</b> ‚Ä¢ –ü—Ä–æ–ø—É—Å–∫–∏: <b>'+miss7+'</b>. –Ø –Ω–µ –æ—Å—É–∂–¥–∞—é. –Ø —Ñ–∏–∫—Å–∏—Ä—É—é.</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn blue" data-act="collect">üì¶ –°–æ–±—Ä–∞—Ç—å –¥–æ–±—ã—á—É</button>'+
        '<button type="button" class="btn" data-act="export">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç</button>'+
        '<button type="button" class="btn danger" data-act="reset">üß® –°–±—Ä–æ—Å</button>'+
      '</div>';
    $("#panelMain").innerHTML = html;
  }

  function openAddHabit(existing){
    existing = existing || null;
    var isEdit = !!existing;
    var pickedEmoji = existing ? existing.emoji : "üíß";
    var diff = existing ? existing.diff : "easy";
    var title = isEdit ? "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É" : "‚ûï –ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞";

    var pickerBtns = EMO.map(function(e){
      return '<button type="button" class="emoBtn '+(e===pickedEmoji?'sel':'')+'" data-act="pickEmoji" data-emoji="'+escapeHtml(e)+'">'+escapeHtml(e)+'</button>';
    }).join("");

    var body =
      '<div class="note">–í—ã–±–µ—Ä–∏ —ç–º–æ–¥–∑–∏ ‚Äî —á—Ç–æ–±—ã –º–æ–∑–≥ –Ω–µ —Ç—Ä–∞—Ç–∏–ª —Å–∏–ª—ã –Ω–∞ ¬´–∫–∞–∫ –Ω–∞–∑–≤–∞—Ç—å –∂–∏–∑–Ω—å¬ª.</div>'+
      '<div class="field">'+
        '<label>–≠–º–æ–¥–∑–∏</label>'+
        '<div class="picker" id="emojiPicker">'+pickerBtns+'</div>'+
        '<div class="muted" style="margin-top:6px">–ò–ª–∏ —Å–≤–æ—ë:</div>'+
        '<input id="emojiCustom" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: üß±" value="'+escapeHtml(pickedEmoji)+'" />'+
      '</div>'+
      '<div class="field">'+
        '<label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏</label>'+
        '<input id="habitName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 10 –º–∏–Ω—É—Ç —Ö–æ–¥—å–±—ã" value="'+escapeHtml(existing?existing.name:"")+'" />'+
      '</div>'+
      '<div class="field">'+
        '<label>–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>'+
        '<div class="chips">'+
          '<button type="button" class="chip '+(diff==="easy"?"on":"")+'" data-act="setDiff" data-diff="easy">–ª—ë–≥–∫–∞—è</button>'+
          '<button type="button" class="chip '+(diff==="normal"?"on":"")+'" data-act="setDiff" data-diff="normal">–Ω–æ—Ä–º</button>'+
          '<button type="button" class="chip '+(diff==="hard"?"on":"")+'" data-act="setDiff" data-diff="hard">–∂—ë—Å—Ç–∫–∞—è</button>'+
        '</div>'+
        '<div class="note" id="rewardHint" style="margin-top:6px"></div>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        (isEdit ? '<button type="button" class="btn danger" data-act="deleteHabit" data-id="'+existing.id+'">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>' : '')+
        '<button type="button" class="btn primary full" data-act="saveHabit" data-id="'+(existing?existing.id:"")+'">üíæ '+(isEdit?"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å":"–°–æ–∑–¥–∞—Ç—å")+'</button>'+
      '</div>';

    openModal(title, body);
    $("#mBody").setAttribute("data-diff", diff);
    $("#mBody").setAttribute("data-emoji", pickedEmoji);

    var r = diffRewards(diff);
    $("#rewardHint").innerHTML = "–ù–∞–≥—Ä–∞–¥–∞: <b>+"+r.xp+" XP</b> –∏ <b>+"+r.coins+" ü™ô</b>.";
  }

  function saveHabit(id){
    var emoji = ($("#emojiCustom") ? $("#emojiCustom").value : "") || ($("#mBody").getAttribute("data-emoji") || "üíß");
    emoji = String(emoji).trim() || "üíß";
    var name = ($("#habitName") ? $("#habitName").value : "").trim();
    var diff = $("#mBody").getAttribute("data-diff") || "easy";
    if(!name) return toast("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ.");
    var r = diffRewards(diff);

    if(id){
      var h=null;
      for(var i=0;i<state.habits.length;i++) if(state.habits[i].id===id) h=state.habits[i];
      if(!h) return;
      h.emoji = emoji; h.name = name; h.diff = diff; h.xp = r.xp; h.coins = r.coins;
    }else{
      state.habits.unshift({id:uid(), emoji:emoji, name:name, diff:diff, xp:r.xp, coins:r.coins, active:true, createdAt:Date.now()});
    }
    save();
    toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.");
    speak("any");
    closeModal();
    render();
  }

  function deleteHabit(id){
    state.habits = state.habits.filter(function(h){ return h.id!==id; });
    if(state.day && state.day.done) delete state.day.done[id];
    save();
    toast("–£–¥–∞–ª–µ–Ω–æ.");
    speak("any");
    closeModal();
    render();
  }

  function toggleHabit(id){
    if(state.day.closed) return toast("–î–µ–Ω—å —É–∂–µ –∑–∞–∫—Ä—ã—Ç.");
    if(!state.day.done) state.day.done = {};
    state.day.done[id] = !state.day.done[id];
    logTodayPreview();
    save();
    speak(state.day.done[id] ? "praise" : "any");
    var st=$("#beaverStage"); st.classList.add("wobble"); setTimeout(function(){st.classList.remove("wobble");},650);
    renderTop();
    renderToday();
  }

  function toggleActive(id){
    var h=null;
    for(var i=0;i<state.habits.length;i++) if(state.habits[i].id===id) h=state.habits[i];
    if(!h) return;
    h.active = !h.active;
    if(!h.active && state.day && state.day.done) delete state.day.done[id];
    save();
    toast(h.active ? "–í–∫–ª—é—á–µ–Ω–æ." : "–í—ã–∫–ª—é—á–µ–Ω–æ.");
    render();
  }

  function editHabit(id){
    var h=null;
    for(var i=0;i<state.habits.length;i++) if(state.habits[i].id===id) h=state.habits[i];
    if(!h) return;
    openAddHabit(h);
  }

  function suggestHabit(){
    var sug = rand(HABIT_SUGGEST);
    var body =
      '<div class="note">–ë–æ–±—Ä –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç (—Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ, –Ω–æ –ø–æ –¥–µ–ª—É):</div>'+
      '<div class="sep"></div>'+
      '<div class="item">'+
        '<div class="l">'+
          '<div class="name">'+escapeHtml(sug.emoji)+' '+escapeHtml(sug.name)+' <span class="tag">—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</span></div>'+
          '<div class="desc">–î–æ–±–∞–≤–ª—è–µ–º? –Ø —Å–¥–µ–ª–∞—é –≤–∏–¥, —á—Ç–æ —ç—Ç–æ –±—ã–ª–æ —Ç–≤–æ—ë —Ä–µ—à–µ–Ω–∏–µ.</div>'+
        '</div>'+
        '<div class="r">'+
          '<button type="button" class="btn sm primary" data-act="acceptSuggest" data-emoji="'+escapeHtml(sug.emoji)+'" data-name="'+escapeHtml(sug.name)+'">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>'+
        '</div>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow"><button type="button" class="btn full" data-act="closeModal">–ó–∞–∫—Ä—ã—Ç—å</button></div>';
    openModal("üß† –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –±–æ–±—Ä–∞", body);
    speak("suggest");
  }

  function acceptSuggest(emoji, name){
    var r = diffRewards("easy");
    state.habits.unshift({id:uid(), emoji:emoji, name:name, diff:"easy", xp:r.xp, coins:r.coins, active:true, createdAt:Date.now()});
    save();
    toast("–ü—Ä–∏–≤—ã—á–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞.");
    speak("praise");
    closeModal();
    render();
  }

  function restToday(){
    var cost = negotiateCost();
    var html =
      '<div class="note">–•–æ—á–µ—à—å –æ—Ç–¥—ã—Ö. –Ø –ø–æ–Ω–∏–º–∞—é. –ù–æ —É –Ω–∞—Å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —Ñ–∞—Ä—Å–∞.</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn warn" data-act="negotiateToday" data-cost="'+cost+'">ü§ù –î–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è (50%) ‚Äî '+cost+' ü™ô</button>'+
        '<button type="button" class="btn" data-act="closeModal">–ü–µ—Ä–µ–¥—É–º–∞–ª, —Ä–∞–±–æ—Ç–∞—é</button>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="note">–ï—Å–ª–∏ –ø—Ä–æ–≤–∞–ª ‚Äî –≥–ª—É–ø—ã–π –∫–≤–µ—Å—Ç, –∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–¥—ã—Ö —Ä–∞–∑—Ä–µ—à—É.</div>';
    openModal("üõå –û—Ç–¥–æ—Ö–Ω—É—Ç—å —Å–µ–≥–æ–¥–Ω—è", html);
    speak("any");
  }

  function negotiateToday(cost){
    cost = Number(cost)||0;
    if((state.user.coins||0) < cost) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç.");
    state.user.coins -= cost;
    var ok = Math.random() < 0.5;
    save();
    if(ok){
      toast("–õ–∞–¥–Ω–æ. –û—Ç–¥—ã—Ö. –ù–æ –∑–∞–≤—Ç—Ä–∞ —Ç—ã –º–Ω–µ –¥–æ–ª–∂–µ–Ω.");
      speak("any");
      closeModal();
      closeDay(true);
      return;
    }
    var task = rand(TASKS);
    state.quests.active = {id:uid(), text:task, createdAt:Date.now(), done:false};
    save();
    var body =
      '<div class="note"><b>–ù–µ –ø—Ä–æ–∫–∞—Ç–∏–ª–æ.</b> –í–∫–ª—é—á–∞—é —Ä–µ–∂–∏–º ¬´–∫–≤–µ—Å—Ç –∑–∞ –ø—Ä–∞–≤–æ –æ—Ç–¥—ã—Ö–∞—Ç—å¬ª.</div>'+
      '<div class="sep"></div>'+
      '<div class="item"><div class="l"><div class="name">ü§° –ì–ª—É–ø–æ–µ –∑–∞–¥–∞–Ω–∏–µ</div><div class="desc">'+escapeHtml(task)+'</div></div></div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn primary" data-act="questDone">‚úÖ –ì–æ—Ç–æ–≤–æ</button>'+
        '<button type="button" class="btn warn" data-act="questSkip">üò∂ –ù–µ —Å–¥–µ–ª–∞–ª</button>'+
      '</div>';
    openModal("ü§ù –ù–µ –¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å", body);
    speak("miss");
  }

  function openResources(){
    tickProduction();
    var rates = totalRatesPerHour();
    var perDayWood = Math.round((rates.wood||0)*24);
    var perDayMetal = Math.round((rates.metal||0)*24);
    var html =
      '<div class="note">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω—É–∂–Ω—ã –¥–ª—è <b>–∞–ø–≥—Ä–µ–π–¥–æ–≤ –±–∞–∑—ã</b> –∏ <b>—à–º–æ—Ç–æ–∫</b>. –ë–∞–∑–∞ –ø—Ä–∏–Ω–æ—Å–∏—Ç –ø–∞—Å—Å–∏–≤–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞—Ö–æ–¥–∏ –∏ —Å–æ–±–∏—Ä–∞–π.</div>'+
      '<div class="sep"></div>'+
      '<div class="resGrid">'+
        '<div class="resBox"><div class="k">ü™µ –î–µ—Ä–µ–≤–æ</div><div class="v">'+Math.floor(state.resources.wood||0)+'</div><div class="muted">+'+Math.round(rates.wood||0)+'/—á ‚Ä¢ '+perDayWood+'/–¥</div></div>'+
        '<div class="resBox"><div class="k">üî© –ú–µ—Ç–∞–ª–ª</div><div class="v">'+Math.floor(state.resources.metal||0)+'</div><div class="muted">+'+Math.round(rates.metal||0)+'/—á ‚Ä¢ '+perDayMetal+'/–¥</div></div>'+
        '<div class="resBox"><div class="k">ü™ô –ú–æ–Ω–µ—Ç—ã</div><div class="v">'+Math.floor(state.user.coins||0)+'</div><div class="muted">–∑–∞ –ø—Ä–∏–≤—ã—á–∫–∏ + –±–æ–Ω—É—Å—ã</div></div>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn blue" data-act="collect">üì¶ –°–æ–±—Ä–∞—Ç—å –¥–æ–±—ã—á—É</button>'+
        '<button type="button" class="btn" data-act="closeModal">–ó–∞–∫—Ä—ã—Ç—å</button>'+
      '</div>';
    openModal("üì¶ –†–µ—Å—É—Ä—Å—ã", html);
  }

  function exportData(){
    var blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = "beaver_builder_export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(function(){ URL.revokeObjectURL(url); }, 5000);
    toast("–≠–∫—Å–ø–æ—Ä—Ç —Å–∫–∞—á–∞–Ω.");
  }

  function resetAll(){
    openModal("üß® –°–±—Ä–æ—Å",
      '<div class="note">–≠—Ç–æ —É–¥–∞–ª–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –Ω–∞—á–Ω—ë—Ç —Å –Ω—É–ª—è. –¢—ã —É–≤–µ—Ä–µ–Ω?</div>'+
      '<div class="sep"></div>'+
      '<div class="btnRow">'+
        '<button type="button" class="btn danger" data-act="confirmReset">–î–∞, —Å–Ω–µ—Å—Ç–∏ –ø–ª–æ—Ç–∏–Ω—É</button>'+
        '<button type="button" class="btn" data-act="closeModal">–ù–µ—Ç</button>'+
      '</div>'
    );
  }
  function confirmReset(){
    localStorage.removeItem(KEY);
    location.reload();
  }

  function openChest(){
    var today = localISODate();
    var last = state.user.chest.lastOpen || "";
    if(last === today) return toast("–°—É–Ω–¥—É–∫ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç —Å–µ–≥–æ–¥–Ω—è.");
    // rewards: coins + random resources
    var coins = 25 + Math.floor(Math.random()*35) + Math.floor(state.user.level*0.6);
    state.user.coins += coins;
    var picks = 2 + (Math.random()<0.35 ? 1 : 0);
    var loot = [];
    for(var i=0;i<picks;i++){
      var rr = rand(RES);
      var key = rr[0];
      var amt = (key==="wood") ? (10 + Math.floor(Math.random()*16)) : (6 + Math.floor(Math.random()*13));
      state.resources[key] = (state.resources[key]||0) + amt;
      loot.push(iconOf(key)+" "+amt);
    }
    state.user.chest.lastOpen = today;
    save();
    toast("–°—É–Ω–¥—É–∫ –æ—Ç–∫—Ä—ã—Ç!");
    speak("praise");
    openModal("üéÅ –°—É–Ω–¥—É–∫ –¥–Ω—è",
      '<div class="tag">–õ—É—Ç</div>'+
      '<div class="sep"></div>'+
      '<div class="kpi">'+
        '<div class="box"><b>+'+coins+' ü™ô</b><span>–º–æ–Ω–µ—Ç—ã</span></div>'+
        '<div class="box"><b>'+escapeHtml(loot.join(" ‚Ä¢ "))+'</b><span>—Ä–µ—Å—É—Ä—Å—ã</span></div>'+
      '</div>'+
      '<div class="sep"></div>'+
      '<button type="button" class="btn primary full" data-act="closeModal">–ó–∞–±—Ä–∞—Ç—å</button>'
    );
    render();
  }

  function setTab(t){
    tab = t;
    $all(".nav button").forEach(function(b){ b.classList.toggle("active", b.getAttribute("data-tab")===t); });
    render();
    speak("any");
  }

  function render(){
    renderTop();
    renderMascotLayers();
    if(tab==="today") renderToday();
    if(tab==="habits") renderHabits();
    if(tab==="base") renderBase();
    if(tab==="shop") renderShop();
    if(tab==="me") renderMe();
    if(tab==="calendar") renderCalendar();
  }

  function onAction(act, el){
    // micro-ripple
    try{
      var b = (el && el.classList && el.classList.contains("btn")) ? el : safeClosest(el, ".btn");
      if(b && b.classList){ b.classList.add("rip"); setTimeout(function(){ b.classList.remove("rip"); }, 620); }
    }catch(_){}

    // Modal + common
    if(act==="closeModal") return closeModal();
    if(act==="say") return speak("any");
    if(act==="collect") return collectAll();
    if(act==="openChest") return openChest();
    if(act==="openResources") return openResources();

    // Navigation helpers
    if(act==="goCalendar"){ setTab("calendar"); return; }
    if(act==="goToday"){ setTab("today"); return; }

    // Guide
    if(act==="guideNext"){
      var s = parseInt(el.getAttribute("data-step")||"0",10);
      if(s >= 3){ state.user.seenGuide = true; save(); closeModal(); return; }
      return openGuide(s+1);
    }
    if(act==="guideSkip"){ state.user.seenGuide = true; save(); return closeModal(); }
    if(act==="guideCta"){
      var step = parseInt(el.getAttribute("data-step")||"0",10);
      if(step===0){ closeModal(); return openAddHabit(null); }
      if(step===1){ closeModal(); setTab("today"); return; }
      if(step===2){ closeModal(); setTab("calendar"); return; }
      if(step===3){ closeModal(); setTab("shop"); return; }
      return;
    }
    if(act==="openGuide") return openGuide(0);

    if(act==="presetToggle"){
      var idx = parseInt(el.getAttribute("data-idx")||"0",10);
      if(!state.tmp) state.tmp = {};
      if(!state.tmp.presetSel) state.tmp.presetSel = {};
      var cur = !!state.tmp.presetSel[idx];
      // –º–∞–∫—Å–∏–º—É–º 3
      if(!cur){
        var cnt = Object.keys(state.tmp.presetSel).filter(function(k){return state.tmp.presetSel[k];}).length;
        if(cnt>=3){ toast("–í—ã–±–µ—Ä–∏ –º–∞–∫—Å–∏–º—É–º 3."); speak("no"); return; }
      }
      state.tmp.presetSel[idx] = !cur;
      speak("pick");
      openGuide(0);
      return;
    }
    if(act==="presetAdd"){
      if(!state.tmp) state.tmp = {};
      var sel = state.tmp.presetSel || {};
      var idxs = Object.keys(sel).filter(function(k){return sel[k];}).map(function(k){return parseInt(k,10);});
      if(idxs.length===0){ toast("–í—ã–±–µ—Ä–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É."); speak("no"); return; }
      // –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –ø—Ä–∏–≤—ã—á–∫–∏
      for(var i=0;i<idxs.length;i++){
        var p = PRESET_HABITS[idxs[i]];
        if(!p) continue;
        addHabitFromPreset(p);
      }
      state.tmp.presetSel = {};
      save();
      speak("nice");
      closeModal();
      setTab("today");
      toast("–ü—Ä–∏–≤—ã—á–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ü–æ–≥–Ω–∞–ª–∏.");
      render();
      return;
    }


    // Calendar day details
    if(act==="openDay") return openDay(el.getAttribute("data-date"));

    // Habits
    if(act==="toggleHabit") return toggleHabit(el.getAttribute("data-id"));
    if(act==="openAddHabit") return openAddHabit(null);
    if(act==="editHabit") return editHabit(el.getAttribute("data-id"));
    if(act==="toggleActive") return toggleActive(el.getAttribute("data-id"));
    if(act==="suggestHabit") return suggestHabit();
    if(act==="acceptSuggest") return acceptSuggest(el.getAttribute("data-emoji"), el.getAttribute("data-name"));

    // Habit editor (inside modal)
    if(act==="pickEmoji"){
      var emo = el.getAttribute("data-emoji") || "üíß";
      var mb = $("#mBody");
      if(mb) mb.setAttribute("data-emoji", emo);
      var inp = $("#emojiCustom"); if(inp) inp.value = emo;
      var pick = $("#emojiPicker");
      if(pick){
        $all(".emoBtn", pick).forEach(function(btn){
          btn.classList.toggle("sel", btn.getAttribute("data-emoji")===emo);
        });
      }
      return;
    }
    if(act==="setDiff"){
      var d = el.getAttribute("data-diff") || "easy";
      var mb2 = $("#mBody");
      if(mb2) mb2.setAttribute("data-diff", d);
      // update chips
      $all('#mBody .chip[data-act="setDiff"]').forEach(function(ch){
        ch.classList.toggle("on", ch.getAttribute("data-diff")===d);
      });
      var r = diffRewards(d);
      var rh = $("#rewardHint");
      if(rh) rh.innerHTML = "–ù–∞–≥—Ä–∞–¥–∞: <b>+"+r.xp+" XP</b> –∏ <b>+"+r.coins+" ü™ô</b>.";
      return;
    }
    if(act==="saveHabit") return saveHabit(el.getAttribute("data-id"));
    if(act==="deleteHabit") return deleteHabit(el.getAttribute("data-id"));

    // Day flow
    if(act==="closeDay") return closeDay(false);
    if(act==="restToday") return restToday();
    if(act==="negotiateToday") return negotiateToday(el.getAttribute("data-cost"));

    // Missed day modal actions
    if(act==="negotiate") return negotiate(el.getAttribute("data-cost"));
    if(act==="punish") return punish();
    if(act==="insurance") return insurance();

    // Quest actions
    if(act==="questDone") return questDone();
    if(act==="questSkip") return questSkip();

    // Base
    if(act==="upgrade") return upgradeBuilding(el.getAttribute("data-id"));

    // Shop / gear
    if(act==="slot") return shopSlot(el.getAttribute("data-slot"), el);
    if(act==="buyGear") return buyGear(el.getAttribute("data-id"));
    if(act==="equip") return equipGear(el.getAttribute("data-id"));

    // Profile
    if(act==="export") return exportData();
    if(act==="reset") return resetAll();
    if(act==="confirmReset") return confirmReset();
  }


  // ==== Mobile tap handling (v5, fixed) ====
// Goal: reliable taps in mobile Safari/Android + WebViews without breaking desktop clicks.
// Implementation: event delegation with safeClosest + touch/click coordination.

(function polyfills(){
  if (!Element.prototype.matches) {
    Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
  }
  if (!Element.prototype.closest) {
    Element.prototype.closest = function(sel){
      var el = this;
      while (el && el.nodeType === 1) {
        if (el.matches(sel)) return el;
        el = el.parentElement;
      }
      return null;
    };
  }
})();

function asElement(node){
  if(!node) return null;
  if(node.nodeType === 1) return node; // ELEMENT_NODE
  return node.parentElement || null;
}

function safeClosest(node, sel){
  var el = asElement(node);
  if(!el) return null;
  if(el.closest) return el.closest(sel);
  while(el){
    if(el.matches && el.matches(sel)) return el;
    el = el.parentElement;
  }
  return null;
}

var lastTouchHandledAt = 0;

function handleTap(e){
  var actBtn = safeClosest(e.target, "[data-act]");
  if(actBtn){ onAction(actBtn.getAttribute("data-act"), actBtn); return true; }

  var tabBtn = safeClosest(e.target, ".nav button[data-tab]");
  if(tabBtn){ setTab(tabBtn.getAttribute("data-tab")); return true; }

  return false;
}

// Prefer pointer events when available.
document.addEventListener("pointerup", function(e){
  if(e && e.pointerType === "touch"){
    if(handleTap(e)) lastTouchHandledAt = Date.now();
  }
}, true);

// Fallback for older/quirky WebViews.
document.addEventListener("touchend", function(e){
  if(handleTap(e)) lastTouchHandledAt = Date.now();
}, true);

// Desktop + non-touch clicks.
// IMPORTANT: don't swallow click unless we just handled a touch.
document.addEventListener("click", function(e){
  if(Date.now() - lastTouchHandledAt < 450) return;
  handleTap(e);
}, true);
// ==== end tap handling ====
  var state = load();
  var tab = "today";

  function boot(){
    ensureWeekInsurance();
    missedDayCheck();
    tickProduction();
    logTodayPreview();
    render();
    speak("any");
    maybeShowGuide();
    // lightweight background tick for base/prof only
    setInterval(function(){
      tickProduction();
      if(tab==="base") renderBase();
      if(tab==="me") renderMe();
    }, 1500);
  }

  boot();
})();
</script>
</body>
</html>
